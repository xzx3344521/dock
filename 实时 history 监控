# åˆ›å»ºå”¯ä¸€çš„ç›‘æ§ç³»ç»Ÿ
cat > /usr/local/bin/cmdwatch << 'EOF'
#!/bin/bash

# é…ç½®æ–‡ä»¶
CONFIG_DIR="/root/.cmdwatch"
LOG_FILE="$CONFIG_DIR/monitor.log"
PID_FILE="$CONFIG_DIR/pid"
LOCK_FILE="$CONFIG_DIR/lock"

# åˆå§‹åŒ–
init_system() {
    mkdir -p "$CONFIG_DIR"
    touch "$LOG_FILE"
}

# è·å–å®¢æˆ·ç«¯IP
get_client_ip() {
    local ip="unknown"
    [ -n "$SSH_CLIENT" ] && ip=$(echo "$SSH_CLIENT" | awk '{print $1}')
    [ "$ip" = "unknown" ] && [ -n "$SSH_CONNECTION" ] && ip=$(echo "$SSH_CONNECTION" | awk '{print $1}')
    echo "$ip"
}

# æ£€æŸ¥æ˜¯å¦è¿è¡Œä¸­
is_running() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE" 2>/dev/null)
        if ps -p "$pid" >/dev/null 2>&1; then
            return 0
        else
            rm -f "$PID_FILE"
        fi
    fi
    return 1
}

# æ–‡ä»¶é”
get_lock() {
    exec 200>"$LOCK_FILE"
    flock -n 200 && return 0
    return 1
}

release_lock() {
    flock -u 200
}

# åœæ­¢æ‰€æœ‰å¯èƒ½çš„ç›‘æ§è¿›ç¨‹
stop_all_monitors() {
    echo "åœæ­¢æ‰€æœ‰ç›‘æ§è¿›ç¨‹..."
    # åœæ­¢å½“å‰ç³»ç»Ÿ
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE" 2>/dev/null)
        [ -n "$pid" ] && kill "$pid" 2>/dev/null
    fi
    
    # åœæ­¢å…¶ä»–å¯èƒ½è¿è¡Œçš„ç›‘æ§
    pkill -f "cmd_monitor"
    pkill -f "monitor.sh"
    pkill -f "mt"
    pkill -f "mon"
    pkill -f "cmdwatch"
    
    # æ¸…ç†æ–‡ä»¶
    rm -f "$PID_FILE"
    rm -f "$LOCK_FILE"
    sleep 1
}

# ä¸»ç›‘æ§å‡½æ•°
start_monitoring() {
    echo "å¯åŠ¨å‘½ä»¤ç›‘æ§..."
    
    # è®¾ç½®å®æ—¶history
    for user_dir in /home/* /root; do
        [ -d "$user_dir" ] || continue
        bashrc="$user_dir/.bashrc"
        [ -f "$bashrc" ] || continue
        if ! grep -q "PROMPT_COMMAND.*cmdwatch" "$bashrc" 2>/dev/null; then
            echo 'export PROMPT_COMMAND="history -a; history -c; history -r #cmdwatch"' >> "$bashrc"
        fi
    done
    
    # å¯åŠ¨ç›‘æ§è¿›ç¨‹
    (
        echo "=== å‘½ä»¤ç›‘æ§å¯åŠ¨: $(date) ===" >> "$LOG_FILE"
        declare -A file_sizes
        
        # åˆå§‹åŒ–æ–‡ä»¶å¤§å°
        for user_dir in /home/* /root; do
            [ -d "$user_dir" ] || continue
            user=$(basename "$user_dir")
            history_file="$user_dir/.bash_history"
            [ -f "$history_file" ] && file_sizes["$user"]=$(stat -c%s "$history_file" 2>/dev/null || echo 0)
        done
        
        # ä¸»ç›‘æ§å¾ªç¯
        while true; do
            for user_dir in /home/* /root; do
                [ -d "$user_dir" ] || continue
                user=$(basename "$user_dir")
                history_file="$user_dir/.bash_history"
                [ -f "$history_file" ] || continue
                
                current_size=$(stat -c%s "$history_file" 2>/dev/null || echo 0)
                last_size=${file_sizes["$user"]:-0}
                
                if [ "$current_size" -gt "$last_size" ]; then
                    new_cmd=$(tail -n 1 "$history_file" 2>/dev/null | sed 's/^[ \t]*//;s/[ \t]*$//')
                    if [ -n "$new_cmd" ] && [ ${#new_cmd} -gt 1 ]; then
                        # è¿‡æ»¤ç®€å•å‘½ä»¤
                        case "$new_cmd" in
                            ls|cd|pwd|ll|history|exit|clear|cmdwatch|"."|"..")
                                continue
                                ;;
                            *)
                                client_ip=$(get_client_ip)
                                timestamp=$(date '+%Y-%m-%d %H:%M:%S')
                                log_entry="[$timestamp] ç”¨æˆ·:$user | å‘½ä»¤:$new_cmd | æ¥æº:$client_ip"
                                echo "$log_entry" >> "$LOG_FILE"
                                file_sizes["$user"]=$current_size
                                ;;
                        esac
                    fi
                fi
            done
            sleep 1
        done
    ) &
    
    echo $! > "$PID_FILE"
    echo "âœ… ç›‘æ§å·²å¯åŠ¨ (PID: $!)"
}

# å‘½ä»¤å¤„ç†
case "$1" in
    start)
        init_system
        if ! get_lock; then
            echo "âŒ ç›‘æ§å·²ç»åœ¨è¿è¡Œä¸­"
            exit 1
        fi
        
        if is_running; then
            echo "âœ… ç›‘æ§å·²åœ¨è¿è¡Œä¸­"
            release_lock
            exit 0
        fi
        
        stop_all_monitors
        start_monitoring
        release_lock
        ;;
        
    stop)
        init_system
        stop_all_monitors
        echo "âœ… æ‰€æœ‰ç›‘æ§å·²åœæ­¢"
        ;;
        
    status)
        init_system
        if is_running; then
            pid=$(cat "$PID_FILE")
            echo "âœ… ç›‘æ§è¿è¡Œä¸­ (PID: $pid)"
            echo "ğŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
            echo "ğŸ“Š æ—¥å¿—è¡Œæ•°: $(wc -l < "$LOG_FILE" 2>/dev/null || echo 0)"
        else
            echo "âŒ ç›‘æ§æœªè¿è¡Œ"
        fi
        ;;
        
    view|logs)
        init_system
        if [ "$2" = "-f" ] || [ "$1" = "view" ]; then
            if [ -f "$LOG_FILE" ]; then
                tail -f "$LOG_FILE"
            else
                echo "æš‚æ— æ—¥å¿—"
            fi
        else
            if [ -f "$LOG_FILE" ]; then
                tail -20 "$LOG_FILE"
            else
                echo "æš‚æ— æ—¥å¿—"
            fi
        fi
        ;;
        
    install)
        init_system
        stop_all_monitors
        
        # è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
        echo "è®¾ç½®å¼€æœºè‡ªå¯åŠ¨..."
        (crontab -l 2>/dev/null | grep -v "cmdwatch"; echo "@reboot /usr/local/bin/cmdwatch start >/dev/null 2>&1") | crontab -
        
        # è®¾ç½®å‘½ä»¤åˆ«å
        echo "è®¾ç½®å‘½ä»¤åˆ«å..."
        sed -i '/alias cmdwatch=/d' ~/.bashrc
        echo "alias cw='/usr/local/bin/cmdwatch view'" >> ~/.bashrc
        
        # å¯åŠ¨ç›‘æ§
        /usr/local/bin/cmdwatch start
        
        source ~/.bashrc
        
        echo ""
        echo "ğŸ‰ å®‰è£…å®Œæˆ!"
        echo "========================"
        echo "ä½¿ç”¨æ–¹æ³•:"
        echo "  cw              # æŸ¥çœ‹å®æ—¶ç›‘æ§"
        echo "  cmdwatch view   # æŸ¥çœ‹å®æ—¶ç›‘æ§"
        echo "  cmdwatch status # æŸ¥çœ‹çŠ¶æ€"
        echo "  cmdwatch stop   # åœæ­¢ç›‘æ§"
        echo "  cmdwatch logs   # æŸ¥çœ‹å†å²æ—¥å¿—"
        ;;
        
    clean)
        echo "ğŸ§¹ å½»åº•æ¸…ç†æ‰€æœ‰ç›‘æ§ç³»ç»Ÿ..."
        # åœæ­¢æ‰€æœ‰
        pkill -f "cmd_monitor"
        pkill -f "monitor.sh"
        pkill -f "mt"
        pkill -f "mon"
        pkill -f "cmdwatch"
        
        # æ¸…ç†æ–‡ä»¶
        rm -rf /root/monitor
        rm -rf /root/install
        rm -rf /root/.cmdwatch
        rm -f /usr/local/bin/mt
        rm -f /usr/local/bin/mon
        rm -f /tmp/*monitor*
        rm -f /tmp/cmd_monitor.*
        
        # æ¸…ç†crontab
        (crontab -l 2>/dev/null | grep -v -E "(monitor|cmd_monitor|mt|mon|cmdwatch)") | crontab -
        
        # æ¸…ç†åˆ«å
        sed -i '/alias to=/d' ~/.bashrc
        sed -i '/alias mon=/d' ~/.bashrc
        sed -i '/alias mt=/d' ~/.bashrc
        sed -i '/alias cw=/d' ~/.bashrc
        
        source ~/.bashrc
        echo "âœ… å½»åº•æ¸…ç†å®Œæˆ"
        ;;
        
    *)
        echo "å‘½ä»¤ç›‘æ§ç³»ç»Ÿ (cmdwatch)"
        echo "========================"
        echo "ä½¿ç”¨æ–¹æ³•:"
        echo "  cmdwatch start   # å¯åŠ¨ç›‘æ§"
        echo "  cmdwatch stop    # åœæ­¢ç›‘æ§"
        echo "  cmdwatch status  # æŸ¥çœ‹çŠ¶æ€"
        echo "  cmdwatch view    # å®æ—¶æŸ¥çœ‹"
        echo "  cmdwatch logs    # æŸ¥çœ‹æ—¥å¿—"
        echo "  cmdwatch install # å®‰è£…é…ç½®"
        echo "  cmdwatch clean   # å½»åº•æ¸…ç†"
        echo ""
        echo "å®‰è£…åä½¿ç”¨: cw   # æŸ¥çœ‹å®æ—¶ç›‘æ§"
        ;;
esac
EOF

# ç»™æ‰§è¡Œæƒé™
chmod +x /usr/local/bin/cmdwatch

# å®‰è£…å¹¶å¯åŠ¨
echo "å®‰è£…å”¯ä¸€ç›‘æ§ç³»ç»Ÿ..."
cmdwatch install

# æµ‹è¯•
echo "æµ‹è¯•ç›‘æ§ç³»ç»Ÿ..."
cw
