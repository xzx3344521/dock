# åˆ›å»ºå®Œæ•´çš„ä¿®å¤è„šæœ¬
cat > /tmp/fix_alias.sh << 'EOF'
#!/bin/bash

echo "=== ä¿®å¤åˆ«åè®¾ç½® ==="

# æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
SCRIPT_PATH="/root/monitor/cmd_monitor_fixed.sh"
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "âŒ ç›‘æ§è„šæœ¬ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º..."
    
    # åˆ›å»ºç›‘æ§ç›®å½•
    mkdir -p /root/monitor
    
    # é‡æ–°åˆ›å»ºç›‘æ§è„šæœ¬
    cat > "$SCRIPT_PATH" << 'SCRIPT_EOF'
#!/bin/bash

INSTALL_DIR="/root/monitor"
SCRIPT_PATH="$INSTALL_DIR/cmd_monitor_fixed.sh"
LOG_DIR="/root/command_logs"
PID_FILE="/tmp/cmd_monitor.pid"

# è·å–å®¢æˆ·ç«¯IPå’Œåœ°ç†ä½ç½®
get_client_ip() {
    local ip="unknown"
    [ -n "$SSH_CLIENT" ] && ip=$(echo "$SSH_CLIENT" | awk '{print $1}')
    [ "$ip" = "unknown" ] && [ -n "$SSH_CONNECTION" ] && ip=$(echo "$SSH_CONNECTION" | awk '{print $1}')
    echo "$ip"
}

get_ip_location() {
    local ip="$1"
    [ "$ip" = "unknown" ] && echo "unknown" && return
    [ "$ip" = "127.0.0.1" ] && echo "localhost" && return
    
    # ä½¿ç”¨ç®€å•çš„åœ°ç†ä½ç½®æŸ¥è¯¢
    if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„åœ°ç†ä½ç½®æŸ¥è¯¢
        # ç°åœ¨å…ˆç”¨ç®€å•çš„æ–¹å¼æ˜¾ç¤ºIPæ®µ
        echo "$(echo $ip | cut -d. -f1-2).x.x"
    else
        echo "unknown"
    fi
}

# æ£€æŸ¥æ˜¯å¦å·²ç»è¿è¡Œ
is_running() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE" 2>/dev/null)
        if ps -p "$pid" >/dev/null 2>&1; then
            return 0
        else
            rm -f "$PID_FILE"
        fi
    fi
    return 1
}

# æ£€æŸ¥toå‘½ä»¤
if [ "$1" = "to" ]; then
    if is_running; then
        echo "åˆ‡æ¢åˆ°å‰å°æ˜¾ç¤ºæ¨¡å¼..."
        exec "$SCRIPT_PATH" display
    else
        echo "å¯åŠ¨åå°ç›‘æ§+å‰å°æ˜¾ç¤ºæ¨¡å¼..."
        exec "$SCRIPT_PATH" both
    fi
    exit 0
fi

case "$1" in
    both|start)
        if is_running; then
            echo "ç›‘æ§å·²ç»åœ¨è¿è¡Œä¸­"
            exec "$SCRIPT_PATH" display
            exit 0
        fi
        
        echo "å¯åŠ¨åå°ç›‘æ§+å‰å°æ˜¾ç¤ºæ¨¡å¼..."
        
        # è®¾ç½®å®æ—¶history
        for user_dir in /home/* /root; do
            [ -d "$user_dir" ] || continue
            bashrc="$user_dir/.bashrc"
            [ -f "$bashrc" ] || continue
            if ! grep -q "PROMPT_COMMAND.*history" "$bashrc" 2>/dev/null; then
                echo 'export PROMPT_COMMAND="history -a; history -c; history -r"' >> "$bashrc"
            fi
        done
        
        # å¯åŠ¨åå°ç›‘æ§
        (
            mkdir -p "$LOG_DIR"
            echo "=== åå°ç›‘æ§å¯åŠ¨: $(date) ===" >> "$LOG_DIR/monitor.log"
            declare -A last_sizes
            
            # åˆå§‹åŒ–æ–‡ä»¶å¤§å°
            for user_dir in /home/* /root; do
                [ -d "$user_dir" ] || continue
                user=$(basename "$user_dir")
                history_file="$user_dir/.bash_history"
                [ -f "$history_file" ] && last_sizes["$user"]=$(stat -c%s "$history_file" 2>/dev/null || echo 0)
            done
            
            while true; do
                for user_dir in /home/* /root; do
                    [ -d "$user_dir" ] || continue
                    user=$(basename "$user_dir")
                    history_file="$user_dir/.bash_history"
                    [ -f "$history_file" ] || continue
                    
                    current_size=$(stat -c%s "$history_file" 2>/dev/null || echo 0)
                    last_size=${last_sizes["$user"]:-0}
                    
                    if [ "$current_size" -gt "$last_size" ]; then
                        new_cmd=$(tail -n 1 "$history_file" 2>/dev/null | sed 's/^[ \t]*//;s/[ \t]*$//')
                        if [ -n "$new_cmd" ] && [ ${#new_cmd} -gt 1 ]; then
                            # è¿‡æ»¤ç®€å•å‘½ä»¤
                            case "$new_cmd" in
                                ls|cd|pwd|ll|history|exit|clear|to|"."|"..")
                                    continue
                                    ;;
                                *)
                                    client_ip=$(get_client_ip)
                                    location=$(get_ip_location "$client_ip")
                                    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
                                    log_entry="[$timestamp] ç”¨æˆ·:$user | å‘½ä»¤:$new_cmd | æ¥æºIP:$client_ip | ä½ç½®:$location"
                                    echo "$log_entry" >> "$LOG_DIR/monitor.log"
                                    # åŒæ—¶è¾“å‡ºåˆ°å‰å°
                                    echo "$log_entry" > /tmp/cmd_monitor.last_cmd
                                    ;;
                            esac
                        fi
                        last_sizes["$user"]=$current_size
                    fi
                done
                sleep 2
            done
        ) &
        
        echo $! > "$PID_FILE"
        echo "âœ… åå°ç›‘æ§å·²å¯åŠ¨ (PID: $!)"
        
        # å¯åŠ¨å‰å°æ˜¾ç¤º
        echo "ğŸ” å¯åŠ¨å‰å°æ˜¾ç¤º..."
        exec "$SCRIPT_PATH" display
        ;;
        
    display|foreground)
        echo "ğŸ” å‰å°æ˜¾ç¤ºæ¨¡å¼å¯åŠ¨..."
        echo "ğŸ’¡ åå°ç›‘æ§æŒç»­è¿è¡Œä¸­"
        echo "ğŸ’¡ è¾“å…¥ 'to' é€€å‡ºæ˜¾ç¤ºï¼ˆåå°ç»§ç»­è¿è¡Œï¼‰"
        echo "â¹ï¸  æŒ‰ Ctrl+C åœæ­¢æ˜¾ç¤º"
        echo "================================"
        
        # æ˜¾ç¤ºæœ€åå‡ æ¡è®°å½•
        if [ -f "$LOG_DIR/monitor.log" ]; then
            echo "æœ€è¿‘è®°å½•:"
            tail -5 "$LOG_DIR/monitor.log" | while read line; do
                echo "  ğŸ“Œ $line"
            done
            echo "------------------------"
        fi
        
        # è®¾ç½®ä¿¡å·å¤„ç†
        trap 'echo -e "\nğŸ›‘ åœæ­¢å‰å°æ˜¾ç¤ºï¼ˆåå°ç›‘æ§ç»§ç»­è¿è¡Œï¼‰"; exit 0' INT TERM
        
        # å®æ—¶æ˜¾ç¤ºæ–°å‘½ä»¤
        while true; do
            # æ£€æµ‹toå‘½ä»¤è¾“å…¥
            if read -t 1 -n 2 input 2>/dev/null; then
                if [ "$input" = "to" ]; then
                    echo "ğŸ”„ é€€å‡ºå‰å°æ˜¾ç¤º..."
                    echo "âœ… åå°ç›‘æ§ç»§ç»­è¿è¡Œä¸­"
                    exit 0
                fi
            fi
            
            # æ˜¾ç¤ºæ–°å‘½ä»¤
            if [ -f /tmp/cmd_monitor.last_cmd ]; then
                echo "ğŸ†• $(cat /tmp/cmd_monitor.last_cmd)"
                rm -f /tmp/cmd_monitor.last_cmd
            fi
        done
        ;;
        
    stop)
        if [ -f "$PID_FILE" ]; then
            pid=$(cat "$PID_FILE")
            if ps -p "$pid" >/dev/null 2>&1; then
                kill "$pid" 2>/dev/null
                rm -f "$PID_FILE"
                rm -f /tmp/cmd_monitor.last_cmd
                echo "âœ… ç›‘æ§å·²åœæ­¢ (PID: $pid)"
            else
                rm -f "$PID_FILE"
                echo "âš ï¸  ç›‘æ§è¿›ç¨‹ä¸å­˜åœ¨ï¼Œå·²æ¸…ç†"
            fi
        else
            echo "â„¹ï¸  ç›‘æ§æœªè¿è¡Œ"
        fi
        ;;
        
    status)
        if is_running; then
            pid=$(cat "$PID_FILE")
            echo "âœ… ç›‘æ§è¿è¡Œä¸­ (PID: $pid)"
            echo "ğŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_DIR/monitor.log"
        else
            echo "âŒ ç›‘æ§æœªè¿è¡Œ"
        fi
        ;;
        
    *)
        echo "å‘½ä»¤ç›‘æ§ç³»ç»Ÿ"
        echo "ä½¿ç”¨æ–¹æ³•: $0 {both|display|stop|status|to}"
        echo ""
        echo "ç¤ºä¾‹:"
        echo "  to        - å¯åŠ¨/åˆ‡æ¢æ¨¡å¼"
        echo "  $0 both   - åå°ç›‘æ§+å‰å°æ˜¾ç¤º"
        echo "  $0 display - ä»…å‰å°æ˜¾ç¤º"
        echo "  $0 stop   - åœæ­¢ç›‘æ§"
        ;;
esac
SCRIPT_EOF

    chmod +x "$SCRIPT_PATH"
    echo "âœ… ç›‘æ§è„šæœ¬å·²åˆ›å»º: $SCRIPT_PATH"
fi

# ä¿®å¤åˆ«å
echo "ä¿®å¤åˆ«åè®¾ç½®..."
# åˆ é™¤æ‰€æœ‰æ—§çš„toåˆ«å
sed -i '/alias to=/d' ~/.bashrc

# æ·»åŠ æ–°çš„åˆ«å
echo 'alias to="/root/monitor/cmd_monitor_fixed.sh to"' >> ~/.bashrc

# é‡æ–°åŠ è½½bashé…ç½®
source ~/.bashrc

echo ""
echo "âœ… ä¿®å¤å®Œæˆï¼"
echo "æµ‹è¯•å‘½ä»¤:"
echo "  to          # å¯åŠ¨ç›‘æ§"
echo "  æˆ–è€…ç›´æ¥è¿è¡Œ: /root/monitor/cmd_monitor_fixed.sh both"
EOF

chmod +x /tmp/fix_alias.sh
/tmp/fix_alias.sh
