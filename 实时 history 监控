# åˆ›å»ºç»Ÿä¸€çš„ç›‘æ§ç³»ç»Ÿ
cat > /usr/local/bin/mon << 'EOF'
#!/bin/bash

LOG_FILE="/root/command_logs/monitor.log"
PID_FILE="/tmp/monitor.pid"
LOCK_FILE="/tmp/monitor.lock"

# è·å–å®¢æˆ·ç«¯IP
get_client_ip() {
    local ip="unknown"
    [ -n "$SSH_CLIENT" ] && ip=$(echo "$SSH_CLIENT" | awk '{print $1}')
    [ "$ip" = "unknown" ] && [ -n "$SSH_CONNECTION" ] && ip=$(echo "$SSH_CONNECTION" | awk '{print $1}')
    echo "$ip"
}

# æ£€æŸ¥æ˜¯å¦è¿è¡Œä¸­
is_running() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE" 2>/dev/null)
        if ps -p "$pid" >/dev/null 2>&1; then
            return 0
        else
            rm -f "$PID_FILE"
        fi
    fi
    return 1
}

# è·å–æ–‡ä»¶é”é˜²æ­¢é‡å¤å¯åŠ¨
get_lock() {
    exec 200>"$LOCK_FILE"
    flock -n 200 && return 0
    return 1
}

release_lock() {
    flock -u 200
    rm -f "$LOCK_FILE"
}

# toå‘½ä»¤å¤„ç†
if [ "$1" = "to" ]; then
    if is_running; then
        echo "ğŸ” åˆ‡æ¢åˆ°å‰å°æ˜¾ç¤ºæ¨¡å¼..."
        echo "ğŸ’¡ æŒ‰ Ctrl+C è¿”å›åå°æ¨¡å¼"
        echo "================================"
        
        if [ -f "$LOG_FILE" ]; then
            echo "æœ€è¿‘è®°å½•:"
            tail -5 "$LOG_FILE"
            echo "------------------------"
            echo "å¼€å§‹å®æ—¶æ˜¾ç¤º..."
            tail -f "$LOG_FILE"
        else
            echo "æš‚æ— æ—¥å¿—è®°å½•"
        fi
    else
        echo "ğŸš€ å¯åŠ¨ç›‘æ§ç³»ç»Ÿ..."
        exec "$0" start
    fi
    exit 0
fi

case "$1" in
    start|background)
        if ! get_lock; then
            echo "âŒ ç›‘æ§å·²ç»åœ¨è¿è¡Œä¸­"
            exit 1
        fi
        
        if is_running; then
            echo "âœ… ç›‘æ§å·²åœ¨è¿è¡Œä¸­ (PID: $(cat "$PID_FILE"))"
            release_lock
            exit 0
        fi
        
        echo "ğŸ”§ å¯åŠ¨åå°ç›‘æ§..."
        
        # è®¾ç½®å®æ—¶historyï¼ˆåªè®¾ç½®ä¸€æ¬¡ï¼‰
        for user_dir in /home/* /root; do
            [ -d "$user_dir" ] || continue
            bashrc="$user_dir/.bashrc"
            [ -f "$bashrc" ] || continue
            if ! grep -q "PROMPT_COMMAND.*history.*a.*c.*r" "$bashrc" 2>/dev/null; then
                echo 'export PROMPT_COMMAND="history -a; history -c; history -r"' >> "$bashrc"
            fi
        done
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p "/root/command_logs"
        
        # å¯åŠ¨å•ä¸€ç›‘æ§è¿›ç¨‹
        (
            echo "=== ç›‘æ§ç³»ç»Ÿå¯åŠ¨: $(date) ===" >> "$LOG_FILE"
            declare -A file_sizes
            
            # åˆå§‹åŒ–æ–‡ä»¶å¤§å°
            for user_dir in /home/* /root; do
                [ -d "$user_dir" ] || continue
                user=$(basename "$user_dir")
                history_file="$user_dir/.bash_history"
                [ -f "$history_file" ] && file_sizes["$user"]=$(stat -c%s "$history_file" 2>/dev/null || echo 0)
            done
            
            # ä¸»ç›‘æ§å¾ªç¯
            while true; do
                for user_dir in /home/* /root; do
                    [ -d "$user_dir" ] || continue
                    user=$(basename "$user_dir")
                    history_file="$user_dir/.bash_history"
                    [ -f "$history_file" ] || continue
                    
                    current_size=$(stat -c%s "$history_file" 2>/dev/null || echo 0)
                    last_size=${file_sizes["$user"]:-0}
                    
                    if [ "$current_size" -gt "$last_size" ]; then
                        new_cmd=$(tail -n 1 "$history_file" 2>/dev/null | sed 's/^[ \t]*//;s/[ \t]*$//')
                        if [ -n "$new_cmd" ] && [ ${#new_cmd} -gt 1 ]; then
                            # è¿‡æ»¤ç®€å•å‘½ä»¤
                            case "$new_cmd" in
                                ls|cd|pwd|ll|history|exit|clear|to|mon|"."|"..")
                                    continue
                                    ;;
                                *)
                                    client_ip=$(get_client_ip)
                                    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
                                    log_entry="[$timestamp] ç”¨æˆ·:$user | å‘½ä»¤:$new_cmd | æ¥æº:$client_ip"
                                    echo "$log_entry" >> "$LOG_FILE"
                                    ;;
                            esac
                        fi
                        file_sizes["$user"]=$current_size
                    fi
                done
                sleep 2
            done
        ) &
        
        monitor_pid=$!
        echo $monitor_pid > "$PID_FILE"
        release_lock
        
        echo "âœ… åå°ç›‘æ§å·²å¯åŠ¨ (PID: $monitor_pid)"
        echo "ğŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
        echo "ğŸ’¡ ä½¿ç”¨ 'mon to' æŸ¥çœ‹å®æ—¶ç›‘æ§"
        ;;
        
    stop)
        if [ -f "$PID_FILE" ]; then
            pid=$(cat "$PID_FILE")
            if ps -p "$pid" >/dev/null 2>&1; then
                kill "$pid" 2>/dev/null
                rm -f "$PID_FILE"
                rm -f "$LOCK_FILE"
                echo "âœ… ç›‘æ§å·²åœæ­¢ (PID: $pid)"
            else
                rm -f "$PID_FILE"
                rm -f "$LOCK_FILE"
                echo "âš ï¸ ç›‘æ§è¿›ç¨‹ä¸å­˜åœ¨ï¼Œå·²æ¸…ç†"
            fi
        else
            echo "â„¹ï¸ ç›‘æ§æœªè¿è¡Œ"
        fi
        ;;
        
    status)
        if is_running; then
            pid=$(cat "$PID_FILE")
            echo "âœ… ç›‘æ§è¿è¡Œä¸­ (PID: $pid)"
            echo "ğŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
            echo "ğŸ“Š æ—¥å¿—è¡Œæ•°: $(wc -l < "$LOG_FILE" 2>/dev/null || echo 0)"
        else
            echo "âŒ ç›‘æ§æœªè¿è¡Œ"
        fi
        ;;
        
    logs)
        if [ -f "$LOG_FILE" ]; then
            if [ "$2" = "-f" ]; then
                tail -f "$LOG_FILE"
            else
                tail -20 "$LOG_FILE"
            fi
        else
            echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        ;;
        
    install)
        # åœæ­¢å¯èƒ½è¿è¡Œçš„æ—§ç›‘æ§
        "$0" stop
        
        # è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
        echo "ğŸ”§ è®¾ç½®å¼€æœºè‡ªå¯åŠ¨..."
        (crontab -l 2>/dev/null | grep -v "$0"; echo "@reboot $0 start >/dev/null 2>&1") | crontab -
        
        # è®¾ç½®å‘½ä»¤åˆ«å
        echo "ğŸ”§ è®¾ç½®å‘½ä»¤åˆ«å..."
        sed -i '/alias to=/d' ~/.bashrc
        echo "alias to='$0 to'" >> ~/.bashrc
        
        # é‡æ–°åŠ è½½é…ç½®
        source ~/.bashrc
        
        # å¯åŠ¨ç›‘æ§
        "$0" start
        
        echo ""
        echo "ğŸ‰ å®‰è£…å®Œæˆ!"
        echo "========================"
        echo "ç«‹å³ä½¿ç”¨:"
        echo "  to          # å¯åŠ¨/æŸ¥çœ‹ç›‘æ§"
        echo "  mon status  # æŸ¥çœ‹çŠ¶æ€"
        echo "  mon stop    # åœæ­¢ç›‘æ§"
        echo "  mon logs    # æŸ¥çœ‹æ—¥å¿—"
        ;;
        
    uninstall)
        "$0" stop
        rm -f "$0"
        # æ¸…ç†crontab
        crontab -l 2>/dev/null | grep -v "$0" | crontab -
        # æ¸…ç†åˆ«å
        sed -i '/alias to=/d' ~/.bashrc
        echo "âœ… å·²å¸è½½ç›‘æ§ç³»ç»Ÿ"
        ;;
        
    *)
        echo "å‘½ä»¤ç›‘æ§ç³»ç»Ÿ"
        echo "========================"
        echo "ä½¿ç”¨æ–¹æ³•:"
        echo "  to              # å¯åŠ¨/æŸ¥çœ‹ç›‘æ§"
        echo "  mon start       # å¯åŠ¨åå°ç›‘æ§"
        echo "  mon stop        # åœæ­¢ç›‘æ§"
        echo "  mon status      # æŸ¥çœ‹çŠ¶æ€"
        echo "  mon logs        # æŸ¥çœ‹æ—¥å¿—"
        echo "  mon logs -f     # å®æ—¶æŸ¥çœ‹æ—¥å¿—"
        echo "  mon install     # å®‰è£…é…ç½®"
        echo "  mon uninstall   # å¸è½½"
        ;;
esac
EOF

# ç»™æ‰§è¡Œæƒé™
chmod +x /usr/local/bin/mon

# å®‰è£…å¹¶å¯åŠ¨
echo "å®‰è£…ç»Ÿä¸€ç›‘æ§ç³»ç»Ÿ..."
mon install

# æµ‹è¯•
echo "æµ‹è¯•ç›‘æ§ç³»ç»Ÿ..."
to
