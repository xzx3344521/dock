#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ³ Dockeré•œåƒæºè‡ªåŠ¨æµ‹é€Ÿè„šæœ¬${NC}"
echo "=================================="

# å®šä¹‰æµ‹è¯•çš„é•œåƒæºåˆ—è¡¨
declare -A MIRRORS=(
    ["é˜¿é‡Œäº‘"]="mirrors.aliyun.com"
    ["ä¸­ç§‘å¤§"]="mirrors.ustc.edu.cn" 
    ["æ¸…å"]="mirrors.tuna.tsinghua.edu.cn"
    ["åä¸ºäº‘"]="repo.huaweicloud.com"
    ["è…¾è®¯äº‘"]="mirrors.cloud.tencent.com"
    ["ç½‘æ˜“"]="mirrors.163.com"
)

# æµ‹è¯•æ–‡ä»¶ï¼ˆä½¿ç”¨ä¸€ä¸ªå°æ–‡ä»¶è¿›è¡Œæµ‹é€Ÿï¼‰
TEST_FILE="dists/bookworm/InRelease"
# æˆ–è€…ä½¿ç”¨Dockerçš„å®é™…åŒ…æ–‡ä»¶æµ‹è¯•
# TEST_FILE="linux/debian/dists/bookworm/InRelease"

# å­˜å‚¨æµ‹é€Ÿç»“æœ
declare -A SPEED_RESULTS
declare -A TIME_RESULTS

# æµ‹é€Ÿå‡½æ•°
speed_test() {
    local mirror_name=$1
    local mirror_url=$2
    
    echo -e "${YELLOW}æµ‹è¯• ${mirror_name} (${mirror_url})...${NC}"
    
    # ä½¿ç”¨curlè¿›è¡Œæµ‹é€Ÿï¼Œä¸‹è½½ä¸€ä¸ªå°æ–‡ä»¶
    start_time=$(date +%s.%N)
    
    # æµ‹è¯•è¿æ¥æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦
    result=$(curl -L --connect-timeout 5 --max-time 10 -o /dev/null -s -w \
    "time_connect:%{time_connect}\ntime_starttransfer:%{time_starttransfer}\ntime_total:%{time_total}\nspeed_download:%{speed_download}" \
    "https://${mirror_url}/${TEST_FILE}" 2>/dev/null)
    
    end_time=$(date +%s.%N)
    
    # æå–é€Ÿåº¦ä¿¡æ¯ï¼ˆå­—èŠ‚/ç§’ï¼‰
    speed_download=$(echo "$result" | grep "speed_download" | cut -d':' -f2)
    time_total=$(echo "$result" | grep "time_total" | cut -d':' -f2)
    
    # è½¬æ¢ä¸ºKB/s
    if [[ $speed_download =~ ^[0-9]+([.][0-9]+)?$ ]]; then
        speed_kbs=$(echo "scale=2; $speed_download / 1024" | bc)
    else
        speed_kbs=0
    fi
    
    # è®¡ç®—å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    response_time=$(echo "scale=2; $time_total * 1000" | bc 2>/dev/null || echo "0")
    
    # å­˜å‚¨ç»“æœ
    SPEED_RESULTS["$mirror_name"]=$speed_kbs
    TIME_RESULTS["$mirror_name"]=$response_time
    
    if [ $(echo "$speed_kbs > 0" | bc) -eq 1 ]; then
        echo -e "${GREEN}  âœ“ é€Ÿåº¦: ${speed_kbs} KB/s, å“åº”æ—¶é—´: ${response_time}ms${NC}"
    else
        echo -e "${RED}  âœ— è¿æ¥å¤±è´¥æˆ–è¶…æ—¶${NC}"
        SPEED_RESULTS["$mirror_name"]=0
        TIME_RESULTS["$mirror_name"]=9999
    fi
    
    echo ""
}

# æ›´æ¢æºçš„å‡½æ•°
change_mirror() {
    local fastest_mirror=$1
    local fastest_url=$2
    
    echo -e "${GREEN}ğŸ¯ åˆ‡æ¢åˆ°æœ€å¿«çš„é•œåƒæº: ${fastest_mirror}${NC}"
    
    # å¤‡ä»½åŸé…ç½®
    if [ -f "/etc/apt/sources.list.d/docker.list" ]; then
        sudo cp /etc/apt/sources.list.d/docker.list /etc/apt/sources.list.d/docker.list.bak.$(date +%Y%m%d_%H%M%S)
    fi
    
    # åˆ›å»ºæ–°çš„Dockeræºé…ç½®
    sudo tee /etc/apt/sources.list.d/docker.list > /dev/null <<EOF
deb [arch=amd64] https://${fastest_url}/docker-ce/linux/debian bookworm stable
EOF
    
    echo -e "${GREEN}âœ… å·²æ›´æ–°Dockeré•œåƒæºä¸º: ${fastest_mirror}${NC}"
    echo -e "${BLUE}ğŸ”„ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨...${NC}"
    
    sudo apt update
}

# ä¸»å‡½æ•°
main() {
    echo -e "${BLUE}ğŸ“¡ å¼€å§‹æµ‹è¯•å„é•œåƒæºé€Ÿåº¦...${NC}"
    echo ""
    
    # æµ‹è¯•æ‰€æœ‰é•œåƒæº
    for mirror_name in "${!MIRRORS[@]}"; do
        speed_test "$mirror_name" "${MIRRORS[$mirror_name]}"
        sleep 1  # é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
    done
    
    # æ‰¾å‡ºæœ€å¿«çš„é•œåƒæº
    fastest_mirror=""
    fastest_speed=0
    fastest_time=9999
    
    echo -e "${BLUE}ğŸ“Š æµ‹é€Ÿç»“æœæ±‡æ€»:${NC}"
    echo "=================================="
    
    for mirror_name in "${!SPEED_RESULTS[@]}"; do
        speed=${SPEED_RESULTS[$mirror_name]}
        time=${TIME_RESULTS[$mirror_name]}
        
        if [ $(echo "$speed > 0" | bc) -eq 1 ]; then
            echo -e "  ${mirror_name}: ${speed} KB/s, ${time}ms"
            
            # é€‰æ‹©ç­–ç•¥ï¼šä¼˜å…ˆé€Ÿåº¦ï¼Œé€Ÿåº¦ç›¸è¿‘æ—¶é€‰æ‹©å“åº”æ—¶é—´çŸ­çš„
            if [ $(echo "$speed > $fastest_speed" | bc) -eq 1 ] || \
               [ $(echo "$speed == $fastest_speed && $time < $fastest_time" | bc) -eq 1 ]; then
                fastest_speed=$speed
                fastest_time=$time
                fastest_mirror=$mirror_name
            fi
        fi
    done
    
    echo ""
    
    if [ -n "$fastest_mirror" ] && [ $(echo "$fastest_speed > 0" | bc) -eq 1 ]; then
        echo -e "${GREEN}ğŸš€ æœ€å¿«çš„é•œåƒæº: ${fastest_mirror}${NC}"
        echo -e "${GREEN}ğŸ“ˆ é€Ÿåº¦: ${fastest_speed} KB/s, å“åº”æ—¶é—´: ${fastest_time}ms${NC}"
        echo ""
        
        read -p "æ˜¯å¦ç«‹å³æ›´æ¢ä¸ºæ­¤é•œåƒæºï¼Ÿ(y/N): " confirm
        if [[ $confirm =~ ^[Yy]$ ]]; then
            change_mirror "$fastest_mirror" "${MIRRORS[$fastest_mirror]}"
        else
            echo -e "${YELLOW}æœªæ›´æ¢é•œåƒæºã€‚${NC}"
        fi
    else
        echo -e "${RED}âŒ æ‰€æœ‰é•œåƒæºæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚${NC}"
    fi
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    if ! command -v curl &> /dev/null; then
        echo -e "${RED}âŒ éœ€è¦å®‰è£… curl${NC}"
        sudo apt update && sudo apt install -y curl
    fi
    
    if ! command -v bc &> /dev/null; then
        echo -e "${RED}âŒ éœ€è¦å®‰è£… bc${NC}"
        sudo apt update && sudo apt install -y bc
    fi
}

# è¿è¡Œè„šæœ¬
check_dependencies
main
