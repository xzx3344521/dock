#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ğŸ³ Dockeré•œåƒæºçœŸå®é€Ÿåº¦æµ‹è¯•è„šæœ¬${NC}"
echo "======================================"

# å®šä¹‰é•œåƒæº
declare -A MIRRORS=(
    ["é˜¿é‡Œäº‘"]="mirrors.aliyun.com"
    ["ä¸­ç§‘å¤§"]="mirrors.ustc.edu.cn" 
    ["æ¸…å"]="mirrors.tuna.tsinghua.edu.cn"
    ["åä¸ºäº‘"]="repo.huaweicloud.com"
    ["è…¾è®¯äº‘"]="mirrors.cloud.tencent.com"
)

# ä½¿ç”¨Dockerçš„å®é™…å®‰è£…åŒ…è¿›è¡Œæµ‹é€Ÿï¼ˆæ›´å¤§æ›´çœŸå®ï¼‰
TEST_PATHS=(
    "docker-ce/pool/stable/amd64/containerd.io_1.7.28-1_amd64.deb"
    "docker-ce/pool/stable/amd64/docker-ce_25.0.5-1~debian.12~bookworm_amd64.deb"
)

# å­˜å‚¨ç»“æœ
declare -A AVG_SPEEDS

# çœŸå®ä¸‹è½½æµ‹é€Ÿå‡½æ•°
real_speed_test() {
    local mirror_name=$1
    local mirror_url=$2
    
    echo -e "${YELLOW}æµ‹è¯• ${mirror_name} (${mirror_url})...${NC}"
    
    local total_speed=0
    local test_count=0
    local max_speed=0
    
    # æµ‹è¯•å¤šä¸ªæ–‡ä»¶å–å¹³å‡å€¼
    for test_path in "${TEST_PATHS[@]}"; do
        local test_url="https://${mirror_url}/${test_path}"
        
        echo -n "  ä¸‹è½½æµ‹é€Ÿä¸­..."
        
        # ä½¿ç”¨wgetè¿›è¡ŒçœŸå®ä¸‹è½½æµ‹é€Ÿï¼ˆä¸‹è½½10ç§’ï¼‰
        local speed_info=$(timeout 10 wget --progress=dot:binary --output-document=/dev/null "$test_url" 2>&1 | grep -o '[0-9.]\+ [KMG]B/s' | tail -1)
        
        if [[ $speed_info ]]; then
            # æå–é€Ÿåº¦æ•°å€¼
            local speed_value=$(echo "$speed_info" | awk '{print $1}')
            local speed_unit=$(echo "$speed_info" | awk '{print $2}')
            
            # ç»Ÿä¸€è½¬æ¢ä¸ºKB/s
            case $speed_unit in
                "MB/s")
                    speed_kbs=$(echo "$speed_value * 1024" | bc -l 2>/dev/null | awk '{printf "%.2f", $1}')
                    ;;
                "GB/s")
                    speed_kbs=$(echo "$speed_value * 1024 * 1024" | bc -l 2>/dev/null | awk '{printf "%.2f", $1}')
                    ;;
                "KB/s")
                    speed_kbs=$speed_value
                    ;;
                *)
                    speed_kbs=0
                    ;;
            esac
            
            if [[ $speed_kbs != "0" ]]; then
                echo -e " ${GREEN}$speed_info â‰ˆ $(echo "$speed_kbs" | awk '{printf "%.0f", $1}') KB/s${NC}"
                total_speed=$(echo "$total_speed + $speed_kbs" | bc -l)
                test_count=$((test_count + 1))
                
                # è®°å½•æœ€å¤§é€Ÿåº¦
                if (( $(echo "$speed_kbs > $max_speed" | bc -l) )); then
                    max_speed=$speed_kbs
                fi
            else
                echo -e " ${RED}æµ‹é€Ÿå¤±è´¥${NC}"
            fi
        else
            echo -e " ${RED}æ— æ³•è¿æ¥${NC}"
        fi
        
        sleep 1
    done
    
    # è®¡ç®—å¹³å‡é€Ÿåº¦
    if [[ $test_count -gt 0 ]]; then
        local avg_speed=$(echo "scale=2; $total_speed / $test_count" | bc -l)
        AVG_SPEEDS["$mirror_name"]=$avg_speed
        echo -e "  ${GREEN}âœ… å¹³å‡é€Ÿåº¦: $(echo "$avg_speed" | awk '{printf "%.0f", $1}') KB/s (å³°å€¼: $(echo "$max_speed" | awk '{printf "%.0f", $1}') KB/s)${NC}"
    else
        AVG_SPEEDS["$mirror_name"]=0
        echo -e "  ${RED}âŒ æ‰€æœ‰æµ‹é€Ÿå¤±è´¥${NC}"
    fi
    
    echo ""
}

# å¤‡ç”¨æµ‹é€Ÿæ–¹æ³•ï¼šä½¿ç”¨speedtest-cli
network_benchmark() {
    echo -e "${BLUE}ğŸŒ è¿›è¡Œç½‘ç»œåŸºå‡†æµ‹è¯•...${NC}"
    
    if command -v speedtest-cli &> /dev/null; then
        speedtest-cli --simple
    else
        echo "å®‰è£…speedtest-cli: sudo apt install speedtest-cli"
    fi
    echo ""
}

# æ›´æ¢é•œåƒæº
change_mirror() {
    local fastest_mirror=$1
    local fastest_url=$2
    
    echo -e "${GREEN}ğŸ¯ åˆ‡æ¢åˆ°æœ€å¿«çš„é•œåƒæº: ${fastest_mirror}${NC}"
    
    # å¤‡ä»½åŸé…ç½®
    sudo cp /etc/apt/sources.list.d/docker.list /etc/apt/sources.list.d/docker.list.bak.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
    
    # åˆ›å»ºæ–°çš„Dockeræºé…ç½®
    sudo tee /etc/apt/sources.list.d/docker.list > /dev/null <<EOF
deb [arch=amd64] https://${fastest_url}/docker-ce/linux/debian bookworm stable
EOF
    
    echo -e "${GREEN}âœ… å·²æ›´æ–°Dockeré•œåƒæº${NC}"
    sudo apt update
}

main() {
    # å…ˆè¿›è¡Œç½‘ç»œåŸºå‡†æµ‹è¯•
    network_benchmark
    
    echo -e "${BLUE}ğŸ“¡ å¼€å§‹çœŸå®ä¸‹è½½é€Ÿåº¦æµ‹è¯•...${NC}"
    echo -e "${YELLOW}æ³¨æ„ï¼šè¿™å°†å®é™…ä¸‹è½½éƒ¨åˆ†æ–‡ä»¶ï¼Œéœ€è¦è¾ƒé•¿æ—¶é—´${NC}"
    echo ""
    
    # æ£€æŸ¥ä¾èµ–
    if ! command -v wget &> /dev/null; then
        echo "å®‰è£…wget: sudo apt install wget"
        sudo apt update && sudo apt install -y wget bc
    fi
    
    # æµ‹è¯•æ‰€æœ‰é•œåƒæº
    for mirror_name in "${!MIRRORS[@]}"; do
        real_speed_test "$mirror_name" "${MIRRORS[$mirror_name]}"
    done
    
    # æ‰¾å‡ºæœ€å¿«çš„
    fastest_mirror=""
    fastest_speed=0
    
    echo -e "${BLUE}ğŸ“Š æœ€ç»ˆæµ‹é€Ÿç»“æœ:${NC}"
    echo "======================================"
    
    for mirror_name in "${!AVG_SPEEDS[@]}"; do
        speed=${AVG_SPEEDS[$mirror_name]}
        echo -e "  ${mirror_name}: $(echo "$speed" | awk '{printf "%.0f", $1}') KB/s"
        
        if (( $(echo "$speed > $fastest_speed" | bc -l) )); then
            fastest_speed=$speed
            fastest_mirror=$mirror_name
        fi
    done
    
    echo ""
    
    if [[ -n "$fastest_mirror" && $(echo "$fastest_speed > 10" | bc -l) -eq 1 ]]; then
        echo -e "${GREEN}ğŸš€ æ¨èé•œåƒæº: ${fastest_mirror}${NC}"
        echo -e "${GREEN}ğŸ“ˆ å¹³å‡é€Ÿåº¦: $(echo "$fastest_speed" | awk '{printf "%.0f", $1}') KB/s${NC}"
        
        read -p "æ˜¯å¦æ›´æ¢é•œåƒæºï¼Ÿ(y/N): " confirm
        if [[ $confirm =~ ^[Yy]$ ]]; then
            change_mirror "$fastest_mirror" "${MIRRORS[$fastest_mirror]}"
        fi
    else
        echo -e "${RED}âŒ ç½‘ç»œçŠ¶å†µä¸ä½³ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥${NC}"
    fi
}

main
