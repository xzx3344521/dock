#!/bin/bash
# å’¸vå’†å“®åˆ¶ä½œ
# x-ui å¤šæ¶æ„è‡ªåŠ¨å®‰è£…è„šæœ¬
# æ”¯æŒ: amd64, 386, arm64, armv5, armv6, armv7, s390x
# é»˜è®¤é…ç½®: ç«¯å£ 8443, è´¦å· 3344, å¯†ç  3344

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# è‡ªå®šä¹‰é…ç½®
PANEL_PORT="8443"
PANEL_USERNAME="3344"
PANEL_PASSWORD="3344"

# æ¶æ„æ˜ å°„è¡¨
declare -A ARCH_MAP=(
    ["x86_64"]="amd64"
    ["i386"]="386"
    ["i486"]="386"
    ["i586"]="386"
    ["i686"]="386"
    ["aarch64"]="arm64"
    ["armv5l"]="armv5"
    ["armv6l"]="armv6"
    ["armv7l"]="armv7"
    ["s390x"]="s390x"
)

# ä¸‹è½½URLåŸºç¡€
BASE_URL="https://github.vps7k7k.xyz/https://github.com/MHSanaei/3x-ui/releases/download/v2.8.5"

# æ‰“å°å½©è‰²ä¿¡æ¯
info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
step() { echo -e "${BLUE}[STEP]${NC} $1"; }
debug() { echo -e "${PURPLE}[DEBUG]${NC} $1"; }

# æ£€æµ‹ç³»ç»Ÿæ¶æ„
detect_architecture() {
    local arch=$(uname -m)
    step "æ£€æµ‹ç³»ç»Ÿæ¶æ„: $arch"
    
    # æ˜ å°„åˆ°å¯¹åº”çš„ä¸‹è½½æ¶æ„
    if [[ -n "${ARCH_MAP[$arch]}" ]]; then
        DETECTED_ARCH="${ARCH_MAP[$arch]}"
        info "æ£€æµ‹åˆ°æ¶æ„: $arch â†’ $DETECTED_ARCH"
    else
        error "ä¸æ”¯æŒçš„æ¶æ„: $arch"
        echo
        info "æ”¯æŒçš„æ¶æ„:"
        for key in "${!ARCH_MAP[@]}"; do
            echo "  $key -> ${ARCH_MAP[$key]}"
        done
        exit 1
    fi
}

# æ„å»ºä¸‹è½½URL
build_download_url() {
    local filename="x-ui-linux-${DETECTED_ARCH}.tar.gz"
    DOWNLOAD_URL="${BASE_URL}/${filename}"
    DOWNLOAD_FILENAME="$filename"
    
    info "ä¸‹è½½æ–‡ä»¶: $DOWNLOAD_FILENAME"
    debug "ä¸‹è½½URL: $DOWNLOAD_URL"
}

# æ£€æŸ¥ root æƒé™
check_root() {
    if [ "$EUID" -ne 0 ]; then
        error "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
        info "å°è¯•ä½¿ç”¨: sudo bash $0"
        exit 1
    fi
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    info "æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„ä¾èµ–..."
    
    if command -v apt-get >/dev/null 2>&1; then
        # Debian/Ubuntu
        apt-get update
        apt-get install -y wget tar curl sqlite3
    elif command -v yum >/dev/null 2>&1; then
        # CentOS/RHEL
        yum install -y wget tar curl sqlite
    elif command -v dnf >/dev/null 2>&1; then
        # Fedora
        dnf install -y wget tar curl sqlite
    elif command -v apk >/dev/null 2>&1; then
        # Alpine
        apk add wget tar curl sqlite
    else
        warn "æ— æ³•ç¡®å®šåŒ…ç®¡ç†å™¨ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
    fi
}

# ä¸‹è½½ x-ui
download_xui() {
    info "å¼€å§‹ä¸‹è½½ x-ui..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–‡ä»¶
    if [ -f "$DOWNLOAD_FILENAME" ]; then
        warn "å‘ç°å·²å­˜åœ¨çš„æ–‡ä»¶ $DOWNLOAD_FILENAME"
        read -p "æ˜¯å¦é‡æ–°ä¸‹è½½? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -f "$DOWNLOAD_FILENAME"
        else
            info "ä½¿ç”¨å·²å­˜åœ¨çš„æ–‡ä»¶"
            return 0
        fi
    fi
    
    # ä¸‹è½½æ–‡ä»¶
    info "æ­£åœ¨ä¸‹è½½ï¼Œè¯·ç¨å€™..."
    if wget --progress=bar:force "$DOWNLOAD_URL" -O "$DOWNLOAD_FILENAME"; then
        info "ä¸‹è½½å®Œæˆ"
    else
        error "ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒURL"
        error "URL: $DOWNLOAD_URL"
        exit 1
    fi
}

# è§£å‹å¹¶æ‰‹åŠ¨å®‰è£…
extract_and_install() {
    info "è§£å‹æ–‡ä»¶..."
    
    if [ ! -f "$DOWNLOAD_FILENAME" ]; then
        error "æ–‡ä»¶ $DOWNLOAD_FILENAME ä¸å­˜åœ¨"
        exit 1
    fi
    
    # æ¸…ç†æ—§æ–‡ä»¶
    rm -rf x-ui-temp
    mkdir -p x-ui-temp
    
    # è§£å‹æ–‡ä»¶
    if ! tar zxvf "$DOWNLOAD_FILENAME" -C x-ui-temp; then
        error "è§£å‹å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸå"
        exit 1
    fi
    
    # è¿›å…¥è§£å‹ç›®å½•
    cd x-ui-temp
    
    # æŸ¥æ‰¾ x-ui ç›®å½•
    if [ -d "x-ui" ]; then
        cd x-ui
    fi
    
    info "å¼€å§‹æ‰‹åŠ¨å®‰è£… x-ui..."
    
    # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶
    if [ ! -f "x-ui" ]; then
        error "æœªæ‰¾åˆ° x-ui å¯æ‰§è¡Œæ–‡ä»¶"
        ls -la
        exit 1
    fi
    
    # è®¾ç½®æ‰§è¡Œæƒé™
    chmod +x x-ui
    if [ -f "x-ui.sh" ]; then
        chmod +x x-ui.sh
    fi
    
    # æ‰‹åŠ¨å®‰è£…
    info "æ‰§è¡Œæ‰‹åŠ¨å®‰è£…..."
    
    # åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§æœåŠ¡
    systemctl stop x-ui 2>/dev/null || true
    
    # å¤åˆ¶æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•
    mkdir -p /usr/local/x-ui/
    cp -f x-ui /usr/local/x-ui/
    if [ -f "x-ui.sh" ]; then
        cp -f x-ui.sh /usr/local/x-ui/
    fi
    if [ -f "x-ui.service" ]; then
        cp -f x-ui.service /etc/systemd/system/
    fi
    
    # å¤åˆ¶ bin ç›®å½•
    if [ -d "bin" ]; then
        cp -rf bin /usr/local/x-ui/
    fi
    
    # è®¾ç½®æƒé™
    chmod +x /usr/local/x-ui/x-ui
    if [ -f "/usr/local/x-ui/x-ui.sh" ]; then
        chmod +x /usr/local/x-ui/x-ui.sh
    fi
    chmod +x /usr/local/x-ui/bin/xray-linux-* 2>/dev/null || true
    
    # åˆ›å»ºç¬¦å·é“¾æ¥
    if [ -f "/usr/local/x-ui/x-ui.sh" ]; then
        ln -sf /usr/local/x-ui/x-ui.sh /usr/bin/x-ui
    else
        ln -sf /usr/local/x-ui/x-ui /usr/bin/x-ui
    fi
    
    # è¿”å›åŸç›®å½•
    cd - > /dev/null
}

# é…ç½®ç³»ç»ŸæœåŠ¡
setup_service() {
    info "é…ç½®ç³»ç»ŸæœåŠ¡..."
    
    # å¦‚æœæœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
    if [ ! -f "/etc/systemd/system/x-ui.service" ]; then
        cat > /etc/systemd/system/x-ui.service << 'EOF'
[Unit]
Description=x-ui Service
Documentation=https://github.com/MHSanaei/3x-ui
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/usr/local/x-ui/
ExecStart=/usr/local/x-ui/x-ui
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF
        info "åˆ›å»ºäº† systemd æœåŠ¡æ–‡ä»¶"
    fi
    
    systemctl daemon-reload
    systemctl enable x-ui
}

# è‡ªå®šä¹‰é…ç½®é¢æ¿
customize_panel() {
    step "å¼€å§‹è‡ªå®šä¹‰é…ç½®é¢æ¿..."
    
    # åœæ­¢æœåŠ¡ä»¥è¿›è¡Œé…ç½®
    info "åœæ­¢ x-ui æœåŠ¡è¿›è¡Œé…ç½®..."
    systemctl stop x-ui 2>/dev/null || true
    
    # ç­‰å¾…æœåŠ¡åœæ­¢
    sleep 3
    
    # åˆ›å»ºæ•°æ®åº“ç›®å½•
    mkdir -p /etc/x-ui/
    
    # åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [ ! -f "/etc/x-ui/x-ui.db" ]; then
        info "åˆå§‹åŒ–æ•°æ®åº“..."
        
        # å¯åŠ¨æœåŠ¡ä»¥åˆ›å»ºåˆå§‹æ•°æ®åº“
        if systemctl start x-ui; then
            sleep 5
            systemctl stop x-ui
            sleep 3
        else
            warn "æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œå°è¯•ç›´æ¥åˆ›å»ºæ•°æ®åº“ç»“æ„"
            # è¿™é‡Œå¯ä»¥æ·»åŠ ç›´æ¥åˆ›å»ºæ•°æ®åº“çš„é€»è¾‘
        fi
        
        if [ ! -f "/etc/x-ui/x-ui.db" ]; then
            warn "æ— æ³•è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“æ–‡ä»¶ï¼Œå°†åœ¨é¦–æ¬¡å¯åŠ¨æ—¶åˆ›å»º"
            return 0
        fi
    fi
    
    # ä¿®æ”¹é…ç½®ï¼ˆå¦‚æœæ•°æ®åº“å­˜åœ¨ä¸”å¯å†™ï¼‰
    if [ -f "/etc/x-ui/x-ui.db" ] && command -v sqlite3 >/dev/null 2>&1; then
        info "è®¾ç½®é¢æ¿ç«¯å£ä¸º: $PANEL_PORT"
        sqlite3 /etc/x-ui/x-ui.db "UPDATE setting SET value = '$PANEL_PORT' WHERE key = 'port';" 2>/dev/null || true
        
        info "è®¾ç½®é¢æ¿è´¦å·: $PANEL_USERNAME, å¯†ç : $PANEL_PASSWORD"
        sqlite3 /etc/x-ui/x-ui.db "UPDATE users SET username = '$PANEL_USERNAME', password = '$PANEL_PASSWORD' WHERE id = 1;" 2>/dev/null || true
        
        sqlite3 /etc/x-ui/x-ui.db "UPDATE setting SET value = 'false' WHERE key = 'hasDefaultCredential';" 2>/dev/null || true
        info "è‡ªå®šä¹‰é…ç½®å®Œæˆ"
    else
        warn "æ— æ³•è‡ªåŠ¨é…ç½®æ•°æ®åº“ï¼Œè¯·åœ¨å®‰è£…åæ‰‹åŠ¨ä¿®æ”¹é…ç½®"
    fi
}

# é…ç½®é˜²ç«å¢™
setup_firewall() {
    info "é…ç½®é˜²ç«å¢™..."
    
    # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
    if command -v ufw >/dev/null 2>&1 && ufw status | grep -q "active"; then
        # ufw
        ufw allow ${PANEL_PORT}/tcp comment "x-ui Panel"
        ufw allow 10000-20000/tcp comment "x-ui Proxy Ports"
        info "UFW é˜²ç«å¢™å·²é…ç½®"
    elif command -v firewall-cmd >/dev/null 2>&1 && firewall-cmd --state >/dev/null 2>&1; then
        # firewalld
        firewall-cmd --permanent --add-port=${PANEL_PORT}/tcp
        firewall-cmd --permanent --add-port=10000-20000/tcp
        firewall-cmd --reload
        info "Firewalld é˜²ç«å¢™å·²é…ç½®"
    elif command -v iptables >/dev/null 2>&1; then
        # iptables
        iptables -I INPUT -p tcp --dport ${PANEL_PORT} -j ACCEPT
        iptables -I INPUT -p tcp --dport 10000:20000 -j ACCEPT
        info "iptables è§„åˆ™å·²æ·»åŠ "
        
        # å°è¯•ä¿å­˜ iptables è§„åˆ™
        if command -v iptables-save >/dev/null 2>&1; then
            iptables-save > /etc/iptables.rules 2>/dev/null || true
        fi
    else
        warn "æœªæ£€æµ‹åˆ°é˜²ç«å¢™ï¼Œè·³è¿‡é…ç½®"
    fi
}

# å¯åŠ¨æœåŠ¡
start_service() {
    info "å¯åŠ¨ x-ui æœåŠ¡..."
    
    systemctl daemon-reload
    systemctl enable x-ui
    
    # å¯åŠ¨æœåŠ¡
    if systemctl start x-ui; then
        info "x-ui æœåŠ¡å¯åŠ¨å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
    else
        error "x-ui æœåŠ¡å¯åŠ¨å¤±è´¥"
        return 1
    fi
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 5
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet x-ui; then
        info "âœ“ x-ui æœåŠ¡è¿è¡Œæ­£å¸¸"
        
        # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
        echo
        systemctl status x-ui --no-pager -l
    else
        warn "âš  x-ui æœåŠ¡æœªè¿è¡Œï¼Œæ£€æŸ¥æ—¥å¿—ä¸­..."
        systemctl status x-ui --no-pager -l
        warn "å°è¯•æ‰‹åŠ¨å¯åŠ¨: systemctl start x-ui"
    fi
}

# éªŒè¯å®‰è£…
verify_installation() {
    step "éªŒè¯å®‰è£…..."
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet x-ui; then
        info "âœ“ æœåŠ¡è¿è¡Œæ­£å¸¸"
    else
        warn "âš  æœåŠ¡æœªè¿è¡Œï¼Œä½†å®‰è£…å·²å®Œæˆ"
        return 0
    fi
    
    # æ£€æŸ¥ç«¯å£ç›‘å¬
    if command -v netstat >/dev/null 2>&1; then
        if netstat -tunlp 2>/dev/null | grep -q ":${PANEL_PORT} "; then
            info "âœ“ ç«¯å£ ${PANEL_PORT} ç›‘å¬æ­£å¸¸"
        else
            warn "âš  ç«¯å£ ${PANEL_PORT} æœªç›‘å¬"
        fi
    elif command -v ss >/dev/null 2>&1; then
        if ss -tunlp 2>/dev/null | grep -q ":${PANEL_PORT} "; then
            info "âœ“ ç«¯å£ ${PANEL_PORT} ç›‘å¬æ­£å¸¸"
        else
            warn "âš  ç«¯å£ ${PANEL_PORT} æœªç›‘å¬"
        fi
    fi
    
    info "éªŒè¯å®Œæˆ"
}

# æ˜¾ç¤ºå®‰è£…ä¿¡æ¯
show_info() {
    # è·å–æœåŠ¡å™¨IP
    local server_ip=$(curl -s --connect-timeout 5 ipv4.icanhazip.com || hostname -I | awk '{print $1}' || echo "ä½ çš„æœåŠ¡å™¨IP")
    
    echo
    info "=================================================="
    info "ğŸ‰ x-ui å¤šæ¶æ„å®‰è£…å®Œæˆï¼"
    info "=================================================="
    info "ç³»ç»Ÿæ¶æ„: $(uname -m) â†’ $DETECTED_ARCH"
    info "ç®¡ç†é¢æ¿: http://${server_ip}:${PANEL_PORT}"
    info "ç”¨æˆ·å: $PANEL_USERNAME"
    info "å¯†ç : $PANEL_PASSWORD"
    info ""
    info "é¢æ¿çŠ¶æ€: å·²è‡ªåŠ¨é…ç½®ä¸ºæŒ‡å®šç«¯å£å’Œè´¦å·"
    info ""
    warn "âš ï¸  é‡è¦å®‰å…¨æé†’:"
    warn "1. è¯·ç«‹å³è®¿é—®é¢æ¿éªŒè¯ç™»å½•"
    warn "2. å»ºè®®å®šæœŸä¿®æ”¹å¯†ç "
    warn "3. ç¡®ä¿é˜²ç«å¢™å·²æ­£ç¡®é…ç½®"
    info ""
    info "å¸¸ç”¨å‘½ä»¤:"
    info "å¯åŠ¨æœåŠ¡: systemctl start x-ui"
    info "åœæ­¢æœåŠ¡: systemctl stop x-ui"
    info "é‡å¯æœåŠ¡: systemctl restart x-ui"
    info "æŸ¥çœ‹çŠ¶æ€: systemctl status x-ui"
    info "æŸ¥çœ‹æ—¥å¿—: journalctl -u x-ui -f"
    info "ç®¡ç†èœå•: x-ui"
    info "=================================================="
    echo
    
    # æ˜¾ç¤ºè®¿é—®URL
    step "ç«‹å³è®¿é—®: http://${server_ip}:${PANEL_PORT}"
    step "ä½¿ç”¨è´¦å·: $PANEL_USERNAME å¯†ç : $PANEL_PASSWORD"
    echo
}

# æ˜¾ç¤ºæ¶æ„ä¿¡æ¯
show_arch_info() {
    echo
    info "ğŸ–¥ï¸  æ”¯æŒçš„æ¶æ„åˆ—è¡¨:"
    echo "  x86_64  - 64ä½ Intel/AMD å¤„ç†å™¨ â†’ amd64"
    echo "  i386    - 32ä½ Intel/AMD å¤„ç†å™¨ â†’ 386" 
    echo "  aarch64 - 64ä½ ARM å¤„ç†å™¨ â†’ arm64"
    echo "  armv7l  - 32ä½ ARM v7 â†’ armv7"
    echo "  armv6l  - 32ä½ ARM v6 â†’ armv6"
    echo "  armv5l  - 32ä½ ARM v5 â†’ armv5"
    echo "  s390x   - IBM å¤§å‹æœº â†’ s390x"
    echo
}

# ä¸»å‡½æ•°
main() {
    info "å¼€å§‹ x-ui å¤šæ¶æ„è‡ªåŠ¨å®‰è£…..."
    show_arch_info
    
    # æ‰§è¡Œå®‰è£…æ­¥éª¤
    check_root
    detect_architecture
    build_download_url
    install_dependencies
    download_xui
    extract_and_install
    setup_service
    customize_panel
    setup_firewall
    start_service
    verify_installation
    show_info
    
    info "å®‰è£…è„šæœ¬æ‰§è¡Œå®Œæ¯•"
}

# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
echo
warn "ğŸš€ x-ui å¤šæ¶æ„è‡ªåŠ¨å®‰è£…è„šæœ¬"
info "é»˜è®¤é…ç½®: ç«¯å£ ${PANEL_PORT} | è´¦å· ${PANEL_USERNAME}/${PANEL_PASSWORD}"
echo

read -p "æ˜¯å¦ç»§ç»­å®‰è£…? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    info "å®‰è£…å·²å–æ¶ˆ"
    exit 0
fi

# æ‰§è¡Œä¸»å‡½æ•°
main
