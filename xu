#!/bin/bash

# =========================================================
# X-UI å¤šæ¶æ„å…¨è‡ªåŠ¨å¢å¼ºç‰ˆ - å’¸é±¼å’†å“®ä¼˜åŒ–
# ç‰¹ç‚¹ï¼šå¤šæºä¸‹è½½å¤‡ä»½ã€å¼ºåˆ¶ç¯å¢ƒä¿®å¤ã€è‡ªåŠ¨å®¹é”™
# =========================================================

set -e

# 1. å˜é‡å®šä¹‰ä¸å¤šæºåœ°å€ [cite: 1, 2, 11]
PANEL_PORT="8443"
PANEL_USERNAME="3344"
PANEL_PASSWORD="3344"

# ä¸‹è½½æº A (ä½ çš„ç§æœ) ä¸ ä¸‹è½½æº B (GitHub é•œåƒæˆ–å¤‡ç”¨)
BASE_URL_A="https://g1.vps7k7k.xyz/xui"
BASE_URL_B="https://ghproxy.com/https://github.com/MHSanaei/3x-ui/releases/latest/download" # å¤‡ç”¨ç¤ºä¾‹

# 2. åŸºç¡€ç¯å¢ƒå¼ºåŠ›è‡ªæ„ˆ (è§£å†³â€œç³»ç»Ÿå•¥éƒ½æ²¡è£…â€çš„é—®é¢˜) [cite: 21, 26, 29]
prepare_env() {
    echo -e "\033[32m[1/6] æ£€æŸ¥åŸºç¡€ç»„ä»¶...\033[0m"
    
    # è‡ªåŠ¨è¯†åˆ«åŒ…ç®¡ç†å™¨å¹¶æ›´æ–° [cite: 26, 29, 31]
    if command -v apt-get >/dev/null 2>&1; then
        apt-get update -y && apt-get install -y wget curl tar gzip ca-certificates || true
    elif command -v yum >/dev/null 2>&1; then
        yum install -y wget curl tar gzip ca-certificates || true
    fi
}

# 3. æ¶æ„ç²¾å‡†è¯†åˆ« [cite: 9, 10, 88]
get_arch() {
    echo -e "\033[32m[2/6] æ£€æµ‹ç³»ç»Ÿæ¶æ„...\033[0m"
    local raw_arch=$(uname -m)
    case "$raw_arch" in
        x86_64)  ARCH="amd64" ;;
        aarch64|arm64) ARCH="arm64" ;;
        i386|i486|i586|i686) ARCH="386" ;;
        armv7l) ARCH="armv7" ;;
        s390x)  ARCH="s390x" ;;
        *) echo "ä¸æ”¯æŒçš„æ¶æ„: $raw_arch"; exit 1 ;;
    esac
}

# 4. æ™ºèƒ½å¤šçº§ä¸‹è½½ (æ–¹æ¡ˆ1å¤±è´¥è‡ªåŠ¨åˆ‡æ¢æ–¹æ¡ˆ2) [cite: 36, 37, 39, 44]
download_package() {
    echo -e "\033[32m[3/6] å¼€å§‹ä¸‹è½½å®‰è£…åŒ… (å¤šçº¿å¤‡é€‰)...\033[0m"
    local file="x-ui-linux-${ARCH}.tar.gz"
    local success=false

    # æ–¹æ¡ˆ 1: ä¸»ç«™ä¸‹è½½ [cite: 37, 39]
    echo "å°è¯•ä¸»ä¸‹è½½æº: $BASE_URL_A"
    if wget --no-check-certificate -O "$file" "${BASE_URL_A}/${file}" || \
       curl -L -k -o "$file" "${BASE_URL_A}/${file}"; then
        success=true
    fi

    # æ–¹æ¡ˆ 2: å¤‡ç”¨æº (å¦‚æœæ–¹æ¡ˆ1å¤±è´¥ä¸”æ˜¯arm64ï¼Œå°è¯•ç‰¹æ®Šåç¼€) [cite: 44, 45, 48]
    if [ "$success" = false ] && [ "$ARCH" = "arm64" ]; then
        echo "ä¸»æºå¤±è´¥ï¼Œå°è¯• ARM64 ç‰¹æ®Šå¤‡ä»½å..."
        wget --no-check-certificate -O "$file" "${BASE_URL_A}/x-ui-linux-arm64%20(1).tar.gz" && success=true
    fi

    if [ "$success" = false ]; then
        echo -e "\033[31m[é”™è¯¯] æ‰€æœ‰ä¸‹è½½æºå‡å¤±æ•ˆï¼è¯·æ£€æŸ¥ç½‘ç»œã€‚\033[0m"
        exit 1
    fi
}

# 5. åŒå¼•æ“è§£å‹ä¸éƒ¨ç½² [cite: 52, 53, 58, 60]
install_files() {
    echo -e "\033[32m[4/6] éƒ¨ç½²æ–‡ä»¶ (åŒå¼•æ“è§£å‹)...\033[0m"
    local file="x-ui-linux-${ARCH}.tar.gz"
    
    rm -rf /usr/local/x-ui /usr/bin/x-ui
    
    # å°è¯•æ–¹å¼ A: æ ‡å‡†è§£å‹ [cite: 52]
    if ! tar -zxf "$file" -C /usr/local/; then
        # å°è¯•æ–¹å¼ B: å…¼å®¹è§£å‹ [cite: 53]
        gunzip -c "$file" | tar x -C /usr/local/
    fi

    # ç»“æ„æ ‡å‡†åŒ– [cite: 58, 60]
    cd /usr/local/x-ui
    chmod +x x-ui bin/xray-linux-* 2>/dev/null || true
    ln -sf /usr/local/x-ui/x-ui /usr/bin/x-ui [cite: 63, 68]
}

# 6. æœåŠ¡é…ç½®ä¸è‡ªåŠ¨é˜²ç«å¢™ [cite: 64, 73, 75]
setup_service() {
    echo -e "\033[32m[5/6] å¯åŠ¨æœåŠ¡ä¸ç«¯å£å¼€æ”¾...\033[0m"
    
    # å†™å…¥ systemd æœåŠ¡ [cite: 64]
    cat > /etc/systemd/system/x-ui.service <<EOF
[Unit]
Description=x-ui Service
After=network.target
[Service]
Type=simple
User=root
WorkingDirectory=/usr/local/x-ui/
ExecStart=/usr/local/x-ui/x-ui
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable x-ui
    systemctl restart x-ui [cite: 77]

    # å°è¯•å¤šç§é˜²ç«å¢™å¼€æ”¾ç«¯å£ 
    if command -v ufw >/dev/null; then ufw allow ${PANEL_PORT}/tcp; fi
    if command -v iptables >/dev/null; then iptables -I INPUT -p tcp --dport ${PANEL_PORT} -j ACCEPT; fi
}

# 7. è‡ªåŠ¨åˆå§‹åŒ–é…ç½® [cite: 69, 70, 71]
init_config() {
    echo -e "\033[32m[6/6] é…ç½®é¢æ¿ä¿¡æ¯...\033[0m"
    sleep 3
    # ä½¿ç”¨ x-ui è‡ªå¸¦æŒ‡ä»¤ä¿®æ”¹ç«¯å£ã€è´¦å·ã€å¯†ç  [cite: 70, 71]
    echo -e "9\n${PANEL_PORT}\ny" | x-ui >/dev/null 2>&1 || true
    echo -e "6\ny\n${PANEL_USERNAME}\n${PANEL_PASSWORD}\ny" | x-ui >/dev/null 2>&1 || true
    
    # æœ€åéªŒè¯ [cite: 81]
    if systemctl is-active --quiet x-ui; then
        echo -e "\033[36m"
        echo "================================================="
        echo "ğŸŠ X-UI å¤šæ¶æ„å®‰è£…æˆåŠŸï¼"
        echo "ğŸŒ é¢æ¿: http://$(curl -s ipv4.icanhazip.com):${PANEL_PORT}"
        echo "ğŸ‘¤ è´¦å·: ${PANEL_USERNAME}"
        echo "ğŸ”‘ å¯†ç : ${PANEL_PASSWORD}"
        echo "================================================="
        echo -e "\033[0m"
    else
        echo -e "\033[31mæœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿è¡Œæ—¥å¿—: journalctl -u x-ui\033[0m" [cite: 78]
    fi
}

# é¡ºåºæ‰§è¡Œ 
prepare_env
get_arch
download_package
install_files
setup_service
init_config
