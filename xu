#!/bin/bash

# x-ui è‡ªåŠ¨å®‰è£…è„šæœ¬ï¼ˆä¿®å¤ç‰ˆï¼‰
# ç‰ˆæœ¬: 2.8.5
# æ¶æ„: amd64 (x86_64)

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ‰“å°å½©è‰²ä¿¡æ¯
info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ£€æŸ¥ç³»ç»Ÿæ¶æ„
check_architecture() {
    local arch=$(uname -m)
    info "æ£€æµ‹ç³»ç»Ÿæ¶æ„: $arch"
    
    if [ "$arch" != "x86_64" ]; then
        warn "æ£€æµ‹åˆ°ç³»ç»Ÿæ¶æ„ä¸º: $arch"
        warn "ä½ ä¸‹è½½çš„æ˜¯ amd64 (x86_64) ç‰ˆæœ¬ï¼Œå¯èƒ½ä¸å…¼å®¹å½“å‰ç³»ç»Ÿ"
        read -p "æ˜¯å¦ç»§ç»­å®‰è£…? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            info "å®‰è£…å·²å–æ¶ˆ"
            exit 1
        fi
    fi
}

# æ£€æŸ¥ root æƒé™
check_root() {
    if [ "$EUID" -ne 0 ]; then
        error "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
        info "å°è¯•ä½¿ç”¨: sudo bash $0"
        exit 1
    fi
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    info "æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„ä¾èµ–..."
    
    if command -v apt-get >/dev/null 2>&1; then
        # Debian/Ubuntu
        apt-get update
        apt-get install -y wget tar curl
    elif command -v yum >/dev/null 2>&1; then
        # CentOS/RHEL
        yum install -y wget tar curl
    elif command -v dnf >/dev/null 2>&1; then
        # Fedora
        dnf install -y wget tar curl
    else
        warn "æ— æ³•ç¡®å®šåŒ…ç®¡ç†å™¨ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
    fi
}

# ä¸‹è½½ x-ui
download_xui() {
    local download_url="https://github.vps7k7k.xyz/https://github.com/MHSanaei/3x-ui/releases/download/v2.8.5/x-ui-linux-amd64.tar.gz"
    local filename="x-ui-linux-amd64.tar.gz"
    
    info "å¼€å§‹ä¸‹è½½ x-ui..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–‡ä»¶
    if [ -f "$filename" ]; then
        warn "å‘ç°å·²å­˜åœ¨çš„æ–‡ä»¶ $filename"
        read -p "æ˜¯å¦é‡æ–°ä¸‹è½½? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -f "$filename"
        else
            info "ä½¿ç”¨å·²å­˜åœ¨çš„æ–‡ä»¶"
            return 0
        fi
    fi
    
    # ä¸‹è½½æ–‡ä»¶
    if wget --progress=bar:force "$download_url" -O "$filename"; then
        info "ä¸‹è½½å®Œæˆ"
    else
        error "ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒURL"
        exit 1
    fi
}

# è§£å‹å¹¶æ‰‹åŠ¨å®‰è£…
extract_and_install() {
    local filename="x-ui-linux-amd64.tar.gz"
    
    info "è§£å‹æ–‡ä»¶..."
    
    if [ ! -f "$filename" ]; then
        error "æ–‡ä»¶ $filename ä¸å­˜åœ¨"
        exit 1
    fi
    
    # æ¸…ç†æ—§æ–‡ä»¶
    rm -rf x-ui-temp
    mkdir -p x-ui-temp
    
    # è§£å‹æ–‡ä»¶
    tar zxvf "$filename" -C x-ui-temp
    
    # è¿›å…¥è§£å‹ç›®å½•
    cd x-ui-temp
    
    # æŸ¥æ‰¾ x-ui ç›®å½•
    if [ -d "x-ui" ]; then
        cd x-ui
    fi
    
    info "å¼€å§‹æ‰‹åŠ¨å®‰è£… x-ui..."
    
    # è®¾ç½®æ‰§è¡Œæƒé™
    chmod +x x-ui
    if [ -f "x-ui.sh" ]; then
        chmod +x x-ui.sh
    fi
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯å¯æ‰§è¡Œæ–‡ä»¶
    if [ ! -x "x-ui" ]; then
        error "x-ui æ–‡ä»¶ä¸å¯æ‰§è¡Œ"
        exit 1
    fi
    
    # æ‰‹åŠ¨å®‰è£…ï¼ˆé¿å…é‡æ–°ä¸‹è½½ï¼‰
    info "æ‰§è¡Œæ‰‹åŠ¨å®‰è£…ï¼Œè·³è¿‡è‡ªåŠ¨ä¸‹è½½..."
    
    # åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§æœåŠ¡
    systemctl stop x-ui 2>/dev/null || true
    
    # å¤åˆ¶æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•
    mkdir -p /usr/local/x-ui/
    cp -f x-ui /usr/local/x-ui/
    cp -f x-ui.sh /usr/local/x-ui/
    if [ -f "x-ui.service" ]; then
        cp -f x-ui.service /etc/systemd/system/
    fi
    
    # å¤åˆ¶ bin ç›®å½•
    if [ -d "bin" ]; then
        cp -rf bin /usr/local/x-ui/
    fi
    
    # è®¾ç½®æƒé™
    chmod +x /usr/local/x-ui/x-ui
    chmod +x /usr/local/x-ui/x-ui.sh
    chmod +x /usr/local/x-ui/bin/xray-linux-* 2>/dev/null || true
    
    # åˆ›å»ºç¬¦å·é“¾æ¥
    ln -sf /usr/local/x-ui/x-ui.sh /usr/bin/x-ui
    
    # è¿”å›åŸç›®å½•
    cd - > /dev/null
}

# é…ç½®ç³»ç»ŸæœåŠ¡
setup_service() {
    info "é…ç½®ç³»ç»ŸæœåŠ¡..."
    
    # å¦‚æœæœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
    if [ ! -f "/etc/systemd/system/x-ui.service" ]; then
        cat > /etc/systemd/system/x-ui.service << 'EOF'
[Unit]
Description=x-ui Service
Documentation=https://github.com/MHSanaei/3x-ui
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/usr/local/x-ui/
ExecStart=/usr/local/x-ui/x-ui
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF
        info "åˆ›å»ºäº† systemd æœåŠ¡æ–‡ä»¶"
    fi
    
    systemctl daemon-reload
    systemctl enable x-ui
}

# é…ç½®é˜²ç«å¢™
setup_firewall() {
    info "é…ç½®é˜²ç«å¢™..."
    
    # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
    if command -v ufw >/dev/null 2>&1 && ufw status | grep -q "active"; then
        # ufw
        ufw allow 54321/tcp comment "x-ui Panel"
        ufw allow 5000/tcp comment "x-ui API"
        ufw allow 10000-20000/tcp comment "x-ui Proxy Ports"
        info "UFW é˜²ç«å¢™å·²é…ç½®"
    elif command -v firewall-cmd >/dev/null 2>&1 && firewall-cmd --state >/dev/null 2>&1; then
        # firewalld
        firewall-cmd --permanent --add-port=54321/tcp
        firewall-cmd --permanent --add-port=5000/tcp
        firewall-cmd --permanent --add-port=10000-20000/tcp
        firewall-cmd --reload
        info "Firewalld é˜²ç«å¢™å·²é…ç½®"
    elif command -v iptables >/dev/null 2>&1; then
        # iptables
        iptables -I INPUT -p tcp --dport 54321 -j ACCEPT
        iptables -I INPUT -p tcp --dport 5000 -j ACCEPT
        iptables -I INPUT -p tcp --dport 10000:20000 -j ACCEPT
        info "iptables è§„åˆ™å·²æ·»åŠ "
        
        # å°è¯•ä¿å­˜ iptables è§„åˆ™
        if command -v iptables-save >/dev/null 2>&1; then
            iptables-save > /etc/iptables.rules 2>/dev/null || true
        fi
    else
        warn "æœªæ£€æµ‹åˆ°é˜²ç«å¢™ï¼Œè·³è¿‡é…ç½®"
    fi
}

# å¯åŠ¨æœåŠ¡
start_service() {
    info "å¯åŠ¨ x-ui æœåŠ¡..."
    
    systemctl daemon-reload
    systemctl enable x-ui
    
    # ç»™æœåŠ¡ä¸€ç‚¹æ—¶é—´å¯åŠ¨
    sleep 2
    systemctl start x-ui
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 3
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet x-ui; then
        info "x-ui æœåŠ¡å¯åŠ¨æˆåŠŸ"
        
        # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
        echo
        systemctl status x-ui --no-pager -l
    else
        error "x-ui æœåŠ¡å¯åŠ¨å¤±è´¥"
        systemctl status x-ui --no-pager -l
        warn "å°è¯•æ‰‹åŠ¨å¯åŠ¨: systemctl start x-ui"
    fi
}

# æ˜¾ç¤ºå®‰è£…ä¿¡æ¯
show_info() {
    echo
    info "=================================================="
    info "ğŸ‰ x-ui å®‰è£…å®Œæˆï¼"
    info "=================================================="
    info "ç®¡ç†é¢æ¿åœ°å€: http://ä½ çš„æœåŠ¡å™¨IP:54321"
    info "é»˜è®¤ç”¨æˆ·å: admin"
    info "é»˜è®¤å¯†ç : admin"
    info ""
    warn "âš ï¸  é‡è¦å®‰å…¨æé†’:"
    warn "1. é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç "
    warn "2. ç¡®ä¿é˜²ç«å¢™å·²æ­£ç¡®é…ç½®"
    warn "3. å»ºè®®ä½¿ç”¨å¼ºå¯†ç å¹¶å®šæœŸæ›´æ–°"
    info ""
    info "å¸¸ç”¨å‘½ä»¤:"
    info "å¯åŠ¨æœåŠ¡: systemctl start x-ui"
    info "åœæ­¢æœåŠ¡: systemctl stop x-ui"
    info "é‡å¯æœåŠ¡: systemctl restart x-ui"
    info "æŸ¥çœ‹çŠ¶æ€: systemctl status x-ui"
    info "æŸ¥çœ‹æ—¥å¿—: journalctl -u x-ui -f"
    info "=================================================="
    echo
}

# ä¸»å‡½æ•°
main() {
    info "å¼€å§‹ x-ui è‡ªåŠ¨å®‰è£…è¿‡ç¨‹..."
    
    # æ‰§è¡Œå®‰è£…æ­¥éª¤
    check_root
    check_architecture
    install_dependencies
    download_xui
    extract_and_install
    setup_service
    setup_firewall
    start_service
    show_info
    
    info "å®‰è£…è„šæœ¬æ‰§è¡Œå®Œæ¯•"
}

# æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
echo
warn "x-ui å®‰è£…è„šæœ¬ï¼ˆä¿®å¤ç‰ˆï¼‰"
warn "æ­¤è„šæœ¬å°†ä½¿ç”¨åŠ é€Ÿé“¾æ¥ä¸‹è½½å¹¶æ‰‹åŠ¨å®‰è£…ï¼Œé¿å…é‡å¤ä¸‹è½½"
echo
read -p "æ˜¯å¦ç»§ç»­å®‰è£…? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    info "å®‰è£…å·²å–æ¶ˆ"
    exit 0
fi

# æ‰§è¡Œä¸»å‡½æ•°
main
