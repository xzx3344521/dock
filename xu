#!/bin/bash

# x-ui å¤šæ¶æ„è‡ªåŠ¨å®‰è£…è„šæœ¬
# æ”¯æŒ: amd64, 386, arm64, armv5, armv6, armv7, s390x
# é»˜è®¤é…ç½®: ç«¯å£ 8443, è´¦å· 3344, å¯†ç  3344
# å’¸Vå’†å“®åˆ¶ä½œ - ä¸€é”®æå®šæ‰€æœ‰æ¶æ„ï¼

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# è‡ªå®šä¹‰é…ç½®
PANEL_PORT="8443"
PANEL_USERNAME="3344"
PANEL_PASSWORD="3344"

# æ¶æ„æ˜ å°„è¡¨
declare -A ARCH_MAP=(
    ["x86_64"]="amd64"
    ["i386"]="386"
    ["i486"]="386"
    ["i586"]="386"
    ["i686"]="386"
    ["aarch64"]="arm64"
    ["armv5l"]="armv5"
    ["armv6l"]="armv6"
    ["armv7l"]="armv7"
    ["s390x"]="s390x"
)

# ä¸‹è½½URLåŸºç¡€
BASE_URL="https://github.vps7k7k.xyz/https://github.com/MHSanaei/3x-ui/releases/download/v2.8.5"

# æ‰“å°å½©è‰²ä¿¡æ¯
info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
step() { echo -e "${BLUE}[STEP]${NC} $1"; }
debug() { echo -e "${PURPLE}[DEBUG]${NC} $1"; }
cyan() { echo -e "${CYAN}$1${NC}"; }

# æ˜¾ç¤ºå¤§å­—æ ‡é¢˜
show_banner() {
    echo
    echo -e "${CYAN}"
    echo " â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—"
    echo " â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘"
    echo "   â–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘"
    echo "  â–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘"
    echo " â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘"
    echo " â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•     â•šâ•â•â•â•â•â• â•šâ•â•"
    echo
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                                            â•‘"
    echo -e "â•‘   ${YELLOW}ğŸš€ è¶…å¼ºå¤šæ¶æ„ X-UI ä¸€é”®å®‰è£…è„šæœ¬ ${RED}       â•‘"
    echo -e "â•‘                                            â•‘"
    echo -e "â•‘   ${GREEN}ğŸ“¦ æ”¯æŒæ‰€æœ‰ä¸»æµCPUæ¶æ„ ${RED}                â•‘"
    echo -e "â•‘   ${BLUE}âš¡ è‡ªåŠ¨æ£€æµ‹ + è‡ªåŠ¨é…ç½® ${RED}                  â•‘"
    echo -e "â•‘   ${PURPLE}ğŸ¯ å’¸Vå’†å“®åˆ¶ä½œ ${RED}                       â•‘"
    echo -e "â•‘                                            â•‘"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ˜¾ç¤ºåˆ¶ä½œä¿¡æ¯
show_creator() {
    echo
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                                                      â•‘"
    echo -e "â•‘  ${YELLOW}ğŸ”¥ å’¸Vå’†å“®å®£è¨€ï¼š${RED}                                  â•‘"
    echo -e "â•‘                                                      â•‘"
    echo -e "â•‘  ${GREEN}ã€Œå¤šæ¶æ„æ”¯æŒï¼Œæ™ºèƒ½é€‚é…ï¼ã€${RED}                         â•‘"
    echo -e "â•‘  ${CYAN}ã€Œä¸€é”®é…ç½®ï¼Œçœå¿ƒçœåŠ›ï¼ã€${RED}                             â•‘"
    echo -e "â•‘  ${PURPLE}ã€Œæœ‰é—®é¢˜å°±åé¦ˆï¼ŒæŒç»­æ”¹è¿›ï¼ã€${RED}                       â•‘"
    echo -e "â•‘                                                      â•‘"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ£€æµ‹ç³»ç»Ÿæ¶æ„
detect_architecture() {
    local arch=$(uname -m)
    step "ğŸ” æ­£åœ¨æ£€æµ‹ç³»ç»Ÿæ¶æ„..."
    cyan "ğŸ‘‰ å½“å‰æ¶æ„: $arch"
    
    # æ˜ å°„åˆ°å¯¹åº”çš„ä¸‹è½½æ¶æ„
    if [[ -n "${ARCH_MAP[$arch]}" ]]; then
        DETECTED_ARCH="${ARCH_MAP[$arch]}"
        info "ğŸ¯ æ¶æ„è¯†åˆ«: $arch â†’ $DETECTED_ARCH"
    else
        error "âŒ ä¸æ”¯æŒçš„æ¶æ„: $arch"
        echo
        show_arch_info
        exit 1
    fi
}

# æ„å»ºä¸‹è½½URL
build_download_url() {
    local filename="x-ui-linux-${DETECTED_ARCH}.tar.gz"
    DOWNLOAD_URL="${BASE_URL}/${filename}"
    DOWNLOAD_FILENAME="$filename"
    
    info "ğŸ“¥ ä¸‹è½½æ–‡ä»¶: $DOWNLOAD_FILENAME"
    debug "ğŸ”— ä¸‹è½½URL: $DOWNLOAD_URL"
}

# æ£€æŸ¥ root æƒé™
check_root() {
    if [ "$EUID" -ne 0 ]; then
        error "âŒ è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬ï¼"
        info "ğŸ’¡ å°è¯•ä½¿ç”¨: ${CYAN}sudo bash $0${NC}"
        exit 1
    fi
    info "âœ… Rootæƒé™æ£€æŸ¥é€šè¿‡"
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    info "ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„ä¾èµ–..."
    
    if command -v apt-get >/dev/null 2>&1; then
        # Debian/Ubuntu
        apt-get update
        apt-get install -y wget tar curl sqlite3
    elif command -v yum >/dev/null 2>&1; then
        # CentOS/RHEL
        yum install -y wget tar curl sqlite
    elif command -v dnf >/dev/null 2>&1; then
        # Fedora
        dnf install -y wget tar curl sqlite
    elif command -v apk >/dev/null 2>&1; then
        # Alpine
        apk add wget tar curl sqlite
    else
        warn "âš  æ— æ³•ç¡®å®šåŒ…ç®¡ç†å™¨ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
    fi
    info "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
}

# ä¸‹è½½ x-ui
download_xui() {
    info "ğŸ“¥ å¼€å§‹ä¸‹è½½ x-ui..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–‡ä»¶
    if [ -f "$DOWNLOAD_FILENAME" ]; then
        warn "ğŸ“ å‘ç°å·²å­˜åœ¨çš„æ–‡ä»¶: $DOWNLOAD_FILENAME"
        read -p "ğŸ”„ æ˜¯å¦é‡æ–°ä¸‹è½½? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -f "$DOWNLOAD_FILENAME"
        else
            info "âœ… ä½¿ç”¨å·²å­˜åœ¨çš„æ–‡ä»¶"
            return 0
        fi
    fi
    
    # ä¸‹è½½æ–‡ä»¶
    info "â¬ æ­£åœ¨ä¸‹è½½ï¼Œè¯·ç¨å€™..."
    cyan "ğŸ’¾ æ–‡ä»¶: $DOWNLOAD_FILENAME"
    
    if wget --progress=bar:force "$DOWNLOAD_URL" -O "$DOWNLOAD_FILENAME"; then
        info "âœ… ä¸‹è½½å®Œæˆï¼"
    else
        error "âŒ ä¸‹è½½å¤±è´¥ï¼"
        error "ğŸ”— è¯·æ£€æŸ¥URL: $DOWNLOAD_URL"
        exit 1
    fi
}

# è§£å‹å¹¶æ‰‹åŠ¨å®‰è£…
extract_and_install() {
    info "ğŸ“‚ è§£å‹æ–‡ä»¶..."
    
    if [ ! -f "$DOWNLOAD_FILENAME" ]; then
        error "âŒ æ–‡ä»¶ $DOWNLOAD_FILENAME ä¸å­˜åœ¨"
        exit 1
    fi
    
    # æ¸…ç†æ—§æ–‡ä»¶
    rm -rf x-ui-temp
    mkdir -p x-ui-temp
    
    # è§£å‹æ–‡ä»¶
    cyan "ğŸ”“ æ­£åœ¨è§£å‹ $DOWNLOAD_FILENAME..."
    if ! tar zxvf "$DOWNLOAD_FILENAME" -C x-ui-temp; then
        error "âŒ è§£å‹å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸå"
        exit 1
    fi
    
    # è¿›å…¥è§£å‹ç›®å½•
    cd x-ui-temp
    
    # æŸ¥æ‰¾ x-ui ç›®å½•
    if [ -d "x-ui" ]; then
        cd x-ui
    fi
    
    info "ğŸ”§ å¼€å§‹æ‰‹åŠ¨å®‰è£… x-ui..."
    
    # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶
    if [ ! -f "x-ui" ]; then
        error "âŒ æœªæ‰¾åˆ° x-ui å¯æ‰§è¡Œæ–‡ä»¶"
        ls -la
        exit 1
    fi
    
    # è®¾ç½®æ‰§è¡Œæƒé™
    chmod +x x-ui
    if [ -f "x-ui.sh" ]; then
        chmod +x x-ui.sh
    fi
    
    # æ‰‹åŠ¨å®‰è£…
    info "âš¡ æ‰§è¡Œæ‰‹åŠ¨å®‰è£…..."
    
    # åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§æœåŠ¡
    systemctl stop x-ui 2>/dev/null || true
    
    # å¤åˆ¶æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•
    mkdir -p /usr/local/x-ui/
    cp -f x-ui /usr/local/x-ui/
    if [ -f "x-ui.sh" ]; then
        cp -f x-ui.sh /usr/local/x-ui/
    fi
    if [ -f "x-ui.service" ]; then
        cp -f x-ui.service /etc/systemd/system/
    fi
    
    # å¤åˆ¶ bin ç›®å½•
    if [ -d "bin" ]; then
        cp -rf bin /usr/local/x-ui/
    fi
    
    # è®¾ç½®æƒé™
    chmod +x /usr/local/x-ui/x-ui
    if [ -f "/usr/local/x-ui/x-ui.sh" ]; then
        chmod +x /usr/local/x-ui/x-ui.sh
    fi
    chmod +x /usr/local/x-ui/bin/xray-linux-* 2>/dev/null || true
    
    # åˆ›å»ºç¬¦å·é“¾æ¥
    if [ -f "/usr/local/x-ui/x-ui.sh" ]; then
        ln -sf /usr/local/x-ui/x-ui.sh /usr/bin/x-ui
    else
        ln -sf /usr/local/x-ui/x-ui /usr/bin/x-ui
    fi
    
    # è¿”å›åŸç›®å½•
    cd - > /dev/null
    info "âœ… æ–‡ä»¶å®‰è£…å®Œæˆ"
}

# é…ç½®ç³»ç»ŸæœåŠ¡
setup_service() {
    info "ğŸ”Œ é…ç½®ç³»ç»ŸæœåŠ¡..."
    
    # å¦‚æœæœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
    if [ ! -f "/etc/systemd/system/x-ui.service" ]; then
        cat > /etc/systemd/system/x-ui.service << 'EOF'
[Unit]
Description=x-ui Service
Documentation=https://github.com/MHSanaei/3x-ui
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/usr/local/x-ui/
ExecStart=/usr/local/x-ui/x-ui
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF
        info "ğŸ“„ åˆ›å»ºäº† systemd æœåŠ¡æ–‡ä»¶"
    fi
    
    systemctl daemon-reload
    systemctl enable x-ui
    info "âœ… ç³»ç»ŸæœåŠ¡é…ç½®å®Œæˆ"
}

# ä½¿ç”¨x-uiå‘½ä»¤ä¿®æ”¹é…ç½®ï¼ˆä¿®å¤ç‰ˆï¼‰
modify_panel_config() {
    step "ğŸ›ï¸  å¼€å§‹ä¿®æ”¹é¢æ¿é…ç½®..."
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    info "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
    systemctl start x-ui 2>/dev/null || true
    sleep 8
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if ! systemctl is-active --quiet x-ui; then
        warn "âš  æœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
        systemctl start x-ui
        sleep 5
    fi
    
    # ä¿®æ”¹ç«¯å£
    info "ğŸ”§ ä¿®æ”¹é¢æ¿ç«¯å£ä¸º: $PANEL_PORT"
    if command -v x-ui >/dev/null 2>&1; then
        # ä½¿ç”¨expectè‡ªåŠ¨äº¤äº’ä¿®æ”¹ç«¯å£
        if command -v expect >/dev/null 2>&1; then
            expect << EOF
spawn x-ui
expect "Please enter your selection"
send "9\r"
expect "Enter port number"
send "$PANEL_PORT\r"
expect "Restart the panel"
send "y\r"
expect "Press enter to return"
send "\r"
expect eof
EOF
            info "âœ… ç«¯å£ä¿®æ”¹å®Œæˆ"
        else
            warn "âš  æœªå®‰è£…expectï¼Œæ— æ³•è‡ªåŠ¨ä¿®æ”¹ç«¯å£"
            info "ğŸ’¡ è¯·æ‰‹åŠ¨è¿è¡Œ 'x-ui' é€‰æ‹© 9 ä¿®æ”¹ç«¯å£ä¸º $PANEL_PORT"
        fi
        
        sleep 3
        
        # ä¿®æ”¹ç”¨æˆ·åå’Œå¯†ç 
        info "ğŸ‘¤ ä¿®æ”¹ç”¨æˆ·åå’Œå¯†ç ä¸º: $PANEL_USERNAME/$PANEL_PASSWORD"
        if command -v expect >/dev/null 2>&1; then
            expect << EOF
spawn x-ui
expect "Please enter your selection"
send "6\r"
expect "Are you sure to reset"
send "y\r"
expect "Please set the login username"
send "$PANEL_USERNAME\r"
expect "Please set the login password"
send "$PANEL_PASSWORD\r"
expect "Do you want to disable currently configured two-factor authentication"
send "y\r"
expect "Restart the panel"
send "y\r"
expect "Press enter to return"
send "\r"
expect eof
EOF
            info "âœ… è´¦å·å¯†ç ä¿®æ”¹å®Œæˆ"
        else
            warn "âš  æœªå®‰è£…expectï¼Œæ— æ³•è‡ªåŠ¨ä¿®æ”¹è´¦å·å¯†ç "
            info "ğŸ’¡ è¯·æ‰‹åŠ¨è¿è¡Œ 'x-ui' é€‰æ‹© 6 ä¿®æ”¹è´¦å·å¯†ç "
        fi
    else
        error "âŒ x-ui å‘½ä»¤æœªæ‰¾åˆ°ï¼Œæ— æ³•è‡ªåŠ¨é…ç½®"
        info "ğŸ’¡ è¯·æ‰‹åŠ¨è¿è¡Œé…ç½®å‘½ä»¤"
    fi
}

# ç›´æ¥ä¿®æ”¹æ•°æ®åº“é…ç½®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
direct_db_config() {
    step "ğŸ—ƒï¸  å°è¯•ç›´æ¥ä¿®æ”¹æ•°æ®åº“é…ç½®..."
    
    # åœæ­¢æœåŠ¡
    systemctl stop x-ui 2>/dev/null || true
    sleep 3
    
    # æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
    if [ -f "/etc/x-ui/x-ui.db" ] && command -v sqlite3 >/dev/null 2>&1; then
        info "ğŸ”§ ç›´æ¥ä¿®æ”¹æ•°æ®åº“é…ç½®..."
        
        # ä¿®æ”¹ç«¯å£
        if sqlite3 /etc/x-ui/x-ui.db "UPDATE setting SET value = '$PANEL_PORT' WHERE key = 'port';"; then
            info "âœ… ç«¯å£ä¿®æ”¹ä¸º: $PANEL_PORT"
        else
            warn "âš  ç«¯å£ä¿®æ”¹å¤±è´¥"
        fi
        
        # ä¿®æ”¹ç”¨æˆ·åå¯†ç 
        if sqlite3 /etc/x-ui/x-ui.db "UPDATE users SET username = '$PANEL_USERNAME', password = '$PANEL_PASSWORD' WHERE id = 1;"; then
            info "âœ… è´¦å·ä¿®æ”¹ä¸º: $PANEL_USERNAME"
            info "âœ… å¯†ç ä¿®æ”¹ä¸º: $PANEL_PASSWORD"
        else
            warn "âš  è´¦å·å¯†ç ä¿®æ”¹å¤±è´¥"
        fi
        
        # ç¦ç”¨é»˜è®¤å‡­æ®è­¦å‘Š
        sqlite3 /etc/x-ui/x-ui.db "UPDATE setting SET value = 'false' WHERE key = 'hasDefaultCredential';" 2>/dev/null || true
    else
        warn "âš  æ— æ³•ç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼Œå°†ä½¿ç”¨äº¤äº’å¼é…ç½®"
    fi
    
    # é‡å¯æœåŠ¡
    systemctl start x-ui
    sleep 5
}

# é…ç½®é˜²ç«å¢™
setup_firewall() {
    info "ğŸ”¥ é…ç½®é˜²ç«å¢™..."
    
    # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
    if command -v ufw >/dev/null 2>&1 && ufw status | grep -q "active"; then
        # ufw
        ufw allow ${PANEL_PORT}/tcp comment "x-ui Panel"
        ufw allow 10000-20000/tcp comment "x-ui Proxy Ports"
        info "âœ… UFW é˜²ç«å¢™å·²é…ç½®"
    elif command -v firewall-cmd >/dev/null 2>&1 && firewall-cmd --state >/dev/null 2>&1; then
        # firewalld
        firewall-cmd --permanent --add-port=${PANEL_PORT}/tcp
        firewall-cmd --permanent --add-port=10000-20000/tcp
        firewall-cmd --reload
        info "âœ… Firewalld é˜²ç«å¢™å·²é…ç½®"
    elif command -v iptables >/dev/null 2>&1; then
        # iptables
        iptables -I INPUT -p tcp --dport ${PANEL_PORT} -j ACCEPT
        iptables -I INPUT -p tcp --dport 10000:20000 -j ACCEPT
        info "âœ… iptables è§„åˆ™å·²æ·»åŠ "
        
        # å°è¯•ä¿å­˜ iptables è§„åˆ™
        if command -v iptables-save >/dev/null 2>&1; then
            iptables-save > /etc/iptables.rules 2>/dev/null || true
        fi
    else
        warn "âš  æœªæ£€æµ‹åˆ°é˜²ç«å¢™ï¼Œè·³è¿‡é…ç½®"
    fi
}

# å¯åŠ¨æœåŠ¡
start_service() {
    info "ğŸš€ å¯åŠ¨ x-ui æœåŠ¡..."
    
    systemctl daemon-reload
    systemctl enable x-ui
    
    # é‡å¯æœåŠ¡ç¡®ä¿é…ç½®ç”Ÿæ•ˆ
    if systemctl restart x-ui; then
        info "âœ… x-ui æœåŠ¡é‡å¯æˆåŠŸ"
    else
        error "âŒ x-ui æœåŠ¡é‡å¯å¤±è´¥"
        return 1
    fi
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 8
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet x-ui; then
        info "âœ… x-ui æœåŠ¡è¿è¡Œæ­£å¸¸"
    else
        warn "âš  x-ui æœåŠ¡æœªè¿è¡Œï¼Œæ£€æŸ¥æ—¥å¿—ä¸­..."
        systemctl status x-ui --no-pager -l
    fi
}

# éªŒè¯å®‰è£…
verify_installation() {
    step "ğŸ” éªŒè¯å®‰è£…..."
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet x-ui; then
        info "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"
    else
        warn "âš  æœåŠ¡æœªè¿è¡Œ"
        return 0
    fi
    
    # æ£€æŸ¥ç«¯å£ç›‘å¬
    if command -v netstat >/dev/null 2>&1; then
        if netstat -tunlp 2>/dev/null | grep -q ":${PANEL_PORT} "; then
            info "âœ… ç«¯å£ ${PANEL_PORT} ç›‘å¬æ­£å¸¸"
        else
            warn "âš  ç«¯å£ ${PANEL_PORT} æœªç›‘å¬"
        fi
    elif command -v ss >/dev/null 2>&1; then
        if ss -tunlp 2>/dev/null | grep -q ":${PANEL_PORT} "; then
            info "âœ… ç«¯å£ ${PANEL_PORT} ç›‘å¬æ­£å¸¸"
        else
            warn "âš  ç«¯å£ ${PANEL_PORT} æœªç›‘å¬"
        fi
    fi
    
    # æ˜¾ç¤ºæœ€ç»ˆé…ç½®
    info "ğŸ“‹ æœ€ç»ˆé…ç½®éªŒè¯:"
    if command -v x-ui >/dev/null 2>&1; then
        echo "n" | x-ui | grep -A 10 "View Current Settings" || true
    fi
    
    info "âœ… éªŒè¯å®Œæˆ"
}

# æ˜¾ç¤ºå®‰è£…ä¿¡æ¯
show_info() {
    # è·å–æœåŠ¡å™¨IP
    local server_ip=$(curl -s --connect-timeout 5 ipv4.icanhazip.com || hostname -I | awk '{print $1}' || echo "ä½ çš„æœåŠ¡å™¨IP")
    
    echo
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                                                      â•‘"
    echo -e "â•‘    ğŸ‰ X-UI å¤šæ¶æ„å®‰è£…å®Œæˆï¼å’¸vå’†å“®åˆ¶ä½œï¼           â•‘"
    echo -e "â•‘                                                      â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    info "ğŸ–¥ï¸  ç³»ç»Ÿæ¶æ„: $(uname -m) â†’ $DETECTED_ARCH"
    info "ğŸŒ ç®¡ç†é¢æ¿: http://${server_ip}:${PANEL_PORT}"
    info "ğŸ‘¤ ç”¨æˆ·å: $PANEL_USERNAME"
    info "ğŸ”‘ å¯†ç : $PANEL_PASSWORD"
    echo
    cyan "ğŸ’¡ é…ç½®çŠ¶æ€: å·²è‡ªåŠ¨è®¾ç½®ç«¯å£å’Œè´¦å·å¯†ç "
    echo
    warn "âš ï¸  é‡è¦æé†’:"
    warn "1. è¯·ç«‹å³è®¿é—®é¢æ¿éªŒè¯ç™»å½•"
    warn "2. å»ºè®®å®šæœŸä¿®æ”¹å¯†ç " 
    warn "3. ç¡®ä¿é˜²ç«å¢™å·²æ­£ç¡®é…ç½®"
    echo
    info "ğŸ”§ å¸¸ç”¨å‘½ä»¤:"
    info "   å¯åŠ¨æœåŠ¡: systemctl start x-ui"
    info "   åœæ­¢æœåŠ¡: systemctl stop x-ui"
    info "   é‡å¯æœåŠ¡: systemctl restart x-ui"
    info "   æŸ¥çœ‹çŠ¶æ€: systemctl status x-ui"
    info "   æŸ¥çœ‹æ—¥å¿—: journalctl -u x-ui -f"
    info "   ç®¡ç†èœå•: x-ui"
    echo
    
    # æ˜¾ç¤ºè®¿é—®URL
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                 ğŸš€ ç«‹å³è®¿é—® ğŸš€                 â•‘"
    echo "â•‘                                                  â•‘"
    echo "â•‘     http://${server_ip}:${PANEL_PORT}           â•‘"
    echo "â•‘                                                   â•‘"
    echo "â•‘           ğŸ‘¤ è´¦å·: $PANEL_USERNAME               â•‘"
    echo "â•‘            ğŸ”‘ å¯†ç : $PANEL_PASSWORD              â•‘"
    echo "â•‘                                                  â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ˜¾ç¤ºæ¶æ„ä¿¡æ¯
show_arch_info() {
    echo
    info "ğŸ–¥ï¸  æ”¯æŒçš„æ¶æ„åˆ—è¡¨:"
    echo -e "  ${CYAN}x86_64${NC}  - 64ä½ Intel/AMD å¤„ç†å™¨ ${GREEN}â†’ amd64${NC}"
    echo -e "  ${CYAN}i386${NC}    - 32ä½ Intel/AMD å¤„ç†å™¨ ${GREEN}â†’ 386${NC}" 
    echo -e "  ${CYAN}aarch64${NC} - 64ä½ ARM å¤„ç†å™¨ ${GREEN}â†’ arm64${NC}"
    echo -e "  ${CYAN}armv7l${NC}  - 32ä½ ARM v7 ${GREEN}â†’ armv7${NC}"
    echo -e "  ${CYAN}armv6l${NC}  - 32ä½ ARM v6 ${GREEN}â†’ armv6${NC}"
    echo -e "  ${CYAN}armv5l${NC}  - 32ä½ ARM v5 ${GREEN}â†’ armv5${NC}"
    echo -e "  ${CYAN}s390x${NC}   - IBM å¤§å‹æœº ${GREEN}â†’ s390x${NC}"
    echo
}

# å®‰è£…expectå·¥å…·
install_expect() {
    if ! command -v expect >/dev/null 2>&1; then
        info "ğŸ“¦ å®‰è£… expect å·¥å…·ç”¨äºè‡ªåŠ¨é…ç½®..."
        if command -v apt-get >/dev/null 2>&1; then
            apt-get install -y expect
        elif command -v yum >/dev/null 2>&1; then
            yum install -y expect
        elif command -v dnf >/dev/null 2>&1; then
            dnf install -y expect
        elif command -v apk >/dev/null 2>&1; then
            apk add expect
        else
            warn "âš  æ— æ³•å®‰è£…expectï¼Œå°†ä½¿ç”¨å¤‡ç”¨é…ç½®æ–¹æ¡ˆ"
        fi
    fi
}

# ä¸»å‡½æ•°
main() {
    show_banner
    show_creator
    
    info "ğŸš€ å¼€å§‹ x-ui å¤šæ¶æ„è‡ªåŠ¨å®‰è£…..."
    show_arch_info
    
    # æ‰§è¡Œå®‰è£…æ­¥éª¤
    check_root
    detect_architecture
    build_download_url
    install_dependencies
    install_expect
    download_xui
    extract_and_install
    setup_service
    direct_db_config  # å…ˆå°è¯•ç›´æ¥ä¿®æ”¹æ•°æ®åº“
    modify_panel_config  # å†ä½¿ç”¨äº¤äº’å¼é…ç½®ç¡®ä¿ç”Ÿæ•ˆ
    setup_firewall
    start_service
    verify_installation
    show_info
    
    echo
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                                            â•‘"
    echo -e "â•‘   ${YELLOW}ğŸŠ å®‰è£…å®Œæˆï¼å’¸vå’†å“®æ„Ÿè°¢ä½¿ç”¨ï¼${RED}      â•‘"
    echo -e "â•‘   ${GREEN}ğŸŸ ä¸æƒ³ä¸Šç­ä¸æƒ³ä¸Šç­ï¼${RED}           â•‘"
    echo -e "â•‘                                            â•‘"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
show_banner
echo
cyan "ğŸ”§ é»˜è®¤é…ç½®: ç«¯å£ ${PANEL_PORT} | è´¦å· ${PANEL_USERNAME} | å¯†ç  ${PANEL_PASSWORD}"
echo

read -p "ğŸ”¥ æ˜¯å¦å¼€å§‹å®‰è£…? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    info "ğŸ‘‹ å®‰è£…å·²å–æ¶ˆ"
    exit 0
fi

# æ‰§è¡Œä¸»å‡½æ•°
main
