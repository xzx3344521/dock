#!/bin/bash

# Ubuntu/Debian/CentOS/RHELç³»ç»Ÿä¼˜åŒ–ä¸Dockerå‡†å¤‡è„šæœ¬
# ç²¾ç®€ç‰ˆ - ä¸å¤‡ä»½æ–‡ä»¶ï¼Œé€‚åˆå°å­˜å‚¨ç©ºé—´VPS

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ—¥å¿—æ–‡ä»¶
LOG_FILE="/tmp/system_optimization.log"

# é”™è¯¯å¤„ç†å‡½æ•°
handle_error() {
    echo -e "${RED}âŒ é”™è¯¯: $1${NC}"
    echo "è¯¦ç»†æ—¥å¿—è¯·æŸ¥çœ‹: $LOG_FILE"
    exit 1
}

# æ—¥å¿—è®°å½•å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
check_command() {
    if ! command -v "$1" &> /dev/null; then
        return 1
    fi
    return 0
}

# æ£€æµ‹ç³»ç»Ÿç±»å‹
detect_os() {
    echo -e "${BLUE}ğŸ” æ£€æµ‹æ“ä½œç³»ç»Ÿ...${NC}"
    
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_NAME=$ID
        OS_VERSION=$VERSION_ID
        OS_PRETTY_NAME=$PRETTY_NAME
        
        echo -e "${GREEN}âœ… æ“ä½œç³»ç»Ÿ: $OS_PRETTY_NAME${NC}"
        echo -e "${GREEN}âœ… ç‰ˆæœ¬: $OS_VERSION${NC}"
        
        case $OS_NAME in
            ubuntu|debian)
                OS_TYPE="debian"
                PM="apt-get"
                UPDATE_CMD="apt-get update"
                UPGRADE_CMD="apt-get upgrade -y"
                INSTALL_CMD="apt-get install -y"
                AUTOREMOVE_CMD="apt-get autoremove -y"
                AUTOCLEAN_CMD="apt-get autoclean -y"
                ;;
            centos|rhel|fedora|rocky|almalinux)
                OS_TYPE="rhel"
                if check_command dnf; then
                    PM="dnf"
                    UPDATE_CMD="dnf update -y"
                    INSTALL_CMD="dnf install -y"
                else
                    PM="yum"
                    UPDATE_CMD="yum update -y"
                    INSTALL_CMD="yum install -y"
                fi
                AUTOREMOVE_CMD="$PM autoremove -y"
                AUTOCLEAN_CMD="$PM clean all"
                ;;
            *)
                handle_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS_NAME"
                ;;
        esac
    else
        handle_error "æ— æ³•æ£€æµ‹æ“ä½œç³»ç»Ÿ"
    fi
}

# æ£€æŸ¥ç³»ç»Ÿæ¶æ„
check_architecture() {
    echo -e "${BLUE}ğŸ” æ£€æŸ¥ç³»ç»Ÿæ¶æ„...${NC}"
    ARCH=$(uname -m)
    case $ARCH in
        x86_64)
            echo -e "${GREEN}âœ… ç³»ç»Ÿæ¶æ„: AMD64${NC}"
            ;;
        aarch64)
            echo -e "${GREEN}âœ… ç³»ç»Ÿæ¶æ„: ARM64${NC}"
            ;;
        *)
            echo -e "${YELLOW}âš ï¸  æ£€æµ‹åˆ°éå¸¸è§æ¶æ„: $ARCH${NC}"
            ;;
    esac
}

# æ¸…ç†ç³»ç»Ÿç¼“å­˜å’Œæ—§åŒ…
clean_system() {
    echo -e "${BLUE}ğŸ§¹ æ¸…ç†ç³»ç»Ÿç¼“å­˜å’Œæ—§åŒ…...${NC}"
    
    if [ "$OS_TYPE" = "debian" ]; then
        # æ¸…ç†aptç¼“å­˜
        apt-get clean >> "$LOG_FILE" 2>&1 || echo -e "${YELLOW}âš ï¸  aptæ¸…ç†ç¼“å­˜å¤±è´¥${NC}"
        apt-get autoremove -y >> "$LOG_FILE" 2>&1 || echo -e "${YELLOW}âš ï¸  aptè‡ªåŠ¨ç§»é™¤å¤±è´¥${NC}"
        
        # æ¸…ç†æ—§å†…æ ¸ï¼ˆä»…ä¿ç•™æœ€æ–°1ä¸ªä»¥èŠ‚çœç©ºé—´ï¼‰
        if check_command dpkg; then
            OLD_KERNELS=$(dpkg -l | grep -E "linux-image-[0-9]" | grep -v $(uname -r | sed 's/-generic//') | awk '{print $2}')
            if [ -n "$OLD_KERNELS" ]; then
                echo -e "${BLUE}ç§»é™¤æ—§å†…æ ¸: $OLD_KERNELS${NC}"
                apt-get remove -y $OLD_KERNELS >> "$LOG_FILE" 2>&1 || true
            fi
        fi
    elif [ "$OS_TYPE" = "rhel" ]; then
        # æ¸…ç†yum/dnfç¼“å­˜
        $PM clean all >> "$LOG_FILE" 2>&1 || echo -e "${YELLOW}âš ï¸  $PMæ¸…ç†ç¼“å­˜å¤±è´¥${NC}"
        
        # æ¸…ç†æ—§å†…æ ¸ï¼ˆä»…ä¿ç•™æœ€æ–°1ä¸ªï¼‰
        if [ "$PM" = "yum" ]; then
            package-cleanup --oldkernels --count=1 -y >> "$LOG_FILE" 2>&1 || true
        elif [ "$PM" = "dnf" ]; then
            dnf remove --oldinstallonly --setopt installonly_limit=1 -y >> "$LOG_FILE" 2>&1 || true
        fi
    fi
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆä¸æ¸…ç†å¤ªå¤šé¿å…å½±å“è¿è¡Œï¼‰
    rm -rf /tmp/*.deb /tmp/*.rpm /var/tmp/*.deb /var/tmp/*.rpm >> "$LOG_FILE" 2>&1 || true
    
    # æ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
    find /var/log -name "*.log" -type f -mtime +7 -delete 2>/dev/null || true
    find /var/log -name "*.gz" -type f -delete 2>/dev/null || true
    
    echo -e "${GREEN}âœ… ç³»ç»Ÿæ¸…ç†å®Œæˆ${NC}"
}

# æ›´æ–°ç³»ç»ŸåŒ…ç®¡ç†å™¨
update_package_manager() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°åŒ…ç®¡ç†å™¨...${NC}"
    
    if [ "$OS_TYPE" = "debian" ]; then
        # æ›´æ–°aptæº
        if ! $UPDATE_CMD >> "$LOG_FILE" 2>&1; then
            echo -e "${YELLOW}âš ï¸  åŒ…ç®¡ç†å™¨æ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤...${NC}"
            
            # ä¿®å¤å¯èƒ½çš„æŸå
            dpkg --configure -a >> "$LOG_FILE" 2>&1 || true
            apt-get install -f -y >> "$LOG_FILE" 2>&1 || true
        fi
    elif [ "$OS_TYPE" = "rhel" ]; then
        if ! $UPDATE_CMD >> "$LOG_FILE" 2>&1; then
            echo -e "${YELLOW}âš ï¸  åŒ…ç®¡ç†å™¨æ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤...${NC}"
            
            # ä¿®å¤å¯èƒ½çš„æŸå
            rpm --rebuilddb >> "$LOG_FILE" 2>&1 || true
            $PM clean all >> "$LOG_FILE" 2>&1 || true
        fi
    fi
    
    echo -e "${GREEN}âœ… åŒ…ç®¡ç†å™¨æ›´æ–°å®Œæˆ${NC}"
}

# å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆç²¾ç®€ç‰ˆï¼‰
install_basic_dependencies() {
    echo -e "${BLUE}ğŸ“¦ å®‰è£…åŸºç¡€ä¾èµ–åŒ…...${NC}"
    
    local base_packages=()
    
    if [ "$OS_TYPE" = "debian" ]; then
        base_packages=(
            "curl" "wget" "gnupg" "lsb-release" "apt-transport-https" 
            "ca-certificates" "software-properties-common"
            "net-tools" "dnsutils" "iputils-ping" "sudo" "bc"
        )
    elif [ "$OS_TYPE" = "rhel" ]; then
        base_packages=(
            "curl" "wget" "gnupg" "redhat-lsb-core" "yum-utils" "epel-release"
            "ca-certificates" "device-mapper-persistent-data" "lvm2"
            "net-tools" "bind-utils" "iputils" "sudo" "bc"
        )
    fi
    
    for package in "${base_packages[@]}"; do
        echo -e "${BLUE}å®‰è£… $package...${NC}"
        if ! $INSTALL_CMD "$package" >> "$LOG_FILE" 2>&1; then
            echo -e "${YELLOW}âš ï¸  $package å®‰è£…å¤±è´¥ï¼Œè·³è¿‡...${NC}"
        fi
    done
    
    echo -e "${GREEN}âœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

# é…ç½®ç³»ç»Ÿä¼˜åŒ–å‚æ•°
configure_system_optimization() {
    echo -e "${BLUE}âš™ï¸  é…ç½®ç³»ç»Ÿä¼˜åŒ–å‚æ•°...${NC}"
    
    # ä¼˜åŒ–å†…æ ¸å‚æ•° - ç›´æ¥ä¿®æ”¹ï¼Œä¸å¤‡ä»½
    if ! grep -q "ç³»ç»Ÿä¼˜åŒ–é…ç½®" /etc/sysctl.conf; then
        cat >> /etc/sysctl.conf << EOF

# ç³»ç»Ÿä¼˜åŒ–é…ç½® - æ·»åŠ äº $(date)
# ç½‘ç»œä¼˜åŒ–
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 16384 16777216
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1

# å†…å­˜ä¼˜åŒ–
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
fs.file-max = 65536
EOF
    fi
    
    # åº”ç”¨é…ç½®
    sysctl -p >> "$LOG_FILE" 2>&1 || echo -e "${YELLOW}âš ï¸  sysctlé…ç½®åº”ç”¨å¤±è´¥${NC}"
    
    # é…ç½®æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
    if ! grep -q "æ–‡ä»¶æè¿°ç¬¦é™åˆ¶" /etc/security/limits.conf; then
        cat >> /etc/security/limits.conf << EOF

# æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ - æ·»åŠ äº $(date)
* soft nofile 65536
* hard nofile 65536
root soft nofile 65536
root hard nofile 65536
EOF
    fi
    
    echo -e "${GREEN}âœ… ç³»ç»Ÿä¼˜åŒ–é…ç½®å®Œæˆ${NC}"
}

# é…ç½®DNSä¼˜åŒ–
configure_dns() {
    echo -e "${BLUE}ğŸŒ é…ç½®DNSä¼˜åŒ–...${NC}"
    
    # ç›´æ¥é…ç½®ï¼Œä¸å¤‡ä»½
    cat > /etc/resolv.conf << EOF
# DNSé…ç½® - ä¼˜åŒ–äº $(date)
nameserver 223.5.5.5
nameserver 119.29.29.29
nameserver 8.8.8.8
nameserver 1.1.1.1
options timeout:2 attempts:3 rotate
EOF
    
    # é˜²æ­¢NetworkManagerè¦†ç›–é…ç½®
    if [ -f /etc/NetworkManager/NetworkManager.conf ]; then
        sed -i 's/^dns=.*/dns=none/' /etc/NetworkManager/NetworkManager.conf 2>/dev/null || true
    fi
    
    echo -e "${GREEN}âœ… DNSä¼˜åŒ–é…ç½®å®Œæˆ${NC}"
}

# é…ç½®Dockerå®‰è£…ç¯å¢ƒ
configure_docker_environment() {
    echo -e "${BLUE}ğŸ³ é…ç½®Dockerå®‰è£…ç¯å¢ƒ...${NC}"
    
    if [ "$OS_TYPE" = "debian" ]; then
        # æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥
        curl -fsSL https://download.docker.com/linux/$OS_NAME/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg >> "$LOG_FILE" 2>&1 || {
            echo -e "${YELLOW}âš ï¸  Docker GPGå¯†é’¥æ·»åŠ å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ${NC}"
            curl -fsSL https://download.docker.com/linux/$OS_NAME/gpg | apt-key add - >> "$LOG_FILE" 2>&1 || true
        }
        
        # æ·»åŠ Dockerä»“åº“
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/$OS_NAME $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        # æ›´æ–°åŒ…åˆ—è¡¨
        $UPDATE_CMD >> "$LOG_FILE" 2>&1 || echo -e "${YELLOW}âš ï¸  æ›´æ–°åŒ…åˆ—è¡¨å¤±è´¥${NC}"
        
    elif [ "$OS_TYPE" = "rhel" ]; then
        # æ·»åŠ Dockerä»“åº“
        $INSTALL_CMD yum-utils >> "$LOG_FILE" 2>&1 || true
        yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo >> "$LOG_FILE" 2>&1 || {
            echo -e "${YELLOW}âš ï¸  Dockerä»“åº“æ·»åŠ å¤±è´¥ï¼Œä½¿ç”¨å®˜æ–¹ä»“åº“${NC}"
        }
        
        # æ›´æ–°åŒ…åˆ—è¡¨
        $UPDATE_CMD >> "$LOG_FILE" 2>&1 || true
    fi
    
    echo -e "${GREEN}âœ… Dockerç¯å¢ƒé…ç½®å®Œæˆ${NC}"
}

# å®‰è£…Docker
install_docker() {
    echo -e "${BLUE}ğŸ³ å®‰è£…Docker...${NC}"
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…Docker
    if check_command docker; then
        echo -e "${YELLOW}âš ï¸  Dockerå·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…${NC}"
        return 0
    fi
    
    if [ "$OS_TYPE" = "debian" ]; then
        $INSTALL_CMD docker-ce docker-ce-cli containerd.io docker-compose-plugin >> "$LOG_FILE" 2>&1 || {
            echo -e "${YELLOW}âš ï¸  Dockerå®‰è£…å¤±è´¥ï¼Œå°è¯•æ›¿ä»£æ–¹æ¡ˆ${NC}"
            # å°è¯•å®‰è£…docker.io
            $INSTALL_CMD docker.io containerd runc >> "$LOG_FILE" 2>&1 || {
                echo -e "${RED}âŒ Dockerå®‰è£…å®Œå…¨å¤±è´¥${NC}"
                return 1
            }
        }
    elif [ "$OS_TYPE" = "rhel" ]; then
        $INSTALL_CMD docker-ce docker-ce-cli containerd.io docker-compose-plugin >> "$LOG_FILE" 2>&1 || {
            echo -e "${YELLOW}âš ï¸  Dockerå®‰è£…å¤±è´¥ï¼Œå°è¯•æ›¿ä»£æ–¹æ¡ˆ${NC}"
            $INSTALL_CMD docker >> "$LOG_FILE" 2>&1 || {
                echo -e "${RED}âŒ Dockerå®‰è£…å®Œå…¨å¤±è´¥${NC}"
                return 1
            }
        }
    fi
    
    # å¯åŠ¨DockeræœåŠ¡
    systemctl enable docker >> "$LOG_FILE" 2>&1 || true
    systemctl start docker >> "$LOG_FILE" 2>&1 || true
    
    # éªŒè¯å®‰è£…
    if docker --version >> "$LOG_FILE" 2>&1; then
        echo -e "${GREEN}âœ… Dockerå®‰è£…æˆåŠŸ: $(docker --version)${NC}"
        
        # é…ç½®ç”¨æˆ·ç»„
        usermod -aG docker $USER 2>/dev/null || true
        echo -e "${GREEN}âœ… å·²å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç»„${NC}"
    else
        echo -e "${RED}âŒ Dockerå®‰è£…éªŒè¯å¤±è´¥${NC}"
        return 1
    fi
}

# å®‰è£…Docker Compose
install_docker_compose() {
    echo -e "${BLUE}ğŸ³ å®‰è£…Docker Compose...${NC}"
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    if check_command docker-compose; then
        echo -e "${YELLOW}âš ï¸  Docker Composeå·²å®‰è£…ï¼Œè·³è¿‡${NC}"
        return 0
    fi
    
    # å®‰è£…æœ€æ–°ç‰ˆæœ¬
    COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    
    if [ -z "$COMPOSE_VERSION" ]; then
        COMPOSE_VERSION="v2.24.0"  # å¤‡ç”¨ç‰ˆæœ¬
    fi
    
    curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose >> "$LOG_FILE" 2>&1
    
    if [ $? -eq 0 ]; then
        chmod +x /usr/local/bin/docker-compose
        ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose 2>/dev/null || true
        
        echo -e "${GREEN}âœ… Docker Composeå®‰è£…æˆåŠŸ: ${COMPOSE_VERSION}${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Docker Composeå®‰è£…å¤±è´¥ï¼Œè·³è¿‡${NC}"
    fi
}

# éªŒè¯å®‰è£…ç»“æœ
verify_installation() {
    echo -e "${BLUE}ğŸ” éªŒè¯å®‰è£…ç»“æœ...${NC}"
    
    echo -e "${CYAN}ç³»ç»Ÿä¿¡æ¯:${NC}"
    echo -e "  OS: $OS_PRETTY_NAME"
    echo -e "  å†…æ ¸: $(uname -r)"
    echo -e "  æ¶æ„: $(uname -m)"
    
    echo -e "${CYAN}æœåŠ¡çŠ¶æ€:${NC}"
    if systemctl is-active docker >/dev/null 2>&1; then
        echo -e "  Docker: ${GREEN}è¿è¡Œä¸­${NC}"
    else
        echo -e "  Docker: ${RED}æœªè¿è¡Œ${NC}"
    fi
    
    echo -e "${CYAN}ç‰ˆæœ¬ä¿¡æ¯:${NC}"
    if check_command docker; then
        echo -e "  Docker: $(docker --version 2>/dev/null | cut -d' ' -f3 | tr -d ',')"
    else
        echo -e "  Docker: ${RED}æœªå®‰è£…${NC}"
    fi
    
    if check_command docker-compose; then
        echo -e "  Docker Compose: $(docker-compose --version 2>/dev/null | cut -d' ' -f3 | tr -d ',')"
    else
        echo -e "  Docker Compose: ${YELLOW}æœªå®‰è£…${NC}"
    fi
    
    # æ˜¾ç¤ºç£ç›˜ç©ºé—´
    echo -e "${CYAN}ç£ç›˜ç©ºé—´:${NC}"
    df -h / | tail -1 | awk '{print "  æ ¹åˆ†åŒº: " $4 " å¯ç”¨ / " $2 " æ€»å¤§å°"}'
    
    echo -e "${GREEN}âœ… éªŒè¯å®Œæˆ${NC}"
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo -e "${GREEN}ç³»ç»Ÿä¼˜åŒ–ä¸Dockerå‡†å¤‡è„šæœ¬ (ç²¾ç®€ç‰ˆ)${NC}"
    echo -e "ä¸“ä¸ºå°å­˜å‚¨ç©ºé—´VPSè®¾è®¡ - ä¸å¤‡ä»½æ–‡ä»¶${NC}"
    echo -e ""
    echo -e "ä½¿ç”¨æ–¹æ³•: $0 [é€‰é¡¹]"
    echo -e ""
    echo -e "é€‰é¡¹:"
    echo -e "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo -e "  -c, --clean    åªæ‰§è¡Œæ¸…ç†æ“ä½œ"
    echo -e "  -o, --optimize åªæ‰§è¡Œç³»ç»Ÿä¼˜åŒ–"
    echo -e "  -d, --docker   åªå®‰è£…Docker"
    echo -e "  -a, --all      æ‰§è¡Œæ‰€æœ‰æ“ä½œï¼ˆé»˜è®¤ï¼‰"
    echo -e ""
    echo -e "åŠŸèƒ½:"
    echo -e "  âœ… ç³»ç»Ÿæ£€æµ‹"
    echo -e "  âœ… æ·±åº¦æ¸…ç†ï¼ˆèŠ‚çœç©ºé—´ï¼‰"
    echo -e "  âœ… ä¾èµ–åŒ…å®‰è£…"
    echo -e "  âœ… ç³»ç»Ÿä¼˜åŒ–é…ç½®"
    echo -e "  âœ… DNSä¼˜åŒ–"
    echo -e "  âœ… Dockerç¯å¢ƒå‡†å¤‡"
    echo -e "  âœ… Dockerå®‰è£…ä¸é…ç½®"
    echo -e ""
    echo -e "ç¤ºä¾‹:"
    echo -e "  $0              # æ‰§è¡Œæ‰€æœ‰æ“ä½œ"
    echo -e "  $0 --clean      # åªæ‰§è¡Œæ¸…ç†"
    echo -e "  $0 --docker     # åªå®‰è£…Docker"
}

# ä¸»å‡½æ•°
main() {
    # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
    > "$LOG_FILE"
    
    # æ˜¾ç¤ºæ ‡é¢˜
    echo -e "${PURPLE}"
    echo "=================================================="
    echo "     ğŸš€ ç³»ç»Ÿä¼˜åŒ–ä¸Dockerå‡†å¤‡è„šæœ¬ (ç²¾ç®€ç‰ˆ)"
    echo "       ä¸“ä¸ºå°å­˜å‚¨ç©ºé—´VPSè®¾è®¡"
    echo "=================================================="
    echo -e "${NC}"
    
    # æ£€æŸ¥rootæƒé™
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}âŒ è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬${NC}"
        echo -e "ä½¿ç”¨: sudo $0"
        exit 1
    fi
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    case "${1:-}" in
        -h|--help)
            show_usage
            exit 0
            ;;
        -c|--clean)
            echo -e "${BLUE}æ‰§è¡Œæ¸…ç†æ“ä½œ...${NC}"
            detect_os
            clean_system
            exit 0
            ;;
        -o|--optimize)
            echo -e "${BLUE}æ‰§è¡Œç³»ç»Ÿä¼˜åŒ–...${NC}"
            detect_os
            configure_system_optimization
            configure_dns
            exit 0
            ;;
        -d|--docker)
            echo -e "${BLUE}å®‰è£…Docker...${NC}"
            detect_os
            configure_docker_environment
            install_docker
            install_docker_compose
            verify_installation
            exit 0
            ;;
        -a|--all|*)
            # æ‰§è¡Œæ‰€æœ‰æ“ä½œ
            ;;
    esac
    
    # æ‰§è¡Œå®Œæ•´æµç¨‹
    echo -e "${BLUE}å¼€å§‹ç³»ç»Ÿä¼˜åŒ–ä¸Dockerå‡†å¤‡...${NC}"
    
    detect_os
    check_architecture
    clean_system
    update_package_manager
    install_basic_dependencies
    configure_system_optimization
    configure_dns
    configure_docker_environment
    install_docker
    install_docker_compose
    
    echo -e "${GREEN}ğŸ‰ æ‰€æœ‰æ“ä½œå®Œæˆï¼${NC}"
    echo ""
    verify_installation
    echo ""
    echo -e "${YELLOW}ğŸ’¡ é‡è¦æç¤º:${NC}"
    echo -e "  1. å»ºè®®é‡å¯ç³»ç»Ÿä»¥ä½¿æ‰€æœ‰é…ç½®ç”Ÿæ•ˆ"
    echo -e "  2. å½“å‰ç”¨æˆ·å·²æ·»åŠ åˆ°dockerç»„ï¼Œé‡æ–°ç™»å½•åç”Ÿæ•ˆ"
    echo -e "  3. è¯¦ç»†æ—¥å¿—è¯·æŸ¥çœ‹: $LOG_FILE"
    echo -e "  4. è„šæœ¬å·²å°½å¯èƒ½èŠ‚çœç£ç›˜ç©ºé—´"
}

# è®¾ç½®é™·é˜±ï¼Œç¡®ä¿è„šæœ¬é€€å‡ºæ—¶é‡ç½®é¢œè‰²
trap 'echo -e "${NC}"' EXIT

# è¿è¡Œä¸»å‡½æ•°
main "$@"
