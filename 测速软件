#!/bin/bash
echo "Docker æµ‹é€Ÿå·¥å…·å®‰è£…è„šæœ¬ - ç¨³å®šç‰ˆ"

BASE_DIR="/opt/1panel/docker/compose/networks/speedtest"
mkdir -p $BASE_DIR

# åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
docker stop librespeed 2>/dev/null
docker rm librespeed 2>/dev/null

echo "æ­£åœ¨å®‰è£… LibreSpeed..."

# æ–¹æ³•1: ä½¿ç”¨æ›´ç¨³å®šçš„ linuxserver/librespeed é•œåƒ
docker run -d \
    --name librespeed \
    -p 8080:80 \
    -p 8081:81 \
    -e PUID=1000 \
    -e PGID=1000 \
    -e TZ=Asia/Shanghai \
    -v $BASE_DIR/librespeed/config:/config \
    --restart=unless-stopped \
    linuxserver/librespeed:latest

sleep 5

# æ£€æŸ¥æ˜¯å¦æˆåŠŸ
if [ $(docker inspect -f '{{.State.Running}}' librespeed 2>/dev/null) = "true" ]; then
    echo "âœ… LibreSpeed å®‰è£…æˆåŠŸ!"
else
    echo "âŒ æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2..."
    docker stop librespeed 2>/dev/null
    docker rm librespeed 2>/dev/null
    
    # æ–¹æ³•2: ä½¿ç”¨åŸå§‹é•œåƒä½†ç®€åŒ–é…ç½®
    docker run -d \
        --name librespeed \
        -p 8080:80 \
        --restart=on-failure:3 \
        adolfintel/speedtest:latest
fi

echo ""
echo "ç­‰å¾…10ç§’æ£€æŸ¥æœ€ç»ˆçŠ¶æ€..."
sleep 10

# æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
echo "=== æœ€ç»ˆå®‰è£…çŠ¶æ€ ==="
if docker ps -f name=librespeed | grep -q librespeed; then
    echo "âœ… LibreSpeed è¿è¡Œæ­£å¸¸"
    echo "ğŸ“Š è®¿é—®åœ°å€: http://ä½ çš„æœåŠ¡å™¨IP:8080"
    echo "ğŸ’¾ æ•°æ®ç›®å½•: $BASE_DIR/librespeed"
else
    echo "âŒ LibreSpeed å¯åŠ¨å¤±è´¥"
    echo "æŸ¥çœ‹æ—¥å¿—: docker logs librespeed"
fi

echo ""
docker ps -f name=librespeed --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
