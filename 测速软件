#!/bin/bash
echo "Docker æµ‹é€Ÿå·¥å…·å®‰è£…è„šæœ¬ - ç¨³å®šç‰ˆ"

# ä½¿ç”¨ä¸RustDeskç›¸åŒçš„ç›®å½•ç»“æ„
BASE_DIR="/data/speedtest"
mkdir -p $BASE_DIR

# åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
docker stop librespeed 2>/dev/null
docker rm librespeed 2>/dev/null

echo "æ­£åœ¨å®‰è£… LibreSpeed..."

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p $BASE_DIR/{config,results,logs}

# ä½¿ç”¨ç¨³å®šçš„ linuxserver/librespeed é•œåƒ
docker run -d \
    --name librespeed \
    -p 8080:80 \
    -p 8081:81 \
    -e PUID=1000 \
    -e PGID=1000 \
    -e TZ=Asia/Shanghai \
    # æŒ‰ç…§RustDeskçš„æŒ‚è½½æ¨¡å¼
    -v $BASE_DIR/config:/config \
    -v $BASE_DIR/results:/results \
    -v $BASE_DIR/logs:/logs \
    --restart=unless-stopped \
    linuxserver/librespeed:latest

echo "ç­‰å¾…å®¹å™¨å¯åŠ¨..."
sleep 10

# æ£€æŸ¥å®‰è£…çŠ¶æ€
if docker ps -f name=librespeed | grep -q librespeed; then
    echo "âœ… LibreSpeed å®‰è£…æˆåŠŸ!"
    echo "ğŸ“Š è®¿é—®åœ°å€: http://ä½ çš„æœåŠ¡å™¨IP:8080"
    echo "ğŸ’¾ æ•°æ®ç›®å½•: $BASE_DIR/"
else
    echo "âŒ å®‰è£…å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
    docker logs librespeed
fi

echo ""
echo "ç›®å½•ç»“æ„:"
ls -la $BASE_DIR/

echo ""
echo "å®¹å™¨çŠ¶æ€:"
docker ps -f name=librespeed --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
