cat > librespeed_install.sh << 'EOF'
#!/usr/bin/env bash
set -e

APP_NAME="librespeed"
DEFAULT_PORT=8000
WORKDIR="/root/librespeed"

echo "======================================="
echo " LibreSpeed å†…ç½‘æµ‹é€Ÿ Docker ä¸€é”®éƒ¨ç½²"
echo "======================================="

# root æ£€æŸ¥
if [ "$(id -u)" -ne 0 ]; then
  echo "âŒ è¯·ä½¿ç”¨ root è¿è¡Œ"
  exit 1
fi

# ç«¯å£é€‰æ‹©
read -p "è¯·è¾“å…¥è®¿é—®ç«¯å£ï¼ˆé»˜è®¤ ${DEFAULT_PORT}ï¼Œç›´æŽ¥å›žè½¦ä½¿ç”¨é»˜è®¤ï¼‰: " PORT
PORT=${PORT:-$DEFAULT_PORT}

# ç«¯å£ç®€å•æ ¡éªŒ
if ! [[ "$PORT" =~ ^[0-9]+$ ]] || [ "$PORT" -lt 1 ] || [ "$PORT" -gt 65535 ]; then
  echo "âŒ ç«¯å£ä¸åˆæ³•"
  exit 1
fi

echo "â–¶ ä½¿ç”¨ç«¯å£: $PORT"

# Docker æ£€æŸ¥
if ! command -v docker >/dev/null 2>&1; then
  echo "âŒ æœªæ£€æµ‹åˆ° Dockerï¼Œè¯·å…ˆå®‰è£… Docker"
  exit 1
fi

# docker compose æ£€æŸ¥
if ! docker compose version >/dev/null 2>&1; then
  echo "âŒ æœªæ£€æµ‹åˆ° docker compose æ’ä»¶"
  exit 1
fi

# åˆ›å»ºç›®å½•
mkdir -p "$WORKDIR"
cd "$WORKDIR"

# ç”Ÿæˆ docker-compose.yml
cat > docker-compose.yml <<YAML
version: '3'
services:
  librespeed:
    image: librespeed/speedtest:latest
    container_name: librespeed
    restart: always
    ports:
      - "${PORT}:80"
YAML

# å¯åŠ¨
echo "â–¶ å¯åŠ¨ LibreSpeed å®¹å™¨..."
docker compose up -d

# éªŒè¯
sleep 1
if docker ps | grep -q librespeed; then
  echo "âœ… LibreSpeed å¯åŠ¨æˆåŠŸ"
  echo "ðŸŒ è®¿é—®åœ°å€: http://$(hostname -I | awk '{print $1}'):${PORT}"
else
  echo "âŒ LibreSpeed å¯åŠ¨å¤±è´¥"
  docker compose logs
fi
EOF
