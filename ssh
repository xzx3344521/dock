#!/bin/bash
# ========================================================
# ğŸ›¡ï¸  secure-ssh-setup.sh
# è‡ªåŠ¨é…ç½® SSH æœåŠ¡ | æ”¯æŒå¯†é’¥ç™»å½• | é˜²ç«å¢™æ”¾è¡Œ | å®‰å…¨åŠ å›º
# ä½œè€…ï¼šAI åŠ©æ‰‹ | å…¼å®¹ Ubuntu/CentOS/Debian/RHEL
# æ— éœ€ Pythonï¼Œä¸€é”®è¿è¡Œ
# ========================================================

set -euo pipefail  # ä¸¥æ ¼æ¨¡å¼ï¼šå‡ºé”™é€€å‡ºã€æœªå®šä¹‰å˜é‡æŠ¥é”™ã€ç®¡é“é”™è¯¯æ•è·

# -------------------------------
# ğŸ”§ é…ç½®é€‰é¡¹ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
# -------------------------------

SSH_PORT=${SSH_PORT:-22}                    # SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼‰
ENABLE_PASSWORD_LOGIN=${ENABLE_PASSWORD_LOGIN:-yes}   # æ˜¯å¦å…è®¸å¯†ç ç™»å½•
ENABLE_ROOT_LOGIN=${ENABLE_ROOT_LOGIN:-no}            # æ˜¯å¦å…è®¸ root å¯†ç ç™»å½•ï¼ˆno æ›´å®‰å…¨ï¼‰
AUTO_INSTALL_SSH=${AUTO_INSTALL_SSH:-yes}             # æ˜¯å¦è‡ªåŠ¨å®‰è£… openssh-server
USE_KEY_LOGIN=${USE_KEY_LOGIN:-yes}                   # æ˜¯å¦ç”Ÿæˆå¯†é’¥å¹¶å¯ç”¨å¯†é’¥ç™»å½•

# -------------------------------
# ğŸ§° å·¥å…·å‡½æ•°
# -------------------------------

log() {
    echo "[$(date +'%H:%M:%S')] ğŸ“ $*"
}

success() {
    echo "[$(date +'%H:%M:%S')] âœ… $*"
}

error() {
    echo "[$(date +'%H:%M:%S')] âŒ $*" >&2
    exit 1
}

warn() {
    echo "[$(date +'%H:%M:%S')] âš ï¸  $*"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
has_cmd() {
    command -v "$1" &>/dev/null
}

# ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼ˆå¯è·³è¿‡ï¼‰
confirm() {
    if [[ "${FORCE:-}" == "yes" ]]; then
        return 0
    fi
    read -p "$1 [y/N]: " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && return 1
    return 0
}

# -------------------------------
# ğŸ–¥ï¸ æ£€æµ‹ç³»ç»Ÿä¿¡æ¯
# -------------------------------

detect_os() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        OS_NAME="$NAME"
        OS_ID="$ID"
        OS_VERSION="$VERSION_ID"
    elif [[ -f /etc/redhat-release ]]; then
        OS_NAME=$(cat /etc/redhat-release)
        OS_ID="rhel"
    else
        OS_NAME=$(uname -s)
        OS_ID="unknown"
    fi
    log "æ£€æµ‹åˆ°ç³»ç»Ÿ: $OS_NAME"
}

# -------------------------------
# ğŸ”§ å®‰è£… OpenSSH æœåŠ¡ï¼ˆå¦‚æœªå®‰è£…ï¼‰
# -------------------------------

install_ssh_server() {
    if has_cmd sshd || has_cmd ssh; then
        return 0
    fi

    if [[ "$AUTO_INSTALL_SSH" != "yes" ]]; then
        error "SSH æœåŠ¡æœªå®‰è£…ï¼Œä¸” AUTO_INSTALL_SSH=noï¼Œé€€å‡ºã€‚"
    fi

    log "OpenSSH æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."

    case "$OS_ID" in
        ubuntu|debian)
            DEBIAN_FRONTEND=noninteractive apt-get update -qq
            DEBIAN_FRONTEND=noninteractive apt-get install -y openssh-server
            ;;
        centos|rhel|almalinux|rocky)
            yum install -y openssh-server || true
            # å¯¹äºè¾ƒæ–°ç³»ç»Ÿä½¿ç”¨ dnf
            if ! has_cmd sshd && has_cmd dnf; then
                dnf install -y openssh-server
            fi
            ;;
        arch)
            pacman -S openssh
            ;;
        suse|opensuse)
            zypper install -y openssh
            ;;
        *)
            error "ä¸æ”¯æŒçš„ç³»ç»Ÿç±»å‹ï¼Œæ— æ³•è‡ªåŠ¨å®‰è£… SSH"
            ;;
    esac

    if ! has_cmd sshd && ! has_cmd ssh; then
        error "å®‰è£…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å®‰è£… openssh-server"
    fi

    success "OpenSSH å®‰è£…å®Œæˆ"
}

# -------------------------------
# âš™ï¸ é…ç½® SSH æœåŠ¡
# -------------------------------

configure_ssh() {
    local config="/etc/ssh/sshd_config"
    local backup="${config}.backup.$(date +%s)"

    # å¤‡ä»½åŸå§‹é…ç½®
    if [[ ! -f "$backup" && -f "$config" ]]; then
        cp "$config" "$backup"
        success "SSH é…ç½®å·²å¤‡ä»½: $backup"
    fi

    # ç¡®ä¿ç›®å½•å­˜åœ¨
    mkdir -p /etc/ssh

    # å†™å…¥åŸºç¡€é…ç½®ï¼ˆå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼‰
    if [[ ! -f "$config" ]]; then
        log "åˆ›å»ºæ–°çš„ sshd_config æ–‡ä»¶"
        {
            echo "Port $SSH_PORT"
            echo "PermitRootLogin $( [[ "$ENABLE_ROOT_LOGIN" == "yes" ]] && echo "yes" || echo "prohibit-password" )"
            echo "PasswordAuthentication $ENABLE_PASSWORD_LOGIN"
            echo "PubkeyAuthentication yes"
            echo "AuthorizedKeysFile .ssh/authorized_keys"
            echo "ChallengeResponseAuthentication no"
            echo "UsePAM yes"
            echo "X11Forwarding yes"
            echo "PrintMotd no"
            echo "AcceptEnv LANG LC_*"
            echo "Subsystem sftp /usr/lib/openssh/sftp-server"
        } > "$config"
    else
        # ä¿®æ”¹ç°æœ‰é…ç½®
        sed -i "s/^#*Port .*/Port $SSH_PORT/" "$config"
        sed -i "s/^#*PermitRootLogin .*/PermitRootLogin $( [[ "$ENABLE_ROOT_LOGIN" == "yes" ]] && echo "yes" || echo "prohibit-password" )/" "$config"
        sed -i "s/^#*PasswordAuthentication .*/PasswordAuthentication $ENABLE_PASSWORD_LOGIN/" "$config"
        sed -i "s/^#*PubkeyAuthentication .*/PubkeyAuthentication yes/" "$config"
        sed -i "s/^#*AuthorizedKeysFile .*/AuthorizedKeysFile .ssh\/authorized_keys/" "$config"
    fi

    success "SSH é…ç½®å·²æ›´æ–° (ç«¯å£: $SSH_PORT)"
}

# -------------------------------
# â–¶ï¸ å¯åŠ¨å¹¶å¯ç”¨ SSH æœåŠ¡
# -------------------------------

start_ssh_service() {
    local service=""

    for s in sshd ssh; do
        if systemctl list-unit-files | grep -q "$s"; then
            service="$s"
            break
        fi
    done

    if [[ -z "$service" ]]; then
        error "æœªæ‰¾åˆ° SSH æœåŠ¡ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®‰è£…æ­£ç¡®"
    fi

    if systemctl is-active --quiet "$service"; then
        success "$service å·²åœ¨è¿è¡Œ"
    else
        log "å¯åŠ¨ $service æœåŠ¡..."
        systemctl start "$service" && systemctl enable "$service"
        success "$service å·²å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯"
    fi

    # æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
    if ! has_cmd ss && has_cmd netstat; then
        if ! netstat -tuln | grep -q ":$SSH_PORT\b"; then
            warn "ç«¯å£ $SSH_PORT æœªç›‘å¬ï¼Œå°è¯•é‡å¯..."
            systemctl restart "$service"
            sleep 2
            if ! netstat -tuln | grep -q ":$SSH_PORT\b"; then
                error "SSH æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: journalctl -u $service"
            fi
        fi
    else
        if ! ss -tuln | grep -q ":$SSH_PORT\b"; then
            warn "ç«¯å£ $SSH_PORT æœªç›‘å¬ï¼Œå°è¯•é‡å¯..."
            systemctl restart "$service"
            sleep 2
            if ! ss -tuln | grep -q ":$SSH_PORT\b"; then
                error "SSH æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: journalctl -u $service"
            fi
        fi
    fi
}

# -------------------------------
# ğŸ”¥ é…ç½®é˜²ç«å¢™
# -------------------------------

setup_firewall() {
    if has_cmd ufw; then
        if ! ufw status | grep -q inactive; then
            ufw allow "$SSH_PORT/tcp" && success "UFW: æ”¾è¡Œç«¯å£ $SSH_PORT"
        else
            log "UFW å¤„äºéæ´»åŠ¨çŠ¶æ€ï¼Œå¯ç”¨ä¸­..."
            yes | ufw enable && ufw allow "$SSH_PORT/tcp"
            success "UFW å·²å¯ç”¨å¹¶æ”¾è¡Œ $SSH_PORT"
        fi
    elif has_cmd firewall-cmd; then
        if firewall-cmd --state &>/dev/null; then
            firewall-cmd --permanent --add-port="$SSH_PORT"/tcp --zone=public
            firewall-cmd --reload
            success "Firewalld: æ”¾è¡Œç«¯å£ $SSH_PORT"
        else
            warn "Firewalld æœªè¿è¡Œ"
        fi
    elif has_cmd iptables; then
        iptables -A INPUT -p tcp --dport "$SSH_PORT" -j ACCEPT
        success "Iptables: æ”¾è¡Œç«¯å£ $SSH_PORT"
    else
        warn "æœªæ£€æµ‹åˆ° UFWã€Firewalld æˆ– Iptablesï¼Œè·³è¿‡é˜²ç«å¢™é…ç½®"
    fi
}

# -------------------------------
# ğŸ”‘ é…ç½®å¯†é’¥ç™»å½•
# -------------------------------

setup_key_login() {
    if [[ "$USE_KEY_LOGIN" != "yes" ]]; then
        return
    fi

    local user="${SUDO_USER:-$USER}"
    local home
    home=$(getent passwd "$user" | cut -d: -f6) || error "æ— æ³•è·å–ç”¨æˆ· $user çš„å®¶ç›®å½•"

    if [[ -z "$home" || ! -d "$home" ]]; then
        error "ç”¨æˆ· $user çš„å®¶ç›®å½•ä¸å­˜åœ¨"
    fi

    local ssh_dir="$home/.ssh"
    local key_file="$ssh_dir/id_rsa"
    local pub_key="$key_file.pub"
    local auth_keys="$ssh_dir/authorized_keys"

    mkdir -p "$ssh_dir"
    chmod 700 "$ssh_dir"

    # ç”Ÿæˆå¯†é’¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [[ ! -f "$key_file" ]]; then
        log "ä¸ºç”¨æˆ· $user ç”Ÿæˆ SSH å¯†é’¥å¯¹..."
        if sudo -u "$user" ssh-keygen -t rsa -b 2048 -f "$key_file" -N "" </dev/null 2>/dev/null; then
            success "å¯†é’¥å·²ç”Ÿæˆ: $key_file"
        else
            warn "å¯†é’¥ç”Ÿæˆå¤±è´¥ï¼Œè·³è¿‡"
            return
        fi
    fi

    # æ·»åŠ å…¬é’¥åˆ° authorized_keys
    if [[ -f "$pub_key" ]]; then
        mkdir -p "$ssh_dir"
        cat "$pub_key" >> "$auth_keys" 2>/dev/null || true
        chmod 600 "$auth_keys"
        chown -R "$user:$user" "$ssh_dir"
        success "å…¬é’¥å·²æ·»åŠ åˆ° $auth_keysï¼Œæ”¯æŒå¯†é’¥ç™»å½•"
    fi
}

# -------------------------------
# ğŸ§¹ æ¸…ç†ä¸´æ—¶å˜é‡
# -------------------------------

cleanup() {
    unset SSH_PORT ENABLE_PASSWORD_LOGIN ENABLE_ROOT_LOGIN AUTO_INSTALL_SSH USE_KEY_LOGIN FORCE
}

# -------------------------------
# ğŸš€ ä¸»å‡½æ•°
# -------------------------------

main() {
    log "å¼€å§‹é…ç½® SSH æœåŠ¡..."

    # æç¤ºç”¨æˆ·
    echo
    echo "é…ç½®æ‘˜è¦ï¼š"
    echo "  SSH ç«¯å£: $SSH_PORT"
    echo "  å…è®¸å¯†ç ç™»å½•: $ENABLE_PASSWORD_LOGIN"
    echo "  å…è®¸ root ç™»å½•: $ENABLE_ROOT_LOGIN"
    echo "  è‡ªåŠ¨ç”Ÿæˆå¯†é’¥: $USE_KEY_LOGIN"
    echo

    if ! confirm "ç¡®è®¤æ‰§è¡Œé…ç½®ï¼Ÿ"; then
        log "ç”¨æˆ·å–æ¶ˆï¼Œé€€å‡ºã€‚"
        exit 1
    fi

    detect_os
    install_ssh_server
    configure_ssh
    start_ssh_service
    setup_firewall
    setup_key_login

    # æœ€ç»ˆæç¤º
    echo
    echo "=================================================="
    echo "âœ… SSH é…ç½®å®Œæˆï¼"
    echo "ğŸ”‘ ç™»å½•æ–¹å¼ï¼š"
    echo "    å¯†é’¥ç™»å½•: ssh -i ~/.ssh/id_rsa $USER@localhost"
    echo "    æˆ–å¤åˆ¶å…¬é’¥åˆ°è¿œç¨‹: ssh-copy-id user@host"
    if [[ "$SSH_PORT" != "22" ]]; then
        echo "    æ³¨æ„ç«¯å£: -p $SSH_PORT"
    fi
    echo "ğŸ’¡ å»ºè®®ï¼šç”Ÿäº§ç¯å¢ƒå…³é—­ PasswordAuthentication"
    echo "=================================================="
}

# -------------------------------
# âœ… æ‰§è¡Œ
# -------------------------------

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    if [[ $(id -u) -ne 0 ]]; then
        error "è¯·ä½¿ç”¨ sudo æˆ– root æƒé™è¿è¡Œæ­¤è„šæœ¬"
    fi
    main "$@"
    cleanup
fi
