#!/bin/bash

# è‡ªåŠ¨æ›´æ”¹SSHç«¯å£å’Œrootå¯†ç è„šæœ¬ï¼ˆå¸¦è‡ªåŠ¨å›æ»šåŠŸèƒ½ï¼‰
# æ”¯æŒ Ubuntu/Debian/CentOS/RHEL ç³»ç»Ÿ

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®å˜é‡
NEW_PORT="2222"
NEW_PASSWORD="Xx3459635287"
ROLLBACK_TIME=300  # 5åˆ†é’Ÿå›æ»šæ—¶é—´ï¼ˆç§’ï¼‰
CHECK_INTERVAL=10  # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰

# å…¨å±€å˜é‡
BACKUP_FILE=""
ORIGINAL_PORT=""
OS=""

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_debug() {
    echo -e "${BLUE}[DEBUG]${NC} $1"
}

# æ£€æŸ¥rootæƒé™
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œ"
        exit 1
    fi
}

# æ£€æµ‹ç³»ç»Ÿç±»å‹
detect_os() {
    if [[ -f /etc/redhat-release ]]; then
        OS="centos"
    elif [[ -f /etc/debian_version ]]; then
        OS="debian"
    elif grep -q "ubuntu" /etc/os-release; then
        OS="ubuntu"
    else
        log_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ"
        exit 1
    fi
    log_info "æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS"
}

# è·å–å½“å‰SSHç«¯å£
get_current_ssh_port() {
    local ssh_config="/etc/ssh/sshd_config"
    if grep -q "^Port" "$ssh_config"; then
        ORIGINAL_PORT=$(grep "^Port" "$ssh_config" | awk '{print $2}')
    else
        ORIGINAL_PORT="22"
    fi
    log_info "æ£€æµ‹åˆ°å½“å‰SSHç«¯å£: $ORIGINAL_PORT"
}

# å¤‡ä»½SSHé…ç½®æ–‡ä»¶
backup_ssh_config() {
    local ssh_config="/etc/ssh/sshd_config"
    BACKUP_FILE="/etc/ssh/sshd_config.backup.$(date +%Y%m%d%H%M%S)"
    
    if [[ -f "$ssh_config" ]]; then
        cp "$ssh_config" "$BACKUP_FILE"
        log_info "SSHé…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ°: $BACKUP_FILE"
    else
        log_error "SSHé…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $ssh_config"
        exit 1
    fi
}

# æ›´æ”¹SSHç«¯å£
change_ssh_port() {
    local ssh_config="/etc/ssh/sshd_config"
    
    log_info "æ­£åœ¨æ›´æ”¹SSHç«¯å£ä¸º: $NEW_PORT"
    
    # æ£€æŸ¥ç«¯å£æ˜¯å¦å·²è¢«ä½¿ç”¨
    if netstat -tuln 2>/dev/null | grep ":$NEW_PORT " > /dev/null; then
        log_error "ç«¯å£ $NEW_PORT å·²è¢«å ç”¨"
        exit 1
    fi
    
    if ss -tuln 2>/dev/null | grep ":$NEW_PORT " > /dev/null; then
        log_error "ç«¯å£ $NEW_PORT å·²è¢«å ç”¨"
        exit 1
    fi
    
    # å¤‡ä»½åŸé…ç½®
    backup_ssh_config
    
    # æ³¨é‡Šæ‰åŸæœ‰çš„Portè¡Œ
    sed -i 's/^Port/#Port/g' "$ssh_config"
    
    # æ·»åŠ æ–°çš„Porté…ç½®
    echo "Port $NEW_PORT" >> "$ssh_config"
    
    # ç¡®ä¿å…è®¸rootç™»å½•
    sed -i 's/^#PermitRootLogin yes/PermitRootLogin yes/g' "$ssh_config"
    sed -i 's/^PermitRootLogin no/PermitRootLogin yes/g' "$ssh_config"
    sed -i 's/^#PermitRootLogin no/PermitRootLogin yes/g' "$ssh_config"
    if ! grep -q "^PermitRootLogin" "$ssh_config"; then
        echo "PermitRootLogin yes" >> "$ssh_config"
    fi
    
    log_info "SSHç«¯å£å·²æ›´æ”¹ä¸º: $NEW_PORT"
}

# æ›´æ”¹rootå¯†ç 
change_root_password() {
    local old_password_backup=""
    
    log_info "æ­£åœ¨æ›´æ”¹rootå¯†ç ..."
    
    # å¤‡ä»½æ—§å¯†ç å“ˆå¸Œï¼ˆç”¨äºå›æ»šï¼‰
    old_password_backup=$(grep '^root:' /etc/shadow | cut -d: -f2)
    echo "$old_password_backup" > /tmp/old_root_password.hash
    
    # æ›´æ”¹rootå¯†ç 
    echo "root:$NEW_PASSWORD" | chpasswd
    
    if [[ $? -eq 0 ]]; then
        log_info "rootå¯†ç å·²æˆåŠŸæ›´æ”¹"
        log_warn "æ–°å¯†ç : $NEW_PASSWORD"
        log_warn "è¯·å¦¥å–„ä¿ç®¡å¯†ç å¹¶åŠæ—¶ä¿®æ”¹"
    else
        log_error "æ›´æ”¹rootå¯†ç å¤±è´¥"
        exit 1
    fi
}

# é…ç½®é˜²ç«å¢™
configure_firewall() {
    log_info "é…ç½®é˜²ç«å¢™è§„åˆ™..."
    
    case $OS in
        "centos"|"rhel")
            if command -v firewall-cmd &> /dev/null; then
                firewall-cmd --permanent --add-port=$NEW_PORT/tcp
                firewall-cmd --reload
                log_info "Firewalldå·²é…ç½®ç«¯å£ $NEW_PORT"
            elif command -v iptables &> /dev/null; then
                iptables -I INPUT -p tcp --dport $NEW_PORT -j ACCEPT
                service iptables save 2>/dev/null || iptables-save > /etc/sysconfig/iptables
                log_info "iptableså·²é…ç½®ç«¯å£ $NEW_PORT"
            fi
            ;;
        "ubuntu"|"debian")
            if command -v ufw &> /dev/null && ufw status | grep -q "active"; then
                ufw allow $NEW_PORT/tcp
                log_info "UFWå·²é…ç½®ç«¯å£ $NEW_PORT"
            elif command -v iptables &> /dev/null; then
                iptables -I INPUT -p tcp --dport $NEW_PORT -j ACCEPT
                iptables-save > /etc/iptables/rules.v4 2>/dev/null || true
                log_info "iptableså·²é…ç½®ç«¯å£ $NEW_PORT"
            fi
            ;;
    esac
}

# æ£€æŸ¥SELinux
check_selinux() {
    if command -v getenforce &> /dev/null; then
        if [[ $(getenforce) != "Disabled" ]]; then
            log_warn "æ£€æµ‹åˆ°SELinuxå·²å¯ç”¨ï¼Œéœ€è¦é…ç½®SELinuxè§„åˆ™"
            if command -v semanage &> /dev/null; then
                semanage port -a -t ssh_port_t -p tcp $NEW_PORT 2>/dev/null || \
                semanage port -m -t ssh_port_t -p tcp $NEW_PORT
                log_info "SELinuxå·²é…ç½®å…è®¸SSHç«¯å£ $NEW_PORT"
            else
                log_warn "SELinuxå·²å¯ç”¨ä½†semanageå‘½ä»¤ä¸å¯ç”¨ï¼Œå»ºè®®å®‰è£…policycoreutils-python-utils"
            fi
        fi
    fi
}

# é‡å¯SSHæœåŠ¡
restart_ssh_service() {
    log_info "é‡å¯SSHæœåŠ¡..."
    
    case $OS in
        "centos"|"rhel")
            if systemctl is-active sshd &> /dev/null; then
                systemctl restart sshd
            else
                systemctl restart ssh
            fi
            ;;
        "ubuntu"|"debian")
            systemctl restart ssh
            ;;
    esac
    
    sleep 2  # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
    
    if systemctl is-active ssh >/dev/null 2>&1 || systemctl is-active sshd >/dev/null 2>&1; then
        log_info "SSHæœåŠ¡é‡å¯æˆåŠŸ"
    else
        log_error "SSHæœåŠ¡é‡å¯å¤±è´¥"
        return 1
    fi
}

# å›æ»šå‡½æ•°
rollback_changes() {
    log_warn "å¼€å§‹å›æ»šé…ç½®..."
    
    # æ¢å¤SSHé…ç½®æ–‡ä»¶
    if [[ -f "$BACKUP_FILE" ]]; then
        cp "$BACKUP_FILE" "/etc/ssh/sshd_config"
        log_info "å·²æ¢å¤SSHé…ç½®æ–‡ä»¶"
    fi
    
    # æ¢å¤rootå¯†ç 
    if [[ -f "/tmp/old_root_password.hash" ]]; then
        local old_hash=$(cat /tmp/old_root_password.hash)
        usermod -p "$old_hash" root 2>/dev/null
        rm -f /tmp/old_root_password.hash
        log_info "å·²æ¢å¤rootå¯†ç "
    fi
    
    # é‡å¯SSHæœåŠ¡
    restart_ssh_service
    
    # æ¢å¤é˜²ç«å¢™è§„åˆ™
    case $OS in
        "centos"|"rhel")
            if command -v firewall-cmd &> /dev/null; then
                firewall-cmd --permanent --remove-port=$NEW_PORT/tcp
                firewall-cmd --reload
            fi
            ;;
        "ubuntu"|"debian")
            if command -v ufw &> /dev/null && ufw status | grep -q "active"; then
                ufw delete allow $NEW_PORT/tcp
            fi
            ;;
    esac
    log_info "å·²æ¢å¤é˜²ç«å¢™è§„åˆ™"
    
    log_info "å›æ»šå®Œæˆï¼å·²æ¢å¤æ‰€æœ‰åŸå§‹é…ç½®"
}

# éªŒè¯æ›´æ”¹
verify_changes() {
    log_info "éªŒè¯æ›´æ”¹..."
    
    # æ£€æŸ¥SSHæœåŠ¡çŠ¶æ€
    case $OS in
        "centos"|"rhel")
            if systemctl is-active sshd &> /dev/null; then
                systemctl status sshd --no-pager -l | head -5
            else
                systemctl status ssh --no-pager -l | head -5
            fi
            ;;
        "ubuntu"|"debian")
            systemctl status ssh --no-pager -l | head -5
            ;;
    esac
    
    # æ£€æŸ¥ç«¯å£ç›‘å¬
    if ss -tuln | grep ":$NEW_PORT " > /dev/null || netstat -tuln 2>/dev/null | grep ":$NEW_PORT " > /dev/null; then
        log_info "SSHæœåŠ¡æ­£åœ¨ç›‘å¬ç«¯å£ $NEW_PORT"
        return 0
    else
        log_error "SSHæœåŠ¡æœªåœ¨ç«¯å£ $NEW_PORT ç›‘å¬"
        return 1
    fi
}

# æ‰‹åŠ¨ç¡®è®¤éªŒè¯å‡½æ•°
manual_verification() {
    local start_time=$(date +%s)
    local current_time=0
    local elapsed_time=0
    
    echo "=========================================="
    log_info "â° æ‚¨æœ‰ 5 åˆ†é’Ÿæ—¶é—´æµ‹è¯•æ–°é…ç½®"
    log_info "ğŸ”‘ æµ‹è¯•è¿æ¥ä¿¡æ¯ï¼š"
    echo ""
    echo "   IP: $(hostname -I | awk '{print $1}')"
    echo "   ç«¯å£: $NEW_PORT" 
    echo "   å¯†ç : $NEW_PASSWORD"
    echo ""
    echo "   æµ‹è¯•å‘½ä»¤:"
    echo "   ssh root@$(hostname -I | awk '{print $1}') -p $NEW_PORT"
    echo ""
    log_info "ğŸ’¡ æç¤ºï¼šè¯·åœ¨æ–°ç»ˆç«¯çª—å£ä¸­æµ‹è¯•è¿æ¥"
    log_info "     æˆåŠŸç™»å½•åè¯·è¿”å›æ­¤çª—å£è¾“å…¥ 'confirm' ç¡®è®¤"
    echo "=========================================="
    
    while true; do
        current_time=$(date +%s)
        elapsed_time=$((current_time - start_time))
        local remaining_time=$((ROLLBACK_TIME - elapsed_time))
        
        # æ£€æŸ¥æ˜¯å¦è¶…æ—¶
        if [[ $elapsed_time -ge $ROLLBACK_TIME ]]; then
            log_warn "â° è¶…æ—¶ï¼šåœ¨ 5 åˆ†é’Ÿå†…æœªæ”¶åˆ°ç¡®è®¤"
            echo ""
            return 1
        fi
        
        # æ˜¾ç¤ºå‰©ä½™æ—¶é—´
        if [[ $((elapsed_time % 30)) -eq 0 ]]; then
            echo ""
            log_info "å‰©ä½™æ—¶é—´: $((remaining_time / 60))åˆ†$((remaining_time % 60))ç§’"
            echo "è¯·è¾“å…¥ 'confirm' ç¡®è®¤æˆåŠŸï¼Œæˆ–ç­‰å¾…è‡ªåŠ¨å›æ»š..."
        fi
        
        # è®¾ç½®è¶…æ—¶è¯»å–ï¼Œé¿å…æ°¸ä¹…é˜»å¡
        if read -t 10 -p "è¯·è¾“å…¥ 'confirm' ç¡®è®¤: " user_confirm; then
            if [[ $user_confirm == "confirm" ]]; then
                log_info "âœ… ç”¨æˆ·ç¡®è®¤æˆåŠŸï¼Œæ–°é…ç½®å°†æ°¸ä¹…ç”Ÿæ•ˆ"
                echo ""
                return 0
            else
                log_warn "æ— æ•ˆè¾“å…¥ï¼Œè¯·è¾“å…¥ 'confirm'"
            fi
        fi
        
        # æ¯10ç§’æ˜¾ç¤ºä¸€æ¬¡æç¤º
        if [[ $((elapsed_time % 10)) -eq 0 ]]; then
            echo "ç­‰å¾…ç¡®è®¤ä¸­... (å‰©ä½™ $((remaining_time / 60))åˆ†$((remaining_time % 60))ç§’)"
        fi
    done
}

# æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
show_warning() {
    echo "=========================================="
    log_warn "              é‡è¦è­¦å‘Š!"
    echo "=========================================="
    log_warn "æ­¤è„šæœ¬å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œ:"
    log_warn "  â€¢ æ›´æ”¹SSHç«¯å£ä¸º $NEW_PORT"
    log_warn "  â€¢ æ›´æ”¹rootå¯†ç ä¸º $NEW_PASSWORD" 
    log_warn "  â€¢ ä¿®æ”¹é˜²ç«å¢™é…ç½®"
    log_warn "  â€¢ é‡å¯SSHæœåŠ¡"
    echo "=========================================="
    log_warn "å®‰å…¨æœºåˆ¶:"
    log_warn "  â€¢ å¦‚æœ5åˆ†é’Ÿå†…æ²¡æœ‰ç¡®è®¤æ–°é…ç½®å·¥ä½œæ­£å¸¸"
    log_warn "  â€¢ ç³»ç»Ÿå°†è‡ªåŠ¨å›æ»šåˆ°åŸå§‹é…ç½®"
    echo "=========================================="
    log_warn "åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿:"
    log_warn "  â€¢ æ‚¨æœ‰æœåŠ¡å™¨çš„ç‰©ç†è®¿é—®æƒé™"
    log_warn "  â€¢ æ‚¨äº†è§£æ“ä½œé£é™©"
    log_warn "  â€¢ æ‚¨å·²ç»å¤‡ä»½äº†é‡è¦æ•°æ®"
    echo "=========================================="
    
    # ç›´æ¥ç­‰å¾…å›è½¦ï¼Œé¿å…è¾“å…¥é—®é¢˜
    echo -e "${YELLOW}æŒ‰å›è½¦é”®ç»§ç»­ï¼Œæˆ–æŒ‰ Ctrl+C å–æ¶ˆ...${NC}"
    read
}

# æ¸…ç†å‡½æ•°
cleanup() {
    rm -f /tmp/old_root_password.hash
}

# ä¿¡å·å¤„ç†
setup_signal_handlers() {
    trap 'echo; log_warn "æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œå¼€å§‹å›æ»š..."; rollback_changes; cleanup; exit 1' INT TERM
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹æ‰§è¡ŒSSHé…ç½®è„šæœ¬ï¼ˆå¸¦è‡ªåŠ¨å›æ»šåŠŸèƒ½ï¼‰"
    
    # è®¾ç½®ä¿¡å·å¤„ç†
    setup_signal_handlers
    
    show_warning
    check_root
    detect_os
    get_current_ssh_port
    
    # æ‰§è¡Œé…ç½®æ›´æ”¹
    change_ssh_port
    change_root_password
    configure_firewall
    check_selinux
    
    if ! restart_ssh_service; then
        log_error "SSHæœåŠ¡é‡å¯å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
        rollback_changes
        exit 1
    fi
    
    if ! verify_changes; then
        log_error "é…ç½®éªŒè¯å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
        rollback_changes
        exit 1
    fi
    
    # å¯åŠ¨æ‰‹åŠ¨éªŒè¯
    log_info "å¯åŠ¨é…ç½®éªŒè¯é˜¶æ®µ..."
    if manual_verification; then
        log_info "âœ… é…ç½®éªŒè¯æˆåŠŸï¼æ–°SSHé…ç½®å·²ç”Ÿæ•ˆ"
        log_info "âœ… ç«¯å£: $NEW_PORT"
        log_info "âœ… è¯·å¦¥å–„ä¿ç®¡æ–°å¯†ç "
        
        # è¯¢é—®æ˜¯å¦ä¿ç•™åŸç«¯å£
        echo "=========================================="
        if read -p "æ˜¯å¦åŒæ—¶ä¿ç•™åŸSSHç«¯å£ $ORIGINAL_PORT? (y/n): " keep_original && [[ $keep_original == "y" || $keep_original == "Y" ]]; then
            log_info "æ¢å¤åŸç«¯å£é…ç½®..."
            # æ¢å¤åŸç«¯å£é…ç½®
            if [[ -f "$BACKUP_FILE" ]]; then
                # ä»å¤‡ä»½æ–‡ä»¶ä¸­æå–åŸPorté…ç½®
                original_port_line=$(grep "^Port" "$BACKUP_FILE" | head -1)
                if [[ -n "$original_port_line" ]]; then
                    echo "$original_port_line" >> "/etc/ssh/sshd_config"
                else
                    echo "Port $ORIGINAL_PORT" >> "/etc/ssh/sshd_config"
                fi
            else
                echo "Port $ORIGINAL_PORT" >> "/etc/ssh/sshd_config"
            fi
            
            if restart_ssh_service; then
                log_info "ç°åœ¨æ”¯æŒåŒç«¯å£: $ORIGINAL_PORT å’Œ $NEW_PORT"
            else
                log_error "é‡å¯SSHæœåŠ¡å¤±è´¥ï¼Œä½†æ–°ç«¯å£é…ç½®å·²ç”Ÿæ•ˆ"
            fi
        fi
        
        cleanup
        log_info "ğŸ‰ è„šæœ¬æ‰§è¡Œå®Œæˆï¼æ–°é…ç½®å·²æ°¸ä¹…ç”Ÿæ•ˆ"
    else
        log_error "âŒ é…ç½®éªŒè¯å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
        rollback_changes
        cleanup
        exit 1
    fi
}

# æ£€æŸ¥æ˜¯å¦ç›´æ¥è¿è¡Œè„šæœ¬
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
