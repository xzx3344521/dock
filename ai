#!/bin/bash

# çœŸæ­£çš„AIé©±åŠ¨é—®é¢˜è§£å†³è„šæœ¬
# å®Œå…¨äº¤ç»™AIæ“ä½œï¼Œè‡ªåŠ¨è¯†åˆ«å’Œä¿®å¤é—®é¢˜

set -e

# é…ç½®
DEEPSEEK_API_KEY="sk-your-api-key-here"  # è¯·æ›¿æ¢ä¸ºä½ çš„çœŸå®APIå¯†é’¥
LOG_FILE="/tmp/ai_solver.log"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
    echo -e "${BLUE}[AIåŠ©æ‰‹]${NC} $1"
}

# è°ƒç”¨AIåˆ†æé—®é¢˜
ask_ai() {
    local problem="$1"
    local context="$2"
    
    log "ğŸ¤– å’¨è¯¢AIè§£å†³æ–¹æ¡ˆ: $problem"
    
    # å‡†å¤‡APIè¯·æ±‚
    local request_data=$(cat << EOF
{
    "model": "deepseek-coder",
    "messages": [
        {
            "role": "system",
            "content": "ä½ æ˜¯ä¸€ä¸ªLinuxç³»ç»Ÿå’Œè„šæœ¬é—®é¢˜ä¸“å®¶ã€‚ç”¨æˆ·é‡åˆ°äº†è„šæœ¬æ‰§è¡Œé—®é¢˜ï¼Œè¯·ç›´æ¥ç»™å‡ºå…·ä½“çš„ä¿®å¤å‘½ä»¤ã€‚ç”¨ä¸­æ–‡å›ç­”ï¼Œè¦å…·ä½“å¯æ‰§è¡Œã€‚"
        },
        {
            "role": "user",
            "content": "é—®é¢˜ï¼š$problem\n\nä¸Šä¸‹æ–‡ï¼š$context\n\nè¯·ç›´æ¥ç»™å‡ºéœ€è¦æ‰§è¡Œçš„Linuxå‘½ä»¤ï¼š"
        }
    ],
    "temperature": 0.3,
    "max_tokens": 1000
}
EOF
    )

    # è°ƒç”¨API
    local response=$(curl -s -X POST "https://api.deepseek.com/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
        -d "$request_data" || echo "AIè¯·æ±‚å¤±è´¥")

    # æå–å›å¤
    local answer=$(echo "$response" | grep -o '"content":"[^"]*"' | cut -d'"' -f4)
    
    if [ -z "$answer" ] || [ "$answer" = "AIè¯·æ±‚å¤±è´¥" ]; then
        echo "å¤‡ç”¨æ–¹æ¡ˆï¼šæ£€æµ‹åˆ°è„šæœ¬æ‰§è¡Œé—®é¢˜ï¼Œå°†é‡‡ç”¨æœ¬åœ°ä¿®å¤æ–¹æ¡ˆ"
        return 1
    fi
    
    echo "$answer"
}

# æ‰§è¡ŒAIå‘½ä»¤
execute_ai_command() {
    local command="$1"
    local description="$2"
    
    log "æ‰§è¡Œ: $description"
    log "å‘½ä»¤: $command"
    
    echo -e "${YELLOW}â–¶ï¸ æ‰§è¡Œ: $command${NC}"
    
    # æ‰§è¡Œå‘½ä»¤
    eval "$command" 2>&1 | while IFS= read -r line; do
        echo "   $line"
        echo "$line" >> "$LOG_FILE"
    done
    
    local exit_code=${PIPESTATUS[0]}
    return $exit_code
}

# åˆ†æå½“å‰é—®é¢˜
analyze_current_problem() {
    log "åˆ†æå½“å‰ç³»ç»Ÿé—®é¢˜..."
    
    # æ”¶é›†ç³»ç»Ÿä¿¡æ¯
    local system_info=$(uname -a)
    local os_info=$(cat /etc/os-release 2>/dev/null || echo "Unknown OS")
    local python_version=$(python3 --version 2>/dev/null || echo "Python not installed")
    local bash_version=$(bash --version | head -1)
    
    # æµ‹è¯•è„šæœ¬URL
    local test_url="https://github.com/xzx3344521/dock/raw/refs/heads/main/ai"
    local script_content=$(curl -sSL "$test_url" 2>/dev/null || echo "ä¸‹è½½å¤±è´¥")
    
    local problem_context="ç³»ç»Ÿä¿¡æ¯: $system_info
OSä¿¡æ¯: $os_info
Pythonç‰ˆæœ¬: $python_version
Bashç‰ˆæœ¬: $bash_version

è„šæœ¬URL: $test_url
è„šæœ¬å†…å®¹å‰å‡ è¡Œ:
$(echo "$script_content" | head -10)

é”™è¯¯ç°è±¡: è„šæœ¬å†…å®¹è¢«ç›´æ¥æ˜¾ç¤ºè€Œä¸æ˜¯æ‰§è¡Œï¼Œå‡ºç° 'command not found' é”™è¯¯"

    echo "$problem_context"
}

# ä¸»è¦ä¿®å¤å‡½æ•°
main_repair() {
    echo -e "${GREEN}ğŸš€ å¯åŠ¨AIé—®é¢˜ä¿®å¤ç³»ç»Ÿ...${NC}"
    echo -e "${YELLOW}âš ï¸ å…¨ç¨‹äº¤ç»™AIæ“ä½œï¼Œè¯·å‹¿ä¸­æ–­...${NC}"
    
    # åˆ†æé—®é¢˜
    local problem_context=$(analyze_current_problem)
    local problem_description="ç”¨æˆ·å°è¯•æ‰§è¡Œè¿œç¨‹è„šæœ¬ä½†å¤±è´¥ï¼Œè„šæœ¬å†…å®¹è¢«æ˜¾ç¤ºè€Œä¸æ˜¯æ‰§è¡Œï¼Œå‡ºç°å‘½ä»¤æœªæ‰¾åˆ°é”™è¯¯"
    
    log "é—®é¢˜æè¿°: $problem_description"
    
    # è¯¢é—®AIè§£å†³æ–¹æ¡ˆ
    local ai_solution=$(ask_ai "$problem_description" "$problem_context")
    
    if [ $? -ne 0 ] || [ -z "$ai_solution" ]; then
        # AIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        backup_solution
        return
    fi
    
    echo -e "${GREEN}ğŸ¤– AIæä¾›çš„è§£å†³æ–¹æ¡ˆ:${NC}"
    echo "$ai_solution"
    echo ""
    
    # æå–å¹¶æ‰§è¡Œå‘½ä»¤
    execute_ai_commands "$ai_solution"
}

# æ‰§è¡ŒAIè¿”å›çš„å‘½ä»¤
execute_ai_commands() {
    local solution="$1"
    
    # æå–çœ‹èµ·æ¥åƒå‘½ä»¤çš„è¡Œ
    echo -e "${YELLOW}ğŸ”§ å¼€å§‹æ‰§è¡Œä¿®å¤å‘½ä»¤...${NC}"
    
    while IFS= read -r line; do
        # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
        if [[ -z "$line" || "$line" =~ ^# ]]; then
            continue
        fi
        
        # è¯†åˆ«å‘½ä»¤ï¼ˆä»¥sudo, apt, curl, wget, python, bashç­‰å¼€å¤´ï¼‰
        if [[ "$line" =~ ^(sudo\s+|apt\s+|curl\s+|wget\s+|python|bash\s+|chmod\s+|mkdir\s+|cd\s+|echo\s+) ]]; then
            log "æ‰§è¡ŒAIå‘½ä»¤: $line"
            execute_ai_command "$line" "AIä¿®å¤å‘½ä»¤"
        fi
    done <<< "$solution"
}

# å¤‡ç”¨è§£å†³æ–¹æ¡ˆ
backup_solution() {
    echo -e "${YELLOW}ğŸ”§ ä½¿ç”¨å¤‡ç”¨ä¿®å¤æ–¹æ¡ˆ...${NC}"
    
    # 1. ç›´æ¥ä¸‹è½½è„šæœ¬åˆ†æ
    execute_ai_command "curl -sSL -o /tmp/analyze_script.py 'https://github.com/xzx3344521/dock/raw/refs/heads/main/ai'" "ä¸‹è½½é—®é¢˜è„šæœ¬"
    
    # 2. æ£€æŸ¥è„šæœ¬ç±»å‹
    execute_ai_command "file /tmp/analyze_script.py" "æ£€æŸ¥è„šæœ¬ç±»å‹"
    execute_ai_command "head -5 /tmp/analyze_script.py" "æŸ¥çœ‹è„šæœ¬å¼€å¤´"
    
    # 3. å®‰è£…å¿…è¦çš„å·¥å…·
    execute_ai_command "sudo apt update && sudo apt install -y python3 python3-pip curl wget" "å®‰è£…åŸºç¡€å·¥å…·"
    
    # 4. æ ¹æ®è„šæœ¬ç±»å‹æ‰§è¡Œ
    if head -1 /tmp/analyze_script.py 2>/dev/null | grep -q "python"; then
        execute_ai_command "python3 /tmp/analyze_script.py" "æ‰§è¡ŒPythonè„šæœ¬"
    else
        execute_ai_command "bash /tmp/analyze_script.py" "æ‰§è¡ŒBashè„šæœ¬"
    fi
}

# åˆ›å»ºæ™ºèƒ½è„šæœ¬è¿è¡Œå™¨
create_smart_runner() {
    echo -e "${GREEN}ğŸ”§ åˆ›å»ºæ™ºèƒ½è„šæœ¬è¿è¡Œå™¨...${NC}"
    
    cat > /usr/local/bin/ai-run << 'EOF'
#!/bin/bash
# AIæ™ºèƒ½è„šæœ¬è¿è¡Œå™¨

URL="$1"
TEMP_SCRIPT="/tmp/smart_script_$$"

if [ -z "$URL" ]; then
    echo "ä½¿ç”¨æ–¹æ³•: ai-run <è„šæœ¬URL>"
    exit 1
fi

echo "ğŸ¤– AIæ™ºèƒ½è¿è¡Œå™¨æ­£åœ¨å¤„ç†: $URL"

# ä¸‹è½½è„šæœ¬
if ! curl -sSL "$URL" -o "$TEMP_SCRIPT"; then
    echo "âŒ ä¸‹è½½å¤±è´¥"
    exit 1
fi

# æ£€æµ‹å¹¶æ‰§è¡Œ
if head -1 "$TEMP_SCRIPT" | grep -q "python"; then
    echo "ğŸ æ£€æµ‹åˆ°Pythonè„šæœ¬ï¼Œä½¿ç”¨Pythonæ‰§è¡Œ..."
    python3 "$TEMP_SCRIPT"
elif head -1 "$TEMP_SCRIPT" | grep -q "bash"; then
    echo "ğŸ’» æ£€æµ‹åˆ°Bashè„šæœ¬ï¼Œä½¿ç”¨Bashæ‰§è¡Œ..."
    bash "$TEMP_SCRIPT"
else
    echo "ğŸ” è‡ªåŠ¨æ£€æµ‹è„šæœ¬ç±»å‹..."
    # å°è¯•Python
    if python3 -m py_compile "$TEMP_SCRIPT" 2>/dev/null; then
        echo "ğŸ ä½œä¸ºPythonè„šæœ¬æ‰§è¡Œ"
        python3 "$TEMP_SCRIPT"
    else
        echo "ğŸ’» ä½œä¸ºBashè„šæœ¬æ‰§è¡Œ"
        bash "$TEMP_SCRIPT"
    fi
fi

# æ¸…ç†
rm -f "$TEMP_SCRIPT"
EOF

    chmod +x /usr/local/bin/ai-run
    echo -e "${GREEN}âœ… æ™ºèƒ½è¿è¡Œå™¨å®‰è£…å®Œæˆ! ä½¿ç”¨: ai-run <URL>${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${GREEN}ğŸ“Š ç³»ç»ŸçŠ¶æ€${NC}"
    echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    echo "ä¸´æ—¶ç›®å½•: /tmp/"
    echo "æ™ºèƒ½è¿è¡Œå™¨: $(which ai-run 2>/dev/null || echo 'æœªå®‰è£…')"
}

# ä¸»ç¨‹åº
case "${1:-}" in
    "fix")
        main_repair
        ;;
    "runner")
        create_smart_runner
        ;;
    "status")
        show_status
        ;;
    "log")
        cat "$LOG_FILE"
        ;;
    *)
        echo -e "${GREEN}AIé©±åŠ¨é—®é¢˜è§£å†³ç³»ç»Ÿ${NC}"
        echo "ä½¿ç”¨æ–¹æ³•:"
        echo "  $0 fix     - AIè‡ªåŠ¨ä¿®å¤é—®é¢˜"
        echo "  $0 runner  - å®‰è£…æ™ºèƒ½è„šæœ¬è¿è¡Œå™¨"
        echo "  $0 status  - æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€"
        echo "  $0 log     - æŸ¥çœ‹æ—¥å¿—"
        echo ""
        echo "å½“å‰é—®é¢˜: è¿œç¨‹è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œå†…å®¹è¢«æ˜¾ç¤ºè€Œä¸æ˜¯æ‰§è¡Œ"
        echo "è§£å†³æ–¹æ¡ˆ: è¿è¡Œ '$0 fix' è®©AIè‡ªåŠ¨ä¿®å¤"
        ;;
esac
