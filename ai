#!/bin/bash

# AIé©±åŠ¨çš„é—®é¢˜ä¿®å¤è„šæœ¬ - è‡ªåŠ¨è¯†åˆ«å¹¶è§£å†³é—®é¢˜

set -e

# é…ç½®
DEEPSEEK_API_KEY="ä½ çš„DeepSeek_APIå¯†é’¥"
LOG_FILE="/var/log/ai_fixer.log"
TEMP_DIR="/tmp/ai_fixer"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# åˆå§‹åŒ–
init() {
    echo -e "${BLUE}ğŸš€ AIé©±åŠ¨é—®é¢˜ä¿®å¤ç³»ç»Ÿå¯åŠ¨...${NC}"
    mkdir -p "$TEMP_DIR"
    sudo touch "$LOG_FILE"
    sudo chmod 644 "$LOG_FILE"
    log "ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"
}

# æ—¥å¿—è®°å½•
log() {
    local message="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $message" | sudo tee -a "$LOG_FILE"
    echo -e "${BLUE}[AIä¿®å¤]${NC} $message"
}

# è°ƒç”¨DeepSeek API
call_ai() {
    local context="$1"
    local problem="$2"
    
    log "å’¨è¯¢AIåŠ©æ‰‹è§£å†³é—®é¢˜: $problem"
    
    # æ„å»ºAPIè¯·æ±‚
    local api_response=$(curl -s -X POST "https://api.deepseek.com/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
        -d '{
            "model": "deepseek-coder",
            "messages": [
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸€ä¸ªLinuxç³»ç»Ÿå’Œç¼–ç¨‹ä¸“å®¶ã€‚è¯·ç›´æ¥ç»™å‡ºè§£å†³é—®é¢˜çš„å…·ä½“å‘½ä»¤æˆ–ä»£ç ï¼Œç”¨ä¸­æ–‡ç®€è¦è§£é‡Šã€‚å½“å‰ç³»ç»Ÿï¼šDebian Linux"
                },
                {
                    "role": "user", 
                    "content": "'"é—®é¢˜ä¸Šä¸‹æ–‡: $context\n\nå…·ä½“é—®é¢˜: $problem\n\nè¯·æä¾›å…·ä½“çš„ä¿®å¤å‘½ä»¤æˆ–è„šæœ¬:"'"
                }
            ],
            "temperature": 0.3
        }')
    
    # æå–AIå›å¤
    local ai_response=$(echo "$api_response" | grep -o '"content":"[^"]*"' | cut -d'"' -f4)
    
    if [ -z "$ai_response" ]; then
        echo "AIè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
        return 1
    fi
    
    echo "$ai_response"
}

# åˆ†æé”™è¯¯ä¿¡æ¯
analyze_error() {
    local error_output="$1"
    log "åˆ†æé”™è¯¯ä¿¡æ¯..."
    
    echo "$error_output" > "$TEMP_DIR/error.log"
    
    # æ£€æµ‹é”™è¯¯ç±»å‹
    if echo "$error_output" | grep -q "command not found"; then
        echo "Pythonè„šæœ¬è¢«å½“ä½œbashæ‰§è¡Œ"
        return 1
    elif echo "$error_output" | grep -q "import.*command not found"; then
        echo "Pythonä»£ç åœ¨bashä¸­æ‰§è¡Œé”™è¯¯"
        return 2
    elif echo "$error_output" | grep -q "syntax error"; then
        echo "è¯­æ³•é”™è¯¯"
        return 3
    else
        echo "æœªçŸ¥é”™è¯¯ç±»å‹"
        return 4
    fi
}

# è‡ªåŠ¨ä¿®å¤Pythonè„šæœ¬é—®é¢˜
fix_python_script() {
    local script_url="$1"
    log "ä¿®å¤Pythonè„šæœ¬: $script_url"
    
    # ä¸‹è½½è„šæœ¬
    local original_content=$(curl -sSL "$script_url")
    
    if [ -z "$original_content" ]; then
        log "ä¸‹è½½è„šæœ¬å¤±è´¥"
        return 1
    fi
    
    echo "$original_content" > "$TEMP_DIR/original_script"
    
    # åˆ†æé—®é¢˜å¹¶è·å–AIä¿®å¤æ–¹æ¡ˆ
    local context="åŸå§‹è„šæœ¬å†…å®¹:\n$original_content\n\né”™è¯¯: Pythonä»£ç è¢«å½“ä½œbashæ‰§è¡Œ"
    local problem="è¿™æ˜¯ä¸€ä¸ªPythonè„šæœ¬ï¼Œä½†è¢«ç”¨bashå‘½ä»¤æ‰§è¡Œäº†ï¼Œå¯¼è‡´importç­‰Pythonè¯­å¥æŠ¥é”™"
    
    local ai_solution=$(call_ai "$context" "$problem")
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}ğŸ¤– AIä¿®å¤æ–¹æ¡ˆ:${NC}"
        echo "$ai_solution"
        echo "$ai_solution" > "$TEMP_DIR/ai_solution"
        
        # æ‰§è¡ŒAIçš„ä¿®å¤å‘½ä»¤
        execute_ai_solution "$ai_solution"
    else
        # å¤‡ç”¨ä¿®å¤æ–¹æ¡ˆ
        backup_fix "$original_content"
    fi
}

# æ‰§è¡ŒAIçš„è§£å†³æ–¹æ¡ˆ
execute_ai_solution() {
    local solution="$1"
    log "æ‰§è¡ŒAIè§£å†³æ–¹æ¡ˆ..."
    
    # æå–å‘½ä»¤éƒ¨åˆ†ï¼ˆå‡è®¾AIè¿”å›ä¸­åŒ…å«å…·ä½“å‘½ä»¤ï¼‰
    local commands=$(echo "$solution" | grep -E "^(sudo |bash |python |curl |wget |apt)" || echo "$solution")
    
    # æ‰§è¡Œæ¯ä¸ªæ‰¾åˆ°çš„å‘½ä»¤
    while IFS= read -r line; do
        if [[ "$line" =~ ^(sudo|bash|python|curl|wget|apt|pip) ]]; then
            log "æ‰§è¡Œ: $line"
            eval "$line" 2>&1 | sudo tee -a "$LOG_FILE"
        fi
    done <<< "$commands"
}

# å¤‡ç”¨ä¿®å¤æ–¹æ¡ˆ
backup_fix() {
    local original_content="$1"
    log "ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆä¿®å¤..."
    
    # æ£€æµ‹è„šæœ¬ç±»å‹
    if echo "$original_content" | grep -q "#!/usr/bin/env python"; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°Pythonè„šæœ¬ï¼Œé‡æ–°ä¸‹è½½å¹¶æ­£ç¡®æ‰§è¡Œ...${NC}"
        
        # ä¸‹è½½ä¸ºPythonæ–‡ä»¶
        curl -sSL "$script_url" -o "$TEMP_DIR/script.py"
        chmod +x "$TEMP_DIR/script.py"
        
        # å®‰è£…å¿…è¦çš„Pythonä¾èµ–
        sudo apt update
        sudo apt install -y python3 python3-pip
        
        # å°è¯•æ‰§è¡ŒPythonè„šæœ¬
        python3 "$TEMP_DIR/script.py"
        
    elif echo "$original_content" | grep -q "import.*"; then
        echo -e "${YELLOW}è¿™æ˜æ˜¾æ˜¯Pythonä»£ç ï¼Œåˆ›å»ºæ­£ç¡®çš„Pythonæ–‡ä»¶...${NC}"
        
        # åˆ›å»ºæ­£ç¡®çš„Pythonè„šæœ¬
        cat > "$TEMP_DIR/fixed_script.py" << EOF
#!/usr/bin/env python3
$original_content
EOF
        
        chmod +x "$TEMP_DIR/fixed_script.py"
        python3 "$TEMP_DIR/fixed_script.py"
        
    else
        echo -e "${RED}æ— æ³•è‡ªåŠ¨è¯†åˆ«è„šæœ¬ç±»å‹${NC}"
        return 1
    fi
}

# åˆ›å»ºæ™ºèƒ½å¯åŠ¨å™¨
create_smart_launcher() {
    log "åˆ›å»ºæ™ºèƒ½è„šæœ¬å¯åŠ¨å™¨..."
    
    cat > /usr/local/bin/ai-run << 'EOF'
#!/bin/bash

# AIæ™ºèƒ½è„šæœ¬å¯åŠ¨å™¨ - è‡ªåŠ¨è¯†åˆ«è„šæœ¬ç±»å‹å¹¶æ­£ç¡®æ‰§è¡Œ

SCRIPT_URL="$1"
TEMP_SCRIPT="/tmp/ai_script_$$"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}ğŸ¤– AIæ™ºèƒ½å¯åŠ¨å™¨è¿è¡Œä¸­...${NC}"

# ä¸‹è½½è„šæœ¬
if ! curl -sSL "$SCRIPT_URL" -o "$TEMP_SCRIPT"; then
    echo -e "${RED}âŒ ä¸‹è½½è„šæœ¬å¤±è´¥${NC}"
    exit 1
fi

# æ£€æµ‹è„šæœ¬ç±»å‹
detect_script_type() {
    local script_content=$(cat "$TEMP_SCRIPT")
    
    # æ£€æŸ¥shebang
    if head -1 "$TEMP_SCRIPT" | grep -q "^#!/usr/bin/env python"; then
        echo "python"
    elif head -1 "$TEMP_SCRIPT" | grep -q "^#!/bin/bash"; then
        echo "bash"
    elif head -1 "$TEMP_SCRIPT" | grep -q "^#!/bin/sh"; then
        echo "shell"
    elif echo "$script_content" | grep -q "import.*"; then
        echo "python"
    elif echo "$script_content" | grep -q "def.*("; then
        echo "python"
    else
        echo "unknown"
    fi
}

SCRIPT_TYPE=$(detect_script_type)

echo -e "${YELLOW}æ£€æµ‹åˆ°è„šæœ¬ç±»å‹: $SCRIPT_TYPE${NC}"

# æ ¹æ®ç±»å‹æ‰§è¡Œ
case "$SCRIPT_TYPE" in
    "python")
        echo -e "${GREEN}æ‰§è¡ŒPythonè„šæœ¬...${NC}"
        # ç¡®ä¿æœ‰Pythonç¯å¢ƒ
        if ! command -v python3 &> /dev/null; then
            sudo apt update && sudo apt install -y python3
        fi
        python3 "$TEMP_SCRIPT"
        ;;
    "bash"|"shell")
        echo -e "${GREEN}æ‰§è¡ŒBashè„šæœ¬...${NC}"
        chmod +x "$TEMP_SCRIPT"
        bash "$TEMP_SCRIPT"
        ;;
    *)
        echo -e "${YELLOW}æœªçŸ¥ç±»å‹ï¼Œå°è¯•æ™ºèƒ½æ‰§è¡Œ...${NC}"
        # å°è¯•ä½œä¸ºbashæ‰§è¡Œ
        if bash -n "$TEMP_SCRIPT" 2>/dev/null; then
            echo -e "${GREEN}ä½œä¸ºBashè„šæœ¬æ‰§è¡Œ${NC}"
            chmod +x "$TEMP_SCRIPT"
            bash "$TEMP_SCRIPT"
        else
            echo -e "${GREEN}ä½œä¸ºPythonè„šæœ¬æ‰§è¡Œ${NC}"
            python3 "$TEMP_SCRIPT"
        fi
        ;;
esac

# æ¸…ç†
rm -f "$TEMP_SCRIPT"
EOF

    chmod +x /usr/local/bin/ai-run
    echo -e "${GREEN}âœ… æ™ºèƒ½å¯åŠ¨å™¨å®‰è£…å®Œæˆ${NC}"
    echo -e "${YELLOW}ä½¿ç”¨æ–¹æ³•: ai-run <è„šæœ¬URL>${NC}"
}

# ä¸»ä¿®å¤å‡½æ•°
main_fix() {
    local script_url="https://github.com/xzx3344521/dock/raw/refs/heads/main/ai"
    
    echo -e "${BLUE}ğŸ” å¼€å§‹åˆ†æé—®é¢˜...${NC}"
    log "ç›®æ ‡è„šæœ¬: $script_url"
    
    # åˆ†æé—®é¢˜
    analyze_error "Pythonè„šæœ¬è¢«å½“ä½œbashæ‰§è¡Œï¼Œimportè¯­å¥æŠ¥é”™"
    
    # ä¿®å¤é—®é¢˜
    fix_python_script "$script_url"
    
    # åˆ›å»ºæ™ºèƒ½å¯åŠ¨å™¨é˜²æ­¢æœªæ¥é—®é¢˜
    create_smart_launcher
    
    echo -e "${GREEN}âœ… ä¿®å¤å®Œæˆï¼${NC}"
    echo -e "${YELLOW}ğŸ¯ ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨: ai-run https://github.com/xzx3344521/dock/raw/refs/heads/main/ai${NC}"
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_help() {
    echo -e "${GREEN}AIé©±åŠ¨é—®é¢˜ä¿®å¤ç³»ç»Ÿ${NC}"
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  $0 fix      - ä¿®å¤å½“å‰é—®é¢˜"
    echo "  $0 run <url> - æ™ºèƒ½è¿è¡Œè„šæœ¬"
    echo "  $0 help     - æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»ç¨‹åº
case "${1:-}" in
    "fix")
        init
        main_fix
        ;;
    "run")
        if [ -z "$2" ]; then
            echo "è¯·æä¾›è„šæœ¬URL"
            exit 1
        fi
        /usr/local/bin/ai-run "$2"
        ;;
    "help"|"")
        show_help
        ;;
    *)
        echo "æœªçŸ¥å‘½ä»¤: $1"
        show_help
        ;;
esac
