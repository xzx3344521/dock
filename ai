#!/usr/bin/env python3
"""
AIé©±åŠ¨æ™ºèƒ½é˜²å¾¡ç³»ç»Ÿ - æ ‡å‡†åŒ–æŒ‡ä»¤å“åº”
"""

import requests
import time
import re
import json
import subprocess
from datetime import datetime
import threading
import sqlite3
import os

class AIDrivenDefenseSystem:
    def __init__(self, api_key, log_file_path="/var/log/auth.log"):
        self.api_key = api_key
        self.api_url = "https://api.deepseek.com/v1/chat/completions"
        self.log_file_path = log_file_path
        self.last_position = 0
        
        # AIæŒ‡ä»¤æ˜ å°„è¡¨
        self.ai_commands = {
            # ç›‘æ§æŒ‡ä»¤
            "é«˜å±æ”»å‡»": self.defend_critical_attack,
            "ç«‹å³å°é”": self.defend_immediate_block,
            "æš´åŠ›ç ´è§£": self.defend_bruteforce,
            "ç«¯å£æ‰«æ": self.defend_port_scan,
            "å¯ç–‘è¡Œä¸º": self.defend_suspicious,
            "æŒç»­ç›‘æ§": self.defend_monitor_only,
            
            # åå‡»æŒ‡ä»¤ï¼ˆåˆæ³•èŒƒå›´å†…ï¼‰
            "åå‘è¿½è¸ª": self.defend_traceback,
            "æµé‡é™åˆ¶": self.defend_rate_limit,
            "æœåŠ¡éšè—": self.defend_service_hide,
            "èœœç½è¯±æ•": self.defend_honeypot,
        }
        
        # åˆå§‹åŒ–æ•°æ®åº“
        self.init_database()
        
    def init_database(self):
        """åˆå§‹åŒ–é˜²å¾¡æ•°æ®åº“"""
        self.conn = sqlite3.connect('defense_actions.db', check_same_thread=False)
        cursor = self.conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS defense_logs (
                id INTEGER PRIMARY KEY,
                timestamp TIMESTAMP,
                ip TEXT,
                ai_command TEXT,
                action_taken TEXT,
                threat_level TEXT
            )
        ''')
        self.conn.commit()

    def get_log_summary(self, log_lines):
        """ä»æ—¥å¿—ä¸­æå–å…³é”®ä¿¡æ¯"""
        summary = {
            'failed_logins': [],
            'suspicious_ips': [],
            'port_scan_signs': [],
            'error_messages': [],
            'timeline': []
        }
        
        for line in log_lines[-100:]:  # åˆ†ææœ€è¿‘100è¡Œ
            line = line.strip()
            
            # SSHç›¸å…³æ£€æµ‹
            if "Failed password" in line:
                ip_match = re.search(r'from (\d+\.\d+\.\d+\.\d+)', line)
                if ip_match:
                    ip = ip_match.group(1)
                    summary['failed_logins'].append(f"SSHå¤±è´¥: {ip}")
                    if ip not in summary['suspicious_ips']:
                        summary['suspicious_ips'].append(ip)
            
            # ç«¯å£æ‰«ææ£€æµ‹
            elif "Connection reset by peer" in line or "refused connect" in line.lower():
                ip_match = re.search(r'from (\d+\.\d+\.\d+\.\d+)', line)
                if ip_match:
                    summary['port_scan_signs'].append(f"ç«¯å£æ‰«æ: {ip_match.group(1)}")
            
            # å…¶ä»–å¯ç–‘è¡Œä¸º
            elif "invalid user" in line.lower() or "authentication failure" in line.lower():
                ip_match = re.search(r'from (\d+\.\d+\.\d+\.\d+)', line) or re.search(r'rhost=(\d+\.\d+\.\d+\.\d+)', line)
                if ip_match:
                    summary['suspicious_ips'].append(ip_match.group(1))
                    summary['error_messages'].append(line)
        
        return summary

    def ask_ai_for_command(self, log_summary):
        """è¯¢é—®AIè·å–æ ‡å‡†åŒ–é˜²å¾¡æŒ‡ä»¤"""
        
        prompt = f"""
        è¯·åˆ†æä»¥ä¸‹ç³»ç»Ÿæ—¥å¿—æ‘˜è¦ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ ‡å‡†åŒ–çš„é˜²å¾¡æŒ‡ä»¤ï¼š

        æ—¥å¿—æ‘˜è¦:
        {json.dumps(log_summary, indent=2, ensure_ascii=False)}

        è¯·ä»ä»¥ä¸‹æŒ‡ä»¤ä¸­é€‰æ‹©æœ€åˆé€‚çš„ä¸€ä¸ªè¿”å›ï¼ˆåªè¿”å›æŒ‡ä»¤å…³é”®è¯ï¼‰ï¼š
        - "é«˜å±æ”»å‡»"ï¼šæ£€æµ‹åˆ°ä¸¥é‡å…¥ä¾µä¼å›¾
        - "ç«‹å³å°é”"ï¼šéœ€è¦ç«‹å³å°é”IP
        - "æš´åŠ›ç ´è§£"ï¼šæ£€æµ‹åˆ°æš´åŠ›ç ´è§£æ”»å‡»
        - "ç«¯å£æ‰«æ"ï¼šæ£€æµ‹åˆ°ç«¯å£æ‰«æè¡Œä¸º
        - "å¯ç–‘è¡Œä¸º"ï¼šä¸€èˆ¬å¯ç–‘æ´»åŠ¨ï¼Œéœ€è¦ç›‘æ§
        - "æŒç»­ç›‘æ§"ï¼šæ— æ˜æ˜¾å¨èƒï¼Œç»§ç»­ç›‘æ§
        - "åå‘è¿½è¸ª"ï¼šéœ€è¦è¿½è¸ªæ”»å‡»æº
        - "æµé‡é™åˆ¶"ï¼šé™åˆ¶è¯¥IPçš„è®¿é—®é¢‘ç‡
        - "æœåŠ¡éšè—"ï¼šéšè—æœåŠ¡ç«¯å£
        - "èœœç½è¯±æ•"ï¼šè®¾ç½®èœœç½è¿›è¡Œååˆ¶

        åŒæ—¶è¯·åˆ†æï¼š
        1. æ”»å‡»çš„ä¸¥é‡ç¨‹åº¦
        2. æ˜¯å¦éœ€è¦ç«‹å³å“åº”
        3. å»ºè®®çš„å…·ä½“é˜²å¾¡æªæ–½

        åªè¿”å›æŒ‡ä»¤å…³é”®è¯ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
        """
        
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        
        data = {
            "model": "deepseek-chat",
            "messages": [
                {
                    "role": "system", 
                    "content": "ä½ æ˜¯ä¸€ä¸ªç½‘ç»œå®‰å…¨ä¸“å®¶ï¼Œä¸“é—¨åˆ†ææ—¥å¿—å’Œæä¾›é˜²å¾¡æŒ‡ä»¤ã€‚åªè¿”å›æ ‡å‡†åŒ–æŒ‡ä»¤å…³é”®è¯ã€‚"
                },
                {
                    "role": "user", 
                    "content": prompt
                }
            ],
            "temperature": 0.1,
            "max_tokens": 50
        }
        
        try:
            response = requests.post(self.api_url, headers=headers, json=data, timeout=30)
            response.raise_for_status()
            result = response.json()
            ai_response = result['choices'][0]['message']['content'].strip()
            
            # æå–æŒ‡ä»¤å…³é”®è¯
            for command in self.ai_commands.keys():
                if command in ai_response:
                    return command
            
            # å¦‚æœæ²¡æœ‰åŒ¹é…çš„æŒ‡ä»¤ï¼Œè¿”å›é»˜è®¤æŒ‡ä»¤
            return "æŒç»­ç›‘æ§"
            
        except Exception as e:
            print(f"AI APIè°ƒç”¨é”™è¯¯: {e}")
            return "æŒç»­ç›‘æ§"

    def execute_defense_command(self, command, ip_address=None, log_data=None):
        """æ‰§è¡ŒAIæŒ‡ä»¤å¯¹åº”çš„é˜²å¾¡åŠ¨ä½œ"""
        print(f"ğŸ¯ æ‰§è¡ŒAIæŒ‡ä»¤: {command} | ç›®æ ‡IP: {ip_address}")
        
        if command in self.ai_commands:
            # è®°å½•åˆ°æ•°æ®åº“
            self.log_defense_action(ip_address, command, "å¼€å§‹æ‰§è¡Œ")
            
            # æ‰§è¡Œå¯¹åº”çš„é˜²å¾¡å‡½æ•°
            result = self.ai_commands[command](ip_address, log_data)
            
            # æ›´æ–°æ—¥å¿—
            self.log_defense_action(ip_address, command, f"æ‰§è¡Œå®Œæˆ: {result}")
            
            return result
        else:
            print(f"æœªçŸ¥æŒ‡ä»¤: {command}")
            return "æœªçŸ¥æŒ‡ä»¤"

    def defend_critical_attack(self, ip, log_data):
        """é«˜å±æ”»å‡»å“åº”"""
        actions = []
        
        # 1. ç«‹å³å°é”IP
        actions.append(self.block_ip_iptables(ip))
        
        # 2. è®°å½•åˆ°é»‘åå•
        actions.append(self.add_to_blacklist(ip))
        
        # 3. å‘é€ç´§æ€¥è­¦æŠ¥
        actions.append(self.send_alert(f"é«˜å±æ”»å‡»æ£€æµ‹", f"IP: {ip} è¢«åˆ¤å®šä¸ºé«˜å±æ”»å‡»"))
        
        # 4. æ”¶é›†æ”»å‡»è¯æ®
        actions.append(self.collect_evidence(ip))
        
        return " | ".join(actions)

    def defend_immediate_block(self, ip, log_data):
        """ç«‹å³å°é”å“åº”"""
        return self.block_ip_iptables(ip)

    def defend_bruteforce(self, ip, log_data):
        """æš´åŠ›ç ´è§£å“åº”"""
        actions = []
        actions.append(self.block_ip_iptables(ip))
        actions.append(self.add_to_blacklist(ip))
        actions.append(self.change_ssh_port())  # æ›´æ”¹SSHç«¯å£
        return " | ".join(actions)

    def defend_port_scan(self, ip, log_data):
        """ç«¯å£æ‰«æå“åº”"""
        actions = []
        actions.append(self.rate_limit_ip(ip))
        actions.append(self.hide_services())
        actions.append(self.monitor_ip(ip))
        return " | ".join(actions)

    def defend_suspicious(self, ip, log_data):
        """å¯ç–‘è¡Œä¸ºå“åº”"""
        return self.monitor_ip(ip)

    def defend_monitor_only(self, ip, log_data):
        """æŒç»­ç›‘æ§"""
        return "ä¿æŒç›‘æ§çŠ¶æ€"

    def defend_traceback(self, ip, log_data):
        """åå‘è¿½è¸ªï¼ˆåˆæ³•æ–¹å¼ï¼‰"""
        try:
            # ä½¿ç”¨tracerouteè¿›è¡Œè·¯å¾„è¿½è¸ª
            result = subprocess.run(
                f"traceroute -m 10 {ip}", 
                shell=True, capture_output=True, text=True, timeout=30
            )
            trace_info = result.stdout[:500]  # åªä¿å­˜å‰500å­—ç¬¦
            
            # ä¿å­˜è¿½è¸ªç»“æœ
            with open(f'traceback_{ip}_{datetime.now().strftime("%Y%m%d_%H%M%S")}.log', 'w') as f:
                f.write(trace_info)
            
            return f"åå‘è¿½è¸ªå®Œæˆ: {ip}"
        except Exception as e:
            return f"è¿½è¸ªå¤±è´¥: {e}"

    def defend_rate_limit(self, ip, log_data):
        """æµé‡é™åˆ¶"""
        try:
            # ä½¿ç”¨iptablesé™åˆ¶è¿æ¥é¢‘ç‡
            cmd = f"sudo iptables -A INPUT -s {ip} -m limit --limit 10/minute -j ACCEPT"
            subprocess.run(cmd, shell=True, check=True)
            cmd = f"sudo iptables -A INPUT -s {ip} -j DROP"
            subprocess.run(cmd, shell=True, check=True)
            return f"æµé‡é™åˆ¶å·²è®¾ç½®: {ip}"
        except Exception as e:
            return f"æµé‡é™åˆ¶å¤±è´¥: {e}"

    def defend_service_hide(self, ip, log_data):
        """æœåŠ¡éšè—"""
        try:
            # æ›´æ”¹SSHç«¯å£ï¼ˆç¤ºä¾‹ï¼‰
            cmd = "sudo sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config"
            subprocess.run(cmd, shell=True, check=True)
            subprocess.run("sudo systemctl restart sshd", shell=True, check=True)
            return "SSHæœåŠ¡å·²éšè—åˆ°2222ç«¯å£"
        except Exception as e:
            return f"æœåŠ¡éšè—å¤±è´¥: {e}"

    def defend_honeypot(self, ip, log_data):
        """èœœç½è¯±æ•"""
        try:
            # åˆ›å»ºç®€å•çš„èœœç½æœåŠ¡
            cmd = "sudo nohup python3 -m http.server 8080 --directory /tmp/ &"
            subprocess.run(cmd, shell=True, check=True)
            return "èœœç½æœåŠ¡å·²åœ¨8080ç«¯å£å¯åŠ¨"
        except Exception as e:
            return f"èœœç½è®¾ç½®å¤±è´¥: {e}"

    # å…·ä½“çš„é˜²å¾¡åŠ¨ä½œå®ç°
    def block_ip_iptables(self, ip):
        """ä½¿ç”¨iptableså°é”IP"""
        try:
            check_cmd = f"sudo iptables -C INPUT -s {ip} -j DROP 2>/dev/null"
            result = subprocess.run(check_cmd, shell=True, capture_output=True)
            
            if result.returncode != 0:
                block_cmd = f"sudo iptables -A INPUT -s {ip} -j DROP"
                subprocess.run(block_cmd, shell=True, check=True)
                return f"IPå·²å°é”: {ip}"
            else:
                return f"IPå·²å­˜åœ¨å°é”è§„åˆ™: {ip}"
        except Exception as e:
            return f"å°é”å¤±è´¥: {e}"

    def add_to_blacklist(self, ip):
        """æ·»åŠ åˆ°é»‘åå•æ–‡ä»¶"""
        try:
            with open('/tmp/ip_blacklist.txt', 'a') as f:
                f.write(f"{ip} # Blocked at {datetime.now()}\n")
            return "å·²æ·»åŠ è‡³é»‘åå•"
        except Exception as e:
            return f"é»‘åå•æ·»åŠ å¤±è´¥: {e}"

    def change_ssh_port(self):
        """æ›´æ”¹SSHç«¯å£"""
        return "å»ºè®®æ‰‹åŠ¨æ›´æ”¹SSHç«¯å£é…ç½®"

    def hide_services(self):
        """éšè—æœåŠ¡"""
        return "æœåŠ¡éšè—ç­–ç•¥å·²æ‰§è¡Œ"

    def monitor_ip(self, ip):
        """ç›‘æ§IP"""
        return f"å¼€å§‹é‡ç‚¹ç›‘æ§: {ip}"

    def send_alert(self, title, message):
        """å‘é€è­¦æŠ¥"""
        print(f"ğŸš¨ è­¦æŠ¥: {title} - {message}")
        return "è­¦æŠ¥å·²å‘é€"

    def collect_evidence(self, ip):
        """æ”¶é›†è¯æ®"""
        try:
            # æ”¶é›†ç½‘ç»œè¿æ¥ä¿¡æ¯
            cmd = f"netstat -an | grep {ip} > /tmp/evidence_{ip}.log"
            subprocess.run(cmd, shell=True)
            return "è¯æ®æ”¶é›†å®Œæˆ"
        except:
            return "è¯æ®æ”¶é›†å¤±è´¥"

    def log_defense_action(self, ip, command, action):
        """è®°å½•é˜²å¾¡åŠ¨ä½œåˆ°æ•°æ®åº“"""
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT INTO defense_logs (timestamp, ip, ai_command, action_taken, threat_level)
            VALUES (?, ?, ?, ?, ?)
        ''', (datetime.now(), ip, command, action, "high" if "å°é”" in command else "medium"))
        self.conn.commit()

    def monitor_loop(self):
        """ä¸»ç›‘æ§å¾ªç¯"""
        print("ğŸ¤– AIé©±åŠ¨é˜²å¾¡ç³»ç»Ÿå¯åŠ¨...")
        print("ğŸ“‹ å¯ç”¨æŒ‡ä»¤:", list(self.ai_commands.keys()))
        
        while True:
            try:
                # æ¨¡æ‹Ÿè·å–æ—¥å¿—ï¼ˆå®é™…ä½¿ç”¨æ—¶æ›¿æ¢ä¸ºçœŸå®æ—¥å¿—è¯»å–ï¼‰
                sample_logs = [
                    f"{datetime.now()} - Failed password for root from 192.168.1.100",
                    f"{datetime.now()} - Connection reset by peer from 10.0.0.50",
                ]
                
                # åˆ†ææ—¥å¿—
                log_summary = self.get_log_summary(sample_logs)
                
                if log_summary['suspicious_ips']:
                    print(f"ğŸ” å‘ç°å¯ç–‘IP: {log_summary['suspicious_ips']}")
                    
                    # è¯¢é—®AIè·å–æŒ‡ä»¤
                    ai_command = self.ask_ai_for_command(log_summary)
                    
                    # å¯¹æ¯ä¸ªå¯ç–‘IPæ‰§è¡ŒæŒ‡ä»¤
                    for ip in log_summary['suspicious_ips']:
                        result = self.execute_defense_command(ai_command, ip, log_summary)
                        print(f"âœ… æ‰§è¡Œç»“æœ: {result}")
                
                time.sleep(30)  # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
                
            except KeyboardInterrupt:
                print("\nğŸ›‘ é˜²å¾¡ç³»ç»Ÿå·²åœæ­¢")
                break
            except Exception as e:
                print(f"âŒ ç›‘æ§é”™è¯¯: {e}")
                time.sleep(30)

def main():
    API_KEY = "æ‚¨çš„DeepSeek_API_Key"
    
    # æ£€æŸ¥æƒé™
    try:
        subprocess.run(['sudo', 'iptables', '-L'], capture_output=True)
        print("âœ… å…·å¤‡é˜²å¾¡æ“ä½œæƒé™")
    except:
        print("âš ï¸ éœ€è¦rootæƒé™æ‰§è¡Œé˜²å¾¡åŠ¨ä½œ")
    
    defense_system = AIDrivenDefenseSystem(API_KEY)
    defense_system.monitor_loop()

if __name__ == "__main__":
    main()
