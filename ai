#!/bin/bash

# äº¤äº’å¼AIé©±åŠ¨é—®é¢˜ä¿®å¤ç³»ç»Ÿ
# è®©ç”¨æˆ·æ¸…æ¥šçŸ¥é“è¿è¡ŒçŠ¶æ€å’Œä½ç½®

set -e

# é…ç½®
DEEPSEEK_API_KEY="sk-your-api-key-here"  # è¯·æ›¿æ¢ä¸ºä½ çš„çœŸå®APIå¯†é’¥
SCRIPT_NAME="interactive_ai_fixer.sh"
INSTALL_DIR="/usr/local/bin"
LOG_FILE="/var/log/ai_interactive_fixer.log"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ˜¾ç¤ºè¿è¡Œä½ç½®å’ŒçŠ¶æ€
show_status() {
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘               AIé©±åŠ¨äº¤äº’å¼ä¿®å¤ç³»ç»Ÿ               â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘ è¿è¡Œä½ç½®: $(pwd) â•‘"
    echo "â•‘ è„šæœ¬åç§°: $0                          â•‘"
    echo "â•‘ ç³»ç»Ÿæ—¶é—´: $(date)                      â•‘"
    echo "â•‘ å½“å‰ç”¨æˆ·: $(whoami)                               â•‘"
    echo "â•‘ ç³»ç»Ÿä¿¡æ¯: $(uname -srm)                           â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
}

# æ—¥å¿—å‡½æ•°
log() {
    local message="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $message" | sudo tee -a "$LOG_FILE"
    echo -e "${BLUE}[AIç³»ç»Ÿ]${NC} $message"
}

# è¿›åº¦æ˜¾ç¤ºå‡½æ•°
show_progress() {
    local step="$1"
    local total="$2"
    local message="$3"
    
    local percent=$((step * 100 / total))
    echo -e "${CYAN}ğŸ“Š è¿›åº¦: [$step/$total] $message...${NC}"
    echo -e "${YELLOW}   â–°â–°â–°â–°â–°â–°â–°â–°â–°â–° $percent% å®Œæˆ${NC}"
    echo ""
}

# è°ƒç”¨AIåˆ†æé—®é¢˜
ask_ai() {
    local problem="$1"
    local context="$2"
    
    log "ğŸ¤– å’¨è¯¢AIè§£å†³æ–¹æ¡ˆ: $problem"
    echo -e "${CYAN}ğŸ”„ æ­£åœ¨è¿æ¥AIåŠ©æ‰‹åˆ†æé—®é¢˜...${NC}"
    
    # å‡†å¤‡APIè¯·æ±‚
    local request_data=$(cat << EOF
{
    "model": "deepseek-coder",
    "messages": [
        {
            "role": "system",
            "content": "ä½ æ˜¯ä¸€ä¸ªLinuxç³»ç»Ÿå’Œè„šæœ¬é—®é¢˜ä¸“å®¶ã€‚ç”¨æˆ·é‡åˆ°äº†è„šæœ¬æ‰§è¡Œé—®é¢˜ï¼Œè¯·ç›´æ¥ç»™å‡ºå…·ä½“çš„ä¿®å¤å‘½ä»¤ã€‚ç”¨ä¸­æ–‡å›ç­”ï¼Œè¦å…·ä½“å¯æ‰§è¡Œã€‚"
        },
        {
            "role": "user",
            "content": "é—®é¢˜ï¼š$problem\n\nä¸Šä¸‹æ–‡ï¼š$context\n\nè¯·ç›´æ¥ç»™å‡ºéœ€è¦æ‰§è¡Œçš„Linuxå‘½ä»¤ï¼š"
        }
    ],
    "temperature": 0.3,
    "max_tokens": 1000
}
EOF
    )

    # è°ƒç”¨API
    echo -e "${YELLOW}ğŸ“¡ å‘é€è¯·æ±‚åˆ°AIæœåŠ¡å™¨...${NC}"
    local response=$(curl -s -X POST "https://api.deepseek.com/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
        -d "$request_data" 2>/dev/null || echo "AIè¯·æ±‚å¤±è´¥")

    # æå–å›å¤
    local answer=$(echo "$response" | grep -o '"content":"[^"]*"' | cut -d'"' -f4)
    
    if [ -z "$answer" ] || [ "$answer" = "AIè¯·æ±‚å¤±è´¥" ]; then
        echo -e "${RED}âŒ AIè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ${NC}"
        return 1
    fi
    
    echo -e "${GREEN}âœ… AIå›å¤æ¥æ”¶æˆåŠŸ${NC}"
    echo "$answer"
}

# æ‰§è¡Œå‘½ä»¤å¹¶æ˜¾ç¤ºç»“æœ
execute_command() {
    local command="$1"
    local description="$2"
    
    log "æ‰§è¡Œ: $description"
    echo -e "${YELLOW}â–¶ï¸ æ‰§è¡Œ: $command${NC}"
    echo -e "${BLUE}ğŸ“ æè¿°: $description${NC}"
    
    # æ˜¾ç¤ºæ‰§è¡Œå¼€å§‹æ—¶é—´
    local start_time=$(date +%s)
    
    # æ‰§è¡Œå‘½ä»¤
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    eval "$command" 2>&1 | while IFS= read -r line; do
        echo "   ğŸ“‹ $line"
    done
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    local exit_code=${PIPESTATUS[0]}
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}âœ… æ‰§è¡ŒæˆåŠŸ (è€—æ—¶: ${duration}s)${NC}"
    else
        echo -e "${RED}âŒ æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $exit_code, è€—æ—¶: ${duration}s)${NC}"
    fi
    
    echo ""
    return $exit_code
}

# åˆ†æå½“å‰é—®é¢˜
analyze_problem() {
    show_progress 1 5 "åˆ†æç³»ç»Ÿç¯å¢ƒ"
    
    echo -e "${PURPLE}ğŸ” å¼€å§‹ç³»ç»Ÿåˆ†æ...${NC}"
    
    # æ”¶é›†ç³»ç»Ÿä¿¡æ¯
    execute_command "uname -a" "è·å–ç³»ç»Ÿå†…æ ¸ä¿¡æ¯"
    execute_command "cat /etc/os-release" "è·å–æ“ä½œç³»ç»Ÿä¿¡æ¯"
    execute_command "python3 --version 2>/dev/null || echo 'Python3 æœªå®‰è£…'" "æ£€æŸ¥Pythonç¯å¢ƒ"
    execute_command "bash --version | head -1" "æ£€æŸ¥Bashç‰ˆæœ¬"
    
    show_progress 2 5 "æµ‹è¯•é—®é¢˜è„šæœ¬"
    
    # æµ‹è¯•é—®é¢˜è„šæœ¬
    local test_url="https://github.com/xzx3344521/dock/raw/refs/heads/main/ai"
    echo -e "${CYAN}ğŸŒ æµ‹è¯•é—®é¢˜è„šæœ¬URL: $test_url${NC}"
    
    execute_command "curl -s -I '$test_url' | head -1" "æ£€æŸ¥URLå¯è®¿é—®æ€§"
    
    local script_content=$(curl -sSL "$test_url" 2>/dev/null || echo "ä¸‹è½½å¤±è´¥")
    echo -e "${YELLOW}ğŸ“„ è„šæœ¬å†…å®¹é¢„è§ˆ:${NC}"
    echo "$script_content" | head -10 | while IFS= read -r line; do
        echo "   ğŸ“ƒ $line"
    done
    
    local problem_context="ç³»ç»Ÿåˆ†æå®Œæˆï¼Œæ£€æµ‹åˆ°è¿œç¨‹è„šæœ¬æ‰§è¡Œé—®é¢˜"
    echo "$problem_context"
}

# ä¸»è¦ä¿®å¤æµç¨‹
main_repair() {
    show_status
    
    echo -e "${GREEN}ğŸš€ å¯åŠ¨AIè‡ªåŠ¨ä¿®å¤æµç¨‹...${NC}"
    echo -e "${YELLOW}âš ï¸  æ³¨æ„: æ•´ä¸ªæµç¨‹å°†ç”±AIè‡ªåŠ¨æ§åˆ¶${NC}"
    echo ""
    
    # åˆ†æé—®é¢˜
    local problem_context=$(analyze_problem)
    local problem_description="ç”¨æˆ·æ‰§è¡Œè¿œç¨‹è„šæœ¬å¤±è´¥ï¼Œè„šæœ¬å†…å®¹è¢«æ˜¾ç¤ºè€Œä¸æ˜¯æ‰§è¡Œï¼Œå‡ºç°å‘½ä»¤æœªæ‰¾åˆ°é”™è¯¯"
    
    show_progress 3 5 "å’¨è¯¢AIè§£å†³æ–¹æ¡ˆ"
    
    # è¯¢é—®AIè§£å†³æ–¹æ¡ˆ
    echo -e "${PURPLE}ğŸ¤– æ­£åœ¨å’¨è¯¢AIåŠ©æ‰‹...${NC}"
    local ai_solution=$(ask_ai "$problem_description" "$problem_context")
    
    if [ $? -ne 0 ] || [ -z "$ai_solution" ]; then
        echo -e "${RED}âŒ AIå’¨è¯¢å¤±è´¥ï¼Œå¯ç”¨å¤‡ç”¨æ–¹æ¡ˆ${NC}"
        backup_solution
        return
    fi
    
    show_progress 4 5 "æ‰§è¡ŒAIæ–¹æ¡ˆ"
    
    echo -e "${GREEN}ğŸ¤– AIæä¾›çš„è§£å†³æ–¹æ¡ˆ:${NC}"
    echo -e "${CYAN}$ai_solution${NC}"
    echo ""
    
    # æ‰§è¡ŒAIå‘½ä»¤
    execute_ai_commands "$ai_solution"
    
    show_progress 5 5 "å®Œæˆä¿®å¤"
    
    echo -e "${GREEN}ğŸ‰ AIä¿®å¤æµç¨‹å®Œæˆï¼${NC}"
}

# æ‰§è¡ŒAIè¿”å›çš„å‘½ä»¤
execute_ai_commands() {
    local solution="$1"
    local command_count=0
    
    echo -e "${PURPLE}ğŸ”§ å¼€å§‹æ‰§è¡ŒAIå»ºè®®çš„å‘½ä»¤...${NC}"
    
    while IFS= read -r line; do
        # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
        if [[ -z "$line" || "$line" =~ ^# ]]; then
            continue
        fi
        
        # è¯†åˆ«å‘½ä»¤
        if [[ "$line" =~ ^(sudo\s+|apt\s+|curl\s+|wget\s+|python|bash\s+|chmod\s+|mkdir\s+|cd\s+|echo\s+|pip\s+) ]]; then
            command_count=$((command_count + 1))
            execute_command "$line" "AIå»ºè®®å‘½ä»¤ #$command_count"
        fi
    done <<< "$solution"
    
    echo -e "${GREEN}âœ… å…±æ‰§è¡Œäº† $command_count ä¸ªAIå‘½ä»¤${NC}"
}

# å¤‡ç”¨è§£å†³æ–¹æ¡ˆ
backup_solution() {
    echo -e "${YELLOW}ğŸ› ï¸ å¯ç”¨å¤‡ç”¨ä¿®å¤æ–¹æ¡ˆ...${NC}"
    
    show_progress 1 3 "ä¸‹è½½å’Œåˆ†æè„šæœ¬"
    execute_command "curl -sSL -o /tmp/problem_script 'https://github.com/xzx3344521/dock/raw/refs/heads/main/ai'" "ä¸‹è½½é—®é¢˜è„šæœ¬"
    execute_command "file /tmp/problem_script" "æ£€æµ‹è„šæœ¬ç±»å‹"
    execute_command "head -3 /tmp/problem_script" "æŸ¥çœ‹è„šæœ¬å¤´éƒ¨"
    
    show_progress 2 3 "å‡†å¤‡æ‰§è¡Œç¯å¢ƒ"
    execute_command "sudo apt update" "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨"
    execute_command "sudo apt install -y python3 python3-pip curl wget file" "å®‰è£…å¿…è¦å·¥å…·"
    
    show_progress 3 3 "æ‰§è¡Œä¿®å¤"
    # æ ¹æ®è„šæœ¬ç±»å‹æ‰§è¡Œ
    if head -1 /tmp/problem_script 2>/dev/null | grep -q "python"; then
        execute_command "python3 /tmp/problem_script" "æ‰§è¡ŒPythonè„šæœ¬"
    else
        execute_command "bash /tmp/problem_script" "æ‰§è¡ŒBashè„šæœ¬"
    fi
}

# å®‰è£…ä¸ºç³»ç»Ÿå‘½ä»¤
install_systemwide() {
    echo -e "${PURPLE}ğŸ“¥ å®‰è£…åˆ°ç³»ç»Ÿå‘½ä»¤...${NC}"
    
    show_status
    
    execute_command "sudo cp '$0' '$INSTALL_DIR/ai-fix'" "å¤åˆ¶è„šæœ¬åˆ°ç³»ç»Ÿç›®å½•"
    execute_command "sudo chmod +x '$INSTALL_DIR/ai-fix'" "è®¾ç½®æ‰§è¡Œæƒé™"
    execute_command "sudo chown root:root '$INSTALL_DIR/ai-fix'" "è®¾ç½®æ‰€æœ‰æƒ"
    
    echo -e "${GREEN}âœ… å®‰è£…å®Œæˆï¼ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š${NC}"
    echo -e "${CYAN}   ai-fix repair    - AIä¿®å¤é—®é¢˜${NC}"
    echo -e "${CYAN}   ai-fix status   - æ˜¾ç¤ºçŠ¶æ€${NC}"
    echo -e "${CYAN}   ai-fix log      - æŸ¥çœ‹æ—¥å¿—${NC}"
}

# äº¤äº’å¼èœå•
interactive_menu() {
    while true; do
        show_status
        
        echo -e "${GREEN}è¯·é€‰æ‹©æ“ä½œ:${NC}"
        echo -e "${CYAN}1. ğŸš€ AIè‡ªåŠ¨ä¿®å¤é—®é¢˜${NC}"
        echo -e "${CYAN}2. ğŸ“¥ å®‰è£…åˆ°ç³»ç»Ÿå‘½ä»¤${NC}"
        echo -e "${CYAN}3. ğŸ“Š æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€${NC}"
        echo -e "${CYAN}4. ğŸ“‹ æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—${NC}"
        echo -e "${CYAN}5. ğŸšª é€€å‡º${NC}"
        echo ""
        
        read -p "è¯·è¾“å…¥é€‰æ‹© (1-5): " choice
        
        case $choice in
            1)
                main_repair
                ;;
            2)
                install_systemwide
                ;;
            3)
                show_status
                ;;
            4)
                execute_command "cat '$LOG_FILE' | tail -20" "æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—"
                ;;
            5)
                echo -e "${GREEN}ğŸ‘‹ å†è§ï¼${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥${NC}"
                ;;
        esac
        
        echo ""
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
        clear
    done
}

# å‘½ä»¤è¡Œå‚æ•°å¤„ç†
case "${1:-}" in
    "repair"|"fix")
        main_repair
        ;;
    "install")
        install_systemwide
        ;;
    "status")
        show_status
        ;;
    "log")
        execute_command "cat '$LOG_FILE'" "æ˜¾ç¤ºå®Œæ•´æ—¥å¿—"
        ;;
    "menu"|"interactive")
        interactive_menu
        ;;
    *)
        echo -e "${GREEN}ğŸ¤– AIé©±åŠ¨äº¤äº’å¼ä¿®å¤ç³»ç»Ÿ${NC}"
        echo ""
        echo -e "${CYAN}è¿è¡Œä½ç½®: $(pwd)${NC}"
        echo -e "${CYAN}è„šæœ¬è·¯å¾„: $0${NC}"
        echo ""
        echo -e "${YELLOW}ä½¿ç”¨æ–¹æ³•:${NC}"
        echo "  $0 repair     - ğŸš€ AIè‡ªåŠ¨ä¿®å¤é—®é¢˜"
        echo "  $0 install    - ğŸ“¥ å®‰è£…åˆ°ç³»ç»Ÿå‘½ä»¤"
        echo "  $0 status     - ğŸ“Š æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€"
        echo "  $0 log        - ğŸ“‹ æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—"
        echo "  $0 menu       - ğŸ–¥ï¸ äº¤äº’å¼èœå•"
        echo ""
        echo -e "${PURPLE}æ¨èä½¿ç”¨: $0 menu è¿›å…¥äº¤äº’æ¨¡å¼${NC}"
        ;;
esac
