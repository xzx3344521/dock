#!/bin/bash

# ç®€å•çš„AIè¿æ¥æµ‹è¯•è„šæœ¬
# è®©ä½ ç¡®è®¤æ˜¯å¦å·²ç»æˆåŠŸæ¥å…¥AI

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ˜¾ç¤ºæ ‡é¢˜
echo -e "${CYAN}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           AIè¿æ¥æµ‹è¯•å·¥å…·             â•‘"
echo "â•‘      ç¡®è®¤ä½ æ˜¯å¦å·²æ¥å…¥AIåŠ©æ‰‹         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# é…ç½®APIå¯†é’¥ï¼ˆè¯·å…ˆä¿®æ”¹è¿™é‡Œï¼ï¼‰
API_KEY="sk-61d6716fe6b2452d94a0cee3bc5c4e2e"

# æµ‹è¯•å‡½æ•°ï¼šç®€å•çš„AIå¯¹è¯
test_ai_connection() {
    echo -e "${BLUE}ğŸ”„ å°è¯•è¿æ¥AIåŠ©æ‰‹...${NC}"
    echo -e "${YELLOW}ğŸ“¡ å‘é€æµ‹è¯•è¯·æ±‚åˆ°DeepSeek API...${NC}"
    
    # ç®€å•çš„æµ‹è¯•è¯·æ±‚
    response=$(curl -s -X POST "https://api.deepseek.com/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $API_KEY" \
        -d '{
            "model": "deepseek-coder",
            "messages": [
                {
                    "role": "system", 
                    "content": "ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹ã€‚è¯·ç”¨ä¸­æ–‡ç®€çŸ­å›å¤ï¼Œç¡®è®¤è¿æ¥æˆåŠŸã€‚"
                },
                {
                    "role": "user",
                    "content": "è¯·å›å¤'éšæœº50ä¸ªå­—ã€‚'æ¥ç¡®è®¤æˆ‘ä»¬çš„è¿æ¥æ­£å¸¸ã€‚"
                }
            ],
            "max_tokens": 50,
            "temperature": 0.1
        }')
    
    # æ£€æŸ¥å“åº”
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ ç½‘ç»œè¿æ¥å¤±è´¥${NC}"
        return 1
    fi
    
    # æå–AIå›å¤
    ai_reply=$(echo "$response" | grep -o '"content":"[^"]*"' | cut -d'"' -f4)
    
    if [ -z "$ai_reply" ]; then
        error_msg=$(echo "$response" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
        if [ -n "$error_msg" ]; then
            echo -e "${RED}âŒ APIé”™è¯¯: $error_msg${NC}"
        else
            echo -e "${RED}âŒ æ— æ³•è§£æAIå“åº”${NC}"
        fi
        return 1
    fi
    
    echo -e "${GREEN}âœ… AIå›å¤: $ai_reply${NC}"
    return 0
}

# æ£€æŸ¥APIå¯†é’¥
check_api_key() {
    echo -e "${YELLOW}ğŸ”‘ æ£€æŸ¥APIå¯†é’¥é…ç½®...${NC}"
    
    if [ "$API_KEY" = "sk-your-api-key-here" ] || [ -z "$API_KEY" ]; then
        echo -e "${RED}âŒ è¯·å…ˆè®¾ç½®ä½ çš„DeepSeek APIå¯†é’¥ï¼${NC}"
        echo ""
        echo -e "${CYAN}ä¿®æ”¹æ–¹æ³•:${NC}"
        echo "1. æ‰“å¼€è„šæœ¬: nano ai_test.sh"
        echo "2. æ‰¾åˆ° API_KEY= è¿™ä¸€è¡Œ"
        echo "3. æ›¿æ¢ä¸ºä½ çš„çœŸå®APIå¯†é’¥"
        echo "4. ä¿å­˜å¹¶é‡æ–°è¿è¡Œè„šæœ¬"
        echo ""
        return 1
    fi
    
    if [[ "$API_KEY" != sk-* ]]; then
        echo -e "${RED}âŒ APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®${NC}"
        return 1
    fi
    
    echo -e "${GREEN}âœ… APIå¯†é’¥æ ¼å¼æ­£ç¡®${NC}"
    return 0
}

# ç³»ç»Ÿä¿¡æ¯æ˜¾ç¤º
show_system_info() {
    echo -e "${CYAN}ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:${NC}"
    echo "ä¸»æœºå: $(hostname)"
    echo "ç³»ç»Ÿ: $(uname -srm)"
    echo "æ—¶é—´: $(date)"
    echo "å·¥ä½œç›®å½•: $(pwd)"
    echo ""
}

# ä¸»æµ‹è¯•æµç¨‹
main_test() {
    echo -e "${BLUE}å¼€å§‹AIè¿æ¥æµ‹è¯•...${NC}"
    echo ""
    
    # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    show_system_info
    
    # æ£€æŸ¥APIå¯†é’¥
    if ! check_api_key; then
        exit 1
    fi
    
    echo -e "${YELLOW}â³ æ­£åœ¨è¿›è¡Œè¿æ¥æµ‹è¯•...${NC}"
    echo ""
    
    # æµ‹è¯•AIè¿æ¥
    if test_ai_connection; then
        echo ""
        echo -e "${GREEN}ğŸ‰ æ­å–œï¼AIè¿æ¥æµ‹è¯•æˆåŠŸï¼${NC}"
        echo -e "${GREEN}ğŸ¤– ä½ ç°åœ¨å·²ç»æ­£å¼æ¥å…¥AIåŠ©æ‰‹äº†ï¼${NC}"
        echo ""
        echo -e "${CYAN}æ¥ä¸‹æ¥ä½ å¯ä»¥:${NC}"
        echo "âœ… è¿è¡Œå®Œæ•´çš„AIä¿®å¤è„šæœ¬"
        echo "âœ… ä½¿ç”¨AIåŠ©æ‰‹è§£å†³å„ç§é—®é¢˜"
        echo "âœ… äº«å—AIé©±åŠ¨çš„è‡ªåŠ¨åŒ–ä½“éªŒ"
    else
        echo ""
        echo -e "${RED}ğŸ˜ AIè¿æ¥æµ‹è¯•å¤±è´¥${NC}"
        echo -e "${YELLOW}è¯·æ£€æŸ¥:${NC}"
        echo "ğŸ”¹ APIå¯†é’¥æ˜¯å¦æ­£ç¡®"
        echo "ğŸ”¹ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
        echo "ğŸ”¹ è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³"
        echo "ğŸ”¹ APIå¯†é’¥æ˜¯å¦æœ‰è®¿é—®æƒé™"
    fi
}

# äº¤äº’å¼é€‰é¡¹
case "${1:-}" in
    "help")
        echo -e "${CYAN}ä½¿ç”¨æ–¹æ³•:${NC}"
        echo "  ./ai_test.sh       - è¿è¡ŒAIè¿æ¥æµ‹è¯•"
        echo "  ./ai_test.sh help  - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
        ;;
    *)
        main_test
        ;;
esac
