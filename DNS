#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log_info() { echo -e "${BLUE}ğŸ“¦ $1${NC}"; }
log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }
log_result() { echo -e "${CYAN}ğŸ“Š $1${NC}"; }

# DNSæä¾›å•†é…ç½®
declare -A DNS_PROVIDERS=(
    ["1"]="è…¾è®¯DNS:119.29.29.29,119.28.28.28"
    ["2"]="é˜¿é‡ŒDNS:223.5.5.5,223.6.6.6"
    ["3"]="114DNS:114.114.114.114,114.114.115.115"
    ["4"]="Cloudflare:1.1.1.1,1.0.0.1"
    ["5"]="GoogleDNS:8.8.8.8,8.8.4.4"
    ["6"]="OpenDNS:208.67.222.222,208.67.220.220"
    ["7"]="ç™¾åº¦DNS:180.76.76.76"
    ["8"]="CNNICSDNS:1.2.4.8,210.2.4.8"
)

# æ£€æµ‹å½“å‰DNS
detect_current_dns() {
    echo -e "${PURPLE}"
    echo "=================================================="
    echo "              ğŸŒˆ å½“å‰DNSæ£€æµ‹ç»“æœ"
    echo "=================================================="
    echo -e "${NC}"
    
    if [ -f /etc/resolv.conf ]; then
        current_dns=$(grep -E '^nameserver' /etc/resolv.conf | awk '{print $2}' | tr '\n' ' ')
        if [ -n "$current_dns" ]; then
            log_result "å½“å‰DNSæœåŠ¡å™¨: $current_dns"
            
            # è¯†åˆ«DNSæä¾›å•†
            for provider in "${!DNS_PROVIDERS[@]}"; do
                dns_ips=${DNS_PROVIDERS[$provider]#*:}
                primary_dns=${dns_ips%,*}
                if [[ "$current_dns" == *"$primary_dns"* ]]; then
                    provider_name=${DNS_PROVIDERS[$provider]%:*}
                    log_success "è¯†åˆ«ä¸º: $provider_name"
                    break
                fi
            done
        else
            log_warning "æœªæ£€æµ‹åˆ°DNSé…ç½®"
        fi
    else
        log_error "æœªæ‰¾åˆ° resolv.conf æ–‡ä»¶"
    fi
    echo ""
}

# æµ‹è¯•DNSé€Ÿåº¦
test_dns_speed() {
    local dns_ips=$1
    local provider_name=$2
    
    log_info "æµ‹è¯• $provider_name é€Ÿåº¦..."
    IFS=',' read -ra dns_array <<< "$dns_ips"
    
    for dns_ip in "${dns_array[@]}"; do
        if ping -c 2 -W 2 "$dns_ip" >/dev/null 2>&1; then
            start_time=$(date +%s%N)
            nslookup baidu.com "$dns_ip" >/dev/null 2>&1
            end_time=$(date +%s%N)
            time_ms=$(( (end_time - start_time) / 1000000 ))
            
            if [ $time_ms -lt 50 ]; then
                echo -e "  ${GREEN}$dns_ip: ${time_ms}ms âœ…${NC}"
            elif [ $time_ms -lt 100 ]; then
                echo -e "  ${YELLOW}$dns_ip: ${time_ms}ms âš ï¸${NC}"
            else
                echo -e "  ${RED}$dns_ip: ${time_ms}ms âŒ${NC}"
            fi
        else
            echo -e "  ${RED}$dns_ip: æ— æ³•è¿æ¥ âŒ${NC}"
        fi
    done
}

# æ˜¾ç¤ºDNSèœå•
show_dns_menu() {
    echo -e "${PURPLE}"
    echo "=================================================="
    echo "              ğŸŒˆ ä¸»æµDNSæä¾›å•†"
    echo "=================================================="
    echo -e "${NC}"
    
    for key in "${!DNS_PROVIDERS[@]}"; do
        provider_name=${DNS_PROVIDERS[$key]%:*}
        dns_ips=${DNS_PROVIDERS[$key]#*:}
        echo -e "  ${CYAN}$key. $provider_name${NC}"
        echo -e "     ${BLUE}$dns_ips${NC}"
    done
    echo ""
}

# ä¸´æ—¶è®¾ç½®DNS
set_dns_temporary() {
    local provider_key=$1
    local provider_name=${DNS_PROVIDERS[$provider_key]%:*}
    local dns_ips=${DNS_PROVIDERS[$provider_key]#*:}
    
    log_info "ä¸´æ—¶è®¾ç½®ä¸º: $provider_name"
    
    # å¤‡ä»½å½“å‰é…ç½®
    cp /etc/resolv.conf /etc/resolv.conf.backup.$(date +%Y%m%d_%H%M%S)
    
    # ç”Ÿæˆæ–°çš„resolv.conf
    echo "# ä¸´æ—¶è®¾ç½® - $provider_name ($(date))" > /etc/resolv.conf
    IFS=',' read -ra dns_array <<< "$dns_ips"
    for dns_ip in "${dns_array[@]}"; do
        echo "nameserver $dns_ip" >> /etc/resolv.conf
    done
    echo "options timeout:2 attempts:3" >> /etc/resolv.conf
    
    log_success "ä¸´æ—¶DNSè®¾ç½®å®Œæˆ (é‡å¯åæ¢å¤)"
}

# æ°¸ä¹…è®¾ç½®DNS
set_dns_permanent() {
    local provider_key=$1
    local provider_name=${DNS_PROVIDERS[$provider_key]%:*}
    local dns_ips=${DNS_PROVIDERS[$provider_key]#*:}
    
    log_info "æ°¸ä¹…è®¾ç½®ä¸º: $provider_name"
    
    # å¤‡ä»½å½“å‰é…ç½®
    cp /etc/resolv.conf /etc/resolv.conf.backup.$(date +%Y%m%d_%H%M%S)
    
    # æ£€æŸ¥å¹¶ç¦ç”¨systemd-resolved
    if systemctl is-active systemd-resolved >/dev/null 2>&1; then
        log_warning "æ£€æµ‹åˆ°systemd-resolvedï¼Œæ­£åœ¨ç¦ç”¨..."
        systemctl stop systemd-resolved
        systemctl disable systemd-resolved
    fi
    
    # ç”Ÿæˆæ°¸ä¹…é…ç½®
    echo "# æ°¸ä¹…è®¾ç½® - $provider_name ($(date))" > /etc/resolv.conf
    IFS=',' read -ra dns_array <<< "$dns_ips"
    for dns_ip in "${dns_array[@]}"; do
        echo "nameserver $dns_ip" >> /etc/resolv.conf
    done
    echo "options timeout:2 attempts:3" >> /etc/resolv.conf
    
    # é˜²æ­¢NetworkManagerè¦†ç›–
    if command -v NetworkManager >/dev/null 2>&1; then
        log_info "é…ç½®NetworkManager..."
        nmcli connection show | grep -v NAME | awk '{print $1}' | while read conn; do
            nmcli connection modify "$conn" ipv4.ignore-auto-dns yes
            for dns_ip in "${dns_array[@]}"; do
                nmcli connection modify "$conn" ipv4.dns "$dns_ip"
            done
        done
    fi
    
    # è®¾ç½®æ–‡ä»¶å±æ€§é˜²æ­¢è¢«è¦†ç›–
    chattr +i /etc/resolv.conf 2>/dev/null || true
    
    log_success "æ°¸ä¹…DNSè®¾ç½®å®Œæˆ"
}

# æ¢å¤å¤‡ä»½
restore_backup() {
    local backup_files=($(ls -t /etc/resolv.conf.backup.* 2>/dev/null))
    
    if [ ${#backup_files[@]} -eq 0 ]; then
        log_error "æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
        return 1
    fi
    
    echo -e "${YELLOW}å¯ç”¨çš„å¤‡ä»½æ–‡ä»¶:${NC}"
    for i in "${!backup_files[@]}"; do
        echo "  $((i+1)). ${backup_files[$i]}"
    done
    
    read -p "é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½ç¼–å· (1-${#backup_files[@]}): " backup_choice
    if [[ $backup_choice =~ ^[0-9]+$ ]] && [ $backup_choice -ge 1 ] && [ $backup_choice -le ${#backup_files[@]} ]; then
        selected_backup="${backup_files[$((backup_choice-1))]}"
        
        # è§£é™¤æ–‡ä»¶é”å®š
        chattr -i /etc/resolv.conf 2>/dev/null || true
        
        cp "$selected_backup" /etc/resolv.conf
        log_success "å·²ä» $selected_backup æ¢å¤DNSè®¾ç½®"
    else
        log_error "æ— æ•ˆçš„é€‰æ‹©"
    fi
}

# ä¸»å‡½æ•°
main() {
    # æ£€æµ‹å½“å‰DNS
    detect_current_dns
    
    while true; do
        echo -e "${PURPLE}"
        echo "=================================================="
        echo "              ğŸŒˆ DNSåˆ‡æ¢ç®¡ç†è„šæœ¬"
        echo "=================================================="
        echo -e "${NC}"
        
        echo -e "${CYAN}è¯·é€‰æ‹©æ“ä½œ:${NC}"
        echo "  1. åˆ‡æ¢DNSæä¾›å•†"
        echo "  2. æµ‹è¯•æ‰€æœ‰DNSé€Ÿåº¦"
        echo "  3. æ¢å¤DNSå¤‡ä»½"
        echo "  4. æ˜¾ç¤ºå½“å‰DNS"
        echo "  5. é€€å‡º"
        echo ""
        
        read -p "è¯·è¾“å…¥é€‰æ‹© (1-5): " main_choice
        
        case $main_choice in
            1)
                show_dns_menu
                read -p "é€‰æ‹©DNSæä¾›å•† (1-8): " dns_choice
                if [[ -n "${DNS_PROVIDERS[$dns_choice]}" ]]; then
                    echo ""
                    echo -e "${CYAN}è¯·é€‰æ‹©è®¾ç½®æ–¹å¼:${NC}"
                    echo "  1. ä¸´æ—¶è®¾ç½® (é‡å¯åå¤±æ•ˆ)"
                    echo "  2. æ°¸ä¹…è®¾ç½®"
                    read -p "è¯·è¾“å…¥é€‰æ‹© (1-2): " set_type
                    
                    case $set_type in
                        1) set_dns_temporary "$dns_choice" ;;
                        2) set_dns_permanent "$dns_choice" ;;
                        *) log_error "æ— æ•ˆçš„é€‰æ‹©" ;;
                    esac
                else
                    log_error "æ— æ•ˆçš„DNSé€‰æ‹©"
                fi
                ;;
            2)
                echo ""
                log_info "æµ‹è¯•æ‰€æœ‰DNSæä¾›å•†é€Ÿåº¦..."
                for key in "${!DNS_PROVIDERS[@]}"; do
                    provider_name=${DNS_PROVIDERS[$key]%:*}
                    dns_ips=${DNS_PROVIDERS[$key]#*:}
                    test_dns_speed "$dns_ips" "$provider_name"
                    echo ""
                done
                ;;
            3)
                restore_backup
                ;;
            4)
                detect_current_dns
                ;;
            5)
                log_success "å†è§ï¼"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆçš„é€‰æ‹©"
                ;;
        esac
        
        echo ""
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
        clear
    done
}

# è„šæœ¬å…¥å£
if [ "$(id -u)" -ne 0 ]; then
    log_error "è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

main
