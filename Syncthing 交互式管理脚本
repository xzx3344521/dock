#!/bin/bash

# Syncthing äº¤äº’å¼ç®¡ç†è„šæœ¬
set -e

# é…ç½®å˜é‡
SYNCTHING_VERSION="v1.27.7"
INSTALL_DIR="/opt/syncthing"
CONFIG_DIR="$HOME/.config/syncthing"
SERVICE_FILE="/etc/systemd/system/syncthing.service"
BIN_PATH="/usr/local/bin/syncthing"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# è¾“å‡ºå‡½æ•°
log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }
log_menu() { echo -e "${PURPLE}âœ¨ $1${NC}"; }
log_step() { echo -e "${CYAN}ğŸ“Œ $1${NC}"; }

# æ˜¾ç¤ºç‚«é…·æ ‡é¢˜
show_header() {
    clear
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           Syncthing äº¤äº’å¼ç®¡ç†è„šæœ¬          â•‘"
    echo "â•‘                ç›´æ¥å®‰è£… Â· æç®€ä½¿ç”¨          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
show_status() {
    log_step "ç³»ç»ŸçŠ¶æ€æ£€æŸ¥..."
    
    # æ£€æŸ¥å®‰è£…çŠ¶æ€
    if [ -f "$BIN_PATH" ]; then
        log_success "Syncthing: å·²å®‰è£…"
        echo "    ğŸ“ å®‰è£…è·¯å¾„: $INSTALL_DIR"
        echo "    âš™ï¸  é…ç½®è·¯å¾„: $CONFIG_DIR"
    else
        log_warning "Syncthing: æœªå®‰è£…"
    fi
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet syncthing 2>/dev/null; then
        log_success "æœåŠ¡çŠ¶æ€: è¿è¡Œä¸­"
        LOCAL_IP=$(hostname -I | awk '{print $1}')
        echo "    ğŸŒ è®¿é—®åœ°å€: http://${LOCAL_IP}:8384"
    elif systemctl is-enabled syncthing 2>/dev/null; then
        log_warning "æœåŠ¡çŠ¶æ€: å·²åœæ­¢"
    else
        log_warning "æœåŠ¡çŠ¶æ€: æœªé…ç½®"
    fi
    
    # æ£€æŸ¥ç«¯å£
    if ss -tuln | grep -q ":8384 "; then
        log_success "ç½‘ç»œç«¯å£: 8384 æ­£åœ¨ç›‘å¬"
    else
        log_warning "ç½‘ç»œç«¯å£: 8384 æœªç›‘å¬"
    fi
    echo ""
}

# ç­‰å¾…ç”¨æˆ·æŒ‰é”®
press_any_key() {
    echo -e "${YELLOW}"
    read -n 1 -s -r -p "ğŸ”¸ æŒ‰ä»»æ„é”®ç»§ç»­..."
    echo -e "${NC}"
    echo ""
}

# å®‰è£… Syncthing
install_syncthing() {
    show_header
    log_menu "å¼€å§‹å®‰è£… Syncthing"
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    if [ -f "$BIN_PATH" ]; then
        log_warning "æ£€æµ‹åˆ° Syncthing å·²å®‰è£…ï¼"
        echo ""
        echo "è¯·é€‰æ‹©ï¼š"
        echo "  1) é‡æ–°å®‰è£…ï¼ˆè¦†ç›–ç°æœ‰ç‰ˆæœ¬ï¼‰"
        echo "  2) è¿”å›ä¸»èœå•"
        echo "  3) æŸ¥çœ‹å½“å‰çŠ¶æ€"
        
        read -p "è¯·è¾“å…¥é€‰æ‹© [1-3]: " choice
        case $choice in
            1)
                log_info "å¼€å§‹é‡æ–°å®‰è£…..."
                ;;
            2)
                return
                ;;
            3)
                show_status
                press_any_key
                return
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©"
                press_any_key
                return
                ;;
        esac
    fi
    
    log_step "æ­¥éª¤ 1/5 - åˆ›å»ºå®‰è£…ç›®å½•..."
    sudo mkdir -p $INSTALL_DIR
    sudo chown $USER:$USER $INSTALL_DIR
    
    log_step "æ­¥éª¤ 2/5 - ä¸‹è½½ Syncthing $SYNCTHING_VERSION..."
    cd /tmp
    if wget -q --show-progress https://github.com/syncthing/syncthing/releases/download/$SYNCTHING_VERSION/syncthing-linux-amd64-$SYNCTHING_VERSION.tar.gz; then
        log_success "ä¸‹è½½å®Œæˆ"
    else
        log_error "ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
        press_any_key
        return
    fi
    
    log_step "æ­¥éª¤ 3/5 - è§£å‹å’Œå®‰è£…..."
    tar xzf syncthing-linux-amd64-$SYNCTHING_VERSION.tar.gz
    cd syncthing-linux-amd64-$SYNCTHING_VERSION
    
    sudo cp syncthing $INSTALL_DIR/
    sudo chmod +x $INSTALL_DIR/syncthing
    sudo ln -sf $INSTALL_DIR/syncthing $BIN_PATH
    
    log_step "æ­¥éª¤ 4/5 - åˆ›å»ºç³»ç»ŸæœåŠ¡..."
    mkdir -p $CONFIG_DIR
    
    sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=Syncthing - Open Source Continuous File Synchronization
After=network.target

[Service]
Type=simple
User=$USER
ExecStart=$BIN_PATH -no-browser -gui-address="0.0.0.0:8384" -no-restart
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    
    log_step "æ­¥éª¤ 5/5 - å¯åŠ¨æœåŠ¡..."
    sudo systemctl enable syncthing
    sudo systemctl start syncthing
    
    # ç­‰å¾…å¯åŠ¨
    log_info "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
    for i in {1..10}; do
        if systemctl is-active --quiet syncthing; then
            break
        fi
        sleep 1
        echo -n "."
    done
    echo ""
    
    if systemctl is-active --quiet syncthing; then
        log_success "ğŸ‰ å®‰è£…å®Œæˆï¼"
        LOCAL_IP=$(hostname -I | awk '{print $1}')
        echo ""
        echo "âœ¨ è®¿é—®ä¿¡æ¯:"
        echo "   ğŸŒ ç®¡ç†ç•Œé¢: http://${LOCAL_IP}:8384"
        echo "   ğŸ“ ç›´æ¥ä½¿ç”¨IPè®¿é—®ï¼Œæ— éœ€å¤æ‚é…ç½®"
        echo ""
        echo "ğŸ“‹ ä¸‹ä¸€æ­¥å»ºè®®:"
        echo "   1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ä¸Šè¿°åœ°å€"
        echo "   2. æ·»åŠ éœ€è¦åŒæ­¥çš„æ–‡ä»¶å¤¹"
        echo "   3. é…ç½®å…¶ä»–è®¾å¤‡è¿›è¡ŒåŒæ­¥"
    else
        log_error "æœåŠ¡å¯åŠ¨å¤±è´¥"
        log_info "è¯·è¿è¡Œ: sudo systemctl status syncthing æŸ¥çœ‹è¯¦æƒ…"
    fi
    
    # æ¸…ç†
    rm -rf /tmp/syncthing-linux-amd64*
    press_any_key
}

# å¸è½½ Syncthing
uninstall_syncthing() {
    show_header
    log_menu "å¸è½½ Syncthing"
    
    if [ ! -f "$BIN_PATH" ]; then
        log_warning "æœªæ‰¾åˆ° Syncthing å®‰è£…æ–‡ä»¶ï¼Œå¯èƒ½æœªå®‰è£…"
        press_any_key
        return
    fi
    
    log_warning "âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œå°†å¸è½½ Syncthing"
    echo ""
    echo "å°†åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š"
    echo "  âœ… ç¨‹åºæ–‡ä»¶: $INSTALL_DIR/"
    echo "  âœ… ç³»ç»ŸæœåŠ¡: syncthing.service"
    echo "  âœ… å¯åŠ¨é“¾æ¥: $BIN_PATH"
    echo ""
    
    read -p "â“ æ˜¯å¦ç»§ç»­å¸è½½ï¼Ÿ[y/N]: " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "å–æ¶ˆå¸è½½"
        press_any_key
        return
    fi
    
    log_step "åœæ­¢æœåŠ¡..."
    sudo systemctl stop syncthing 2>/dev/null || true
    sudo systemctl disable syncthing 2>/dev/null || true
    
    log_step "åˆ é™¤æœåŠ¡æ–‡ä»¶..."
    sudo rm -f $SERVICE_FILE
    sudo systemctl daemon-reload
    
    log_step "åˆ é™¤ç¨‹åºæ–‡ä»¶..."
    sudo rm -rf $INSTALL_DIR
    sudo rm -f $BIN_PATH
    
    echo ""
    read -p "â“ æ˜¯å¦åˆ é™¤é…ç½®æ–‡ä»¶ï¼Ÿ[y/N]: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_step "åˆ é™¤é…ç½®æ–‡ä»¶..."
        rm -rf $CONFIG_DIR
        log_success "é…ç½®å·²åˆ é™¤"
    else
        log_info "é…ç½®æ–‡ä»¶ä¿ç•™åœ¨: $CONFIG_DIR"
    fi
    
    log_success "å¸è½½å®Œæˆï¼"
    press_any_key
}

# æœåŠ¡ç®¡ç†
manage_service() {
    show_header
    log_menu "æœåŠ¡ç®¡ç†"
    
    if [ ! -f "$BIN_PATH" ]; then
        log_error "Syncthing æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…"
        press_any_key
        return
    fi
    
    show_status
    
    echo "è¯·é€‰æ‹©æ“ä½œï¼š"
    echo "  1) å¯åŠ¨æœåŠ¡"
    echo "  2) åœæ­¢æœåŠ¡" 
    echo "  3) é‡å¯æœåŠ¡"
    echo "  4) æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  5) æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  6) è¿”å›ä¸»èœå•"
    
    read -p "è¯·è¾“å…¥é€‰æ‹© [1-6]: " choice
    case $choice in
        1)
            log_step "å¯åŠ¨æœåŠ¡..."
            sudo systemctl start syncthing
            sleep 2
            if systemctl is-active --quiet syncthing; then
                log_success "æœåŠ¡å¯åŠ¨æˆåŠŸ"
            else
                log_error "æœåŠ¡å¯åŠ¨å¤±è´¥"
            fi
            ;;
        2)
            log_step "åœæ­¢æœåŠ¡..."
            sudo systemctl stop syncthing
            log_success "æœåŠ¡å·²åœæ­¢"
            ;;
        3)
            log_step "é‡å¯æœåŠ¡..."
            sudo systemctl restart syncthing
            sleep 2
            if systemctl is-active --quiet syncthing; then
                log_success "æœåŠ¡é‡å¯æˆåŠŸ"
            else
                log_error "æœåŠ¡é‡å¯å¤±è´¥"
            fi
            ;;
        4)
            log_step "æœåŠ¡çŠ¶æ€ï¼š"
            sudo systemctl status syncthing
            ;;
        5)
            log_step "å¼€å§‹æ˜¾ç¤ºå®æ—¶æ—¥å¿—ï¼ˆCtrl+C é€€å‡ºï¼‰..."
            sudo journalctl -u syncthing -f
            ;;
        6)
            return
            ;;
        *)
            log_error "æ— æ•ˆé€‰æ‹©"
            ;;
    esac
    press_any_key
}

# å¿«é€Ÿè®¿é—®
quick_access() {
    show_header
    log_menu "å¿«é€Ÿè®¿é—®"
    
    if ! systemctl is-active --quiet syncthing 2>/dev/null; then
        log_error "æœåŠ¡æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨æœåŠ¡"
        press_any_key
        return
    fi
    
    LOCAL_IP=$(hostname -I | awk '{print $1}')
    
    log_success "è®¿é—®ä¿¡æ¯ï¼š"
    echo "   ğŸŒ æœ¬åœ°è®¿é—®: http://127.0.0.1:8384"
    echo "   ğŸŒ ç½‘ç»œè®¿é—®: http://${LOCAL_IP}:8384"
    echo "   ğŸ“ ç«¯å£: 8384"
    echo ""
    
    echo "å¿«æ·æ“ä½œï¼š"
    echo "  1) ç”¨é»˜è®¤æµè§ˆå™¨æ‰“å¼€"
    echo "  2) å¤åˆ¶è®¿é—®åœ°å€åˆ°å‰ªè´´æ¿"
    echo "  3) æ˜¾ç¤ºäºŒç»´ç ï¼ˆå¦‚æœæœ‰ï¼‰"
    echo "  4) è¿”å›ä¸»èœå•"
    
    read -p "è¯·è¾“å…¥é€‰æ‹© [1-4]: " choice
    case $choice in
        1)
            if command -v xdg-open >/dev/null; then
                xdg-open "http://${LOCAL_IP}:8384"
                log_success "å·²å°è¯•æ‰“å¼€æµè§ˆå™¨"
            else
                log_info "è¯·åœ¨æµè§ˆå™¨ä¸­è®¿é—®: http://${LOCAL_IP}:8384"
            fi
            ;;
        2)
            if command -v xclip >/dev/null; then
                echo "http://${LOCAL_IP}:8384" | xclip -selection clipboard
                log_success "åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"
            else
                log_info "è¯·æ‰‹åŠ¨å¤åˆ¶: http://${LOCAL_IP}:8384"
            fi
            ;;
        3)
            log_info "äºŒç»´ç åŠŸèƒ½éœ€è¦é¢å¤–å·¥å…·æ”¯æŒ"
            ;;
        4)
            return
            ;;
        *)
            log_error "æ— æ•ˆé€‰æ‹©"
            ;;
    esac
    press_any_key
}

# æ˜¾ç¤ºä¸»èœå•
show_main_menu() {
    show_header
    show_status
    
    log_menu "ä¸»èœå•"
    echo "è¯·é€‰æ‹©æ“ä½œï¼š"
    echo "  1) å®‰è£… Syncthing"
    echo "  2) å¸è½½ Syncthing"
    echo "  3) æœåŠ¡ç®¡ç†ï¼ˆå¯åŠ¨/åœæ­¢/é‡å¯ï¼‰"
    echo "  4) å¿«é€Ÿè®¿é—®"
    echo "  5) æŸ¥çœ‹è¯¦ç»†çŠ¶æ€"
    echo "  6) é€€å‡ºè„šæœ¬"
    echo ""
}

# ä¸»å¾ªç¯
main() {
    while true; do
        show_main_menu
        read -p "è¯·è¾“å…¥é€‰æ‹© [1-6]: " choice
        
        case $choice in
            1)
                install_syncthing
                ;;
            2)
                uninstall_syncthing
                ;;
            3)
                manage_service
                ;;
            4)
                quick_access
                ;;
            5)
                show_header
                show_status
                press_any_key
                ;;
            6)
                log_success "å†è§ï¼"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 1-6 ä¹‹é—´çš„æ•°å­—"
                sleep 2
                ;;
        esac
    done
}

# è„šæœ¬å¯åŠ¨
if [[ $1 == "-y" || $1 == "--auto" ]]; then
    # éäº¤äº’æ¨¡å¼
    if [ ! -f "$BIN_PATH" ]; then
        install_syncthing
    else
        show_status
    fi
else
    # äº¤äº’æ¨¡å¼
    main
fi
