cat > /data/install_docker_online.sh << 'EOF'
#!/bin/bash

# ================= é…ç½®åŒºåŸŸ =================
# ä¸»çº¿è·¯ (Cloudflare R2 - é€šå¸¸é€Ÿåº¦å¿«ä¸”ç¨³å®š)
URL_PRIMARY="https://pub-b69a7194f4ea42fba6aa990c49bded91.r2.dev/xui/dockde12.zip"
# å¤‡ç”¨çº¿è·¯ (ä¸ªäººVPS - å…œåº•ç”¨)
URL_BACKUP="https://freeyx.vps3344.dpdns.org/xui/dockde12.zip"

INSTALL_DIR="/data/docker_install_temp"
ZIP_FILE="$INSTALL_DIR/dockde12.zip"
TARGET_VER="29.1.3"
# ===========================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}====================================================${NC}"
echo -e "${BLUE}   Docker å…¨è‡ªåŠ¨åœ¨çº¿å®‰è£…è„šæœ¬ V4.0 (åŒçº¿è·¯ç‰ˆ)       ${NC}"
echo -e "${BLUE}====================================================${NC}"

# 1.ã€æƒé™ä¸æ¶æ„æ£€æŸ¥ã€‘
if [ "$(id -u)" -ne 0 ]; then
    echo -e "${RED}âŒ é”™è¯¯: è¯·ä½¿ç”¨ root æƒé™è¿è¡Œï¼${NC}"; exit 1
fi
if [ "$(uname -m)" != "x86_64" ]; then
    echo -e "${RED}âŒ é”™è¯¯: æ­¤å®‰è£…åŒ…ä»…æ”¯æŒ x86_64 (AMD64) æ¶æ„ã€‚${NC}"; exit 1
fi

# 2.ã€å½»åº•æ¸…ç†å†²çªä¸æ®‹ç•™ã€‘
echo -e "${YELLOW}ğŸ§¹ æ­¥éª¤1/5: æ¸…ç†æ—§ç‰ˆæœ¬ä¸å†²çªé…ç½®...${NC}"
systemctl stop docker >/dev/null 2>&1
systemctl stop containerd >/dev/null 2>&1

# å…³é”®ï¼šç§»é™¤å¯èƒ½å¯¼è‡´æœåŠ¡å¯åŠ¨å¤±è´¥çš„ containerd é…ç½®æ–‡ä»¶
if [ -f /etc/containerd/config.toml ]; then
    echo "   -> å¤‡ä»½å¹¶ç§»é™¤æ—§çš„ containerd é…ç½® (é˜²æ­¢å†²çª)..."
    mv /etc/containerd/config.toml /etc/containerd/config.toml.bak.$(date +%s)
fi

# å¸è½½å†²çªè½¯ä»¶
PKGS="docker.io docker-doc docker-compose podman-docker containerd runc docker-ce docker-ce-cli containerd.io"
for pkg in $PKGS; do
    if dpkg -l | grep -q "$pkg"; then
        apt-get remove -y "$pkg" >/dev/null 2>&1
        apt-get purge -y "$pkg" >/dev/null 2>&1
    fi
done
apt-get autoremove -y >/dev/null 2>&1

# 3.ã€æ™ºèƒ½ä¸‹è½½ã€‘(åŒçº¿è·¯åˆ‡æ¢)
echo -e "${YELLOW}ğŸ“¥ æ­¥éª¤2/5: å¼€å§‹ä¸‹è½½å®‰è£…åŒ…...${NC}"
rm -rf "$INSTALL_DIR"
mkdir -p "$INSTALL_DIR"

download_success=0

# æ£€æŸ¥å·¥å…·
if command -v curl >/dev/null 2>&1; then
    DL_CMD="curl -L -k --retry 3 --connect-timeout 10 -o"
elif command -v wget >/dev/null 2>&1; then
    DL_CMD="wget --no-check-certificate -t 3 -T 10 -O"
else
    echo -e "${RED}âŒ é”™è¯¯: ç³»ç»Ÿç¼ºå°‘ curl æˆ– wgetï¼Œæ— æ³•ä¸‹è½½ã€‚${NC}"
    echo "å°è¯•è¿è¡Œ: apt-get update && apt-get install curl -y"
    exit 1
fi

# å°è¯•çº¿è·¯ 1
echo "   -> æ­£åœ¨å°è¯•ä¸»çº¿è·¯ (R2 Storage)..."
$DL_CMD "$ZIP_FILE" "$URL_PRIMARY"
if [ $? -eq 0 ] && [ -s "$ZIP_FILE" ]; then
    echo -e "${GREEN}   -> ä¸»çº¿è·¯ä¸‹è½½æˆåŠŸï¼${NC}"
    download_success=1
else
    echo -e "${RED}   -> ä¸»çº¿è·¯ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºï¼Œåˆ‡æ¢å¤‡ç”¨çº¿è·¯...${NC}"
    # å°è¯•çº¿è·¯ 2
    echo "   -> æ­£åœ¨å°è¯•å¤‡ç”¨çº¿è·¯ (VPS)..."
    $DL_CMD "$ZIP_FILE" "$URL_BACKUP"
    if [ $? -eq 0 ] && [ -s "$ZIP_FILE" ]; then
        echo -e "${GREEN}   -> å¤‡ç”¨çº¿è·¯ä¸‹è½½æˆåŠŸï¼${NC}"
        download_success=1
    fi
fi

if [ $download_success -eq 0 ]; then
    echo -e "${RED}âŒ é”™è¯¯: æ‰€æœ‰ä¸‹è½½çº¿è·¯å‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚${NC}"; exit 1
fi

# 4.ã€æ™ºèƒ½è§£å‹ã€‘
echo -e "${YELLOW}ğŸ“¦ æ­¥éª¤3/5: è§£å‹å®‰è£…åŒ…...${NC}"
cd "$INSTALL_DIR" || exit

# ä¼˜å…ˆç”¨ unzipï¼Œå¤±è´¥ç”¨ python
if command -v unzip >/dev/null 2>&1; then
    unzip -o "$ZIP_FILE" >/dev/null 2>&1
else
    echo "   -> æœªæ‰¾åˆ° unzipï¼Œä½¿ç”¨ Python è§£å‹..."
    python3 -c "import zipfile; zipfile.ZipFile('$ZIP_FILE', 'r').extractall('.')"
fi

# æ•´ç†æ–‡ä»¶ (é˜²æ­¢å¥—å¨ƒç›®å½•)
find . -name "*.deb" -exec mv {} . \; 2>/dev/null
DEB_COUNT=$(ls *.deb 2>/dev/null | wc -l)
if [ "$DEB_COUNT" -eq 0 ]; then
    echo -e "${RED}âŒ é”™è¯¯: å‹ç¼©åŒ…å·²ä¸‹è½½ä½†æœªæ‰¾åˆ° .deb æ–‡ä»¶ï¼Œå¯èƒ½æ–‡ä»¶å·²æŸåã€‚${NC}"; exit 1
fi

# 5.ã€å¼ºåŠ›å®‰è£…ã€‘
echo -e "${YELLOW}ğŸš€ æ­¥éª¤4/5: æ‰§è¡Œå®‰è£…...${NC}"
dpkg -i --force-overwrite *.deb >/dev/null 2>&1

if [ $? -ne 0 ]; then
    echo -e "${RED}âš  é¦–æ¬¡å®‰è£…ä¾èµ–ä¸è¶³ï¼Œæ­£åœ¨å°è¯•è‡ªåŠ¨ä¿®å¤...${NC}"
    apt-get update --allow-insecure-repositories >/dev/null 2>&1
    apt-get install -f -y
    echo "   -> ä¿®å¤å®Œæˆï¼Œé‡è¯•å®‰è£…..."
    dpkg -i --force-overwrite *.deb
fi

# 6.ã€å¯åŠ¨ä¸éªŒè¯ã€‘
echo -e "${YELLOW}âš™ æ­¥éª¤5/5: é…ç½®å¹¶å¯åŠ¨æœåŠ¡...${NC}"
systemctl daemon-reload
systemctl unmask docker >/dev/null 2>&1
systemctl enable docker
systemctl restart docker

# æ£€æŸ¥ Docker çŠ¶æ€
echo "----------------------------------------------------"
FINAL_VER=$(docker --version 2>/dev/null)
if [[ "$FINAL_VER" == *"$TARGET_VER"* ]]; then
    echo -e "${GREEN}âœ… å®‰è£…æˆåŠŸï¼${NC}"
    echo -e "   Docker ç‰ˆæœ¬: $FINAL_VER"
    echo -e "   Composeç‰ˆæœ¬: $(docker compose version 2>/dev/null)"
    
    # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜æ´»
    if systemctl is-active --quiet docker; then
        echo -e "   æœåŠ¡çŠ¶æ€:    ${GREEN}è¿è¡Œæ­£å¸¸ (Active)${NC}"
    else
        echo -e "   æœåŠ¡çŠ¶æ€:    ${RED}å¯åŠ¨å¤±è´¥ (Failed)${NC}"
        echo -e "   å»ºè®®æŸ¥çœ‹æ—¥å¿—: journalctl -xeu docker.service"
    fi
else
    echo -e "${RED}âŒ å®‰è£…å¤±è´¥æˆ–ç‰ˆæœ¬ä¸åŒ¹é…ã€‚${NC}"
fi

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf "$INSTALL_DIR"
echo -e "${BLUE}====================================================${NC}"
EOF

# èµ‹äºˆæ‰§è¡Œæƒé™å¹¶è¿è¡Œ
chmod +x /data/install_docker_online.sh
bash /data/install_docker_online.sh
