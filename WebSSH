#!/bin/bash

# NexTerm 一键安装脚本
echo "开始安装 NexTerm..."

# 创建安装目录
mkdir -p /opt/nexterm
cd /opt/nexterm

# 创建 docker-compose.yml 文件
cat > docker-compose.yml << 'EOF'
version: '3'

services:
  nexterm:
    environment:
      ENCRYPTION_KEY: "aba3aa8e29b9904d5d8d705230b664c053415c54be20ad13be99af0057dfa23a"
    ports:
      - "4589:6989"
    restart: always
    volumes:
      - nexterm:/app/data
    image: germannewsmaker/nexterm:1.0.5-OPEN-PREVIEW

volumes:
  nexterm:
EOF

# 尝试启动 Docker 服务（如果系统支持）
systemctl start docker 2>/dev/null || service docker start 2>/dev/null || true

# 拉取并启动容器
echo "正在拉取镜像并启动容器..."
docker-compose pull
docker-compose up -d

# 检查服务状态
echo "等待服务启动..."
sleep 10

# 显示安装结果
if docker ps | grep -q nexterm; then
    echo "=================================================="
    echo "NexTerm 安装完成！"
    echo "访问地址: http://服务器IP:4589"
    echo ""
    echo "检查服务状态: cd /opt/nexterm && docker-compose ps"
    echo "停止服务: cd /opt/nexterm && docker-compose stop"
    echo "重启服务: cd /opt/nexterm && docker-compose restart"
    echo "查看日志: cd /opt/nexterm && docker-compose logs"
    echo "=================================================="
else
    echo "安装可能存在问题，请检查 Docker 服务是否正常运行"
    echo "可以尝试手动启动: cd /opt/nexterm && docker-compose up -d"
fi
