#!/bin/bash

echo "ğŸ” å¼€å§‹å®‰å…¨æ¸…ç† NexTerm..."

# æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨åŠå…¶çŠ¶æ€
echo "1. æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
docker ps -a | grep nexterm

# è·å–å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯
echo "2. è·å–å®¹å™¨è¯¦ç»†ä¿¡æ¯..."
CONTAINER_INFO=$(docker inspect nexterm 2>/dev/null || echo "å®¹å™¨ä¸å­˜åœ¨")

if [ "$CONTAINER_INFO" != "å®¹å™¨ä¸å­˜åœ¨" ]; then
    echo "ğŸ“¦ å®¹å™¨ä¿¡æ¯:"
    echo "   çŠ¶æ€: $(echo "$CONTAINER_INFO" | grep '"Status"' | head -1)"
    echo "   é•œåƒ: $(echo "$CONTAINER_INFO" | grep '"Image"' | head -1)"
    echo "   åˆ›å»ºæ—¶é—´: $(echo "$CONTAINER_INFO" | grep '"Created"' | head -1)"
    
    # è·å–å®¹å™¨ä½¿ç”¨çš„å·
    echo "3. æ£€æŸ¥å®¹å™¨æŒ‚è½½çš„å·..."
    MOUNTS=$(echo "$CONTAINER_INFO" | grep '"Source"' | awk -F'"' '{print $4}')
    if [ -n "$MOUNTS" ]; then
        echo "ğŸ“ å®¹å™¨æŒ‚è½½çš„ç›®å½•:"
        echo "$MOUNTS"
    fi
fi

# æ£€æŸ¥æ•°æ®å·
echo "4. æ£€æŸ¥æ•°æ®å·..."
VOLUME_INFO=$(docker volume inspect nexterm 2>/dev/null || echo "æ•°æ®å·ä¸å­˜åœ¨")
if [ "$VOLUME_INFO" != "æ•°æ®å·ä¸å­˜åœ¨" ]; then
    echo "ğŸ’¾ æ•°æ®å·ä¿¡æ¯:"
    VOLUME_PATH=$(echo "$VOLUME_INFO" | grep '"Mountpoint"' | awk -F'"' '{print $4}')
    echo "   æŒ‚è½½ç‚¹: $VOLUME_PATH"
    echo "   æ•°æ®å¤§å°: $(du -sh $VOLUME_PATH 2>/dev/null || echo "æ— æ³•è·å–å¤§å°")"
fi

# ç¡®è®¤åˆ é™¤
read -p "âš ï¸  ç¡®è®¤è¦åˆ é™¤ NexTerm å®¹å™¨å’Œæ•°æ®å·å—ï¼Ÿ(y/N): " confirm
if [[ $confirm != [yY] ]]; then
    echo "âŒ æ“ä½œå·²å–æ¶ˆ"
    exit 0
fi

# å¼€å§‹æ¸…ç†
echo "5. å¼€å§‹æ¸…ç†..."

# åœæ­¢å®¹å™¨ï¼ˆå¦‚æœè¿è¡Œä¸­ï¼‰
echo "   ğŸ›‘ åœæ­¢å®¹å™¨..."
docker stop nexterm 2>/dev/null && echo "   âœ… å®¹å™¨å·²åœæ­¢" || echo "   â„¹ï¸  å®¹å™¨æœªè¿è¡Œ"

# åˆ é™¤å®¹å™¨
echo "   ğŸ—‘ï¸  åˆ é™¤å®¹å™¨..."
docker rm nexterm 2>/dev/null && echo "   âœ… å®¹å™¨å·²åˆ é™¤" || echo "   â„¹ï¸  å®¹å™¨ä¸å­˜åœ¨"

# åˆ é™¤æ•°æ®å·
echo "   ğŸ—‘ï¸  åˆ é™¤æ•°æ®å·..."
docker volume rm nexterm 2>/dev/null && echo "   âœ… æ•°æ®å·å·²åˆ é™¤" || echo "   â„¹ï¸  æ•°æ®å·ä¸å­˜åœ¨"

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ®‹ç•™
echo "6. æ£€æŸ¥æ¸…ç†ç»“æœ..."
CLEAN_RESULT=$(docker ps -a | grep -c nexterm)
VOLUME_RESULT=$(docker volume ls | grep -c nexterm)

if [ $CLEAN_RESULT -eq 0 ] && [ $VOLUME_RESULT -eq 0 ]; then
    echo "âœ… æ¸…ç†å®Œæˆï¼NexTerm å·²å®Œå…¨åˆ é™¤"
else
    echo "âš ï¸  å‘ç°æ®‹ç•™é¡¹ç›®:"
    [ $CLEAN_RESULT -ne 0 ] && echo "   - å®¹å™¨æ®‹ç•™" && docker ps -a | grep nexterm
    [ $VOLUME_RESULT -ne 0 ] && echo "   - æ•°æ®å·æ®‹ç•™" && docker volume ls | grep nexterm
fi

# ç”Ÿæˆæ–°å¯†é’¥å¹¶ä½¿ç”¨éšæœºç«¯å£é‡æ–°å®‰è£…
echo "7. é‡æ–°å®‰è£…ï¼ˆä½¿ç”¨éšæœºç«¯å£ï¼‰..."
NEW_KEY=$(openssl rand -hex 32)
echo "ğŸ”‘ æ–°åŠ å¯†å¯†é’¥: $NEW_KEY"
echo "ğŸ’¡ è¯·å¦¥å–„ä¿å­˜æ­¤å¯†é’¥ï¼"

docker run -d \
  -e ENCRYPTION_KEY=$NEW_KEY \
  -p 3000 \  # åªæŒ‡å®šå®¹å™¨ç«¯å£ï¼Œè®©Dockerè‡ªåŠ¨åˆ†é…ä¸»æœºç«¯å£
  --name nexterm \
  --restart unless-stopped \
  -v nexterm:/app/data \
  germannewsmaker/nexterm:1.0.5-OPEN-PREVIEW

echo "8. ç­‰å¾…å®¹å™¨å¯åŠ¨..."
sleep 8

# è·å–å®é™…æ˜ å°„çš„ç«¯å£
echo "9. è·å–ç«¯å£æ˜ å°„ä¿¡æ¯..."
ACTUAL_PORT=$(docker port nexterm | grep '3000/tcp' | awk -F: '{print $2}')

if docker ps | grep -q nexterm; then
    echo "âœ… NexTerm é‡æ–°å®‰è£…æˆåŠŸï¼"
    echo "ğŸŒ è®¿é—®åœ°å€: http://æœåŠ¡å™¨IP:${ACTUAL_PORT:-æœªçŸ¥ç«¯å£}"
    echo "ğŸ”‘ åŠ å¯†å¯†é’¥: $NEW_KEY"
    
    # æ˜¾ç¤ºå®Œæ•´çš„ç«¯å£ä¿¡æ¯
    echo ""
    echo "ğŸ“Š ç«¯å£æ˜ å°„è¯¦æƒ…:"
    docker port nexterm
    
    # è·å–æœåŠ¡å™¨IP
    SERVER_IP=$(curl -s ipv4.icanhazip.com 2>/dev/null || hostname -I | awk '{print $1}' || echo "localhost")
    echo ""
    echo "ğŸ¯ å®Œæ•´è®¿é—®åœ°å€: http://${SERVER_IP}:${ACTUAL_PORT}"
else
    echo "âŒ å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: docker logs nexterm"
fi
