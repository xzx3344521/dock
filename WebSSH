#!/bin/bash

echo "ğŸš€ NexTerm ä¸€é”®å®‰è£…ï¼ˆDocker Compose + éšæœºç«¯å£ï¼‰"

# ç”ŸæˆåŠ å¯†å¯†é’¥
ENCRYPTION_KEY=$(openssl rand -hex 32)
echo "ğŸ”‘ ç”ŸæˆåŠ å¯†å¯†é’¥: $ENCRYPTION_KEY"

# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p /boot/docker-apps

# åˆ›å»º Docker Compose é…ç½®æ–‡ä»¶
cat > /boot/docker-apps/nexterm.yml << EOF
version: '3.8'

services:
  nexterm:
    image: germannewsmaker/nexterm:1.0.5-OPEN-PREVIEW
    container_name: nexterm
    ports:
      - "3000"    # éšæœºç«¯å£
    environment:
      - ENCRYPTION_KEY=$ENCRYPTION_KEY
      - TZ=Asia/Shanghai
    volumes:
      - nexterm_data:/app/data
    restart: unless-stopped

volumes:
  nexterm_data:
EOF

echo "ğŸ“ é…ç½®æ–‡ä»¶å·²åˆ›å»º: /boot/docker-apps/nexterm.yml"

# åœæ­¢å¹¶åˆ é™¤æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
echo "ğŸ”„ æ¸…ç†æ—§ç‰ˆæœ¬..."
docker compose -f /boot/docker-apps/nexterm.yml down 2>/dev/null || true

# å¯åŠ¨æœåŠ¡
echo "ğŸ³ å¯åŠ¨ NexTerm..."
docker compose -f /boot/docker-apps/nexterm.yml up -d

# ç­‰å¾…å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# è·å–å®é™…ç«¯å£
ACTUAL_PORT=$(docker compose -f /boot/docker-apps/nexterm.yml port nexterm 3000 | cut -d: -f2)
SERVER_IP=$(curl -s ipv4.icanhazip.com 2>/dev/null || hostname -I | awk '{print $1}')

echo ""
echo "âœ… å®‰è£…å®Œæˆï¼"
echo "ğŸŒ è®¿é—®åœ°å€: http://$SERVER_IP:$ACTUAL_PORT"
echo "ğŸ”‘ åŠ å¯†å¯†é’¥: $ENCRYPTION_KEY"
echo ""
echo "ğŸ“‹ ç®¡ç†å‘½ä»¤:"
echo "   å¯åŠ¨: docker compose -f /boot/docker-apps/nexterm.yml start"
echo "   åœæ­¢: docker compose -f /boot/docker-apps/nexterm.yml stop"
echo "   é‡å¯: docker compose -f /boot/docker-apps/nexterm.yml restart"
echo "   å¸è½½: docker compose -f /boot/docker-apps/nexterm.yml down"
echo "   æ—¥å¿—: docker compose -f /boot/docker-apps/nexterm.yml logs"
