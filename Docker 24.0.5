#!/bin/bash
set -e

echo "=========================================="
echo " ä¿®å¤DockeræœåŠ¡é—®é¢˜"
echo "=========================================="

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ£€æŸ¥DockerçŠ¶æ€
check_docker_status() {
    log_info "æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€..."
    systemctl status docker --no-pager -l
}

# ä¿®å¤DockeræœåŠ¡
fix_docker_service() {
    log_info "ä¿®å¤DockeræœåŠ¡..."
    
    # åœæ­¢æœåŠ¡
    systemctl stop docker 2>/dev/null || true
    systemctl stop containerd 2>/dev/null || true
    
    # æ¸…ç†å¯èƒ½çš„é—®é¢˜
    pkill -f docker 2>/dev/null || true
    pkill -f containerd 2>/dev/null || true
    
    # é‡æ–°é…ç½®containerd
    log_info "é‡æ–°é…ç½®containerd..."
    containerd config default > /etc/containerd/config.toml 2>/dev/null || true
    systemctl enable containerd
    systemctl start containerd
    
    # é‡å¯DockeræœåŠ¡
    log_info "é‡å¯DockeræœåŠ¡..."
    systemctl enable docker
    systemctl daemon-reload
    systemctl start docker
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 3
}

# æ£€æŸ¥æœåŠ¡æ—¥å¿—
check_docker_logs() {
    log_info "æ£€æŸ¥DockeræœåŠ¡æ—¥å¿—..."
    journalctl -u docker --no-pager -n 20
}

# ä¿®å¤æƒé™å’Œé…ç½®
fix_permissions() {
    log_info "ä¿®å¤Dockerç›¸å…³æƒé™..."
    
    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    mkdir -p /etc/docker
    mkdir -p /var/lib/docker
    mkdir -p /run/docker
    
    # é…ç½®docker daemonï¼ˆç®€åŒ–é…ç½®ï¼‰
    cat > /etc/docker/daemon.json << 'EOF'
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "50m",
    "max-file": "3"
  },
  "storage-driver": "overlay2"
}
EOF

    # ä¿®å¤æƒé™
    chmod 755 /etc/docker
    chmod 644 /etc/docker/daemon.json
}

# éªŒè¯ä¿®å¤
verify_fix() {
    log_info "éªŒè¯Dockerä¿®å¤..."
    
    if systemctl is-active docker &> /dev/null; then
        log_info "âœ… DockeræœåŠ¡ç°åœ¨è¿è¡Œæ­£å¸¸ï¼"
        
        # æµ‹è¯•åŸºæœ¬å‘½ä»¤
        log_info "æµ‹è¯•Dockerå‘½ä»¤..."
        docker --version
        docker info --format "{{.ServerVersion}}" && {
            log_info "âœ… DockeræœåŠ¡å“åº”æ­£å¸¸ï¼"
        } || {
            log_warn "âš ï¸ DockeræœåŠ¡è¿è¡Œä½†infoå‘½ä»¤å¤±è´¥"
        }
        
        # å°è¯•è¿è¡Œæµ‹è¯•å®¹å™¨ï¼ˆä¸æ‹‰å–é•œåƒï¼Œåªæµ‹è¯•æœ¬åœ°ï¼‰
        log_info "æµ‹è¯•DockeråŸºæœ¬åŠŸèƒ½..."
        if docker images -q &> /dev/null; then
            log_info "âœ… Dockeré•œåƒåˆ—è¡¨æŸ¥è¯¢æˆåŠŸï¼"
        else
            log_warn "âš ï¸ Dockeré•œåƒåˆ—è¡¨æŸ¥è¯¢å¤±è´¥"
        fi
        
    else
        log_error "âŒ DockeræœåŠ¡ä»ç„¶æœªè¿è¡Œ"
        return 1
    fi
}

# å®‰è£…RustDeskæœåŠ¡å™¨
install_rustdesk() {
    log_info "å¼€å§‹å®‰è£…RustDeskæœåŠ¡å™¨..."
    
    if ! systemctl is-active docker &> /dev/null; then
        log_error "DockeræœåŠ¡æœªè¿è¡Œï¼Œæ— æ³•å®‰è£…RustDesk"
        return 1
    fi
    
    # åˆ›å»ºRustDeskæ•°æ®ç›®å½•
    mkdir -p /var/lib/rustdesk-server/{hbbs,hbbr}
    
    # æ‹‰å–RustDeskæœåŠ¡å™¨é•œåƒ
    log_info "æ‹‰å–RustDeskæœåŠ¡å™¨é•œåƒ..."
    docker pull rustdesk/rustdesk-server:latest
    
    # è¿è¡Œhbbs (IDæœåŠ¡å™¨)
    log_info "å¯åŠ¨RustDesk hbbsæœåŠ¡..."
    docker run -d \
        --name hbbs \
        --network host \
        -v /var/lib/rustdesk-server/hbbs:/root \
        rustdesk/rustdesk-server:latest hbbs
    
    # è¿è¡Œhbbr (ä¸­ç»§æœåŠ¡å™¨)  
    log_info "å¯åŠ¨RustDesk hbbræœåŠ¡..."
    docker run -d \
        --name hbbr \
        --network host \
        -v /var/lib/rustdesk-server/hbbr:/root \
        rustdesk/rustdesk-server:latest hbbr
    
    log_info "âœ… RustDeskæœåŠ¡å™¨éƒ¨ç½²å®Œæˆï¼"
    
    # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
    show_rustdesk_info
}

# æ˜¾ç¤ºRustDeskä¿¡æ¯
show_rustdesk_info() {
    echo ""
    log_info "ğŸ‰ RustDeskæœåŠ¡å™¨éƒ¨ç½²å®Œæˆï¼"
    echo "=========================================="
    echo "æœåŠ¡çŠ¶æ€:"
    echo "  docker ps -a                          # æŸ¥çœ‹å®¹å™¨çŠ¶æ€"
    echo "  docker logs hbbs                     # æŸ¥çœ‹hbbsæ—¥å¿—"
    echo "  docker logs hbbr                     # æŸ¥çœ‹hbbræ—¥å¿—"
    echo ""
    echo "é‡è¦ä¿¡æ¯:"
    echo "  hbbså®¹å™¨ä¼šç”Ÿæˆå¯†é’¥æ–‡ä»¶åœ¨: /var/lib/rustdesk-server/hbbs"
    echo "  æŸ¥çœ‹å¯†é’¥: cat /var/lib/rustdesk-server/hbbs/id_ed25519.pub"
    echo ""
    echo "å®¢æˆ·ç«¯è¿æ¥æ—¶éœ€è¦:"
    echo "  1. æœåŠ¡å™¨IPåœ°å€"
    echo "  2. ä¸Šé¢æ˜¾ç¤ºçš„å¯†é’¥"
    echo "=========================================="
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹ä¿®å¤DockeræœåŠ¡..."
    
    check_docker_status
    fix_permissions
    fix_docker_service
    check_docker_logs
    verify_fix
    
    if systemctl is-active docker &> /dev/null; then
        log_info "âœ… DockeræœåŠ¡ä¿®å¤æˆåŠŸï¼"
        echo ""
        read -p "æ˜¯å¦ç°åœ¨å®‰è£…RustDeskæœåŠ¡å™¨ï¼Ÿ(y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            install_rustdesk
        else
            log_info "æ‚¨å¯ä»¥ç¨åæ‰‹åŠ¨å®‰è£…RustDesk"
        fi
    else
        log_error "âŒ DockeræœåŠ¡ä¿®å¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
