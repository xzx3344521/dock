#!/bin/bash
set -e

echo "=========================================="
echo " ä¿®å¤DockeræœåŠ¡æœªæ‰¾åˆ°é—®é¢˜"
echo "=========================================="

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ£€æŸ¥Dockerå®‰è£…çŠ¶æ€
check_docker_installation() {
    log_info "æ£€æŸ¥Dockerå®‰è£…çŠ¶æ€..."
    
    if command -v docker &> /dev/null; then
        docker --version
        log_info "âœ… Docker CLI å·²å®‰è£…"
        return 0
    else
        log_error "âŒ Docker CLI æœªå®‰è£…"
        return 1
    fi
}

# æ£€æŸ¥æœåŠ¡æ–‡ä»¶
check_service_files() {
    log_info "æ£€æŸ¥DockeræœåŠ¡æ–‡ä»¶..."
    
    local services=(
        "/lib/systemd/system/docker.service"
        "/usr/lib/systemd/system/docker.service"
        "/etc/systemd/system/docker.service"
    )
    
    for service in "${services[@]}"; do
        if [ -f "$service" ]; then
            log_info "æ‰¾åˆ°æœåŠ¡æ–‡ä»¶: $service"
            return 0
        fi
    done
    
    log_warn "æœªæ‰¾åˆ°DockeræœåŠ¡æ–‡ä»¶"
    return 1
}

# é‡æ–°å®‰è£…DockeræœåŠ¡
reinstall_docker_service() {
    log_info "é‡æ–°å®‰è£…DockeræœåŠ¡..."
    
    # å½»åº•æ¸…ç†
    log_info "å½»åº•æ¸…ç†Docker..."
    systemctl stop docker 2>/dev/null || true
    systemctl stop containerd 2>/dev/null || true
    
    # å¸è½½ç°æœ‰docker
    apt-get remove -y --purge docker docker-engine docker.io containerd runc docker-ce docker-ce-cli 2>/dev/null || true
    
    # æ¸…ç†æ–‡ä»¶å’Œç›®å½•
    rm -rf /var/lib/docker
    rm -rf /var/lib/containerd
    rm -rf /etc/docker
    rm -f /etc/apt/sources.list.d/docker*
    
    # é‡æ–°å®‰è£…Dockerï¼ˆä½¿ç”¨æ›´ç¨³å®šçš„æ–¹æ³•ï¼‰
    log_info "é‡æ–°å®‰è£…Docker..."
    
    # æ–¹æ³•1ï¼šä½¿ç”¨å®˜æ–¹è„šæœ¬ä½†è·³è¿‡æœåŠ¡è®¾ç½®
    curl -fsSL https://get.docker.com -o get-docker.sh
    chmod +x get-docker.sh
    
    # ä¿®æ”¹è„šæœ¬ä»¥è·³è¿‡systemdæ£€æŸ¥
    sed -i 's/systemctl is-active docker/#systemctl is-active docker/g' get-docker.sh
    sed -i 's/systemctl start docker/#systemctl start docker/g' get-docker.sh
    sed -i 's/systemctl enable docker/#systemctl enable docker/g' get-docker.sh
    
    # è¿è¡Œä¿®æ”¹åçš„è„šæœ¬
    ./get-docker.sh --version 24.0.5
    
    if [ $? -eq 0 ]; then
        log_info "âœ… Dockerç»„ä»¶å®‰è£…æˆåŠŸ"
    else
        log_warn "å®˜æ–¹è„šæœ¬å®‰è£…æœ‰é—®é¢˜ï¼Œå°è¯•æ‰‹åŠ¨å®‰è£…..."
        manual_install_docker
    fi
}

# æ‰‹åŠ¨å®‰è£…Docker
manual_install_docker() {
    log_info "æ‰‹åŠ¨å®‰è£…Docker..."
    
    # å®‰è£…ä¾èµ–
    apt-get update
    apt-get install -y \
        apt-transport-https \
        ca-certificates \
        curl \
        gnupg2 \
        software-properties-common
    
    # æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    
    # æ·»åŠ Dockerä»“åº“
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # å®‰è£…Docker
    apt-get update
    apt-get install -y \
        docker-ce=5:24.0.5-1~debian.12~bookworm \
        docker-ce-cli=5:24.0.5-1~debian.12~bookworm \
        containerd.io \
        docker-buildx-plugin \
        docker-compose-plugin
}

# åˆ›å»ºDockeræœåŠ¡æ–‡ä»¶
create_docker_service() {
    log_info "åˆ›å»ºDockeræœåŠ¡æ–‡ä»¶..."
    
    # åˆ›å»ºæœåŠ¡ç›®å½•
    mkdir -p /etc/systemd/system
    
    # åˆ›å»ºdocker.serviceæ–‡ä»¶
    cat > /etc/systemd/system/docker.service << 'EOF'
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=containerd.service

[Service]
Type=notify
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF

    # åˆ›å»ºcontainerdæœåŠ¡æ–‡ä»¶
    cat > /etc/systemd/system/containerd.service << 'EOF'
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/bin/containerd
Restart=always
RestartSec=5
Delegate=yes
KillMode=process
OOMScoreAdjust=-999
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity

[Install]
WantedBy=multi-user.target
EOF

    log_info "æœåŠ¡æ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# é…ç½®å’Œå¯åŠ¨æœåŠ¡
setup_and_start_services() {
    log_info "é…ç½®å’Œå¯åŠ¨DockeræœåŠ¡..."
    
    # é‡æ–°åŠ è½½systemd
    systemctl daemon-reload
    
    # å¯ç”¨å¹¶å¯åŠ¨containerd
    systemctl enable containerd
    systemctl start containerd
    
    # å¯ç”¨å¹¶å¯åŠ¨docker
    systemctl enable docker
    systemctl start docker
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 5
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active docker &> /dev/null; then
        log_info "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸï¼"
    else
        log_error "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥"
        journalctl -u docker --no-pager -n 20
        return 1
    fi
}

# éªŒè¯å®‰è£…
verify_installation() {
    log_info "éªŒè¯Dockerå®‰è£…..."
    
    # æ£€æŸ¥dockerå‘½ä»¤
    if command -v docker &> /dev/null; then
        log_info "âœ… Docker CLI: $(docker --version)"
    else
        log_error "âŒ Docker CLI ä¸å¯ç”¨"
        return 1
    fi
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active docker &> /dev/null; then
        log_info "âœ… DockeræœåŠ¡è¿è¡Œæ­£å¸¸"
    else
        log_error "âŒ DockeræœåŠ¡æœªè¿è¡Œ"
        return 1
    fi
    
    # æµ‹è¯•docker info
    if docker info &> /dev/null; then
        log_info "âœ… Dockerå®ˆæŠ¤è¿›ç¨‹å“åº”æ­£å¸¸"
    else
        log_warn "âš ï¸ Dockerå®ˆæŠ¤è¿›ç¨‹æ— å“åº”"
        return 1
    fi
    
    log_info "ğŸ‰ Dockerå®‰è£…éªŒè¯å®Œæˆï¼"
}

# å®‰è£…RustDeskæœåŠ¡å™¨
install_rustdesk() {
    log_info "å¼€å§‹å®‰è£…RustDeskæœåŠ¡å™¨..."
    
    # åˆ›å»ºæ•°æ®ç›®å½•
    mkdir -p /var/lib/rustdesk-server/{hbbs,hbbr}
    
    # æ‹‰å–é•œåƒ
    log_info "æ‹‰å–RustDeskæœåŠ¡å™¨é•œåƒ..."
    docker pull rustdesk/rustdesk-server:latest
    
    # å¯åŠ¨hbbs
    log_info "å¯åŠ¨RustDesk hbbsæœåŠ¡..."
    docker run -d \
        --name hbbs \
        --restart unless-stopped \
        --network host \
        -v /var/lib/rustdesk-server/hbbs:/root \
        rustdesk/rustdesk-server:latest hbbs
    
    # å¯åŠ¨hbbr
    log_info "å¯åŠ¨RustDesk hbbræœåŠ¡..."
    docker run -d \
        --name hbbr \
        --restart unless-stopped \
        --network host \
        -v /var/lib/rustdesk-server/hbbr:/root \
        rustdesk/rustdesk-server:latest hbbr
    
    log_info "âœ… RustDeskæœåŠ¡å™¨éƒ¨ç½²å®Œæˆï¼"
    
    # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
    show_rustdesk_info
}

# æ˜¾ç¤ºRustDeskä¿¡æ¯
show_rustdesk_info() {
    echo ""
    log_info "ğŸ‰ RustDeskæœåŠ¡å™¨éƒ¨ç½²å®Œæˆï¼"
    echo "=========================================="
    echo "æœåŠ¡çŠ¶æ€:"
    echo "  docker ps -a                          # æŸ¥çœ‹å®¹å™¨çŠ¶æ€"
    echo "  systemctl status docker              # æŸ¥çœ‹DockeræœåŠ¡"
    echo ""
    echo "é‡è¦ä¿¡æ¯:"
    echo "  æŸ¥çœ‹å¯†é’¥: cat /var/lib/rustdesk-server/hbbs/id_ed25519.pub"
    echo "  æœåŠ¡å™¨IP: $(curl -s ifconfig.me || hostname -I | awk '{print $1}')"
    echo ""
    echo "å®¢æˆ·ç«¯è¿æ¥æ—¶éœ€è¦:"
    echo "  1. ä¸Šé¢æ˜¾ç¤ºçš„IPåœ°å€"
    echo "  2. ä¸Šé¢æ˜¾ç¤ºçš„å¯†é’¥"
    echo "=========================================="
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹ä¿®å¤DockeræœåŠ¡æœªæ‰¾åˆ°é—®é¢˜..."
    
    check_docker_installation || {
        log_error "Dockeræœªæ­£ç¡®å®‰è£…ï¼Œé€€å‡º"
        exit 1
    }
    
    if check_service_files; then
        log_info "æœåŠ¡æ–‡ä»¶å­˜åœ¨ï¼Œå°è¯•å¯åŠ¨æœåŠ¡..."
        setup_and_start_services
    else
        log_info "æœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‡æ–°å®‰è£…..."
        reinstall_docker_service
        create_docker_service
        setup_and_start_services
    fi
    
    verify_installation && {
        log_info "âœ… Dockerä¿®å¤æˆåŠŸï¼"
        echo ""
        read -p "æ˜¯å¦ç°åœ¨å®‰è£…RustDeskæœåŠ¡å™¨ï¼Ÿ(y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            install_rustdesk
        else
            log_info "æ‚¨å¯ä»¥ç¨åè¿è¡Œæ­¤è„šæœ¬å®‰è£…RustDesk"
        fi
    } || {
        log_error "âŒ Dockerä¿®å¤å¤±è´¥"
    }
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
