#!/bin/bash
set -e

echo "=========================================="
echo " Debianä¸“ç”¨ Docker ä¸€é”®å®‰è£…è„šæœ¬"
echo "=========================================="

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    log_info "æ£€æŸ¥ç£ç›˜ç©ºé—´..."
    local available=$(df / | awk 'NR==2 {print $4}')
    if [ "$available" -lt 1048576 ]; then  # å°äº1GB
        log_warn "ç£ç›˜ç©ºé—´ç´§å¼ ï¼Œæ­£åœ¨æ¸…ç†..."
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        rm -rf /tmp/*
        journalctl --vacuum-size=50M
    fi
}

# å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆæœ€å°åŒ–ï¼‰
install_minimal_deps() {
    log_info "å®‰è£…æœ€å°åŒ–ä¾èµ–..."
    apt-get update --allow-unauthenticated || {
        log_warn "APTæ›´æ–°å¤±è´¥ï¼Œç»§ç»­å®‰è£…..."
    }
    
    apt-get install -y --allow-unauthenticated \
        curl \
        wget \
        gnupg \
        ca-certificates \
        iptables \
        libseccomp2
}

# å½»åº•æ¸…ç†æœ‰é—®é¢˜çš„dockeré…ç½®
clean_docker_config() {
    log_info "æ¸…ç†Dockeré…ç½®..."
    # åœæ­¢dockeræœåŠ¡
    systemctl stop docker 2>/dev/null || true
    systemctl stop containerd 2>/dev/null || true
    
    # ç§»é™¤æ—§é…ç½®
    rm -f /etc/apt/sources.list.d/docker.list
    rm -f /etc/apt/sources.list.d/docker.list.save
    rm -rf /var/lib/docker
}

# ä¸‹è½½å¹¶å®‰è£…DockeräºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå®Œå…¨ç¦»çº¿æ–¹å¼ï¼‰
install_docker_binary() {
    log_info "ä¸‹è½½DockeräºŒè¿›åˆ¶æ–‡ä»¶..."
    
    # åˆ›å»ºå®‰è£…ç›®å½•
    INSTALL_DIR="/opt/docker-bin"
    mkdir -p $INSTALL_DIR
    cd $INSTALL_DIR
    
    # ä¸‹è½½Dockeré™æ€äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä»å®˜æ–¹releaseï¼‰
    DOCKER_VERSION="24.0.5"
    log_info "ä¸‹è½½Docker $DOCKER_VERSION é™æ€äºŒè¿›åˆ¶æ–‡ä»¶..."
    
    # ä¸‹è½½docker cli
    if [ ! -f "docker" ]; then
        wget -O docker https://download.docker.com/linux/static/stable/x86_64/docker-$DOCKER_VERSION.tgz && \
        tar xzvf docker-$DOCKER_VERSION.tgz && \
        cp docker/docker /usr/local/bin/ && \
        chmod +x /usr/local/bin/docker
    fi
    
    # ä¸‹è½½docker-compose
    if [ ! -f "docker-compose" ]; then
        DOCKER_COMPOSE_VERSION="2.20.2"
        wget -O /usr/local/bin/docker-compose "https://github.com/docker/compose/releases/download/v$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" && \
        chmod +x /usr/local/bin/docker-compose
    fi
}

# ä½¿ç”¨å®˜æ–¹è„šæœ¬å®‰è£…ï¼ˆç½‘ç»œæ–¹å¼ï¼‰
install_docker_official() {
    log_info "ä½¿ç”¨Dockerå®˜æ–¹è„šæœ¬å®‰è£…..."
    
    # ä¸‹è½½å¹¶è¿è¡Œå®˜æ–¹å®‰è£…è„šæœ¬
    curl -fsSL https://get.docker.com -o get-docker.sh
    # ä¿®æ”¹è„šæœ¬ä»¥è·³è¿‡ç©ºé—´æ£€æŸ¥
    sed -i 's/check_space/#check_space/g' get-docker.sh
    sed -i 's/apt_get_update/#apt_get_update/g' get-docker.sh
    
    # è¿è¡Œä¿®æ”¹åçš„è„šæœ¬
    sh get-docker.sh --version 24.0.5
    
    # å¦‚æœå®˜æ–¹è„šæœ¬å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
    if [ $? -ne 0 ]; then
        log_warn "å®˜æ–¹è„šæœ¬å®‰è£…å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•..."
        install_docker_backup
    fi
}

# å¤‡ç”¨å®‰è£…æ–¹æ³•
install_docker_backup() {
    log_info "ä½¿ç”¨å¤‡ç”¨æ–¹æ³•å®‰è£…Docker..."
    
    # ç›´æ¥ä¸‹è½½debåŒ…å®‰è£…
    cd /tmp
    wget https://download.docker.com/linux/debian/dists/bookworm/pool/stable/amd64/docker-ce_24.0.5-1~debian.12~bookworm_amd64.deb
    wget https://download.docker.com/linux/debian/dists/bookworm/pool/stable/amd64/docker-ce-cli_24.0.5-1~debian.12~bookworm_amd64.deb
    wget https://download.docker.com/linux/debian/dists/bookworm/pool/stable/amd64/containerd.io_1.6.21-1_amd64.deb
    
    # å®‰è£…ä¾èµ–
    apt-get install -y --allow-unauthenticated \
        libltdl7 \
        pigz \
        iptables
    
    # å®‰è£…dockeråŒ…
    dpkg -i containerd.io_1.6.21-1_amd64.deb
    dpkg -i docker-ce-cli_24.0.5-1~debian.12~bookworm_amd64.deb
    dpkg -i docker-ce_24.0.5-1~debian.12~bookworm_amd64.deb
}

# é…ç½®DockeræœåŠ¡
setup_docker_service() {
    log_info "é…ç½®DockeræœåŠ¡..."
    
    # åˆ›å»ºdockerç»„
    groupadd docker 2>/dev/null || true
    
    # é…ç½®docker daemon
    mkdir -p /etc/docker
    cat > /etc/docker/daemon.json << 'EOF'
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "50m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "data-root": "/var/lib/docker"
}
EOF

    # å¯åŠ¨æœåŠ¡
    systemctl enable docker
    systemctl start docker
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 3
}

# éªŒè¯å®‰è£…
verify_installation() {
    log_info "éªŒè¯å®‰è£…..."
    
    if command -v docker &> /dev/null; then
        docker --version
        log_info "âœ… Dockerå®‰è£…æˆåŠŸï¼"
    else
        log_error "âŒ Dockerå®‰è£…å¤±è´¥"
        return 1
    fi
    
    # æµ‹è¯•dockeræœåŠ¡
    if systemctl is-active docker &> /dev/null; then
        log_info "âœ… DockeræœåŠ¡è¿è¡Œæ­£å¸¸"
    else
        log_warn "âš ï¸ DockeræœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
        systemctl start docker
    fi
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹Dockerå®‰è£…æµç¨‹..."
    
    check_disk_space
    clean_docker_config
    install_minimal_deps
    install_docker_official
    setup_docker_service
    verify_installation
    
    log_info "ğŸ‰ Dockerå®‰è£…å®Œæˆï¼"
    echo ""
    echo "ä½¿ç”¨è¯´æ˜:"
    echo "  docker --version      # æŸ¥çœ‹ç‰ˆæœ¬"
    echo "  systemctl status docker # æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  usermod -aG docker \$USER # æ·»åŠ ç”¨æˆ·åˆ°dockerç»„"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
