#!/bin/bash

# hubproxy ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰
set -e

echo "ğŸš€ å¼€å§‹å®‰è£… hubproxy å®¹å™¨ä»£ç†æœåŠ¡..."

# æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
if ! command -v docker &> /dev/null; then
    echo "âŒ é”™è¯¯: æœªæ£€æµ‹åˆ° Dockerï¼Œè¯·å…ˆå®‰è£… Docker"
    exit 1
fi

# æ˜¾ç¤ºå½“å‰ä¿¡æ¯
echo "ğŸ“‹ å®‰è£…é…ç½®:"
echo "   - å®¹å™¨åç§°: hubproxy"
echo "   - æ˜ å°„ç«¯å£: 5000"
echo "   - é•œåƒ: ghcr.io/sky22333/hubproxy"

# åœæ­¢å¹¶æ¸…ç†æ—§å®¹å™¨
echo "ğŸ§¹ æ¸…ç†æ—§å®¹å™¨..."
docker stop hubproxy 2>/dev/null || true
docker rm hubproxy 2>/dev/null || true

# æ‹‰å–å¹¶è¿è¡Œæ–°å®¹å™¨
echo "ğŸ“¥ æ‹‰å–é•œåƒ..."
docker pull ghcr.io/sky22333/hubproxy

echo "ğŸ³ å¯åŠ¨å®¹å™¨..."
docker run -d \
  --name hubproxy \
  -p 5000:5000 \
  --restart always \
  ghcr.io/sky22333/hubproxy

# ç­‰å¾…å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
for i in {1..30}; do
    if docker ps --filter "name=hubproxy" --filter "status=running" | grep -q hubproxy; then
        break
    fi
    sleep 1
done

# è·å–ç½‘ç»œä¿¡æ¯
IP=$(hostname -I | awk '{print $1}')
if [ -z "$IP" ]; then
    IP="127.0.0.1"
fi

# æ˜¾ç¤ºç»“æœ
echo ""
echo "========================================"
echo "âœ… hubproxy å®‰è£…å®Œæˆï¼"
echo "========================================"
echo "ğŸŒ è®¿é—®åœ°å€: http://$IP:5000"
echo "ğŸ”— æœ¬åœ°è®¿é—®: http://localhost:5000"
echo "ğŸ“Œ ç«¯å£: 5000"
echo "ğŸ³ å®¹å™¨çŠ¶æ€: $(docker inspect -f '{{.State.Status}}' hubproxy)"
echo ""
echo "ğŸ“‹ å¸¸ç”¨å‘½ä»¤:"
echo "   æŸ¥çœ‹æ—¥å¿—: docker logs hubproxy"
echo "   åœæ­¢æœåŠ¡: docker stop hubproxy"
echo "   å¯åŠ¨æœåŠ¡: docker start hubproxy"
echo "   é‡å¯æœåŠ¡: docker restart hubproxy"
echo "========================================"
