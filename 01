#!/bin/bash

set -e

echo "ðŸš€ å¼€å§‹åœ¨ AlmaLinux 9.4 ä¸Šå®‰è£… Docker..."

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# æ£€æµ‹ç³»ç»Ÿ
if [ ! -f /etc/almalinux-release ]; then
    echo -e "${RED}é”™è¯¯: è¿™ä¸ªè„šæœ¬åªæ”¯æŒ AlmaLinux${NC}"
    exit 1
fi

echo -e "${YELLOW}[1/7] æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
sudo dnf remove -y docker* podman* containerd* || true

echo -e "${YELLOW}[2/7] å®‰è£…ä¾èµ–...${NC}"
sudo dnf install -y dnf-plugins-core yum-utils device-mapper-persistent-data lvm2

echo -e "${YELLOW}[3/7] æ·»åŠ  Docker ä»“åº“...${NC}"
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

echo -e "${YELLOW}[4/7] å¯ç”¨ CRB ä»“åº“...${NC}"
sudo dnf config-manager --set-enabled crb

echo -e "${YELLOW}[5/7] å®‰è£… Docker...${NC}"
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

echo -e "${YELLOW}[6/7] é…ç½® Docker...${NC}"
sudo systemctl start docker
sudo systemctl enable docker

echo -e "${YELLOW}[7/7] é…ç½®ç”¨æˆ·æƒé™...${NC}"
sudo usermod -aG docker $USER

# é…ç½®é•œåƒåŠ é€Ÿå™¨ï¼ˆå›½å†…ç”¨æˆ·ï¼‰
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json > /dev/null <<EOF
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://registry.docker-cn.com"
  ],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  }
}
EOF

sudo systemctl restart docker

echo -e "${GREEN}âœ… Docker å®‰è£…æˆåŠŸï¼${NC}"
echo -e "${YELLOW}ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:${NC}"
docker --version
docker-compose --version

echo -e "${YELLOW}ðŸ”§ è¯·é‡æ–°ç™»å½•æˆ–è¿è¡Œä»¥ä¸‹å‘½ä»¤:${NC}"
echo "  newgrp docker"
echo -e "${YELLOW}ðŸ³ æµ‹è¯•å‘½ä»¤:${NC}"
echo "  docker run hello-world"
