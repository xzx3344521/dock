#!/bin/bash

# åŠ å¼ºç‰ˆæœåŠ¡å™¨æ§åˆ¶å™¨è„šæœ¬
# æ”¯æŒå¤šå®¢æˆ·ç«¯ç®¡ç†ã€æ—¥å¿—è®°å½•ã€å®‰å…¨æ§åˆ¶

SERVER_PORT=25555
LOG_FILE="/var/log/controller_server.log"
CLIENTS_FILE="/var/lib/controller_clients.txt"
SCRIPT_DIR="/opt/controller_scripts"
BACKUP_DIR="/var/backup/controller"
CONFIG_FILE="/etc/controller_server.conf"
PID_FILE="/var/run/controller_server.pid"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# åˆå§‹åŒ–é…ç½®
init_config() {
    mkdir -p "$(dirname "$LOG_FILE")"
    mkdir -p "$(dirname "$CLIENTS_FILE")"
    mkdir -p "$SCRIPT_DIR"
    mkdir -p "$BACKUP_DIR"
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << EOF
# æœåŠ¡å™¨æ§åˆ¶å™¨é…ç½®
SERVER_PORT=$SERVER_PORT
LOG_FILE="$LOG_FILE"
CLIENTS_FILE="$CLIENTS_FILE"
SCRIPT_DIR="$SCRIPT_DIR"
BACKUP_DIR="$BACKUP_DIR"
PID_FILE="$PID_FILE"
MAX_CLIENTS=1000
HEARTBEAT_TIMEOUT=300
ALLOWED_IPS="0.0.0.0/0"
ENABLE_LOGGING=true
EOF
    fi
    
    source "$CONFIG_FILE"
    
    # åˆ›å»ºç¤ºä¾‹è„šæœ¬
    create_sample_scripts
    create_management_scripts
    
    touch "$LOG_FILE"
    touch "$CLIENTS_FILE"
    
    chmod 600 "$CLIENTS_FILE"
}

log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    if [[ "$ENABLE_LOGGING" == "true" ]]; then
        echo -e "[$timestamp] $1" | tee -a "$LOG_FILE"
    else
        echo -e "[$timestamp] $1"
    fi
}

print_color() {
    echo -e "${2}${1}${NC}"
}

print_banner() {
    clear
    echo
    print_color "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" "$CYAN"
    print_color "â•‘                  åŠ å¼ºç‰ˆæœåŠ¡å™¨æ§åˆ¶å™¨ v2.0                   â•‘" "$BLUE"
    print_color "â•‘              Enhanced Server Controller v2.0               â•‘" "$BLUE"
    print_color "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" "$CYAN"
    print_color "â•‘ ç«¯å£: $SERVER_PORT | å®¢æˆ·ç«¯æ•°: $(get_client_count) | çŠ¶æ€: $(server_status) â•‘" "$GREEN"
    print_color "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" "$CYAN"
    echo
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local deps=("nc" "awk" "grep" "sed")
    local missing=()
    
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            missing+=("$dep")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        print_color "ç¼ºå°‘ä¾èµ–: ${missing[*]}" "$RED"
        print_color "æ­£åœ¨å®‰è£…..." "$YELLOW"
        
        if command -v apt-get &> /dev/null; then
            apt-get update && apt-get install -y netcat-traditional awk grep sed
        elif command -v yum &> /dev/null; then
            yum install -y nc awk grep sed
        elif command -v dnf &> /dev/null; then
            dnf install -y nc awk grep sed
        elif command -v apk &> /dev/null; then
            apk add netcat-openbsd awk grep sed
        fi
    fi
}

# åˆ›å»ºç®¡ç†è„šæœ¬
create_management_scripts() {
    # æ‰¹é‡æ›´æ–°è„šæœ¬
    cat > "$SCRIPT_DIR/batch_update.sh" << 'EOF'
#!/bin/bash
echo "å¼€å§‹æ‰¹é‡æ›´æ–°æ‰€æœ‰å®¢æˆ·ç«¯..."
for client in $(grep -oP '^[^|]+' /var/lib/controller_clients.txt); do
    echo "æ›´æ–°å®¢æˆ·ç«¯: $client"
    echo "COMMAND:apt-get update && apt-get upgrade -y" | nc -w 3 $(get_client_ip $client) 5556
done
echo "æ‰¹é‡æ›´æ–°å®Œæˆ"
EOF

    # ç³»ç»Ÿä¿¡æ¯æ”¶é›†è„šæœ¬
    cat > "$SCRIPT_DIR/collect_system_info.sh" << 'EOF'
#!/bin/bash
echo "æ”¶é›†æ‰€æœ‰å®¢æˆ·ç«¯ç³»ç»Ÿä¿¡æ¯..."
while IFS='|' read -r serial ip hostname system last_seen; do
    if [[ -n "$serial" ]]; then
        echo "=== $hostname ($serial) ==="
        echo "COMMAND:uname -a; free -h; df -h" | nc -w 3 "$ip" 5556
        echo "------------------------"
    fi
done < /var/lib/controller_clients.txt
EOF

    # ç½‘ç»œè¯Šæ–­è„šæœ¬
    cat > "$SCRIPT_DIR/network_diagnosis.sh" << 'EOF'
#!/bin/bash
echo "ç½‘ç»œè¯Šæ–­..."
while IFS='|' read -r serial ip hostname system last_seen; do
    if [[ -n "$serial" ]]; then
        echo "æ£€æŸ¥ $hostname ç½‘ç»œ..."
        echo "COMMAND:ip addr show; ping -c 2 8.8.8.8" | nc -w 3 "$ip" 5556
    fi
done < /var/lib/controller_clients.txt
EOF

    chmod +x "$SCRIPT_DIR"/*.sh
}

create_sample_scripts() {
    # åŸºç¡€ç®¡ç†è„šæœ¬
    cat > "$SCRIPT_DIR/shutdown.sh" << 'EOF'
#!/bin/bash
echo "æ‰§è¡Œå…³æœºæ“ä½œ..."
shutdown -h now
EOF

    cat > "$SCRIPT_DIR/reboot.sh" << 'EOF'
#!/bin/bash
echo "æ‰§è¡Œé‡å¯æ“ä½œ..."
reboot
EOF

    cat > "$SCRIPT_DIR/restart_services.sh" << 'EOF'
#!/bin/bash
echo "é‡å¯ç³»ç»ŸæœåŠ¡..."
systemctl restart networking 2>/dev/null || systemctl restart network 2>/dev/null
systemctl restart ssh 2>/dev/null || systemctl restart sshd 2>/dev/null
EOF

    # ç›‘æ§è„šæœ¬
    cat > "$SCRIPT_DIR/monitor_system.sh" << 'EOF'
#!/bin/bash
echo "=== ç³»ç»Ÿç›‘æ§ ==="
echo "ä¸»æœºå: $(hostname)"
echo "ä¸Šçº¿æ—¶é—´: $(uptime)"
echo "å†…å­˜ä½¿ç”¨:"
free -h
echo "ç£ç›˜ä½¿ç”¨:"
df -h
echo "CPUä½¿ç”¨:"
top -bn1 | head -10
EOF

    # å®‰å…¨è„šæœ¬
    cat > "$SCRIPT_DIR/security_check.sh" << 'EOF'
#!/bin/bash
echo "=== å®‰å…¨æ£€æŸ¥ ==="
echo "ç™»å½•ç”¨æˆ·:"
who
echo "å¤±è´¥ç™»å½•:"
lastb | head -10
echo "SSHè¿æ¥:"
netstat -tlnp | grep ssh
EOF

    chmod +x "$SCRIPT_DIR"/*.sh
}

# æœåŠ¡å™¨çŠ¶æ€
server_status() {
    if is_server_running; then
        echo -e "${GREEN}è¿è¡Œä¸­${NC}"
    else
        echo -e "${RED}æœªè¿è¡Œ${NC}"
    fi
}

is_server_running() {
    if [[ -f "$PID_FILE" ]]; then
        local pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            return 0
        else
            rm -f "$PID_FILE"
        fi
    fi
    return 1
}

# è·å–å®¢æˆ·ç«¯æ•°é‡
get_client_count() {
    if [[ -f "$CLIENTS_FILE" ]]; then
        grep -c . "$CLIENTS_FILE" 2>/dev/null || echo "0"
    else
        echo "0"
    fi
}

# è·å–å®¢æˆ·ç«¯IP
get_client_ip() {
    local serial=$1
    grep "^$serial|" "$CLIENTS_FILE" | cut -d'|' -f2
}

# æ¸…ç†è¿‡æœŸå®¢æˆ·ç«¯
cleanup_expired_clients() {
    local current_time=$(date +%s)
    local temp_file=$(mktemp)
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        if [[ -n "$last_seen" ]]; then
            local client_time=$(date -d "$last_seen" +%s 2>/dev/null || echo "0")
            local time_diff=$((current_time - client_time))
            
            if [[ $time_diff -lt $HEARTBEAT_TIMEOUT ]]; then
                echo "$serial|$ip|$hostname|$system|$last_seen" >> "$temp_file"
            else
                log "æ¸…ç†è¿‡æœŸå®¢æˆ·ç«¯: $serial ($hostname)"
            fi
        fi
    done < "$CLIENTS_FILE"
    
    mv "$temp_file" "$CLIENTS_FILE" 2>/dev/null
}

# å¤‡ä»½æ•°æ®
backup_data() {
    local backup_file="$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    tar -czf "$backup_file" "$CLIENTS_FILE" "$LOG_FILE" "$SCRIPT_DIR" 2>/dev/null
    log "æ•°æ®å·²å¤‡ä»½åˆ°: $backup_file"
}

# æ˜¾ç¤ºå®¢æˆ·ç«¯åˆ—è¡¨
show_clients() {
    cleanup_expired_clients
    
    local count=$(get_client_count)
    print_color "å·²è¿æ¥å®¢æˆ·ç«¯: $count" "$BLUE"
    
    if [[ $count -eq 0 ]]; then
        print_color "æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥" "$YELLOW"
        return
    fi
    
    print_color "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" "$CYAN"
    print_color "â”‚  åºåˆ—å·    â”‚    IPåœ°å€     â”‚      ä¸»æœºå      â”‚      ç³»ç»Ÿ       â”‚     æœ€ååœ¨çº¿       â”‚" "$CYAN"
    print_color "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" "$CYAN"
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        if [[ -n "$serial" ]]; then
            printf "â”‚ ${GREEN}%-10s${NC} â”‚ ${YELLOW}%-13s${NC} â”‚ ${BLUE}%-16s${NC} â”‚ ${PURPLE}%-15s${NC} â”‚ ${GREEN}%-19s${NC} â”‚\n" \
                   "$serial" "$ip" "$hostname" "$system" "$last_seen"
        fi
    done < "$CLIENTS_FILE"
    
    print_color "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" "$CYAN"
}

# å‘å®¢æˆ·ç«¯å‘é€å‘½ä»¤
send_command() {
    local serial=$1
    shift
    local command="$*"
    
    if [[ -z "$serial" || -z "$command" ]]; then
        print_color "ç”¨æ³•: send <åºåˆ—å·> <å‘½ä»¤>" "$RED"
        return
    fi
    
    local client_info=$(grep "^$serial|" "$CLIENTS_FILE")
    if [[ -z "$client_info" ]]; then
        print_color "é”™è¯¯: æœªæ‰¾åˆ°åºåˆ—å· $serial çš„å®¢æˆ·ç«¯" "$RED"
        return
    fi
    
    IFS='|' read -r serial ip hostname system last_seen <<< "$client_info"
    
    print_color "å‘å®¢æˆ·ç«¯ $serial å‘é€å‘½ä»¤..." "$GREEN"
    print_color "å®¢æˆ·ç«¯: $hostname ($ip)" "$BLUE"
    print_color "å‘½ä»¤: $command" "$YELLOW"
    
    # å‘é€å‘½ä»¤åˆ°å®¢æˆ·ç«¯
    echo "COMMAND:$command" | nc -w 5 "$ip" 5556
    
    if [[ $? -eq 0 ]]; then
        log "å‘½ä»¤å‘é€æˆåŠŸ: $serial -> $command"
        print_color "å‘½ä»¤å‘é€æˆåŠŸ!" "$GREEN"
    else
        log "å‘½ä»¤å‘é€å¤±è´¥: $serial -> $command"
        print_color "å‘½ä»¤å‘é€å¤±è´¥!" "$RED"
    fi
}

# å¹¿æ’­å‘½ä»¤åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
broadcast_command() {
    local command="$*"
    
    if [[ -z "$command" ]]; then
        print_color "ç”¨æ³•: broadcast <å‘½ä»¤>" "$RED"
        return
    fi
    
    local count=0
    print_color "å‘æ‰€æœ‰å®¢æˆ·ç«¯å¹¿æ’­å‘½ä»¤..." "$YELLOW"
    print_color "å‘½ä»¤: $command" "$PURPLE"
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        if [[ -n "$serial" ]]; then
            echo "å‘ $serial å‘é€å‘½ä»¤..."
            echo "COMMAND:$command" | nc -w 3 "$ip" 5556 &
            count=$((count + 1))
        fi
    done < "$CLIENTS_FILE"
    
    wait
    log "å¹¿æ’­å‘½ä»¤å®Œæˆ: $command -> $count ä¸ªå®¢æˆ·ç«¯"
    print_color "å¹¿æ’­å®Œæˆ! å…±å‘é€ç»™ $count ä¸ªå®¢æˆ·ç«¯" "$GREEN"
}

# æ‰§è¡Œè„šæœ¬
execute_script() {
    local serial=$1
    local script_name=$2
    
    if [[ -z "$serial" || -z "$script_name" ]]; then
        print_color "ç”¨æ³•: script <åºåˆ—å·> <è„šæœ¬å>" "$RED"
        show_available_scripts
        return
    fi
    
    local script_path="$SCRIPT_DIR/$script_name"
    if [[ ! -f "$script_path" ]]; then
        print_color "é”™è¯¯: è„šæœ¬ $script_name ä¸å­˜åœ¨" "$RED"
        show_available_scripts
        return
    fi
    
    local client_info=$(grep "^$serial|" "$CLIENTS_FILE")
    if [[ -z "$client_info" ]]; then
        print_color "é”™è¯¯: æœªæ‰¾åˆ°åºåˆ—å· $serial çš„å®¢æˆ·ç«¯" "$RED"
        return
    fi
    
    IFS='|' read -r serial ip hostname system last_seen <<< "$client_info"
    
    print_color "å‘å®¢æˆ·ç«¯ $serial å‘é€è„šæœ¬..." "$GREEN"
    print_color "å®¢æˆ·ç«¯: $hostname ($ip)" "$BLUE"
    print_color "è„šæœ¬: $script_name" "$YELLOW"
    
    # å‘é€è„šæœ¬æ‰§è¡Œå‘½ä»¤
    echo "SCRIPT:$script_name" | nc -w 5 "$ip" 5556
    
    if [[ $? -eq 0 ]]; then
        log "è„šæœ¬å‘é€æˆåŠŸ: $serial -> $script_name"
        print_color "è„šæœ¬å‘é€æˆåŠŸ!" "$GREEN"
    else
        log "è„šæœ¬å‘é€å¤±è´¥: $serial -> $script_name"
        print_color "è„šæœ¬å‘é€å¤±è´¥!" "$RED"
    fi
}

# æ˜¾ç¤ºå¯ç”¨è„šæœ¬
show_available_scripts() {
    print_color "å¯ç”¨è„šæœ¬:" "$BLUE"
    echo
    print_color "ç³»ç»Ÿç®¡ç†:" "$CYAN"
    ls "$SCRIPT_DIR"/*.sh 2>/dev/null | xargs -n 1 basename | while read script; do
        print_color "  ğŸ“œ $script" "$GREEN"
    done || print_color "  æ— å¯ç”¨è„šæœ¬" "$YELLOW"
}

# æ‰¹é‡æ‰§è¡Œè„šæœ¬
batch_execute_script() {
    local script_name=$1
    
    if [[ -z "$script_name" ]]; then
        print_color "ç”¨æ³•: batch <è„šæœ¬å>" "$RED"
        show_available_scripts
        return
    fi
    
    local script_path="$SCRIPT_DIR/$script_name"
    if [[ ! -f "$script_path" ]]; then
        print_color "é”™è¯¯: è„šæœ¬ $script_name ä¸å­˜åœ¨" "$RED"
        return
    fi
    
    local count=0
    print_color "æ‰¹é‡æ‰§è¡Œè„šæœ¬: $script_name" "$YELLOW"
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        if [[ -n "$serial" ]]; then
            echo "å‘ $serial å‘é€è„šæœ¬..."
            echo "SCRIPT:$script_name" | nc -w 3 "$ip" 5556 &
            count=$((count + 1))
        fi
    done < "$CLIENTS_FILE"
    
    wait
    log "æ‰¹é‡æ‰§è¡Œå®Œæˆ: $script_name -> $count ä¸ªå®¢æˆ·ç«¯"
    print_color "æ‰¹é‡æ‰§è¡Œå®Œæˆ! å…±å‘é€ç»™ $count ä¸ªå®¢æˆ·ç«¯" "$GREEN"
}

# æŸ¥çœ‹å®¢æˆ·ç«¯è¯¦æƒ…
show_client_detail() {
    local serial=$1
    
    if [[ -z "$serial" ]]; then
        print_color "ç”¨æ³•: detail <åºåˆ—å·>" "$RED"
        return
    fi
    
    local client_info=$(grep "^$serial|" "$CLIENTS_FILE")
    if [[ -z "$client_info" ]]; then
        print_color "é”™è¯¯: æœªæ‰¾åˆ°åºåˆ—å· $serial çš„å®¢æˆ·ç«¯" "$RED"
        return
    fi
    
    IFS='|' read -r serial ip hostname system last_seen <<< "$client_info"
    
    print_color "=== å®¢æˆ·ç«¯è¯¦æƒ… ===" "$BLUE"
    print_color "åºåˆ—å·: $serial" "$GREEN"
    print_color "IPåœ°å€: $ip" "$YELLOW"
    print_color "ä¸»æœºå: $hostname" "$CYAN"
    print_color "ç³»ç»Ÿä¿¡æ¯: $system" "$PURPLE"
    print_color "æœ€ååœ¨çº¿: $last_seen" "$GREEN"
    
    # æµ‹è¯•è¿æ¥
    print_color "è¿æ¥æµ‹è¯•..." "$BLUE"
    if ping -c 1 -W 1 "$ip" &> /dev/null; then
        print_color "ç½‘ç»œè¿æ¥: æ­£å¸¸" "$GREEN"
    else
        print_color "ç½‘ç»œè¿æ¥: å¤±è´¥" "$RED"
    fi
}

# å¯åŠ¨æœåŠ¡å™¨
start_server() {
    if is_server_running; then
        print_color "æœåŠ¡å™¨å·²ç»åœ¨è¿è¡Œ (PID: $(cat "$PID_FILE"))" "$YELLOW"
        return
    fi
    
    print_color "å¯åŠ¨æœåŠ¡å™¨åœ¨ç«¯å£ $SERVER_PORT ..." "$GREEN"
    
    # ä¿å­˜PID
    echo $$ > "$PID_FILE"
    
    # è®¾ç½®ä¿¡å·å¤„ç†
    trap 'cleanup' INT TERM EXIT
    
    log "æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼ŒPID: $$"
    
    while true; do
        log "ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥..."
        nc -l -p $SERVER_PORT -c '
            client_ip=$(echo $SSH_CLIENT | awk "{print \$1}")
            if [[ -z "$client_ip" ]]; then
                client_ip="unknown"
            fi
            
            read -r data
            timestamp=$(date "+%Y-%m-%d %H:%M:%S")
            
            if echo "$data" | grep -q "HEARTBEAT|"; then
                IFS="|" read -r heartbeat serial hostname system <<< "$data"
                
                # æ›´æ–°å®¢æˆ·ç«¯ä¿¡æ¯
                grep -v "^$serial|" /var/lib/controller_clients.txt > /tmp/clients.tmp 2>/dev/null
                echo "$serial|$client_ip|$hostname|$system|$timestamp" >> /tmp/clients.tmp
                mv /tmp/clients.tmp /var/lib/controller_clients.txt
                
                echo "ACK:OK"
                echo "å®¢æˆ·ç«¯ $serial å·²è¿æ¥ - $hostname ($client_ip)"
            else
                echo "ACK:UNKNOWN_COMMAND"
            fi
        ' 2>/dev/null
        sleep 1
    done
}

cleanup() {
    log "æœåŠ¡å™¨åœæ­¢"
    rm -f "$PID_FILE"
    exit 0
}

# åœæ­¢æœåŠ¡å™¨
stop_server() {
    if is_server_running; then
        local pid=$(cat "$PID_FILE")
        print_color "åœæ­¢æœåŠ¡å™¨ (PID: $pid)..." "$GREEN"
        kill "$pid"
        sleep 2
        if is_server_running; then
            kill -9 "$pid"
        fi
        print_color "æœåŠ¡å™¨å·²åœæ­¢" "$GREEN"
    else
        print_color "æœåŠ¡å™¨æœªåœ¨è¿è¡Œ" "$YELLOW"
    fi
}

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
show_log() {
    if [[ -f "$LOG_FILE" ]]; then
        tail -20 "$LOG_FILE"
    else
        print_color "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨" "$RED"
    fi
}

# æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
show_stats() {
    local total_clients=$(get_client_count)
    local active_clients=0
    local current_time=$(date +%s)
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        if [[ -n "$last_seen" ]]; then
            local client_time=$(date -d "$last_seen" +%s 2>/dev/null || echo "0")
            local time_diff=$((current_time - client_time))
            if [[ $time_diff -lt 600 ]]; then  # 10åˆ†é’Ÿå†…æ´»è·ƒ
                active_clients=$((active_clients + 1))
            fi
        fi
    done < "$CLIENTS_FILE"
    
    print_color "=== æœåŠ¡å™¨ç»Ÿè®¡ ===" "$BLUE"
    print_color "æ€»å®¢æˆ·ç«¯æ•°: $total_clients" "$GREEN"
    print_color "æ´»è·ƒå®¢æˆ·ç«¯: $active_clients" "$CYAN"
    print_color "æœåŠ¡å™¨è¿è¡Œ: $(is_server_running && echo 'æ˜¯' || echo 'å¦')" "$YELLOW"
    print_color "å¯åŠ¨æ—¶é—´: $(ps -p $(cat "$PID_FILE" 2>/dev/null) -o lstart= 2>/dev/null || echo 'æœªçŸ¥')" "$PURPLE"
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    print_color "å¯ç”¨å‘½ä»¤:" "$BLUE"
    echo
    print_color "æœåŠ¡å™¨ç®¡ç†:" "$CYAN"
    echo "  start     - å¯åŠ¨æœåŠ¡å™¨"
    echo "  stop      - åœæ­¢æœåŠ¡å™¨"
    echo "  restart   - é‡å¯æœåŠ¡å™¨"
    echo "  status    - æœåŠ¡å™¨çŠ¶æ€"
    echo "  log       - æŸ¥çœ‹æ—¥å¿—"
    echo "  stats     - ç»Ÿè®¡ä¿¡æ¯"
    echo "  backup    - å¤‡ä»½æ•°æ®"
    
    print_color "å®¢æˆ·ç«¯ç®¡ç†:" "$CYAN"
    echo "  list      - æ˜¾ç¤ºå®¢æˆ·ç«¯åˆ—è¡¨"
    echo "  detail    - æŸ¥çœ‹å®¢æˆ·ç«¯è¯¦æƒ…"
    echo "  send      - å‘é€å‘½ä»¤åˆ°å®¢æˆ·ç«¯"
    echo "  broadcast - å¹¿æ’­å‘½ä»¤åˆ°æ‰€æœ‰å®¢æˆ·ç«¯"
    echo "  script    - æ‰§è¡Œè„šæœ¬åˆ°å®¢æˆ·ç«¯"
    echo "  batch     - æ‰¹é‡æ‰§è¡Œè„šæœ¬"
    
    print_color "è„šæœ¬ç®¡ç†:" "$CYAN"
    echo "  scripts   - æ˜¾ç¤ºå¯ç”¨è„šæœ¬"
    
    print_color "ç³»ç»Ÿç®¡ç†:" "$CYAN"
    echo "  help      - æ˜¾ç¤ºå¸®åŠ©"
    echo "  exit      - é€€å‡º"
}

# ä¸»èœå•
main_menu() {
    while true; do
        print_banner
        
        echo
        print_color "è¯·é€‰æ‹©æ“ä½œ:" "$BLUE"
        echo
        print_color "1. å¯åŠ¨æœåŠ¡å™¨" "$GREEN"
        print_color "2. åœæ­¢æœåŠ¡å™¨" "$RED"
        print_color "3. å®¢æˆ·ç«¯åˆ—è¡¨" "$CYAN"
        print_color "4. å‘é€å‘½ä»¤" "$YELLOW"
        print_color "5. å¹¿æ’­å‘½ä»¤" "$PURPLE"
        print_color "6. æ‰§è¡Œè„šæœ¬" "$BLUE"
        print_color "7. æ‰¹é‡æ‰§è¡Œ" "$CYAN"
        print_color "8. å®¢æˆ·ç«¯è¯¦æƒ…" "$GREEN"
        print_color "9. æŸ¥çœ‹æ—¥å¿—" "$YELLOW"
        print_color "10. ç»Ÿè®¡ä¿¡æ¯" "$PURPLE"
        print_color "11. å¤‡ä»½æ•°æ®" "$BLUE"
        print_color "12. æ˜¾ç¤ºè„šæœ¬" "$CYAN"
        print_color "13. å¸®åŠ©" "$GREEN"
        print_color "0. é€€å‡º" "$RED"
        echo
        
        read -p "è¯·è¾“å…¥é€‰æ‹© [0-13]: " choice
        
        case $choice in
            1) start_server ;;
            2) stop_server ;;
            3) show_clients ;;
            4)
                read -p "è¾“å…¥åºåˆ—å·: " serial
                read -p "è¾“å…¥å‘½ä»¤: " cmd
                send_command "$serial" "$cmd"
                ;;
            5)
                read -p "è¾“å…¥å¹¿æ’­å‘½ä»¤: " cmd
                broadcast_command "$cmd"
                ;;
            6)
                read -p "è¾“å…¥åºåˆ—å·: " serial
                read -p "è¾“å…¥è„šæœ¬å: " script
                execute_script "$serial" "$script"
                ;;
            7)
                read -p "è¾“å…¥è„šæœ¬å: " script
                batch_execute_script "$script"
                ;;
            8)
                read -p "è¾“å…¥åºåˆ—å·: " serial
                show_client_detail "$serial"
                ;;
            9) show_log ;;
            10) show_stats ;;
            11) backup_data ;;
            12) show_available_scripts ;;
            13) show_help ;;
            0)
                print_color "å†è§!" "$GREEN"
                exit 0
                ;;
            *)
                print_color "æ— æ•ˆé€‰æ‹©!" "$RED"
                ;;
        esac
        
        echo
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
    done
}

# å‘½ä»¤è¡Œå‚æ•°å¤„ç†
case "${1:-}" in
    "start")
        check_dependencies
        init_config
        start_server
        ;;
    "stop")
        stop_server
        ;;
    "restart")
        stop_server
        sleep 2
        check_dependencies
        init_config
        start_server
        ;;
    "status")
        if is_server_running; then
            print_color "æœåŠ¡å™¨è¿è¡Œä¸­ (PID: $(cat "$PID_FILE"))" "$GREEN"
        else
            print_color "æœåŠ¡å™¨æœªè¿è¡Œ" "$RED"
        fi
        ;;
    "log")
        show_log
        ;;
    *)
        check_dependencies
        init_config
        main_menu
        ;;
esac
