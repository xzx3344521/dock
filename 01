#!/bin/bash

echo "å¼€å§‹å¸è½½ Docker..."

# æ£€æµ‹ç³»ç»Ÿç±»å‹
if [ -x "$(command -v yum)" ]; then
    echo "æ£€æµ‹åˆ° CentOS/RHEL ç³»ç»Ÿ"
    PKG_MGR="yum"
elif [ -x "$(command -v apt-get)" ]; then
    echo "æ£€æµ‹åˆ° Debian/Ubuntu ç³»ç»Ÿ"
    PKG_MGR="apt-get"
else
    echo "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨"
    exit 1
fi

# åœæ­¢ Docker æœåŠ¡
echo "åœæ­¢ Docker ç›¸å…³æœåŠ¡..."
sudo systemctl stop docker docker.socket containerd 2>/dev/null || true
sudo pkill -f docker 2>/dev/null || true

# å¸è½½ Docker åŒ…
echo "å¸è½½ Docker è½¯ä»¶åŒ…..."
if [ "$PKG_MGR" = "yum" ]; then
    sudo yum remove -y docker \
        docker-client \
        docker-client-latest \
        docker-common \
        docker-latest \
        docker-latest-logrotate \
        docker-logrotate \
        docker-engine \
        containerd \
        runc \
        docker-ce \
        docker-ce-cli \
        docker-ce-rootless-extras
else
    sudo apt-get purge -y docker-ce \
        docker-ce-cli \
        docker-ce-rootless-extras \
        containerd.io \
        docker-buildx-plugin \
        docker-compose-plugin
fi

# åˆ é™¤æ‰€æœ‰ Docker æ•°æ®å’Œé…ç½®
echo "åˆ é™¤ Docker æ•°æ®å’Œé…ç½®..."
sudo rm -rf /var/lib/docker
sudo rm -rf /var/lib/containerd
sudo rm -rf /etc/docker
sudo rm -rf /var/run/docker.sock
sudo rm -rf /var/run/containerd
sudo rm -rf /etc/apparmor.d/docker
sudo rm -rf /usr/bin/docker*
sudo rm -rf /usr/libexec/docker
sudo rm -rf /usr/lib/docker*

# åˆ é™¤ Docker ç”¨æˆ·ç»„ï¼ˆå¦‚æœå­˜åœ¨ä¸”æ²¡æœ‰å…¶ä»–ç”¨æˆ·ï¼‰
echo "æ¸…ç† Docker ç”¨æˆ·ç»„..."
if getent group docker >/dev/null; then
    echo "è­¦å‘Š: å°†åˆ é™¤ docker ç”¨æˆ·ç»„"
    sudo groupdel docker
fi

# æ¸…ç†ç³»ç»Ÿ
echo "æ‰§è¡Œç³»ç»Ÿæ¸…ç†..."
if [ "$PKG_MGR" = "yum" ]; then
    sudo yum autoremove -y
else
    sudo apt-get autoremove -y
    sudo apt-get autoclean -y
fi

# éªŒè¯å¸è½½
echo "éªŒè¯å¸è½½ç»“æœ..."
if command -v docker >/dev/null 2>&1; then
    echo "âŒ å¸è½½ä¸å½»åº•ï¼šä»æ£€æµ‹åˆ° docker å‘½ä»¤"
    exit 1
else
    echo "âœ… Docker å·²å®Œå…¨å¸è½½"
    
    # æ£€æŸ¥æ®‹ç•™æ–‡ä»¶
    echo "æ£€æŸ¥æ®‹ç•™æ–‡ä»¶..."
    RESIDUAL_FILES=$(find / -name "*docker*" -type f 2>/dev/null | head -10)
    if [ -n "$RESIDUAL_FILES" ]; then
        echo "å‘ç°ä»¥ä¸‹æ®‹ç•™æ–‡ä»¶ï¼š"
        echo "$RESIDUAL_FILES"
        echo "å»ºè®®æ‰‹åŠ¨æ£€æŸ¥è¿™äº›æ–‡ä»¶æ˜¯å¦éœ€è¦ä¿ç•™"
    fi
fi

echo "Docker å¸è½½å®Œæˆï¼"}

# å¯åŠ¨æœåŠ¡å™¨
start_server() {
    if is_server_running; then
        print_color "æœåŠ¡å™¨å·²åœ¨è¿è¡Œ (PID: $(cat "$PID_FILE"))" "$YELLOW"
        return
    fi
    
    print_color "å¯åŠ¨æœåŠ¡å™¨ç«¯å£: $SERVER_PORT" "$GREEN"
    echo $$ > "$PID_FILE"
    
    # ä¸»æœåŠ¡å™¨å¾ªç¯
    while true; do
        log "ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥..."
        nc -l -p $SERVER_PORT -c "
            client_ip=\$(echo \$SSH_CLIENT | awk '{print \$1}')
            [[ -z \"\$client_ip\" ]] && client_ip=\"unknown\"
            
            read -r data
            timestamp=\$(date '+%Y-%m-%d %H:%M:%S')
            
            if echo \"\$data\" | grep -q \"HEARTBEAT|\"; then
                IFS=\"|\" read -r heartbeat serial hostname system <<< \"\$data\"
                
                # æ›´æ–°å®¢æˆ·ç«¯ä¿¡æ¯
                grep -v \"^\$serial|\" \"$CLIENTS_FILE\" > /tmp/clients.tmp 2>/dev/null
                echo \"\$serial|\$client_ip|\$hostname|\$system|\$timestamp\" >> /tmp/clients.tmp
                mv /tmp/clients.tmp \"$CLIENTS_FILE\" 2>/dev/null
                
                echo \"ACK:OK\"
                log \"å®¢æˆ·ç«¯ \$serial å·²è¿æ¥ - \$hostname (\$client_ip)\"
            else
                echo \"ACK:UNKNOWN\"
            fi
        " 2>/dev/null
        sleep 1
    done
}

# åœæ­¢æœåŠ¡å™¨
stop_server() {
    if is_server_running; then
        local pid=$(cat "$PID_FILE")
        print_color "åœæ­¢æœåŠ¡å™¨ (PID: $pid)" "$GREEN"
        kill "$pid"
        rm -f "$PID_FILE"
    else
        print_color "æœåŠ¡å™¨æœªè¿è¡Œ" "$YELLOW"
    fi
}

# æ˜¾ç¤ºå®¢æˆ·ç«¯åˆ—è¡¨
show_clients() {
    if [[ ! -s "$CLIENTS_FILE" ]]; then
        print_color "æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥" "$YELLOW"
        return
    fi
    
    local count=$(wc -l < "$CLIENTS_FILE" 2>/dev/null || echo "0")
    print_color "å·²è¿æ¥å®¢æˆ·ç«¯ ($count):" "$BLUE"
    
    print_color "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" "$CYAN"
    print_color "â”‚   åºåˆ—å·   â”‚    IPåœ°å€     â”‚      ä¸»æœºå      â”‚      ç³»ç»Ÿ       â”‚     æœ€ååœ¨çº¿       â”‚" "$CYAN"
    print_color "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" "$CYAN"
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        if [[ -n "$serial" ]]; then
            printf "â”‚ ${GREEN}%-10s${NC} â”‚ ${YELLOW}%-13s${NC} â”‚ ${BLUE}%-16s${NC} â”‚ ${PURPLE}%-15s${NC} â”‚ ${GREEN}%-19s${NC} â”‚\n" \
                   "$serial" "$ip" "$hostname" "$system" "$last_seen"
        fi
    done < "$CLIENTS_FILE"
    
    print_color "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" "$CYAN"
}

# å‘é€å‘½ä»¤åˆ°å®¢æˆ·ç«¯
send_command() {
    local serial="$1"
    local command="$2"
    
    [[ -z "$serial" || -z "$command" ]] && {
        print_color "ç”¨æ³•: send <åºåˆ—å·> <å‘½ä»¤>" "$RED"
        return
    }
    
    local client_info=$(grep "^$serial|" "$CLIENTS_FILE")
    [[ -z "$client_info" ]] && {
        print_color "å®¢æˆ·ç«¯æœªæ‰¾åˆ°: $serial" "$RED"
        return
    }
    
    IFS='|' read -r serial ip hostname system last_seen <<< "$client_info"
    
    print_color "å‘é€å‘½ä»¤åˆ° $serial ($hostname)..." "$GREEN"
    print_color "å‘½ä»¤: $command" "$YELLOW"
    
    # å‘é€å‘½ä»¤
    echo "COMMAND:$command" | timeout 5 nc -w 3 "$ip" 5556
    
    [[ $? -eq 0 ]] && {
        log "å‘½ä»¤å‘é€æˆåŠŸ: $serial -> $command"
        print_color "å‘½ä»¤å‘é€æˆåŠŸ!" "$GREEN"
    } || {
        log "å‘½ä»¤å‘é€å¤±è´¥: $serial -> $command"
        print_color "å‘½ä»¤å‘é€å¤±è´¥!" "$RED"
    }
}

# æ‰§è¡Œè„šæœ¬
execute_script() {
    local serial="$1"
    local script_name="$2"
    
    [[ -z "$serial" || -z "$script_name" ]] && {
        print_color "ç”¨æ³•: script <åºåˆ—å·> <è„šæœ¬å>" "$RED"
        show_scripts
        return
    }
    
    local script_path="$SCRIPT_DIR/$script_name"
    [[ ! -f "$script_path" ]] && {
        print_color "è„šæœ¬ä¸å­˜åœ¨: $script_name" "$RED"
        show_scripts
        return
    }
    
    local client_info=$(grep "^$serial|" "$CLIENTS_FILE")
    [[ -z "$client_info" ]] && {
        print_color "å®¢æˆ·ç«¯æœªæ‰¾åˆ°: $serial" "$RED"
        return
    }
    
    IFS='|' read -r serial ip hostname system last_seen <<< "$client_info"
    
    print_color "æ‰§è¡Œè„šæœ¬åˆ° $serial ($hostname)..." "$GREEN"
    print_color "è„šæœ¬: $script_name" "$YELLOW"
    
    echo "SCRIPT:$script_name" | timeout 5 nc -w 3 "$ip" 5556
    
    [[ $? -eq 0 ]] && {
        log "è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $serial -> $script_name"
        print_color "è„šæœ¬æ‰§è¡ŒæˆåŠŸ!" "$GREEN"
    } || {
        log "è„šæœ¬æ‰§è¡Œå¤±è´¥: $serial -> $script_name"
        print_color "è„šæœ¬æ‰§è¡Œå¤±è´¥!" "$RED"
    }
}

# æ˜¾ç¤ºå¯ç”¨è„šæœ¬
show_scripts() {
    print_color "å¯ç”¨è„šæœ¬:" "$BLUE"
    ls "$SCRIPT_DIR"/*.sh 2>/dev/null | xargs -n 1 basename | while read script; do
        print_color "  ğŸ“œ $script" "$GREEN"
    done || print_color "  æ— å¯ç”¨è„šæœ¬" "$YELLOW"
}

# å¹¿æ’­å‘½ä»¤
broadcast_command() {
    local command="$1"
    [[ -z "$command" ]] && {
        print_color "ç”¨æ³•: broadcast <å‘½ä»¤>" "$RED"
        return
    }
    
    local count=0
    print_color "å¹¿æ’­å‘½ä»¤: $command" "$YELLOW"
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        [[ -n "$serial" ]] && {
            echo "å‘é€åˆ° $serial..."
            echo "COMMAND:$command" | timeout 3 nc -w 2 "$ip" 5556 &
            count=$((count + 1))
        }
    done < "$CLIENTS_FILE"
    
    wait
    print_color "å¹¿æ’­å®Œæˆ! å‘é€åˆ° $count ä¸ªå®¢æˆ·ç«¯" "$GREEN"
}

# æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€
show_status() {
    print_color "=== æœåŠ¡å™¨çŠ¶æ€ ===" "$BLUE"
    print_color "ç«¯å£: $SERVER_PORT" "$GREEN"
    print_color "è¿è¡ŒçŠ¶æ€: $(is_server_running && echo 'è¿è¡Œä¸­' || echo 'æœªè¿è¡Œ')" "$YELLOW"
    print_color "å®¢æˆ·ç«¯æ•°: $(wc -l < "$CLIENTS_FILE" 2>/dev/null || echo "0")" "$CYAN"
    print_color "æ—¥å¿—æ–‡ä»¶: $LOG_FILE" "$PURPLE"
}

# ä¸»èœå•
main_menu() {
    while true; do
        clear
        print_color "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" "$CYAN"
        print_color "â•‘                   æœåŠ¡å™¨æ§åˆ¶å™¨ v3.0                         â•‘" "$BLUE"
        print_color "â•‘                 Server Controller v3.0                      â•‘" "$BLUE"
        print_color "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" "$CYAN"
        print_color "â•‘ ç«¯å£: $SERVER_PORT | å®¢æˆ·ç«¯: $(wc -l < "$CLIENTS_FILE" 2>/dev/null || echo "0") | çŠ¶æ€: $(is_server_running && echo -e "${GREEN}è¿è¡Œä¸­${NC}" || echo -e "${RED}æœªè¿è¡Œ${NC}") â•‘" "$GREEN"
        print_color "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" "$CYAN"
        echo
        
        print_color "1. å¯åŠ¨æœåŠ¡å™¨" "$GREEN"
        print_color "2. åœæ­¢æœåŠ¡å™¨" "$RED"
        print_color "3. å®¢æˆ·ç«¯åˆ—è¡¨" "$CYAN"
        print_color "4. å‘é€å‘½ä»¤" "$YELLOW"
        print_color "5. æ‰§è¡Œè„šæœ¬" "$BLUE"
        print_color "6. å¹¿æ’­å‘½ä»¤" "$PURPLE"
        print_color "7. æ˜¾ç¤ºè„šæœ¬" "$CYAN"
        print_color "8. æœåŠ¡å™¨çŠ¶æ€" "$GREEN"
        print_color "9. æŸ¥çœ‹æ—¥å¿—" "$YELLOW"
        print_color "0. é€€å‡º" "$RED"
        echo
        
        read -p "è¯·é€‰æ‹©æ“ä½œ [0-9]: " choice
        
        case $choice in
            1) start_server ;;
            2) stop_server ;;
            3) show_clients ;;
            4)
                read -p "åºåˆ—å·: " serial
                read -p "å‘½ä»¤: " cmd
                send_command "$serial" "$cmd"
                ;;
            5)
                read -p "åºåˆ—å·: " serial
                read -p "è„šæœ¬å: " script
                execute_script "$serial" "$script"
                ;;
            6)
                read -p "å¹¿æ’­å‘½ä»¤: " cmd
                broadcast_command "$cmd"
                ;;
            7) show_scripts ;;
            8) show_status ;;
            9) tail -f "$LOG_FILE" ;;
            0)
                print_color "å†è§!" "$GREEN"
                exit 0
                ;;
            *) print_color "æ— æ•ˆé€‰æ‹©!" "$RED" ;;
        esac
        
        echo
        read -p "æŒ‰å›è½¦ç»§ç»­..."
    done
}

# å‘½ä»¤è¡Œå¤„ç†
case "${1:-}" in
    start)
        init_server
        start_server
        ;;
    stop)
        stop_server
        ;;
    status)
        init_server
        show_status
        ;;
    *)
        init_server
        main_menu
        ;;
esac
