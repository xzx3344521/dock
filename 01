#!/bin/bash

# å®Œæ•´æœåŠ¡å™¨æ§åˆ¶å™¨ v3.0
# æ”¯æŒå¤šå®¢æˆ·ç«¯ç®¡ç†ã€å‘½ä»¤æ‰§è¡Œã€è„šæœ¬åˆ†å‘

SERVER_PORT=25555
LOG_FILE="/var/log/controller_server.log"
CLIENTS_FILE="/var/lib/controller_clients.txt"
SCRIPT_DIR="/opt/controller_scripts"
BACKUP_DIR="/var/backup/controller"
CONFIG_FILE="/etc/controller_server.conf"
PID_FILE="/var/run/controller_server.pid"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# åˆå§‹åŒ–
init_server() {
    mkdir -p "$(dirname "$LOG_FILE")"
    mkdir -p "$(dirname "$CLIENTS_FILE")"
    mkdir -p "$SCRIPT_DIR"
    mkdir -p "$BACKUP_DIR"
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << EOF
SERVER_PORT=$SERVER_PORT
LOG_FILE="$LOG_FILE"
CLIENTS_FILE="$CLIENTS_FILE"
SCRIPT_DIR="$SCRIPT_DIR"
HEARTBEAT_TIMEOUT=300
MAX_CLIENTS=1000
EOF
    fi
    
    source "$CONFIG_FILE"
    create_default_scripts
}

# åˆ›å»ºé»˜è®¤è„šæœ¬
create_default_scripts() {
    # ç³»ç»Ÿç®¡ç†è„šæœ¬
    cat > "$SCRIPT_DIR/system_info.sh" << 'EOF'
#!/bin/bash
echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
echo "ä¸»æœºå: $(hostname)"
echo "ç³»ç»Ÿ: $(grep PRETTY_NAME /etc/os-release 2>/dev/null | cut -d= -f2 | tr -d '"' || echo 'unknown')"
echo "å†…æ ¸: $(uname -r)"
echo "æ¶æ„: $(uname -m)"
echo "ä¸Šçº¿æ—¶é—´: $(uptime -p 2>/dev/null || uptime)"
echo "å†…å­˜: $(free -h 2>/dev/null || echo 'unknown')"
echo "ç£ç›˜: $(df -h 2>/dev/null || echo 'unknown')"
EOF

    # æœåŠ¡ç®¡ç†è„šæœ¬
    cat > "$SCRIPT_DIR/restart_services.sh" << 'EOF'
#!/bin/bash
echo "é‡å¯ç³»ç»ŸæœåŠ¡..."
systemctl restart networking 2>/dev/null || systemctl restart network 2>/dev/null
systemctl restart ssh 2>/dev/null || systemctl restart sshd 2>/dev/null
echo "æœåŠ¡é‡å¯å®Œæˆ"
EOF

    # æ›´æ–°è„šæœ¬
    cat > "$SCRIPT_DIR/update_system.sh" << 'EOF'
#!/bin/bash
echo "å¼€å§‹ç³»ç»Ÿæ›´æ–°..."
if command -v apt-get &>/dev/null; then
    apt-get update && apt-get upgrade -y
elif command -v yum &>/dev/null; then
    yum update -y
elif command -v dnf &>/dev/null; then
    dnf update -y
elif command -v apk &>/dev/null; then
    apk update && apk upgrade
fi
echo "ç³»ç»Ÿæ›´æ–°å®Œæˆ"
EOF

    # ç½‘ç»œè¯Šæ–­è„šæœ¬
    cat > "$SCRIPT_DIR/network_info.sh" << 'EOF'
#!/bin/bash
echo "=== ç½‘ç»œä¿¡æ¯ ==="
ip addr show 2>/dev/null || ifconfig 2>/dev/null || echo "æ— æ³•è·å–ç½‘ç»œä¿¡æ¯"
echo "=== è·¯ç”±è¡¨ ==="
ip route show 2>/dev/null || route -n 2>/dev/null || echo "æ— æ³•è·å–è·¯ç”±ä¿¡æ¯"
EOF

    chmod +x "$SCRIPT_DIR"/*.sh
}

# æ—¥å¿—å‡½æ•°
log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "[$timestamp] $1" | tee -a "$LOG_FILE"
}

print_color() {
    echo -e "${2}${1}${NC}"
}

# æœåŠ¡å™¨çŠ¶æ€
is_server_running() {
    [[ -f "$PID_FILE" ]] && kill -0 $(cat "$PID_FILE") 2>/dev/null
}

# å¯åŠ¨æœåŠ¡å™¨
start_server() {
    if is_server_running; then
        print_color "æœåŠ¡å™¨å·²åœ¨è¿è¡Œ (PID: $(cat "$PID_FILE"))" "$YELLOW"
        return
    fi
    
    print_color "å¯åŠ¨æœåŠ¡å™¨ç«¯å£: $SERVER_PORT" "$GREEN"
    echo $$ > "$PID_FILE"
    
    # ä¸»æœåŠ¡å™¨å¾ªç¯
    while true; do
        log "ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥..."
        nc -l -p $SERVER_PORT -c "
            client_ip=\$(echo \$SSH_CLIENT | awk '{print \$1}')
            [[ -z \"\$client_ip\" ]] && client_ip=\"unknown\"
            
            read -r data
            timestamp=\$(date '+%Y-%m-%d %H:%M:%S')
            
            if echo \"\$data\" | grep -q \"HEARTBEAT|\"; then
                IFS=\"|\" read -r heartbeat serial hostname system <<< \"\$data\"
                
                # æ›´æ–°å®¢æˆ·ç«¯ä¿¡æ¯
                grep -v \"^\$serial|\" \"$CLIENTS_FILE\" > /tmp/clients.tmp 2>/dev/null
                echo \"\$serial|\$client_ip|\$hostname|\$system|\$timestamp\" >> /tmp/clients.tmp
                mv /tmp/clients.tmp \"$CLIENTS_FILE\" 2>/dev/null
                
                echo \"ACK:OK\"
                log \"å®¢æˆ·ç«¯ \$serial å·²è¿æ¥ - \$hostname (\$client_ip)\"
            else
                echo \"ACK:UNKNOWN\"
            fi
        " 2>/dev/null
        sleep 1
    done
}

# åœæ­¢æœåŠ¡å™¨
stop_server() {
    if is_server_running; then
        local pid=$(cat "$PID_FILE")
        print_color "åœæ­¢æœåŠ¡å™¨ (PID: $pid)" "$GREEN"
        kill "$pid"
        rm -f "$PID_FILE"
    else
        print_color "æœåŠ¡å™¨æœªè¿è¡Œ" "$YELLOW"
    fi
}

# æ˜¾ç¤ºå®¢æˆ·ç«¯åˆ—è¡¨
show_clients() {
    if [[ ! -s "$CLIENTS_FILE" ]]; then
        print_color "æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥" "$YELLOW"
        return
    fi
    
    local count=$(wc -l < "$CLIENTS_FILE" 2>/dev/null || echo "0")
    print_color "å·²è¿æ¥å®¢æˆ·ç«¯ ($count):" "$BLUE"
    
    print_color "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" "$CYAN"
    print_color "â”‚   åºåˆ—å·   â”‚    IPåœ°å€     â”‚      ä¸»æœºå      â”‚      ç³»ç»Ÿ       â”‚     æœ€ååœ¨çº¿       â”‚" "$CYAN"
    print_color "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" "$CYAN"
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        if [[ -n "$serial" ]]; then
            printf "â”‚ ${GREEN}%-10s${NC} â”‚ ${YELLOW}%-13s${NC} â”‚ ${BLUE}%-16s${NC} â”‚ ${PURPLE}%-15s${NC} â”‚ ${GREEN}%-19s${NC} â”‚\n" \
                   "$serial" "$ip" "$hostname" "$system" "$last_seen"
        fi
    done < "$CLIENTS_FILE"
    
    print_color "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" "$CYAN"
}

# å‘é€å‘½ä»¤åˆ°å®¢æˆ·ç«¯
send_command() {
    local serial="$1"
    local command="$2"
    
    [[ -z "$serial" || -z "$command" ]] && {
        print_color "ç”¨æ³•: send <åºåˆ—å·> <å‘½ä»¤>" "$RED"
        return
    }
    
    local client_info=$(grep "^$serial|" "$CLIENTS_FILE")
    [[ -z "$client_info" ]] && {
        print_color "å®¢æˆ·ç«¯æœªæ‰¾åˆ°: $serial" "$RED"
        return
    }
    
    IFS='|' read -r serial ip hostname system last_seen <<< "$client_info"
    
    print_color "å‘é€å‘½ä»¤åˆ° $serial ($hostname)..." "$GREEN"
    print_color "å‘½ä»¤: $command" "$YELLOW"
    
    # å‘é€å‘½ä»¤
    echo "COMMAND:$command" | timeout 5 nc -w 3 "$ip" 5556
    
    [[ $? -eq 0 ]] && {
        log "å‘½ä»¤å‘é€æˆåŠŸ: $serial -> $command"
        print_color "å‘½ä»¤å‘é€æˆåŠŸ!" "$GREEN"
    } || {
        log "å‘½ä»¤å‘é€å¤±è´¥: $serial -> $command"
        print_color "å‘½ä»¤å‘é€å¤±è´¥!" "$RED"
    }
}

# æ‰§è¡Œè„šæœ¬
execute_script() {
    local serial="$1"
    local script_name="$2"
    
    [[ -z "$serial" || -z "$script_name" ]] && {
        print_color "ç”¨æ³•: script <åºåˆ—å·> <è„šæœ¬å>" "$RED"
        show_scripts
        return
    }
    
    local script_path="$SCRIPT_DIR/$script_name"
    [[ ! -f "$script_path" ]] && {
        print_color "è„šæœ¬ä¸å­˜åœ¨: $script_name" "$RED"
        show_scripts
        return
    }
    
    local client_info=$(grep "^$serial|" "$CLIENTS_FILE")
    [[ -z "$client_info" ]] && {
        print_color "å®¢æˆ·ç«¯æœªæ‰¾åˆ°: $serial" "$RED"
        return
    }
    
    IFS='|' read -r serial ip hostname system last_seen <<< "$client_info"
    
    print_color "æ‰§è¡Œè„šæœ¬åˆ° $serial ($hostname)..." "$GREEN"
    print_color "è„šæœ¬: $script_name" "$YELLOW"
    
    echo "SCRIPT:$script_name" | timeout 5 nc -w 3 "$ip" 5556
    
    [[ $? -eq 0 ]] && {
        log "è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $serial -> $script_name"
        print_color "è„šæœ¬æ‰§è¡ŒæˆåŠŸ!" "$GREEN"
    } || {
        log "è„šæœ¬æ‰§è¡Œå¤±è´¥: $serial -> $script_name"
        print_color "è„šæœ¬æ‰§è¡Œå¤±è´¥!" "$RED"
    }
}

# æ˜¾ç¤ºå¯ç”¨è„šæœ¬
show_scripts() {
    print_color "å¯ç”¨è„šæœ¬:" "$BLUE"
    ls "$SCRIPT_DIR"/*.sh 2>/dev/null | xargs -n 1 basename | while read script; do
        print_color "  ğŸ“œ $script" "$GREEN"
    done || print_color "  æ— å¯ç”¨è„šæœ¬" "$YELLOW"
}

# å¹¿æ’­å‘½ä»¤
broadcast_command() {
    local command="$1"
    [[ -z "$command" ]] && {
        print_color "ç”¨æ³•: broadcast <å‘½ä»¤>" "$RED"
        return
    }
    
    local count=0
    print_color "å¹¿æ’­å‘½ä»¤: $command" "$YELLOW"
    
    while IFS='|' read -r serial ip hostname system last_seen; do
        [[ -n "$serial" ]] && {
            echo "å‘é€åˆ° $serial..."
            echo "COMMAND:$command" | timeout 3 nc -w 2 "$ip" 5556 &
            count=$((count + 1))
        }
    done < "$CLIENTS_FILE"
    
    wait
    print_color "å¹¿æ’­å®Œæˆ! å‘é€åˆ° $count ä¸ªå®¢æˆ·ç«¯" "$GREEN"
}

# æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€
show_status() {
    print_color "=== æœåŠ¡å™¨çŠ¶æ€ ===" "$BLUE"
    print_color "ç«¯å£: $SERVER_PORT" "$GREEN"
    print_color "è¿è¡ŒçŠ¶æ€: $(is_server_running && echo 'è¿è¡Œä¸­' || echo 'æœªè¿è¡Œ')" "$YELLOW"
    print_color "å®¢æˆ·ç«¯æ•°: $(wc -l < "$CLIENTS_FILE" 2>/dev/null || echo "0")" "$CYAN"
    print_color "æ—¥å¿—æ–‡ä»¶: $LOG_FILE" "$PURPLE"
}

# ä¸»èœå•
main_menu() {
    while true; do
        clear
        print_color "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" "$CYAN"
        print_color "â•‘                   æœåŠ¡å™¨æ§åˆ¶å™¨ v3.0                         â•‘" "$BLUE"
        print_color "â•‘                 Server Controller v3.0                      â•‘" "$BLUE"
        print_color "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" "$CYAN"
        print_color "â•‘ ç«¯å£: $SERVER_PORT | å®¢æˆ·ç«¯: $(wc -l < "$CLIENTS_FILE" 2>/dev/null || echo "0") | çŠ¶æ€: $(is_server_running && echo -e "${GREEN}è¿è¡Œä¸­${NC}" || echo -e "${RED}æœªè¿è¡Œ${NC}") â•‘" "$GREEN"
        print_color "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" "$CYAN"
        echo
        
        print_color "1. å¯åŠ¨æœåŠ¡å™¨" "$GREEN"
        print_color "2. åœæ­¢æœåŠ¡å™¨" "$RED"
        print_color "3. å®¢æˆ·ç«¯åˆ—è¡¨" "$CYAN"
        print_color "4. å‘é€å‘½ä»¤" "$YELLOW"
        print_color "5. æ‰§è¡Œè„šæœ¬" "$BLUE"
        print_color "6. å¹¿æ’­å‘½ä»¤" "$PURPLE"
        print_color "7. æ˜¾ç¤ºè„šæœ¬" "$CYAN"
        print_color "8. æœåŠ¡å™¨çŠ¶æ€" "$GREEN"
        print_color "9. æŸ¥çœ‹æ—¥å¿—" "$YELLOW"
        print_color "0. é€€å‡º" "$RED"
        echo
        
        read -p "è¯·é€‰æ‹©æ“ä½œ [0-9]: " choice
        
        case $choice in
            1) start_server ;;
            2) stop_server ;;
            3) show_clients ;;
            4)
                read -p "åºåˆ—å·: " serial
                read -p "å‘½ä»¤: " cmd
                send_command "$serial" "$cmd"
                ;;
            5)
                read -p "åºåˆ—å·: " serial
                read -p "è„šæœ¬å: " script
                execute_script "$serial" "$script"
                ;;
            6)
                read -p "å¹¿æ’­å‘½ä»¤: " cmd
                broadcast_command "$cmd"
                ;;
            7) show_scripts ;;
            8) show_status ;;
            9) tail -f "$LOG_FILE" ;;
            0)
                print_color "å†è§!" "$GREEN"
                exit 0
                ;;
            *) print_color "æ— æ•ˆé€‰æ‹©!" "$RED" ;;
        esac
        
        echo
        read -p "æŒ‰å›è½¦ç»§ç»­..."
    done
}

# å‘½ä»¤è¡Œå¤„ç†
case "${1:-}" in
    start)
        init_server
        start_server
        ;;
    stop)
        stop_server
        ;;
    status)
        init_server
        show_status
        ;;
    *)
        init_server
        main_menu
        ;;
esac
