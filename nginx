#!/bin/bash

set -euo pipefail

# ==================================================
# Nginx Proxy Manager ä¸€é”®å®‰è£…è„šæœ¬
# ç‰ˆæœ¬: 1.0
# æè¿°: è‡ªåŠ¨éƒ¨ç½² Nginx Proxy Manager åå‘ä»£ç†ç®¡ç†å·¥å…·
# ==================================================

# è„šæœ¬é…ç½®
APP_NAME="nginx-proxy-manager"
SCRIPT_NAME="deploy_nginx_proxy_manager.sh"
WORK_DIR="/data"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# é”™è¯¯å¤„ç†å‡½æ•°
error_exit() {
    log_error "$1"
    exit 1
}

# æ¸…ç†å‡½æ•°
cleanup() {
    log_info "æ­£åœ¨æ¸…ç†ä¸´æ—¶èµ„æº..."
    # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ¸…ç†ä»£ç 
}

# ä¿¡å·å¤„ç†
trap cleanup EXIT INT TERM

# ==================================================
# ç¯å¢ƒæ£€æŸ¥
# ==================================================

log_info "å¼€å§‹æ£€æŸ¥è¿è¡Œç¯å¢ƒ..."

# æ£€æŸ¥æ˜¯å¦ä¸º root ç”¨æˆ·
if [[ $EUID -eq 0 ]]; then
    log_warning "å»ºè®®ä½¿ç”¨é root ç”¨æˆ·æ‰§è¡Œæ­¤è„šæœ¬ï¼Œä½†å°†ç»§ç»­æ‰§è¡Œ..."
fi

# æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
if ! command -v docker &> /dev/null; then
    error_exit "Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker"
fi

# æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€
if ! systemctl is-active --quiet docker && ! systemctl is-active --quiet docker.service; then
    log_info "å°è¯•å¯åŠ¨ Docker æœåŠ¡..."
    if ! sudo systemctl start docker 2>/dev/null; then
        error_exit "Docker æœåŠ¡æœªè¿è¡Œä¸”æ— æ³•å¯åŠ¨"
    fi
fi

# æµ‹è¯• Docker æ˜¯å¦æ­£å¸¸å·¥ä½œ
if ! docker info &> /dev/null; then
    error_exit "Docker æ— æ³•æ­£å¸¸å·¥ä½œï¼Œè¯·æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€"
fi

log_success "ç¯å¢ƒæ£€æŸ¥é€šè¿‡"

# ==================================================
# ç›®å½•å‡†å¤‡
# ==================================================

log_info "æ­£åœ¨å‡†å¤‡å·¥ä½œç›®å½•..."

# åˆ›å»ºå¹¶åˆ‡æ¢åˆ°å·¥ä½œç›®å½•
if [[ ! -d "$WORK_DIR" ]]; then
    log_info "åˆ›å»ºå·¥ä½œç›®å½•: $WORK_DIR"
    if ! sudo mkdir -p "$WORK_DIR" 2>/dev/null && ! mkdir -p "$WORK_DIR"; then
        error_exit "æ— æ³•åˆ›å»ºç›®å½• $WORK_DIRï¼Œè¯·æ£€æŸ¥æƒé™"
    fi
fi

# è¿›å…¥å·¥ä½œç›®å½•
cd "$WORK_DIR" || error_exit "æ— æ³•è¿›å…¥ç›®å½• $WORK_DIR"

# åˆ›å»ºå¿…è¦çš„å­ç›®å½•
for dir in nginx-proxy-manager/data nginx-proxy-manager/letsencrypt; do
    if [[ ! -d "$dir" ]]; then
        log_info "åˆ›å»ºç›®å½•: $WORK_DIR/$dir"
        mkdir -p "$dir" || error_exit "æ— æ³•åˆ›å»ºç›®å½• $dir"
    fi
done

log_success "ç›®å½•å‡†å¤‡å®Œæˆ"

# ==================================================
# åœæ­¢å¹¶åˆ é™¤ç°æœ‰å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# ==================================================

log_info "æ£€æŸ¥ç°æœ‰å®¹å™¨..."

if docker ps -a --format "table {{.Names}}" | grep -q "^${APP_NAME}$"; then
    log_info "å‘ç°å·²å­˜åœ¨çš„å®¹å™¨ï¼Œæ­£åœ¨åœæ­¢å¹¶åˆ é™¤..."
    
    # åœæ­¢å®¹å™¨
    if docker ps --format "table {{.Names}}" | grep -q "^${APP_NAME}$"; then
        docker stop "$APP_NAME" || log_warning "åœæ­¢å®¹å™¨å¤±è´¥ï¼Œä½†å°†ç»§ç»­æ‰§è¡Œ"
        sleep 5
    fi
    
    # åˆ é™¤å®¹å™¨
    docker rm "$APP_NAME" || error_exit "åˆ é™¤æ—§å®¹å™¨å¤±è´¥"
    log_success "æ—§å®¹å™¨æ¸…ç†å®Œæˆ"
fi

# ==================================================
# æ‹‰å– Docker é•œåƒ
# ==================================================

log_info "æ­£åœ¨æ‹‰å– Nginx Proxy Manager é•œåƒ..."

# è®¾ç½®é‡è¯•æœºåˆ¶
MAX_RETRIES=3
RETRY_COUNT=0

while [[ $RETRY_COUNT -lt $MAX_RETRIES ]]; do
    if docker pull docker.io/jc21/nginx-proxy-manager:latest; then
        log_success "é•œåƒæ‹‰å–æˆåŠŸ"
        break
    else
        RETRY_COUNT=$((RETRY_COUNT + 1))
        if [[ $RETRY_COUNT -eq $MAX_RETRIES ]]; then
            error_exit "é•œåƒæ‹‰å–å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
        else
            log_warning "é•œåƒæ‹‰å–å¤±è´¥ï¼Œç¬¬ $RETRY_COUNT æ¬¡é‡è¯•..."
            sleep 10
        fi
    fi
done

# ==================================================
# éƒ¨ç½²å®¹å™¨
# ==================================================

log_info "æ­£åœ¨å¯åŠ¨ Nginx Proxy Manager å®¹å™¨..."

DOCKER_RUN_CMD="docker run -d \
    --name $APP_NAME \
    --restart=unless-stopped \
    -p 80:80 \
    -p 81:81 \
    -p 443:443 \
    -v $WORK_DIR/nginx-proxy-manager/data:/data \
    -v $WORK_DIR/nginx-proxy-manager/letsencrypt:/etc/letsencrypt \
    docker.io/jc21/nginx-proxy-manager:latest"

log_info "æ‰§è¡Œå‘½ä»¤: $DOCKER_RUN_CMD"

if ! eval "$DOCKER_RUN_CMD"; then
    error_exit "å®¹å™¨å¯åŠ¨å¤±è´¥"
fi

log_success "å®¹å™¨å¯åŠ¨å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"

# ==================================================
# ç­‰å¾…å¹¶éªŒè¯æœåŠ¡çŠ¶æ€
# ==================================================

log_info "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
if ! docker ps --format "table {{.Names}}\t{{.Status}}" | grep -q "$APP_NAME"; then
    error_exit "å®¹å™¨æœªè¿è¡Œï¼Œè¯·æ£€æŸ¥æ—¥å¿—: docker logs $APP_NAME"
fi

CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' "$APP_NAME" 2>/dev/null || echo "unknown")
if [[ "$CONTAINER_STATUS" != "running" ]]; then
    error_exit "å®¹å™¨çŠ¶æ€å¼‚å¸¸: $CONTAINER_STATUSï¼Œè¯·æ£€æŸ¥æ—¥å¿—: docker logs $APP_NAME"
fi

# æ£€æŸ¥æœåŠ¡ç«¯å£
PORTS=(80 81 443)
for port in "${PORTS[@]}"; do
    if ! ss -tln | grep -q ":$port "; then
        log_warning "ç«¯å£ $port æœªç›‘å¬ï¼ŒæœåŠ¡å¯èƒ½ä»åœ¨å¯åŠ¨ä¸­"
    fi
done

log_success "Nginx Proxy Manager éƒ¨ç½²å®Œæˆï¼"

# ==================================================
# æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
# ==================================================

echo
log_success "ğŸ‰ Nginx Proxy Manager éƒ¨ç½²æˆåŠŸï¼"
echo
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "è®¿é—®åœ°å€: http://$(hostname -I | awk '{print $1}'):81"
echo "é»˜è®¤é‚®ç®±: admin@example.com"
echo "é»˜è®¤å¯†ç : changeme"
echo
echo "é‡è¦æç¤ºï¼š"
echo "1. é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç "
echo "2. ç®¡ç†ç•Œé¢è¿è¡Œåœ¨ 81 ç«¯å£"
echo "3. æ•°æ®å­˜å‚¨ä½ç½®: $WORK_DIR/nginx-proxy-manager/"
echo "4. æŸ¥çœ‹å®¹å™¨æ—¥å¿—: docker logs $APP_NAME"
echo "5. åœæ­¢æœåŠ¡: docker stop $APP_NAME"
echo "6. å¯åŠ¨æœåŠ¡: docker start $APP_NAME"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo

# æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
log_info "å½“å‰å®¹å™¨çŠ¶æ€:"
docker ps --filter "name=$APP_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# æ˜¾ç¤ºæ•°æ®ç›®å½•ç»“æ„
log_info "æ•°æ®ç›®å½•ç»“æ„:"
find "$WORK_DIR/nginx-proxy-manager" -type f -name "*" | head -10
