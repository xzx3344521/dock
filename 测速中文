#!/bin/bash

echo "ğŸš€ ä¸€é”®ç½‘ç»œæµ‹é€Ÿè„šæœ¬ (è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æ–¹æ¡ˆ)"

# å®‰è£…å¿…è¦å·¥å…·
echo "ğŸ“¦ å®‰è£…å¿…è¦å·¥å…·..."
apt-get update >/dev/null 2>&1
apt-get install -y curl wget iputils-ping bc dnsutils >/dev/null 2>&1

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥..."
if ping -c 2 -W 3 223.5.5.5 >/dev/null 2>&1; then
    echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸"
else
    echo "âŒ ç½‘ç»œè¿æ¥å¤±è´¥"
    exit 1
fi

# å°è¯•å®˜æ–¹speedtest
echo "ğŸ“Š å°è¯•å®˜æ–¹speedtestæµ‹é€Ÿ..."
if command -v speedtest &>/dev/null || command -v speedtest-cli &>/dev/null; then
    if speedtest --simple 2>/dev/null || speedtest-cli --simple 2>/dev/null; then
        echo "âœ… å®˜æ–¹speedtestæµ‹é€Ÿå®Œæˆ"
        exit 0
    fi
fi

# å®‰è£…å®˜æ–¹speedtest
echo "ğŸ”§ å®‰è£…å®˜æ–¹speedtest..."
if curl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh | sudo bash >/dev/null 2>&1; then
    if sudo apt-get install -y speedtest >/dev/null 2>&1; then
        echo "âœ… å®˜æ–¹speedtestå®‰è£…æˆåŠŸ"
        if speedtest --simple 2>/dev/null; then
            echo "âœ… å®˜æ–¹speedtestæµ‹é€Ÿå®Œæˆ"
            exit 0
        fi
    fi
fi

# å®‰è£…éå®˜æ–¹speedtest-cli
echo "ğŸ”„ å®‰è£…éå®˜æ–¹speedtest-cli..."
if ! command -v speedtest-cli &>/dev/null; then
    if apt-get install -y speedtest-cli >/dev/null 2>&1 || pip3 install speedtest-cli >/dev/null 2>&1; then
        echo "âœ… speedtest-cliå®‰è£…æˆåŠŸ"
    else
        wget -q -O speedtest-cli https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py
        chmod +x speedtest-cli
        mv speedtest-cli /usr/local/bin/ >/dev/null 2>&1
    fi
fi

# å°è¯•éå®˜æ–¹speedtest-cli
if command -v speedtest-cli &>/dev/null; then
    echo "ğŸ“Š å°è¯•éå®˜æ–¹speedtest-cliæµ‹é€Ÿ..."
    if speedtest-cli --simple 2>/dev/null; then
        echo "âœ… éå®˜æ–¹speedtest-cliæµ‹é€Ÿå®Œæˆ"
        exit 0
    fi
fi

# å¤‡ç”¨æµ‹é€Ÿæ–¹æ³•
echo "ğŸ”„ åˆ‡æ¢åˆ°å¤‡ç”¨æµ‹é€Ÿæ–¹æ³•..."
start_time=$(date +%s.%N)
if curl -L --max-time 30 --progress-bar -o /dev/null http://cachefly.cachefly.net/100mb.test >/dev/null 2>&1; then
    end_time=$(date +%s.%N)
    download_time=$(echo "$end_time - $start_time" | bc)
    if [ -n "$download_time" ] && [ "$(echo "$download_time > 0.1" | bc -l)" -eq 1 ]; then
        speed_mbps=$(echo "scale=2; (100 * 8) / $download_time" | bc)
        echo "ç½‘ç»œå»¶è¿Ÿ: 0.0 æ¯«ç§’"
        echo "ä¸‹è½½é€Ÿåº¦: ${speed_mbps} Mbit/ç§’"
        echo "ä¸Šä¼ é€Ÿåº¦: 0.0 Mbit/ç§’"
        echo "âœ… å¤‡ç”¨æµ‹é€Ÿå®Œæˆ"
        exit 0
    fi
fi

# æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆ
echo "ğŸ”„ å°è¯•æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆ..."
test_urls=(
    "http://speedtest.ftp.otenet.gr/files/test100Mb.db"
    "http://ipv4.download.thinkbroadband.com/100MB.zip"
)

for url in "${test_urls[@]}"; do
    echo "å°è¯•: $(echo $url | cut -d'/' -f3)"
    start_time=$(date +%s.%N)
    if curl -L --max-time 30 -o /dev/null "$url" >/dev/null 2>&1; then
        end_time=$(date +%s.%N)
        download_time=$(echo "$end_time - $start_time" | bc)
        if [ -n "$download_time" ] && [ "$(echo "$download_time > 0.1" | bc -l)" -eq 1 ]; then
            speed_mbps=$(echo "scale=2; (100 * 8) / $download_time" | bc)
            echo "ç½‘ç»œå»¶è¿Ÿ: 0.0 æ¯«ç§’"
            echo "ä¸‹è½½é€Ÿåº¦: ${speed_mbps} Mbit/ç§’"
            echo "ä¸Šä¼ é€Ÿåº¦: 0.0 Mbit/ç§’"
            echo "âœ… æœ€ç»ˆå¤‡ç”¨æµ‹é€Ÿå®Œæˆ"
            exit 0
        fi
    fi
done

echo "âŒ æ‰€æœ‰æµ‹é€Ÿæ–¹æ³•éƒ½å¤±è´¥äº†"
