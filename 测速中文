#!/bin/bash

echo "ğŸš€ ä¸€é”®ç½‘ç»œæµ‹é€Ÿè„šæœ¬"

# å®‰è£…å¿…è¦å·¥å…·
echo "ğŸ“¦ å®‰è£…å¿…è¦å·¥å…·..."
apt-get update >/dev/null 2>&1
apt-get install -y curl wget iputils-ping bc dnsutils >/dev/null 2>&1

# å®‰è£…speedtest
if ! command -v speedtest-cli &>/dev/null; then
    if apt-get install -y speedtest-cli >/dev/null 2>&1 || pip3 install speedtest-cli >/dev/null 2>&1; then
        echo "âœ… speedtestå®‰è£…æˆåŠŸ"
    else
        wget -q -O speedtest-cli https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py
        chmod +x speedtest-cli
        mv speedtest-cli /usr/local/bin/
    fi
fi

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥..."
if ping -c 2 -W 3 223.5.5.5 >/dev/null 2>&1; then
    echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸"
else
    echo "âŒ ç½‘ç»œè¿æ¥å¤±è´¥"
    exit 1
fi

# æµ‹é€Ÿ
echo "ğŸ“Š å¼€å§‹æµ‹é€Ÿ..."
if command -v speedtest-cli &>/dev/null; then
    result=$(speedtest-cli --simple)
    # è½¬æ¢ä¸ºä¸­æ–‡æ˜¾ç¤º
    echo "$result" | sed '
        s/Ping:/ç½‘ç»œå»¶è¿Ÿ:/
        s/Download:/ä¸‹è½½é€Ÿåº¦:/
        s/Upload:/ä¸Šä¼ é€Ÿåº¦:/
        s/ ms/ æ¯«ç§’/
        s/ Mbit\/s/ Mbit\/ç§’/
        s/ Gbit\/s/ Gbit\/ç§’/
    '
else
    # å¤‡ç”¨æµ‹é€Ÿæ–¹æ³•
    start_time=$(date +%s.%N)
    curl -L --max-time 30 --progress-bar -o /dev/null http://cachefly.cachefly.net/100mb.test >/dev/null 2>&1
    end_time=$(date +%s.%N)
    download_time=$(echo "$end_time - $start_time" | bc)
    speed_mbps=$(echo "scale=2; (100 * 8) / $download_time" | bc)
    echo "ç½‘ç»œå»¶è¿Ÿ: 0.0 æ¯«ç§’"
    echo "ä¸‹è½½é€Ÿåº¦: ${speed_mbps} Mbit/ç§’"
    echo "ä¸Šä¼ é€Ÿåº¦: 0.0 Mbit/ç§’"
fi

echo "âœ… æµ‹é€Ÿå®Œæˆ"
