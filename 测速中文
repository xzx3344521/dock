#!/bin/bash

# ç²¾å‡†ç½‘ç»œæµ‹é€Ÿä¸€é”®è„šæœ¬ - ç»ˆæä¿®å¤ç‰ˆ
# æ”¯æŒå¤šç³»ç»Ÿï¼šUbuntu/Debian/CentOS/RHEL/Alpine
# åŠŸèƒ½ï¼šç½‘ç»œè¿é€šæ€§æµ‹è¯•ã€å¤šèŠ‚ç‚¹å»¶è¿Ÿæµ‹è¯•ã€Speedtestæµ‹é€Ÿ

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# é”™è¯¯å¤„ç†å‡½æ•°
handle_error() {
    echo -e "${RED}âŒ é”™è¯¯: $1${NC}"
    exit 1
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
check_command() {
    if ! command -v "$1" &> /dev/null; then
        return 1
    fi
    return 0
}

# å®‰è£…å¿…è¦å·¥å…·
install_tools() {
    echo -e "${BLUE}ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£…å¿…è¦å·¥å…·...${NC}"
    
    # æ£€æµ‹åŒ…ç®¡ç†å™¨
    if check_command apt-get; then
        PM="apt-get"
        UPDATE_CMD="apt-get update"
        INSTALL_CMD="apt-get install -y"
    elif check_command yum; then
        PM="yum"
        UPDATE_CMD="yum update -y"
        INSTALL_CMD="yum install -y"
    elif check_command dnf; then
        PM="dnf"
        UPDATE_CMD="dnf update -y"
        INSTALL_CMD="dnf install -y"
    elif check_command apk; then
        PM="apk"
        UPDATE_CMD="apk update"
        INSTALL_CMD="apk add"
    else
        handle_error "æœªæ‰¾åˆ°æ”¯æŒçš„åŒ…ç®¡ç†å™¨"
    fi

    # æ›´æ–°åŒ…åˆ—è¡¨
    echo -e "${BLUE}æ›´æ–°åŒ…åˆ—è¡¨...${NC}"
    if ! $UPDATE_CMD >/dev/null 2>&1; then
        echo -e "${YELLOW}âš ï¸  åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥ï¼Œç»§ç»­å®‰è£…...${NC}"
    fi

    # å®‰è£…å¿…è¦å·¥å…·
    TOOLS=("curl" "wget" "ping" "bc" "python3")
    for tool in "${TOOLS[@]}"; do
        if ! check_command "$tool"; then
            echo -e "${BLUE}å®‰è£… $tool...${NC}"
            case $tool in
                "ping")
                    if [ "$PM" = "apt-get" ]; then
                        $INSTALL_CMD iputils-ping >/dev/null 2>&1 || echo -e "${YELLOW}âš ï¸  iputils-ping å®‰è£…å¤±è´¥${NC}"
                    elif [ "$PM" = "yum" ] || [ "$PM" = "dnf" ]; then
                        $INSTALL_CMD iputils >/dev/null 2>&1 || echo -e "${YELLOW}âš ï¸  iputils å®‰è£…å¤±è´¥${NC}"
                    elif [ "$PM" = "apk" ]; then
                        $INSTALL_CMD iputils >/dev/null 2>&1 || echo -e "${YELLOW}âš ï¸  iputils å®‰è£…å¤±è´¥${NC}"
                    fi
                    ;;
                "bc")
                    $INSTALL_CMD bc >/dev/null 2>&1 || echo -e "${YELLOW}âš ï¸  bc å®‰è£…å¤±è´¥${NC}"
                    ;;
                "python3")
                    if [ "$PM" = "apt-get" ]; then
                        $INSTALL_CMD python3 python3-pip >/dev/null 2>&1 || echo -e "${YELLOW}âš ï¸  python3 å®‰è£…å¤±è´¥${NC}"
                    elif [ "$PM" = "yum" ] || [ "$PM" = "dnf" ]; then
                        $INSTALL_CMD python3 python3-pip >/dev/null 2>&1 || echo -e "${YELLOW}âš ï¸  python3 å®‰è£…å¤±è´¥${NC}"
                    elif [ "$PM" = "apk" ]; then
                        $INSTALL_CMD python3 py3-pip >/dev/null 2>&1 || echo -e "${YELLOW}âš ï¸  python3 å®‰è£…å¤±è´¥${NC}"
                    fi
                    ;;
                *)
                    $INSTALL_CMD "$tool" >/dev/null 2>&1 || echo -e "${YELLOW}âš ï¸  $tool å®‰è£…å¤±è´¥${NC}"
                    ;;
            esac
        fi
    done
}

# ç»ˆæspeedtestå®‰è£…æ–¹æ¡ˆ
install_speedtest_ultimate() {
    echo -e "${BLUE}ğŸš€ ç»ˆæspeedtestå®‰è£…æ–¹æ¡ˆ...${NC}"
    
    # æ–¹æ³•1: ç›´æ¥ä¸‹è½½é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæœ€å¯é ï¼‰
    echo -e "${BLUE}æ–¹æ³•1: ä¸‹è½½é¢„ç¼–è¯‘äºŒè¿›åˆ¶...${NC}"
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ]; then
        BINARY_URL="https://github.com/tmplink/speedtest/raw/master/speedtest_x86_64"
    elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
        BINARY_URL="https://github.com/tmplink/speedtest/raw/master/speedtest_aarch64"
    else
        echo -e "${YELLOW}âš ï¸  ä¸æ”¯æŒçš„æ¶æ„: $ARCHï¼Œå°è¯•x86_64ç‰ˆæœ¬${NC}"
        BINARY_URL="https://github.com/tmplink/speedtest/raw/master/speedtest_x86_64"
    fi
    
    if curl -s -L -o /tmp/speedtest "$BINARY_URL" && chmod +x /tmp/speedtest; then
        mv /tmp/speedtest /usr/local/bin/speedtest
        echo -e "${GREEN}âœ… äºŒè¿›åˆ¶speedtestå®‰è£…æˆåŠŸ${NC}"
        return 0
    fi

    # æ–¹æ³•2: ä½¿ç”¨Python speedteståº“
    echo -e "${BLUE}æ–¹æ³•2: å®‰è£…Python speedteståº“...${NC}"
    if check_command python3; then
        cat > /usr/local/bin/speedtest.py << 'EOF'
#!/usr/bin/env python3
import speedtest
import sys

def main():
    try:
        s = speedtest.Speedtest()
        s.get_best_server()
        
        print("æµ‹è¯•ä¸‹è½½é€Ÿåº¦...")
        download_speed = s.download() / 1024 / 1024  # è½¬æ¢ä¸ºMbps
        print(f"ä¸‹è½½é€Ÿåº¦: {download_speed:.2f} Mbps")
        
        print("æµ‹è¯•ä¸Šä¼ é€Ÿåº¦...")
        upload_speed = s.upload() / 1024 / 1024  # è½¬æ¢ä¸ºMbps
        print(f"ä¸Šä¼ é€Ÿåº¦: {upload_speed:.2f} Mbps")
        
        print("æµ‹è¯•å»¶è¿Ÿ...")
        ping = s.results.ping
        print(f"ç½‘ç»œå»¶è¿Ÿ: {ping:.2f} ms")
        
    except Exception as e:
        print(f"æµ‹é€Ÿå¤±è´¥: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
EOF
        if python3 -c "import speedtest" 2>/dev/null; then
            echo -e "${GREEN}âœ… Python speedtestå·²å®‰è£…${NC}"
        else
            if python3 -m pip install speedtest-cli >/dev/null 2>&1; then
                echo -e "${GREEN}âœ… Python speedtestå®‰è£…æˆåŠŸ${NC}"
            fi
        fi
        chmod +x /usr/local/bin/speedtest.py
        # åˆ›å»ºåŒ…è£…è„šæœ¬
        cat > /usr/local/bin/speedtest << 'EOF'
#!/bin/bash
/usr/bin/python3 /usr/local/bin/speedtest.py
EOF
        chmod +x /usr/local/bin/speedtest
        echo -e "${GREEN}âœ… Pythonç‰ˆspeedtestå®‰è£…æˆåŠŸ${NC}"
        return 0
    fi

    # æ–¹æ³•3: ä½¿ç”¨wgetå’Œcurlè¿›è¡ŒåŸºæœ¬æµ‹é€Ÿ
    echo -e "${YELLOW}âš ï¸  æ— æ³•å®‰è£…æ ‡å‡†speedtestï¼Œå°†ä½¿ç”¨åŸºç¡€æµ‹é€Ÿæ–¹æ³•${NC}"
    return 1
}

# å¢å¼ºç‰ˆç½‘ç»œæµ‹é€Ÿ
enhanced_speed_test() {
    echo -e "${CYAN}ğŸŒ å¢å¼ºç‰ˆç½‘ç»œæµ‹é€Ÿ...${NC}"
    
    # æµ‹è¯•å›½å†…CDNé€Ÿåº¦
    echo -e "${BLUE}æµ‹è¯•å›½å†…ä¸‹è½½é€Ÿåº¦...${NC}"
    domestic_servers=(
        "https://mirrors.aliyun.com/ubuntu/ls-lR.gz"
        "https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ls-lR.gz"
        "https://mirrors.ustc.edu.cn/ubuntu/ls-lR.gz"
    )
    
    for server in "${domestic_servers[@]}"; do
        domain=$(echo "$server" | awk -F/ '{print $3}')
        echo -e "æµ‹è¯• $domain ..."
        if check_command curl; then
            start_time=$(date +%s%N)
            if curl -s --max-time 10 -o /dev/null "$server" 2>/dev/null; then
                end_time=$(date +%s%N)
                duration=$(( (end_time - start_time) / 1000000 ))  # æ¯«ç§’
                download_time=$(echo "scale=2; $duration / 1000" | bc -l 2>/dev/null || echo "0")
                if [ "$download_time" != "0" ] && [ $(echo "$download_time > 0" | bc -l 2>/dev/null) -eq 1 ]; then
                    speed=$(echo "scale=2; 1.0 / $download_time * 8" | bc -l 2>/dev/null || echo "N/A")
                    echo -e "${GREEN}  ä¸‹è½½é€Ÿåº¦: ${speed} Mbps${NC}"
                    break
                else
                    echo -e "${YELLOW}  è¿æ¥æˆåŠŸä½†é€Ÿåº¦è®¡ç®—å¤±è´¥${NC}"
                fi
            else
                echo -e "${YELLOW}  è¿æ¥å¤±è´¥${NC}"
            fi
        fi
    done
    
    # æµ‹è¯•å›½é™…é€Ÿåº¦
    echo -e "${BLUE}æµ‹è¯•å›½é™…è¿æ¥é€Ÿåº¦...${NC}"
    international_servers=(
        "https://www.google.com/favicon.ico"
        "https://www.github.com/favicon.ico"
        "https://www.cloudflare.com/favicon.ico"
    )
    
    for server in "${international_servers[@]}"; do
        domain=$(echo "$server" | awk -F/ '{print $3}')
        echo -e "æµ‹è¯• $domain ..."
        if check_command curl; then
            if curl -s --max-time 10 -o /dev/null -w "HTTPçŠ¶æ€: %{http_code}\nä¸‹è½½å¤§å°: %{size_download} bytes\næ€»æ—¶é—´: %{time_total} s\n" "$server"; then
                echo -e "${GREEN}  è¿æ¥æˆåŠŸ${NC}"
                break
            else
                echo -e "${YELLOW}  è¿æ¥å¤±è´¥${NC}"
            fi
        fi
    done
    
    # ä½¿ç”¨pingæµ‹è¯•ç½‘ç»œè´¨é‡
    echo -e "${BLUE}ç½‘ç»œè´¨é‡æµ‹è¯•...${NC}"
    test_hosts=("223.5.5.5" "114.114.114.114" "8.8.8.8" "1.1.1.1")
    for host in "${test_hosts[@]}"; do
        if ping -c 3 -W 2 "$host" >/dev/null 2>&1; then
            result=$(ping -c 3 -W 2 "$host" 2>/dev/null | grep "packet loss" | awk '{print "  ä¸¢åŒ…ç‡: "$6" | "}')
            avg_ping=$(ping -c 3 -W 2 "$host" 2>/dev/null | grep "min/avg/max" | awk -F'/' '{print $5}')
            echo -e "${GREEN}$host - å¹³å‡å»¶è¿Ÿ: ${avg_ping}ms $result${NC}"
        else
            echo -e "${RED}$host - æ— æ³•è¿æ¥${NC}"
        fi
    done
}

# ç®€å•speedtestæµ‹é€Ÿï¼ˆå¦‚æœå®‰è£…æˆåŠŸï¼‰
simple_speedtest() {
    echo -e "${CYAN}ğŸš€ æ‰§è¡ŒSpeedtestæµ‹é€Ÿ...${NC}"
    
    if check_command speedtest; then
        echo -e "${GREEN}ä½¿ç”¨ç³»ç»Ÿspeedtestå‘½ä»¤...${NC}"
        if speedtest --simple 2>/dev/null; then
            return 0
        fi
    fi
    
    if [ -f /usr/local/bin/speedtest.py ] && check_command python3; then
        echo -e "${GREEN}ä½¿ç”¨Python speedtest...${NC}"
        python3 /usr/local/bin/speedtest.py
        return 0
    fi
    
    echo -e "${YELLOW}âš ï¸  æœªæ‰¾åˆ°å¯ç”¨çš„speedtestï¼Œä½¿ç”¨å¢å¼ºæµ‹é€Ÿ...${NC}"
    enhanced_speed_test
}

# æ£€æŸ¥ç³»ç»Ÿå…¼å®¹æ€§
check_system() {
    echo -e "${BLUE}ğŸ” æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ...${NC}"
    
    # æ£€æŸ¥æ“ä½œç³»ç»Ÿ
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo -e "${GREEN}âœ… æ“ä½œç³»ç»Ÿ: $PRETTY_NAME${NC}"
    else
        echo -e "${YELLOW}âš ï¸  æ— æ³•æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹${NC}"
    fi

    # æ£€æŸ¥æ¶æ„
    ARCH=$(uname -m)
    echo -e "${GREEN}âœ… ç³»ç»Ÿæ¶æ„: $ARCH${NC}"

    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
    KERNEL=$(uname -r)
    echo -e "${GREEN}âœ… å†…æ ¸ç‰ˆæœ¬: $KERNEL${NC}"
    
    # æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    echo -e "${BLUE}ğŸŒ æ£€æŸ¥ç½‘ç»œçŠ¶æ€...${NC}"
    if check_command curl; then
        if curl -s --connect-timeout 5 https://www.baidu.com >/dev/null; then
            echo -e "${GREEN}âœ… ç½‘ç»œè¿æ¥æ­£å¸¸${NC}"
        else
            echo -e "${YELLOW}âš ï¸  ç½‘ç»œè¿æ¥å¯èƒ½æœ‰é™åˆ¶${NC}"
        fi
    fi
}

# ç½‘ç»œè¿é€šæ€§æµ‹è¯•
test_connectivity() {
    echo -e "${BLUE}ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥...${NC}"
    
    # æµ‹è¯•å¤šä¸ªDNSæœåŠ¡å™¨
    dns_servers=("223.5.5.5" "114.114.114.114" "8.8.8.8" "1.1.1.1")
    connected=false
    
    for dns in "${dns_servers[@]}"; do
        if ping -c 2 -W 3 "$dns" >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… ç½‘ç»œè¿æ¥æ­£å¸¸ (é€šè¿‡ $dns)${NC}"
            connected=true
            break
        fi
    done
    
    if [ "$connected" = false ]; then
        echo -e "${YELLOW}âš ï¸  åŸºç¡€ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æµ‹è¯•...${NC}"
    fi
}

# å¤šèŠ‚ç‚¹å»¶è¿Ÿæµ‹è¯•
test_latency() {
    echo -e "${CYAN}ğŸ¯ å¤šèŠ‚ç‚¹å»¶è¿Ÿæµ‹è¯•${NC}"
    nodes=("é˜¿é‡ŒDNS:223.5.5.5" "114DNS:114.114.114.114" "è…¾è®¯DNS:119.29.29.29" "Cloudflare:1.1.1.1" "Google DNS:8.8.8.8")
    
    for node in "${nodes[@]}"; do
        name="${node%:*}"
        ip="${node#*:}"
        echo -e "${BLUE}æµ‹è¯• $name...${NC}"
        
        if ping -c 4 -W 2 "$ip" >/dev/null 2>&1; then
            result=$(ping -c 4 -W 2 "$ip" 2>/dev/null | grep "min/avg/max" | awk -F'/' '{print "  å¹³å‡å»¶è¿Ÿ: "$5"ms"}')
            if [ -n "$result" ]; then
                latency=$(echo "$result" | grep -o '[0-9.]*')
                if command -v bc >/dev/null 2>&1 && [ -n "$latency" ]; then
                    if (( $(echo "$latency < 50" | bc -l 2>/dev/null) )); then
                        echo -e "${GREEN}$result âœ…${NC}"
                    elif (( $(echo "$latency < 100" | bc -l 2>/dev/null) )); then
                        echo -e "${GREEN}$result ğŸ‘${NC}"
                    elif (( $(echo "$latency < 200" | bc -l 2>/dev/null) )); then
                        echo -e "${YELLOW}$result âš ï¸${NC}"
                    else
                        echo -e "${RED}$result âŒ${NC}"
                    fi
                else
                    echo -e "${GREEN}$result${NC}"
                fi
            else
                echo -e "${YELLOW}  å»¶è¿Ÿæµ‹è¯•ç»“æœè§£æå¤±è´¥${NC}"
            fi
        else
            echo -e "${RED}  æµ‹è¯•å¤±è´¥${NC}"
        fi
    done
}

# æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
show_system_info() {
    echo -e "${PURPLE}"
    echo "=================================================="
    echo "           ğŸŒˆ ç»ˆæç½‘ç»œæµ‹é€Ÿè„šæœ¬ v4.0"
    echo "       ä¸“æ²»å„ç§ç½‘ç»œæµ‹é€Ÿå¤±è´¥é—®é¢˜"
    echo "          æ”¯æŒ: Ubuntu/Debian/CentOS/RHEL"
    echo "=================================================="
    echo -e "${NC}"
    
    check_system
    echo ""
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo -e "${GREEN}ä½¿ç”¨æ–¹æ³•:${NC}"
    echo -e "  $0 [é€‰é¡¹]"
    echo -e ""
    echo -e "${GREEN}é€‰é¡¹:${NC}"
    echo -e "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo -e "  -v, --version  æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo -e "  -f, --fix      å¼ºåˆ¶ä¿®å¤speedtestå®‰è£…"
    echo -e ""
    echo -e "${GREEN}åŠŸèƒ½:${NC}"
    echo -e "  âœ… ç³»ç»Ÿç¯å¢ƒæ£€æµ‹"
    echo -e "  âœ… è‡ªåŠ¨å®‰è£…ä¾èµ–å·¥å…·"
    echo -e "  âœ… ç½‘ç»œè¿é€šæ€§æµ‹è¯•"
    echo -e "  âœ… å¤šèŠ‚ç‚¹å»¶è¿Ÿæµ‹è¯•"
    echo -e "  âœ… ç»ˆæspeedtestå®‰è£…"
    echo -e "  âœ… å¢å¼ºç‰ˆç½‘ç»œæµ‹é€Ÿ"
    echo -e ""
}

# ä¸»å‡½æ•°
main() {
    # å¤„ç†å‘½ä»¤è¡Œå‚æ•°
    case "${1:-}" in
        -h|--help)
            show_usage
            exit 0
            ;;
        -v|--version)
            echo -e "${GREEN}ç»ˆæç½‘ç»œæµ‹é€Ÿè„šæœ¬ v4.0${NC}"
            exit 0
            ;;
        -f|--fix)
            echo -e "${YELLOW}ğŸ› ï¸  å¼ºåˆ¶ä¿®å¤æ¨¡å¼...${NC}"
            ;;
        *)
            ;;
    esac

    show_system_info
    install_tools
    echo ""
    install_speedtest_ultimate
    echo ""
    test_connectivity
    echo ""
    test_latency
    echo ""
    simple_speedtest
    echo ""
    
    echo -e "${PURPLE}==================================================${NC}"
    echo -e "${PURPLE}                 æµ‹è¯•å®Œæˆ ğŸŒŸ${NC}"
    echo -e "${PURPLE}==================================================${NC}"
    echo -e "${BLUE}ğŸ’¡ æç¤º: å¦‚æœæµ‹é€Ÿä¸ç†æƒ³ï¼Œå¯å°è¯•: $0 --fix${NC}"
}

# è®¾ç½®é™·é˜±ï¼Œç¡®ä¿è„šæœ¬é€€å‡ºæ—¶é‡ç½®é¢œè‰²
trap 'echo -e "${NC}"' EXIT

# è¿è¡Œä¸»å‡½æ•°
main "$@"
