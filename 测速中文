#!/bin/bash

echo "ğŸš€ Debian 12 ä¸“ç”¨ç½‘ç»œæµ‹é€Ÿè„šæœ¬"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦ä¸º Debian
check_debian() {
    if [ ! -f /etc/debian_version ]; then
        log_error "æ­¤è„šæœ¬ä¸“ä¸º Debian ç³»ç»Ÿè®¾è®¡"
        exit 1
    fi
    
    local version=$(cat /etc/debian_version)
    log_info "æ£€æµ‹åˆ° Debian ç‰ˆæœ¬: $version"
}

# æ£€æŸ¥å¹¶å®‰è£…å¿…è¦å·¥å…·
install_debian_tools() {
    log_info "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
    sudo apt-get update
    
    local tools=("curl" "wget" "iputils-ping" "bc" "dnsutils" "traceroute")
    local missing_tools=()
    
    # æ£€æŸ¥ç¼ºå°‘çš„å·¥å…·
    for tool in "${tools[@]}"; do
        if ! dpkg -l | grep -q "^ii  $tool "; then
            missing_tools+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -ne 0 ]; then
        log_warning "å®‰è£…ç¼ºå°‘çš„å·¥å…·: ${missing_tools[*]}"
        sudo apt-get install -y "${missing_tools[@]}"
        
        if [ $? -eq 0 ]; then
            log_success "å·¥å…·å®‰è£…å®Œæˆ"
        else
            log_error "å·¥å…·å®‰è£…å¤±è´¥"
            exit 1
        fi
    else
        log_success "æ‰€æœ‰å¿…è¦å·¥å…·å·²å®‰è£…"
    fi
}

# å®‰è£… speedtest-cli
install_speedtest_cli() {
    if ! command -v speedtest-cli &> /dev/null; then
        log_info "å®‰è£… speedtest-cli..."
        
        # æ–¹æ³•1: ä½¿ç”¨ apt å®‰è£…
        if sudo apt-get install -y speedtest-cli 2>/dev/null; then
            log_success "speedtest-cli å®‰è£…æˆåŠŸ"
            return 0
        fi
        
        # æ–¹æ³•2: ä½¿ç”¨ pip å®‰è£…
        if command -v pip3 &> /dev/null; then
            log_info "å°è¯•ä½¿ç”¨ pip3 å®‰è£…..."
            if pip3 install speedtest-cli 2>/dev/null; then
                log_success "speedtest-cli å®‰è£…æˆåŠŸ"
                return 0
            fi
        fi
        
        # æ–¹æ³•3: ç›´æ¥ä¸‹è½½
        log_info "ç›´æ¥ä¸‹è½½ speedtest-cli..."
        wget -O speedtest-cli https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py
        chmod +x speedtest-cli
        sudo mv speedtest-cli /usr/local/bin/
        
        if command -v speedtest-cli &> /dev/null; then
            log_success "speedtest-cli å®‰è£…æˆåŠŸ"
        else
            log_warning "speedtest-cli å®‰è£…å¤±è´¥ï¼Œè·³è¿‡"
        fi
    fi
}

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
test_connectivity() {
    log_info "æ£€æŸ¥ç½‘ç»œè¿é€šæ€§..."
    
    # æµ‹è¯•å¤šä¸ªå›½å†…å¯é ç«™ç‚¹
    local test_hosts=(
        "223.5.5.5"           # é˜¿é‡ŒDNS
        "114.114.114.114"     # 114DNS
        "1.1.1.1"            # Cloudflare
        "8.8.8.8"            # Google DNS
    )
    
    local connected=false
    
    for host in "${test_hosts[@]}"; do
        if ping -c 2 -W 3 "$host" &> /dev/null; then
            log_success "ç½‘ç»œè¿æ¥æ­£å¸¸ ($host)"
            connected=true
            break
        else
            log_warning "æ— æ³•è¿æ¥åˆ° $host"
        fi
    done
    
    if [ "$connected" = false ]; then
        log_error "æ‰€æœ‰ç½‘ç»œè¿æ¥æµ‹è¯•å‡å¤±è´¥"
        return 1
    fi
    
    return 0
}

# DNS è§£ææµ‹è¯•
test_dns() {
    log_info "æµ‹è¯• DNS è§£æ..."
    
    local domains=("baidu.com" "qq.com" "github.com" "debian.org")
    
    for domain in "${domains[@]}"; do
        if nslookup "$domain" &> /dev/null; then
            log_success "DNS è§£ææ­£å¸¸: $domain"
        else
            log_warning "DNS è§£æå¤±è´¥: $domain"
        fi
    done
}

# å»¶è¿Ÿæµ‹è¯•
test_latency() {
    log_info "æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ..."
    
    local latency_hosts=(
        "223.5.5.5"           # é˜¿é‡ŒDNS
        "114.114.114.114"     # 114DNS
        "1.1.1.1"            # Cloudflare
        "8.8.8.8"            # Google DNS
    )
    
    for host in "${latency_hosts[@]}"; do
        if ping -c 4 -W 2 "$host" &> /dev/null; then
            local result
            result=$(ping -c 4 -W 2 "$host" | tail -1 | awk -F'/' '{print "å¹³å‡å»¶è¿Ÿ: "$4" ms"}')
            log_info "$host - $result"
        else
            log_warning "$host - å»¶è¿Ÿæµ‹è¯•å¤±è´¥"
        fi
    done
}

# ä½¿ç”¨ speedtest-cli æµ‹è¯•
test_speedtest_cli() {
    if command -v speedtest-cli &> /dev/null; then
        log_info "ä½¿ç”¨ speedtest-cli è¿›è¡Œä¸“ä¸šæµ‹é€Ÿ..."
        speedtest-cli --simple
        return $?
    else
        return 1
    fi
}

# ä¸‹è½½é€Ÿåº¦æµ‹è¯•
test_download_speed() {
    log_info "æµ‹è¯•ä¸‹è½½é€Ÿåº¦..."
    
    # å›½å†…æµ‹é€ŸèŠ‚ç‚¹
    local cn_speed_test_urls=(
        "http://mirrors.163.com/debian/dists/stable/Release"  # ç½‘æ˜“é•œåƒ
        "http://mirrors.aliyun.com/debian/dists/stable/Release" # é˜¿é‡Œäº‘é•œåƒ
        "http://mirrors.tuna.tsinghua.edu.cn/debian/dists/stable/Release" # æ¸…åé•œåƒ
    )
    
    # å›½é™…æµ‹é€ŸèŠ‚ç‚¹
    local speed_test_urls=(
        "http://speedtest.ftp.otenet.gr/files/test100Mb.db"
        "http://ipv4.download.thinkbroadband.com/100MB.zip"
    )
    
    local speed_test_success=false
    
    # ä¼˜å…ˆä½¿ç”¨ speedtest-cli
    if test_speedtest_cli; then
        speed_test_success=true
        return 0
    fi
    
    log_warning "speedtest-cli ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
    
    # æ–¹æ³•1: ä½¿ç”¨ curl æµ‹è¯•ä¸‹è½½é€Ÿåº¦
    for url in "${cn_speed_test_urls[@]}" "${speed_test_urls[@]}"; do
        log_info "å°è¯•èŠ‚ç‚¹: $(echo "$url" | cut -d'/' -f1-3)"
        
        if curl -I --connect-timeout 10 "$url" &> /dev/null; then
            local start_time end_time download_time speed_mbps
            
            start_time=$(date +%s.%N)
            # ä¸‹è½½ 10MB æ•°æ®æ¥æµ‹è¯•é€Ÿåº¦
            curl -L --max-time 30 --progress-bar -o /dev/null "$url" 2>&1 | grep -o '[0-9.]* [GM]B' | tail -1
            end_time=$(date +%s.%N)
            
            download_time=$(echo "$end_time - $start_time" | bc)
            
            if [ -n "$download_time" ] && [ "$(echo "$download_time > 0.1" | bc)" -eq 1 ]; then
                # å‡è®¾ä¸‹è½½äº†çº¦10MBæ•°æ®
                local file_size_bytes=10000000
                speed_mbps=$(echo "scale=2; ($file_size_bytes * 8) / ($download_time * 1000000)" | bc)
                
                if [ -n "$speed_mbps" ]; then
                    log_success "ä¸‹è½½é€Ÿåº¦: ${speed_mbps} Mbps"
                    speed_test_success=true
                    break
                fi
            fi
        else
            log_warning "èŠ‚ç‚¹ä¸å¯ç”¨: $(echo "$url" | cut -d'/' -f1-3)"
        fi
    done
    
    # æ–¹æ³•2: ä½¿ç”¨ wget æµ‹è¯•
    if [ "$speed_test_success" = false ] && command -v wget &> /dev/null; then
        log_info "ä½¿ç”¨ wget æµ‹è¯•ä¸‹è½½é€Ÿåº¦"
        
        for url in "${cn_speed_test_urls[@]}"; do
            if wget --spider --timeout=10 "$url" &> /dev/null; then
                log_info "æµ‹è¯•èŠ‚ç‚¹: $(echo "$url" | cut -d'/' -f1-3)"
                wget -O /dev/null --progress=dot "$url" 2>&1 | grep --line-buffered -o '[0-9.]* [KMGT]B/s' | tail -1
                speed_test_success=true
                break
            fi
        done
    fi
    
    if [ "$speed_test_success" = false ]; then
        log_error "æ‰€æœ‰ä¸‹è½½é€Ÿåº¦æµ‹è¯•æ–¹æ³•å‡å¤±è´¥"
        return 1
    fi
    
    return 0
}

# è·¯ç”±è¿½è¸ª
test_traceroute() {
    log_info "è¿›è¡Œè·¯ç”±è¿½è¸ª..."
    
    if command -v traceroute &> /dev/null; then
        traceroute -m 10 223.5.5.5 | head -15
    else
        log_warning "traceroute ä¸å¯ç”¨"
    fi
}

# ç½‘ç»œæ¥å£ä¿¡æ¯
show_network_info() {
    log_info "ç½‘ç»œæ¥å£ä¿¡æ¯:"
    ip addr show | grep -E "^( |[0-9])" | grep -E "inet|state" | head -10
    
    log_info "è·¯ç”±è¡¨ä¿¡æ¯:"
    ip route | head -5
}

# æ¸…ç†å‡½æ•°
cleanup() {
    log_info "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    rm -f /tmp/speedtest*.tmp
    rm -f speedtest-cli
}

# ä¸»å‡½æ•°
main() {
    echo "=================================================="
    echo "           ğŸš€ Debian 12 ç½‘ç»œæµ‹é€Ÿè„šæœ¬"
    echo "=================================================="
    
    # è®¾ç½®é”™è¯¯å¤„ç†
    set -e
    trap 'cleanup; log_error "è„šæœ¬æ‰§è¡Œä¸­æ–­"; exit 130' INT TERM
    trap 'cleanup' EXIT
    
    # æ£€æŸ¥ç³»ç»Ÿ
    check_debian
    
    # å®‰è£…å¿…è¦å·¥å…·
    install_debian_tools
    install_speedtest_cli
    
    # æµ‹è¯•ç½‘ç»œè¿é€šæ€§
    if ! test_connectivity; then
        log_error "ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®"
        exit 1
    fi
    
    echo ""
    
    # æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
    show_network_info
    
    echo ""
    
    # DNS æµ‹è¯•
    test_dns
    
    echo ""
    
    # å»¶è¿Ÿæµ‹è¯•
    test_latency
    
    echo ""
    
    # ä¸‹è½½é€Ÿåº¦æµ‹è¯•
    if ! test_download_speed; then
        log_warning "ä¸‹è½½é€Ÿåº¦æµ‹è¯•é‡åˆ°é—®é¢˜"
    fi
    
    echo ""
    
    # è·¯ç”±è¿½è¸ªï¼ˆå¯é€‰ï¼‰
    read -p "æ˜¯å¦è¿›è¡Œè·¯ç”±è¿½è¸ªï¼Ÿ(y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        test_traceroute
    fi
    
    echo ""
    echo "=================================================="
    log_success "ç½‘ç»œæµ‹é€Ÿå®Œæˆ"
    echo "=================================================="
    
    # æ˜¾ç¤ºå»ºè®®
    log_info "å»ºè®®:"
    echo "1. å¦‚æœé€Ÿåº¦è¾ƒæ…¢ï¼Œå¯ä»¥å°è¯•æ›´æ¢ DNS æœåŠ¡å™¨"
    echo "2. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œè·¯ç”±å™¨è®¾ç½®"
    echo "3. è”ç³»ç½‘ç»œæœåŠ¡æä¾›å•†"
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo "ä½¿ç”¨æ–¹æ³•: $0 [é€‰é¡¹]"
    echo "é€‰é¡¹:"
    echo "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  -q, --quick    å¿«é€Ÿæ¨¡å¼ï¼ˆè·³è¿‡è·¯ç”±è¿½è¸ªï¼‰"
    echo "  -f, --full     å®Œæ•´æ¨¡å¼ï¼ˆåŒ…å«æ‰€æœ‰æµ‹è¯•ï¼‰"
}

# å‚æ•°è§£æ
case "${1:-}" in
    -h|--help)
        show_usage
        exit 0
        ;;
    -q|--quick)
        # å¿«é€Ÿæ¨¡å¼
        main | grep -E "âœ…|âŒ|âš ï¸|â„¹ï¸|å¹³å‡å»¶è¿Ÿ|ä¸‹è½½é€Ÿåº¦"
        ;;
    -f|--full)
        # å®Œæ•´æ¨¡å¼
        main
        ;;
    *)
        main
        ;;
esac
