#!/bin/bash

echo "🚀 一键网络测速脚本"

# 安装必要工具
echo "📦 安装必要工具..."
apt-get update >/dev/null 2>&1
apt-get install -y curl wget iputils-ping bc dnsutils >/dev/null 2>&1

# 安装speedtest
if ! command -v speedtest-cli &>/dev/null; then
    if apt-get install -y speedtest-cli >/dev/null 2>&1 || pip3 install speedtest-cli >/dev/null 2>&1; then
        echo "✅ speedtest安装成功"
    else
        wget -q -O speedtest-cli https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py
        chmod +x speedtest-cli
        mv speedtest-cli /usr/local/bin/
    fi
fi

# 测试网络连通性
echo "🌐 测试网络连接..."
if ping -c 2 -W 3 223.5.5.5 >/dev/null 2>&1; then
    echo "✅ 网络连接正常"
else
    echo "❌ 网络连接失败"
    exit 1
fi

# 测速
echo "📊 开始测速..."
if command -v speedtest-cli &>/dev/null; then
    result=$(speedtest-cli --simple)
    # 转换为中文显示
    echo "$result" | sed '
        s/Ping:/网络延迟:/
        s/Download:/下载速度:/
        s/Upload:/上传速度:/
        s/ ms/ 毫秒/
        s/ Mbit\/s/ Mbit\/秒/
        s/ Gbit\/s/ Gbit\/秒/
    '
else
    # 备用测速方法
    start_time=$(date +%s.%N)
    curl -L --max-time 30 --progress-bar -o /dev/null http://cachefly.cachefly.net/100mb.test >/dev/null 2>&1
    end_time=$(date +%s.%N)
    download_time=$(echo "$end_time - $start_time" | bc)
    speed_mbps=$(echo "scale=2; (100 * 8) / $download_time" | bc)
    echo "网络延迟: 0.0 毫秒"
    echo "下载速度: ${speed_mbps} Mbit/秒"
    echo "上传速度: 0.0 Mbit/秒"
fi

echo "✅ 测速完成"
