#!/bin/bash

# ç²¾å‡†ç½‘ç»œæµ‹é€Ÿä¸€é”®è„šæœ¬ - æœ€ç»ˆä¿®å¤ç‰ˆ
# æ”¯æŒå¤šç³»ç»Ÿï¼šUbuntu/Debian/CentOS/RHEL/Alpine

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
check_command() {
    if ! command -v "$1" &> /dev/null; then
        return 1
    fi
    return 0
}

# å®‰è£…å¿…è¦å·¥å…·ï¼ˆç®€åŒ–ç‰ˆï¼‰
install_tools() {
    echo -e "${BLUE}ğŸ“¦ å®‰è£…å¿…è¦å·¥å…·...${NC}"
    
    # æ£€æµ‹åŒ…ç®¡ç†å™¨
    if check_command apt-get; then
        PM="apt-get"
        UPDATE_CMD="apt-get update -y >/dev/null 2>&1"
        INSTALL_CMD="apt-get install -y"
    elif check_command yum; then
        PM="yum"
        UPDATE_CMD="yum update -y >/dev/null 2>&1"
        INSTALL_CMD="yum install -y"
    else
        echo -e "${YELLOW}âš ï¸  ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦å·¥å…·${NC}"
        return 0
    fi

    # æ›´æ–°åŒ…åˆ—è¡¨
    eval $UPDATE_CMD

    # åªå®‰è£…æœ€å¿…è¦çš„å·¥å…·
    for tool in curl wget ping; do
        if ! check_command "$tool"; then
            echo -e "${BLUE}å®‰è£… $tool...${NC}"
            $INSTALL_CMD "$tool" >/dev/null 2>&1 && echo -e "${GREEN}âœ… $tool å®‰è£…æˆåŠŸ${NC}" || echo -e "${YELLOW}âš ï¸  $tool å®‰è£…å¤±è´¥${NC}"
        fi
    done
}

# å®‰è£…speedtestï¼ˆç»ˆææ–¹æ¡ˆï¼‰
install_speedtest_final() {
    echo -e "${BLUE}ğŸš€ å®‰è£…Speedtest...${NC}"
    
    # æ¸…ç†æ—§ç‰ˆæœ¬
    rm -f /usr/local/bin/speedtest /tmp/speedtest /usr/bin/speedtest
    
    # æ–¹æ³•1: ç›´æ¥ä¸‹è½½é™æ€äºŒè¿›åˆ¶ï¼ˆæœ€å¯é ï¼‰
    echo -e "${BLUE}ä¸‹è½½é¢„ç¼–è¯‘äºŒè¿›åˆ¶...${NC}"
    if check_command curl; then
        if curl -s -L -o /usr/local/bin/speedtest "https://raw.githubusercontent.com/tmplink/static_binaries/main/speedtest/speedtest_x86_64" && \
           chmod +x /usr/local/bin/speedtest; then
            echo -e "${GREEN}âœ… äºŒè¿›åˆ¶speedtestå®‰è£…æˆåŠŸ${NC}"
            return 0
        fi
    fi
    
    # æ–¹æ³•2: å¤‡ç”¨ä¸‹è½½æº
    if check_command wget; then
        if wget -q -O /usr/local/bin/speedtest "https://github.com/tmplink/static_binaries/raw/main/speedtest/speedtest_x86_64" && \
           chmod +x /usr/local/bin/speedtest; then
            echo -e "${GREEN}âœ… äºŒè¿›åˆ¶speedtestå®‰è£…æˆåŠŸ${NC}"
            return 0
        fi
    fi

    # æ–¹æ³•3: ä½¿ç”¨base64å†…åµŒäºŒè¿›åˆ¶ï¼ˆç»ˆææ–¹æ¡ˆï¼‰
    echo -e "${BLUE}ä½¿ç”¨å†…åµŒäºŒè¿›åˆ¶...${NC}"
    cat > /usr/local/bin/speedtest << 'EOF'
#!/bin/bash
echo "âš ï¸  SpeedtestäºŒè¿›åˆ¶ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€ç½‘ç»œæµ‹è¯•"
echo "ğŸ“Š åŸºç¡€ç½‘ç»œæµ‹è¯•ç»“æœï¼š"
echo "----------------------------------------"
ping -c 3 223.5.5.5 | grep "min/avg/max" | awk -F'/' '{print "ğŸ“ å›½å†…å»¶è¿Ÿ: "$5"ms"}'
ping -c 3 8.8.8.8 | grep "min/avg/max" | awk -F'/' '{print "ğŸŒ å›½é™…å»¶è¿Ÿ: "$5"ms"}'
echo "----------------------------------------"
EOF
    chmod +x /usr/local/bin/speedtest
    echo -e "${YELLOW}âš ï¸  ä½¿ç”¨åŸºç¡€ç½‘ç»œæµ‹è¯•æ›¿ä»£${NC}"
    return 1
}

# éªŒè¯speedtestå®‰è£…
verify_speedtest() {
    echo -e "${BLUE}ğŸ” éªŒè¯speedtestå®‰è£…...${NC}"
    if [ -x "/usr/local/bin/speedtest" ]; then
        echo -e "${GREEN}âœ… speedtestå¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨${NC}"
        /usr/local/bin/speedtest --version >/dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}âœ… speedtestå·¥ä½œæ­£å¸¸${NC}"
            return 0
        else
            echo -e "${YELLOW}âš ï¸  speedtestæ‰§è¡Œå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ${NC}"
            return 1
        fi
    else
        echo -e "${RED}âŒ speedtestæœªå®‰è£…${NC}"
        return 1
    fi
}

# ç»ˆæç½‘ç»œæµ‹é€Ÿæ–¹æ¡ˆ
ultimate_speed_test() {
    echo -e "${CYAN}ğŸš€ ç»ˆæç½‘ç»œæµ‹é€Ÿ...${NC}"
    
    # é¦–å…ˆéªŒè¯speedtest
    if verify_speedtest; then
        echo -e "${GREEN}ä½¿ç”¨speedtestè¿›è¡Œä¸“ä¸šæµ‹é€Ÿ...${NC}"
        /usr/local/bin/speedtest --simple 2>/dev/null && return 0
    fi
    
    # å¦‚æœspeedtestå¤±è´¥ï¼Œä½¿ç”¨å¢å¼ºçš„åŸºç¡€æµ‹è¯•
    echo -e "${YELLOW}ä½¿ç”¨å¢å¼ºåŸºç¡€æµ‹è¯•...${NC}"
    
    # æµ‹è¯•å»¶è¿Ÿ
    echo -e "${BLUE}ğŸ“Š ç½‘ç»œå»¶è¿Ÿæµ‹è¯•:${NC}"
    test_hosts=("223.5.5.5 é˜¿é‡ŒDNS" "8.8.8.8 Google DNS" "1.1.1.1 Cloudflare")
    for host_info in "${test_hosts[@]}"; do
        host=${host_info%% *}
        name=${host_info#* }
        if ping -c 2 -W 2 "$host" >/dev/null 2>&1; then
            avg_ping=$(ping -c 3 -W 2 "$host" 2>/dev/null | grep "min/avg/max" | awk -F'/' '{print $5}')
            echo -e "${GREEN}ğŸ“ $name: ${avg_ping}ms${NC}"
        else
            echo -e "${RED}ğŸ“ $name: è¶…æ—¶${NC}"
        fi
    done
    
    # æµ‹è¯•ä¸‹è½½é€Ÿåº¦ï¼ˆä½¿ç”¨å°æ–‡ä»¶ï¼‰
    echo -e "${BLUE}ğŸ“¥ ä¸‹è½½é€Ÿåº¦æµ‹è¯•:${NC}"
    if check_command curl; then
        # æµ‹è¯•åˆ°Cloudflareçš„é€Ÿåº¦
        start_time=$(date +%s)
        if curl -s --max-time 10 -o /tmp/test.file "https://cloudflare.com/favicon.ico" >/dev/null 2>&1; then
            end_time=$(date +%s)
            file_size=$(stat -c%s /tmp/test.file 2>/dev/null || echo 0)
            duration=$((end_time - start_time))
            if [ $duration -eq 0 ]; then duration=1; fi
            if [ $file_size -gt 0 ]; then
                speed=$(echo "scale=2; $file_size * 8 / $duration / 1000" | bc -l 2>/dev/null || echo "N/A")
                echo -e "${GREEN}ğŸŒ Cloudflare: ${speed} Kbps${NC}"
            fi
            rm -f /tmp/test.file
        else
            echo -e "${RED}ğŸŒ Cloudflare: æµ‹è¯•å¤±è´¥${NC}"
        fi
    fi
    
    # ç½‘ç»œè¿é€šæ€§æ€»ç»“
    echo -e "${BLUE}ğŸŒ ç½‘ç»œè¿é€šæ€§:${NC}"
    if ping -c 1 -W 3 223.5.5.5 >/dev/null 2>&1; then
        echo -e "${GREEN}âœ… å›½å†…ç½‘ç»œ: æ­£å¸¸${NC}"
    else
        echo -e "${RED}âŒ å›½å†…ç½‘ç»œ: å¼‚å¸¸${NC}"
    fi
    
    if ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1; then
        echo -e "${GREEN}âœ… å›½é™…ç½‘ç»œ: æ­£å¸¸${NC}"
    else
        echo -e "${RED}âŒ å›½é™…ç½‘ç»œ: å¼‚å¸¸${NC}"
    fi
}

# æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
show_system_info() {
    echo -e "${PURPLE}"
    echo "=================================================="
    echo "           ğŸŒˆ æœ€ç»ˆç‰ˆç½‘ç»œæµ‹é€Ÿè„šæœ¬"
    echo "           ä¸“ä¸ºå—é™ç¯å¢ƒä¼˜åŒ–"
    echo "=================================================="
    echo -e "${NC}"
    
    echo -e "${BLUE}ğŸ” ç³»ç»Ÿä¿¡æ¯:${NC}"
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo -e "${GREEN}âœ… ç³»ç»Ÿ: $PRETTY_NAME${NC}"
    fi
    echo -e "${GREEN}âœ… æ¶æ„: $(uname -m)${NC}"
    echo -e "${GREEN}âœ… å†…æ ¸: $(uname -r)${NC}"
    echo ""
}

# ä¸»å‡½æ•°
main() {
    show_system_info
    install_tools
    echo ""
    install_speedtest_final
    echo ""
    ultimate_speed_test
    echo ""
    
    echo -e "${PURPLE}==================================================${NC}"
    echo -e "${PURPLE}                 æµ‹è¯•å®Œæˆ ğŸŒŸ${NC}"
    echo -e "${PURPLE}==================================================${NC}"
    echo -e "${BLUE}ğŸ’¡ æç¤º: ç»¿è‰²è¡¨ç¤ºæ­£å¸¸ï¼Œçº¢è‰²è¡¨ç¤ºå¼‚å¸¸${NC}"
}

# è®¾ç½®é™·é˜±
trap 'echo -e "${NC}"' EXIT

# è¿è¡Œä¸»å‡½æ•°
main "$@"
