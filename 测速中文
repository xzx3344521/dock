#!/bin/bash

echo "ğŸš€ Debian/Ubuntu ç½‘ç»œæµ‹é€Ÿä¸è¯Šæ–­è„šæœ¬"

# è„šæœ¬ä¿¡æ¯
SCRIPT_NAME="network-speedtest"
SCRIPT_VERSION="2.0.0"
SCRIPT_AUTHOR="ç³»ç»Ÿä¼˜åŒ–ç‰ˆ"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

log_result() {
    echo -e "${CYAN}ğŸ“Š $1${NC}"
}

log_debug() {
    if [ "$DEBUG" = "true" ]; then
        echo -e "${PURPLE}ğŸ› $1${NC}"
    fi
}

# æ˜¾ç¤ºæ ‡é¢˜
show_header() {
    echo "=================================================="
    echo "           ğŸš€ $SCRIPT_NAME v$SCRIPT_VERSION"
    echo "              $SCRIPT_AUTHOR"
    echo "=================================================="
}

# æ£€æŸ¥ç³»ç»Ÿå…¼å®¹æ€§
check_system() {
    log_info "æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ..."
    
    # æ£€æŸ¥æ˜¯å¦ä¸º Debian/Ubuntu ç³»
    if [ ! -f /etc/debian_version ] && [ ! -f /etc/lsb-release ]; then
        if [ -f /etc/redhat-release ] || [ -f /etc/centos-release ]; then
            log_warning "æ£€æµ‹åˆ° RedHat/CentOS ç³»ç»Ÿï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½éœ€è¦è°ƒæ•´"
        elif [ -f /etc/alpine-release ]; then
            log_warning "æ£€æµ‹åˆ° Alpine Linuxï¼Œå»ºè®®ä½¿ç”¨ Debian/Ubuntu ç³»ç»Ÿ"
        else
            log_warning "é Debian/Ubuntu ç³»ç»Ÿï¼Œå…¼å®¹æ€§å¯èƒ½å—é™"
        fi
    fi

    # æ£€æµ‹ç³»ç»Ÿç‰ˆæœ¬
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        log_info "æ£€æµ‹åˆ°ç³»ç»Ÿ: $PRETTY_NAME"
        
        # æ£€æŸ¥ç³»ç»Ÿæ¶æ„
        local arch=$(uname -m)
        log_info "ç³»ç»Ÿæ¶æ„: $arch"
        
        # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
        local kernel=$(uname -r)
        log_info "å†…æ ¸ç‰ˆæœ¬: $kernel"
    fi

    # æ£€æŸ¥æƒé™
    if [ "$EUID" -eq 0 ]; then
        log_warning "å½“å‰ä»¥ root æƒé™è¿è¡Œ"
    else
        log_info "å½“å‰ä»¥æ™®é€šç”¨æˆ·æƒé™è¿è¡Œï¼Œéƒ¨åˆ†æ“ä½œéœ€è¦ sudo"
    fi
}

# æ£€æŸ¥å¹¶å®‰è£…å¿…è¦å·¥å…·
install_required_tools() {
    log_info "æ£€æŸ¥ç³»ç»Ÿå·¥å…·..."
    
    local packages=()
    local package_manager=""
    local install_cmd=""
    
    # æ£€æµ‹åŒ…ç®¡ç†å™¨
    if command -v apt-get &> /dev/null; then
        package_manager="apt"
        install_cmd="sudo apt-get install -y"
    elif command -v yum &> /dev/null; then
        package_manager="yum"
        install_cmd="sudo yum install -y"
    elif command -v dnf &> /dev/null; then
        package_manager="dnf"
        install_cmd="sudo dnf install -y"
    elif command -v apk &> /dev/null; then
        package_manager="apk"
        install_cmd="sudo apk add"
    else
        log_error "æœªæ‰¾åˆ°æ”¯æŒçš„åŒ…ç®¡ç†å™¨"
        return 1
    fi
    
    log_info "ä½¿ç”¨åŒ…ç®¡ç†å™¨: $package_manager"
    
    # åŸºç¡€å·¥å…·åˆ—è¡¨
    local base_tools=("curl" "wget" "ping" "bc" "dig" "traceroute")
    
    # æ ¹æ®åŒ…ç®¡ç†å™¨è°ƒæ•´åŒ…å
    case $package_manager in
        "apt")
            packages=("curl" "wget" "iputils-ping" "bc" "dnsutils" "traceroute")
            ;;
        "yum"|"dnf")
            packages=("curl" "wget" "iputils" "bc" "bind-utils" "traceroute")
            ;;
        "apk")
            packages=("curl" "wget" "iputils" "bc" "bind-tools" "traceroute")
            ;;
    esac
    
    # æ›´æ–°åŒ…åˆ—è¡¨
    log_info "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
    case $package_manager in
        "apt") sudo apt-get update ;;
        "yum") sudo yum check-update || true ;;
        "dnf") sudo dnf check-update || true ;;
        "apk") sudo apk update ;;
    esac
    
    # æ£€æŸ¥å¹¶å®‰è£…ç¼ºå¤±çš„åŒ…
    local missing_packages=()
    
    for pkg in "${packages[@]}"; do
        if ! command -v "${pkg%% *}" &> /dev/null && ! dpkg -l | grep -q "^ii  ${pkg} " 2>/dev/null; then
            missing_packages+=("$pkg")
        fi
    done
    
    if [ ${#missing_packages[@]} -ne 0 ]; then
        log_warning "éœ€è¦å®‰è£…ç¼ºå¤±çš„åŒ…: ${missing_packages[*]}"
        
        if [ "$AUTO_INSTALL" = "true" ]; then
            log_info "è‡ªåŠ¨å®‰è£…ä¸­..."
        else
            read -p "æ˜¯å¦å®‰è£…è¿™äº›åŒ…ï¼Ÿ(Y/n): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Nn]$ ]]; then
                log_warning "è·³è¿‡åŒ…å®‰è£…ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨"
                return 0
            fi
        fi
        
        if $install_cmd "${missing_packages[@]}"; then
            log_success "åŒ…å®‰è£…å®Œæˆ"
        else
            log_error "åŒ…å®‰è£…å¤±è´¥"
            return 1
        fi
    else
        log_success "æ‰€æœ‰å¿…è¦å·¥å…·å·²å®‰è£…"
    fi
}

# å®‰è£… speedtest-cli
install_speedtest() {
    log_info "æ£€æŸ¥ speedtest å·¥å…·..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    if command -v speedtest &> /dev/null || command -v speedtest-cli &> /dev/null; then
        log_success "speedtest å·²å®‰è£…"
        return 0
    fi
    
    log_info "å®‰è£… speedtest-cli..."
    
    # æ–¹æ³•1: ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨
    case $package_manager in
        "apt")
            if sudo apt-get install -y speedtest-cli 2>/dev/null; then
                log_success "é€šè¿‡ apt å®‰è£…æˆåŠŸ"
                return 0
            fi
            ;;
        "yum"|"dnf")
            if sudo $package_manager install -y speedtest-cli 2>/dev/null; then
                log_success "é€šè¿‡ $package_manager å®‰è£…æˆåŠŸ"
                return 0
            fi
            ;;
    esac
    
    # æ–¹æ³•2: ä½¿ç”¨ pip
    if command -v pip3 &> /dev/null; then
        log_info "å°è¯•ä½¿ç”¨ pip3 å®‰è£…..."
        if pip3 install speedtest-cli 2>/dev/null; then
            log_success "é€šè¿‡ pip3 å®‰è£…æˆåŠŸ"
            return 0
        fi
    fi
    
    # æ–¹æ³•3: ä½¿ç”¨å®˜æ–¹è„šæœ¬
    log_info "ä½¿ç”¨å®˜æ–¹è„šæœ¬å®‰è£…..."
    if curl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh | sudo bash 2>/dev/null; then
        if sudo apt-get install -y speedtest 2>/dev/null; then
            log_success "é€šè¿‡å®˜æ–¹ä»“åº“å®‰è£…æˆåŠŸ"
            return 0
        fi
    fi
    
    # æ–¹æ³•4: ç›´æ¥ä¸‹è½½
    log_info "ç›´æ¥ä¸‹è½½ speedtest-cli..."
    if wget -q -O speedtest-cli https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py; then
        chmod +x speedtest-cli
        sudo mv speedtest-cli /usr/local/bin/speedtest-cli
        
        if command -v speedtest-cli &> /dev/null; then
            log_success "speedtest-cli å®‰è£…æˆåŠŸ"
            return 0
        fi
    fi
    
    log_warning "speedtest-cli å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æµ‹é€Ÿæ–¹æ³•"
    return 1
}

# ç½‘ç»œè¿é€šæ€§æµ‹è¯•
test_connectivity() {
    log_info "æµ‹è¯•ç½‘ç»œè¿é€šæ€§..."
    
    local test_hosts=(
        "223.5.5.5"           # é˜¿é‡ŒDNS
        "114.114.114.114"     # 114DNS
        "1.1.1.1"            # Cloudflare
        "8.8.8.8"            # Google DNS
        "119.29.29.29"       # è…¾è®¯DNS
    )
    
    local connected=false
    local success_count=0
    
    for host in "${test_hosts[@]}"; do
        if ping -c 2 -W 3 "$host" &> /dev/null; then
            log_success "è¿é€š $host"
            connected=true
            ((success_count++))
        else
            log_warning "æ— æ³•è¿æ¥ $host"
        fi
    done
    
    if [ "$connected" = false ]; then
        log_error "ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥"
        return 1
    fi
    
    log_info "ç½‘ç»œè¿é€šæ€§: $success_count/${#test_hosts[@]} ä¸ªæµ‹è¯•ç‚¹æˆåŠŸ"
    return 0
}

# DNS è§£ææµ‹è¯•
test_dns() {
    log_info "æµ‹è¯• DNS è§£æ..."
    
    local domains=("baidu.com" "qq.com" "taobao.com" "github.com" "debian.org")
    local success_count=0
    
    for domain in "${domains[@]}"; do
        if dig +short "$domain" &> /dev/null; then
            local ip=$(dig +short "$domain" | head -1)
            log_success "è§£æ $domain â†’ $ip"
            ((success_count++))
        else
            log_warning "è§£æå¤±è´¥: $domain"
        fi
    done
    
    log_info "DNS è§£æ: $success_count/${#domains[@]} ä¸ªåŸŸåæˆåŠŸ"
}

# å»¶è¿Ÿæµ‹è¯•
test_latency() {
    log_info "æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ..."
    
    local latency_hosts=(
        "223.5.5.5"           # é˜¿é‡ŒDNS
        "114.114.114.114"     # 114DNS
        "1.1.1.1"            # Cloudflare
        "8.8.8.8"            # Google DNS
    )
    
    for host in "${latency_hosts[@]}"; do
        if ping -c 4 -W 2 "$host" &> /dev/null; then
            local result
            result=$(ping -c 4 -W 2 "$host" | tail -1 | awk -F'/' '{print "å¹³å‡å»¶è¿Ÿ: "$5"ms, æŠ–åŠ¨: "$6"ms"}')
            log_info "$host - $result"
        else
            log_warning "$host - å»¶è¿Ÿæµ‹è¯•å¤±è´¥"
        fi
    done
}

# ä¸“ä¸šæµ‹é€Ÿ
test_speed_professional() {
    log_info "å¼€å§‹ä¸“ä¸šç½‘ç»œæµ‹é€Ÿ..."
    
    # å°è¯•ä½¿ç”¨ speedtest
    if command -v speedtest &> /dev/null; then
        log_info "ä½¿ç”¨ Ookla speedtest..."
        if speedtest --accept-license --simple; then
            return 0
        fi
    fi
    
    if command -v speedtest-cli &> /dev/null; then
        log_info "ä½¿ç”¨ speedtest-cli..."
        local result
        result=$(speedtest-cli --simple 2>/dev/null)
        
        if [ $? -eq 0 ] && [ -n "$result" ]; then
            echo "$result" | while IFS= read -r line; do
                case $line in
                    Ping:*)
                        local ping_value=$(echo "$line" | awk '{print $2 " " $3}')
                        log_result "ğŸ”„ ç½‘ç»œå»¶è¿Ÿ: $ping_value"
                        ;;
                    Download:*)
                        local download_value=$(echo "$line" | awk '{print $2 " " $3}')
                        log_result "â¬‡ï¸  ä¸‹è½½é€Ÿåº¦: $download_value"
                        ;;
                    Upload:*)
                        local upload_value=$(echo "$line" | awk '{print $2 " " $3}')
                        log_result "â¬†ï¸  ä¸Šä¼ é€Ÿåº¦: $upload_value"
                        ;;
                esac
            done
            return 0
        fi
    fi
    
    # å¤‡ç”¨æµ‹é€Ÿæ–¹æ³•
    test_speed_backup
}

# å¤‡ç”¨æµ‹é€Ÿæ–¹æ³•
test_speed_backup() {
    log_info "ä½¿ç”¨å¤‡ç”¨æ–¹æ³•æµ‹é€Ÿ..."
    
    # ä½¿ç”¨ cachefly çš„æµ‹é€ŸèŠ‚ç‚¹
    local test_urls=(
        "http://cachefly.cachefly.net/100mb.test"
        "http://speedtest.ftp.otenet.gr/files/test100Mb.db"
    )
    
    for url in "${test_urls[@]}"; do
        log_info "å°è¯•èŠ‚ç‚¹: $(basename "$url")"
        
        if curl -I --connect-timeout 5 "$url" &> /dev/null; then
            local start_time end_time download_time speed_mbps
            
            start_time=$(date +%s.%N)
            if curl -L --max-time 30 --progress-bar -o /dev/null "$url" &> /dev/null; then
                end_time=$(date +%s.%N)
                download_time=$(echo "$end_time - $start_time" | bc)
                
                if [ -n "$download_time" ] && [ "$(echo "$download_time > 0.1" | bc -l)" -eq 1 ]; then
                    speed_mbps=$(echo "scale=2; (100 * 8) / $download_time" | bc)
                    log_result "â¬‡ï¸  ä¸‹è½½é€Ÿåº¦: ${speed_mbps} Mbit/s"
                    
                    # ä¼°ç®—ä¸Šä¼ é€Ÿåº¦
                    local upload_speed=$(echo "scale=2; $speed_mbps * 0.4" | bc)
                    log_result "â¬†ï¸  ä¸Šä¼ é€Ÿåº¦: ${upload_speed} Mbit/s (ä¼°ç®—å€¼)"
                    return 0
                fi
            fi
        fi
    done
    
    log_warning "å¤‡ç”¨æµ‹é€Ÿæ–¹æ³•å¤±è´¥"
    return 1
}

# ç½‘ç»œæ¥å£ä¿¡æ¯
show_network_info() {
    log_info "æ”¶é›†ç½‘ç»œä¿¡æ¯..."
    
    # IP åœ°å€ä¿¡æ¯
    log_info "IP åœ°å€ä¿¡æ¯:"
    ip -4 addr show | grep inet | awk '{print "  " $2}' | head -5
    
    # é»˜è®¤ç½‘å…³
    log_info "é»˜è®¤ç½‘å…³:"
    ip route | grep default | awk '{print "  " $3}'
    
    # DNS æœåŠ¡å™¨
    log_info "DNS æœåŠ¡å™¨:"
    if [ -f /etc/resolv.conf ]; then
        grep nameserver /etc/resolv.conf | awk '{print "  " $2}'
    fi
}

# è·¯ç”±è¿½è¸ª
test_traceroute() {
    if [ "$QUICK_MODE" = "true" ]; then
        return 0
    fi
    
    log_info "è¿›è¡Œè·¯ç”±è¿½è¸ª..."
    
    if command -v traceroute &> /dev/null; then
        traceroute -m 8 -w 2 223.5.5.5 | head -12
    else
        log_warning "traceroute ä¸å¯ç”¨"
    fi
}

# æ¸…ç†å‡½æ•°
cleanup() {
    log_debug "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    rm -f /tmp/speedtest*.tmp
    rm -f speedtest-cli 2>/dev/null
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ä½¿ç”¨æ–¹æ³•: $0 [é€‰é¡¹]"
    echo
    echo "é€‰é¡¹:"
    echo "  -h, --help         æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  -v, --version      æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo "  -q, --quick        å¿«é€Ÿæ¨¡å¼ï¼ˆè·³è¿‡è·¯ç”±è¿½è¸ªï¼‰"
    echo "  -f, --full         å®Œæ•´æ¨¡å¼ï¼ˆåŒ…å«è¯¦ç»†è¯Šæ–­ï¼‰"
    echo "  -y, --yes          è‡ªåŠ¨ç¡®è®¤æ‰€æœ‰æç¤º"
    echo "  -d, --debug        è°ƒè¯•æ¨¡å¼"
    echo
    echo "ç¤ºä¾‹:"
    echo "  $0                  # æ ‡å‡†æ¨¡å¼"
    echo "  $0 -q               # å¿«é€Ÿæ¨¡å¼"
    echo "  $0 -y               # è‡ªåŠ¨ç¡®è®¤"
}

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
show_version() {
    echo "$SCRIPT_NAME v$SCRIPT_VERSION"
    echo "é€‚ç”¨äº Debian/Ubuntu ç³»ç»Ÿçš„ç½‘ç»œæµ‹é€Ÿå·¥å…·"
}

# å‚æ•°è§£æ
parse_arguments() {
    QUICK_MODE="false"
    AUTO_INSTALL="false"
    DEBUG="false"
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            -q|--quick)
                QUICK_MODE="true"
                shift
                ;;
            -f|--full)
                QUICK_MODE="false"
                shift
                ;;
            -y|--yes)
                AUTO_INSTALL="true"
                shift
                ;;
            -d|--debug)
                DEBUG="true"
                shift
                ;;
            *)
                log_error "æœªçŸ¥å‚æ•°: $1"
                show_help
                exit 1
                ;;
        esac
    done
}

# ä¸»å‡½æ•°
main() {
    # è§£æå‚æ•°
    parse_arguments "$@"
    
    # æ˜¾ç¤ºæ ‡é¢˜
    show_header
    
    # è®¾ç½®é”™è¯¯å¤„ç†
    set -e
    trap 'cleanup; log_error "è„šæœ¬æ‰§è¡Œä¸­æ–­"; exit 130' INT TERM
    trap 'cleanup' EXIT
    
    # ç³»ç»Ÿæ£€æŸ¥
    check_system
    
    # å®‰è£…å¿…è¦å·¥å…·
    if ! install_required_tools; then
        log_error "å·¥å…·å®‰è£…å¤±è´¥"
        exit 1
    fi
    
    # å®‰è£… speedtest
    install_speedtest
    
    # æµ‹è¯•ç½‘ç»œè¿é€šæ€§
    if ! test_connectivity; then
        log_error "ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®"
        exit 1
    fi
    
    echo ""
    
    # æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
    show_network_info
    
    echo ""
    
    # DNS æµ‹è¯•
    test_dns
    
    echo ""
    
    # å»¶è¿Ÿæµ‹è¯•
    test_latency
    
    echo ""
    
    # ä¸“ä¸šæµ‹é€Ÿ
    if ! test_speed_professional; then
        log_warning "ä¸“ä¸šæµ‹é€Ÿå¤±è´¥"
    fi
    
    echo ""
    
    # è·¯ç”±è¿½è¸ª
    if [ "$QUICK_MODE" = "false" ]; then
        test_traceroute
    fi
    
    echo ""
    log_success "ç½‘ç»œæµ‹é€Ÿå®Œæˆ"
    
    # æ˜¾ç¤ºä½¿ç”¨å»ºè®®
    echo ""
    log_info "æç¤º:"
    echo "  - ä½¿ç”¨ '$0 -q' è¿›è¡Œå¿«é€Ÿæµ‹é€Ÿ"
    echo "  - ä½¿ç”¨ '$0 -y' è‡ªåŠ¨ç¡®è®¤æ‰€æœ‰æç¤º"
    echo "  - å®šæœŸè¿è¡Œä»¥ç›‘æ§ç½‘ç»œè´¨é‡"
}

# è„šæœ¬å…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
