#!/bin/bash

# cloudflared Docker å®¹å™¨åŒ–ä¸€é”®éƒ¨ç½²è„šæœ¬
# åŠŸèƒ½ï¼šè‡ªåŠ¨éƒ¨ç½²å¹¶é…ç½® cloudflared éš§é“æœåŠ¡ï¼Œæ”¯æŒé€‰æ‹©å¯†é’¥å’ŒæœåŠ¡å™¨ä½ç½®

set -e  # é‡åˆ°ä»»ä½•é”™è¯¯ç«‹å³é€€å‡ºè„šæœ¬

# é¢œè‰²å®šä¹‰ç”¨äºè¾“å‡ºç¾åŒ–
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # æ— é¢œè‰²

# é»˜è®¤ Cloudflare Tunnel ä»¤ç‰Œ
DEFAULT_CF_TUNNEL_TOKEN="eyJhIjoiYmI2OTg1ZGU4N2ZiMDEyYjNjNjI2YWExM2VkYTY3OTciLCJ0IjoiNGYyMjNhM2UtNWNjYy00ZmMwLWI1N2MtNjQzZGY5ZmI1ZWZmIiwicyI6Ik1qTmxOR1U0WmpndE5ERXlPQzAwTjJKaExUazNaVFl0WVRWaU5tUmtObVkxTkdSaSJ9"

# ç”¨æˆ·æä¾›çš„ Cloudflare Tunnel ä»¤ç‰Œ
USER_CF_TUNNEL_TOKEN="eyJhIjoiYmI2OTg1ZGU4N2ZiMDEyYjNjNjI2YWExM2VkYTY3OTciLCJ0IjoiOWRhNTU2YmMtMWZhNC00Njg2LTg1YTQtZTczOTQ1YmEwMGNmIiwicyI6Ik5XWTNPV05tTkRjdFltVTBOQzAwTkRkaExXRm1ZVEF0T1daaE9XRTVaVFUyTWpRMSJ9"

# å½“å‰ä½¿ç”¨çš„ä»¤ç‰Œ
CF_TUNNEL_TOKEN=""
SERVER_LOCATION=""

# è¾“å‡ºå¸¦é¢œè‰²çš„ä¿¡æ¯å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# æ£€æŸ¥ Docker æ˜¯å¦å¯ç”¨
check_docker() {
    log_step "æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€..."
    if ! command -v docker &> /dev/null; then
        log_error "Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker"
        exit 1
    fi
    
    if ! docker info &> /dev/null; then
        log_error "Docker æœåŠ¡æœªè¿è¡Œï¼Œè¯·å¯åŠ¨ Docker æœåŠ¡"
        exit 1
    fi
    log_info "Docker æœåŠ¡çŠ¶æ€æ­£å¸¸"
}

# å‡†å¤‡æ•°æ®ç›®å½•å’Œé…ç½®æ–‡ä»¶
prepare_directories() {
    log_step "å‡†å¤‡æ•°æ®ç›®å½•å’Œé…ç½®æ–‡ä»¶..."
    
    # åˆ›å»º /data ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [ ! -d "/data" ]; then
        log_info "åˆ›å»º /data ç›®å½•"
        sudo mkdir -p /data
        sudo chmod 755 /data
    fi
    
    # åˆ‡æ¢åˆ°å·¥ä½œç›®å½•
    cd /data
    
    # åˆ›å»º cloudflared ç›¸å…³ç›®å½•
    mkdir -p cloudflared/{config,logs,cert}
    chmod -R 755 cloudflared
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    cat > /data/cloudflared/config/config.yml << EOF
# Cloudflare Tunnel é…ç½®æ–‡ä»¶
tunnel: $(echo $CF_TUNNEL_TOKEN | cut -d'.' -f2 | base64 -d 2>/dev/null | grep '"t"' | cut -d'"' -f4 || echo "tunnel-id")
credentials-file: /etc/cloudflared/credentials.json
logfile: /var/log/cloudflared/cloudflared.log
loglevel: info

# æœåŠ¡é…ç½®ï¼ˆç¤ºä¾‹ï¼Œè¯·æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ï¼‰
ingress:
  - hostname: example.your-domain.com
    service: http://localhost:80
    originRequest:
      connectTimeout: 30s
      noTLSVerify: false
  - service: http_status:404
EOF

    # åˆ›å»ºå‡­è¯æ–‡ä»¶
    cat > /data/cloudflared/config/credentials.json << EOF
{"AccountTag":"$(echo $CF_TUNNEL_TOKEN | cut -d'.' -f2 | base64 -d 2>/dev/null | grep '"a"' | cut -d'"' -f4 || echo "account-tag")","TunnelSecret":"$(echo $CF_TUNNEL_TOKEN | cut -d'.' -f2 | base64 -d 2>/dev/null | grep '"s"' | cut -d'"' -f4 || echo "tunnel-secret")","TunnelID":"$(echo $CF_TUNNEL_TOKEN | cut -d'.' -f2 | base64 -d 2>/dev/null | grep '"t"' | cut -d'"' -f4 || echo "tunnel-id")","TunnelName":"docker-tunnel"}
EOF

    log_info "æ•°æ®ç›®å½•å’Œé…ç½®æ–‡ä»¶å‡†å¤‡å®Œæˆ"
}

# éªŒè¯ Cloudflare Token æ ¼å¼
validate_token() {
    log_step "éªŒè¯ Cloudflare Tunnel Token..."
    
    if [ -z "$CF_TUNNEL_TOKEN" ]; then
        log_error "Cloudflare Tunnel Token ä¸èƒ½ä¸ºç©º"
        exit 1
    fi
    
    # ç®€å•çš„ token æ ¼å¼éªŒè¯
    if [[ ! "$CF_TUNNEL_TOKEN" =~ ^eyJ ]]; then
        log_warning "Token æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼Œä½†å°†ç»§ç»­éƒ¨ç½²"
    else
        log_info "Token æ ¼å¼éªŒè¯é€šè¿‡"
    fi
}

# éƒ¨ç½² cloudflared å®¹å™¨
deploy_cloudflared() {
    log_step "å¼€å§‹éƒ¨ç½² cloudflared å®¹å™¨..."
    
    local container_name="cloudflared-tunnel"
    
    # æ£€æŸ¥å®¹å™¨æ˜¯å¦å·²å­˜åœ¨
    if docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_info "å‘ç°å·²å­˜åœ¨çš„ ${container_name} å®¹å™¨ï¼Œæ­£åœ¨æ¸…ç†..."
        docker stop ${container_name} >/dev/null 2>&1 || true
        docker rm ${container_name} >/dev/null 2>&1 || true
    fi
    
    # è¿è¡Œ cloudflared å®¹å™¨
    log_info "å¯åŠ¨ cloudflared éš§é“æœåŠ¡..."
    log_info "æœåŠ¡å™¨ä½ç½®: ${SERVER_LOCATION}"
    
    docker run -d \
        --name ${container_name} \
        --restart=unless-stopped \
        --network host \
        -v /data/cloudflared/config:/etc/cloudflared \
        -v /data/cloudflared/logs:/var/log/cloudflared \
        -v /data/cloudflared/cert:/home/nonroot/.cloudflared \
        -e TUNNEL_TOKEN="${CF_TUNNEL_TOKEN}" \
        cloudflare/cloudflared:latest \
        tunnel --config /etc/cloudflared/config.yml run
    
    log_info "cloudflared å®¹å™¨éƒ¨ç½²å®Œæˆ"
}

# éªŒè¯å®¹å™¨çŠ¶æ€
verify_deployment() {
    log_step "éªŒè¯å®¹å™¨è¿è¡ŒçŠ¶æ€..."
    
    local container_name="cloudflared-tunnel"
    local max_retries=10
    local retry_interval=5
    
    for i in $(seq 1 $max_retries); do
        if docker ps --format "{{.Names}}" | grep -q "^${container_name}$"; then
            local status=$(docker inspect -f '{{.State.Status}}' ${container_name} 2>/dev/null || echo "unknown")
            
            if [ "$status" = "running" ]; then
                log_info "âœ… cloudflared å®¹å™¨æ­£åœ¨æ­£å¸¸è¿è¡Œ"
                
                # æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
                echo ""
                log_info "å®¹å™¨åç§°: ${container_name}"
                log_info "è¿è¡ŒçŠ¶æ€: ${status}"
                log_info "æœåŠ¡å™¨ä½ç½®: ${SERVER_LOCATION}"
                log_info "æ•°æ®ç›®å½•: /data/cloudflared/"
                log_info "é…ç½®ç›®å½•: /data/cloudflared/config"
                log_info "æ—¥å¿—ç›®å½•: /data/cloudflared/logs"
                log_info "è¯ä¹¦ç›®å½•: /data/cloudflared/cert"
                echo ""
                
                # æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—
                log_info "å®¹å™¨å¯åŠ¨æ—¥å¿—:"
                docker logs ${container_name} --tail 10
                
                return 0
            else
                log_warning "å®¹å™¨çŠ¶æ€: ${status}ï¼Œç­‰å¾…ä¸­... (å°è¯• $i/$max_retries)"
            fi
        else
            log_warning "å®¹å™¨æœªè¿è¡Œï¼Œç­‰å¾…ä¸­... (å°è¯• $i/$max_retries)"
        fi
        sleep $retry_interval
    done
    
    log_error "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥æˆ–è¶…æ—¶"
    docker logs ${container_name} --tail 50
    exit 1
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo ""
    log_info "ğŸ”§ ä½¿ç”¨è¯´æ˜:"
    log_info "æŸ¥çœ‹æ—¥å¿—: docker logs cloudflared-tunnel -f"
    log_info "é‡å¯æœåŠ¡: docker restart cloudflared-tunnel"
    log_info "åœæ­¢æœåŠ¡: docker stop cloudflared-tunnel"
    log_info "æŸ¥çœ‹çŠ¶æ€: docker ps -f name=cloudflared-tunnel"
    echo ""
    log_info "ğŸ“ é…ç½®æ–‡ä»¶è·¯å¾„: /data/cloudflared/config/config.yml"
    log_info "è¯·æ ¹æ®å®é™…éœ€æ±‚ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„åŸŸåå’ŒæœåŠ¡è®¾ç½®"
    echo ""
}

# é€‰æ‹©ä½¿ç”¨å“ªä¸ªä»¤ç‰Œ
select_token() {
    echo ""
    log_info "è¯·é€‰æ‹©è¦ä½¿ç”¨çš„ Cloudflare Tunnel Token:"
    echo "1. ä½¿ç”¨é»˜è®¤å¯†é’¥"
    echo "2. ä½¿ç”¨ç”¨æˆ·æä¾›çš„å¯†é’¥"
    echo ""
    
    while true; do
        read -p "è¯·è¾“å…¥é€‰æ‹© (1/2): " choice
        case $choice in
            1)
                CF_TUNNEL_TOKEN=$DEFAULT_CF_TUNNEL_TOKEN
                log_info "å·²é€‰æ‹©ä½¿ç”¨é»˜è®¤å¯†é’¥"
                break
                ;;
            2)
                CF_TUNNEL_TOKEN=$USER_CF_TUNNEL_TOKEN
                log_info "å·²é€‰æ‹©ä½¿ç”¨ç”¨æˆ·æä¾›çš„å¯†é’¥"
                break
                ;;
            *)
                log_error "æ— æ•ˆçš„é€‰æ‹©ï¼Œè¯·è¾“å…¥ 1 æˆ– 2"
                ;;
        esac
    done
}

# é€‰æ‹©æœåŠ¡å™¨ä½ç½®
select_server_location() {
    echo ""
    log_info "è¯·é€‰æ‹©æœåŠ¡å™¨ä½ç½®:"
    echo "1. å›½å†…æœåŠ¡å™¨"
    echo "2. é¦™æ¸¯æœåŠ¡å™¨"
    echo ""
    
    while true; do
        read -p "è¯·è¾“å…¥é€‰æ‹© (1/2): " choice
        case $choice in
            1)
                SERVER_LOCATION="å›½å†…æœåŠ¡å™¨"
                break
                ;;
            2)
                SERVER_LOCATION="é¦™æ¸¯æœåŠ¡å™¨"
                break
                ;;
            *)
                log_error "æ— æ•ˆçš„é€‰æ‹©ï¼Œè¯·è¾“å…¥ 1 æˆ– 2"
                ;;
        esac
    done
}

# ä¸»æ‰§è¡Œå‡½æ•°
main() {
    echo ""
    log_info "ğŸš€ å¼€å§‹éƒ¨ç½² Cloudflare Tunnel Docker å®¹å™¨..."
    log_info "=========================================="
    
    select_token
    select_server_location
    validate_token
    check_docker
    prepare_directories
    deploy_cloudflared
    verify_deployment
    
    log_info "=========================================="
    log_info "âœ… Cloudflare Tunnel éƒ¨ç½²å®Œæˆï¼"
    log_info "éš§é“å·²ä½¿ç”¨æä¾›çš„ Token è¿›è¡Œè®¤è¯"
    log_info "æœåŠ¡å™¨ä½ç½®: ${SERVER_LOCATION}"
    
    show_usage
}

# å¼‚å¸¸å¤„ç†
trap 'log_error "è„šæœ¬æ‰§è¡Œè¢«ä¸­æ–­"; exit 1' INT TERM

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
