#!/bin/bash

# é«˜ç«¯ Docker ç«¯å£æŸ¥çœ‹å·¥å…· - ä¿®å¤ç‰ˆ
# æ˜¾ç¤ºå…¨éƒ¨å®¹å™¨çš„ç«¯å£æ˜ å°„ä¿¡æ¯

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# è·å–ç»ˆç«¯å®½åº¦
TERM_WIDTH=$(tput cols 2>/dev/null || echo 80)

print_header() {
    local title="ğŸ³ DOCKER å®¹å™¨ç«¯å£æ˜ å°„è¡¨ ğŸ³"
    local padding=$(( (TERM_WIDTH - ${#title}) / 2 ))
    printf "\n${BOLD}${CYAN}%*s${NC}\n" $((padding + ${#title})) "$title"
    echo
}

print_separator() {
    printf "${BLUE}%*s${NC}\n" $TERM_WIDTH | tr ' ' 'â•'
}

print_table_header() {
    printf "${BOLD}${YELLOW}%-25s %-12s %-35s %-20s${NC}\n" "å®¹å™¨åç§°" "çŠ¶æ€" "ä¸»æœºç«¯å£ â†’ å®¹å™¨ç«¯å£" "é•œåƒ"
    print_separator
}

format_ports() {
    local ports="$1"
    if [[ -z "$ports" || "$ports" == "" ]]; then
        echo -e "${RED}æ— ç«¯å£æ˜ å°„${NC}"
        return
    fi
    
    # æå–å¹¶æ ¼å¼åŒ–ç«¯å£ä¿¡æ¯
    echo "$ports" | sed -E '
        s/0\.0\.0\.0:([0-9]+)->([0-9]+)\/tcp/\1 â†’ \2/g;
        s/\[::\]:([0-9]+)->([0-9]+)\/tcp/\1 â†’ \2/g;
        s/, /\\n/g;
    ' | while IFS= read -r line; do
        if [[ -n "$line" ]]; then
            echo -e "  ${GREEN}${line}${NC}"
        fi
    done
}

print_container_info() {
    local name="$1"
    local status="$2"
    local ports="$3"
    local image="$4"
    
    # çŠ¶æ€é¢œè‰²
    local status_color=$GREEN
    if [[ "$status" == *"Exited"* ]]; then
        status_color=$RED
    elif [[ "$status" == *"Restarting"* ]]; then
        status_color=$YELLOW
    fi
    
    # ç¼©çŸ­é•œåƒåç§°
    local image_short=$(echo "$image" | cut -d':' -f1 | rev | cut -d'/' -f1 | rev)
    if [[ ${#image_short} -gt 18 ]]; then
        image_short="${image_short:0:15}..."
    fi
    
    # æ‰“å°å®¹å™¨åŸºæœ¬ä¿¡æ¯
    printf "%-25s ${status_color}%-12s${NC} %-35s %-20s\n" \
        "${name:0:24}" \
        "${status:0:11}" \
        "" \
        "$image_short"
    
    # æ‰“å°ç«¯å£ä¿¡æ¯
    format_ports "$ports"
}

get_total_info() {
    local total=$(docker ps -aq | wc -l | tr -d ' ')
    local running=$(docker ps -q | wc -l | tr -d ' ')
    local stopped=$((total - running))
    echo "$total $running $stopped"
}

main() {
    # æ£€æŸ¥ Docker
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}é”™è¯¯: Docker æœªå®‰è£…${NC}"
        exit 1
    fi
    
    # æ˜¾ç¤ºå¤´éƒ¨
    print_header
    
    # è·å–ç»Ÿè®¡ä¿¡æ¯
    read total running stopped <<< $(get_total_info)
    
    # æ˜¾ç¤ºç»Ÿè®¡
    echo -e "${BOLD}ğŸ“Š å®¹å™¨ç»Ÿè®¡: ${GREEN}è¿è¡Œ: $running${NC} | ${YELLOW}åœæ­¢: $stopped${NC} | ${BLUE}æ€»è®¡: $total${NC}"
    print_separator
    echo
    
    # æ˜¾ç¤ºè¡¨æ ¼å¤´éƒ¨
    print_table_header
    
    # è·å–å¹¶æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
    docker ps -a --format "{{.Names}}||{{.Status}}||{{.Ports}}||{{.Image}}" | while IFS='||' read -r name status ports image; do
        print_container_info "$name" "$status" "$ports" "$image"
        echo
    done
    
    # æ˜¾ç¤ºåº•éƒ¨ä¿¡æ¯
    echo
    print_separator
    echo -e "${CYAN}ğŸ’¡ æç¤º:${NC}"
    echo -e "  ${GREEN}â—${NC} ç»¿è‰²çŠ¶æ€: å®¹å™¨æ­£å¸¸è¿è¡Œ"
    echo -e "  ${YELLOW}â—${NC} é»„è‰²çŠ¶æ€: å®¹å™¨é‡å¯ä¸­"
    echo -e "  ${RED}â—${NC} çº¢è‰²çŠ¶æ€: å®¹å™¨å·²åœæ­¢"
    echo
    echo -e "${PURPLE}ğŸ”„ åˆ·æ–°: é‡æ–°è¿è¡Œæ­¤è„šæœ¬${NC}"
    echo -e "${PURPLE}ğŸ³ ç®¡ç†: docker ps -a | docker start/stop [å®¹å™¨å]${NC}"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"
