#!/bin/bash

# OpenList Docker ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆå¸¦è‡ªåŠ¨å¯†ç æ£€æµ‹ï¼‰
# ç‰ˆæœ¬ï¼š1.3 - åœ¨åŸæœ‰æˆåŠŸè„šæœ¬åŸºç¡€ä¸Šæ·»åŠ å¯†ç è‡ªåŠ¨å¤„ç†

set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥åˆ™ç«‹å³é€€å‡ºè„šæœ¬

# å…¨å±€å˜é‡
CONTAINER_NAME="openlist"
DATA_DIR="/data/openlist"
IMAGE_NAME="openlistteam/openlist:latest"
DEFAULT_PORT=5344
PORT_MAPPING=""

# é¢œè‰²è¾“å‡ºå‡½æ•°
red() { echo -e "\033[31m$1\033[0m"; }
green() { echo -e "\033[32m$1\033[0m"; }
yellow() { echo -e "\033[33m$1\033[0m"; }
blue() { echo -e "\033[34m$1\033[0m"; }

# é”™è¯¯é€€å‡ºå‡½æ•°
error_exit() {
    red "âŒ é”™è¯¯ï¼š$1"
    exit 1
}

# æ£€æŸ¥ Docker æ˜¯å¦å¯ç”¨
check_docker() {
    blue "ğŸ” æ£€æŸ¥ Docker ç¯å¢ƒ..."
    if ! command -v docker &> /dev/null; then
        error_exit "æœªæ£€æµ‹åˆ° Dockerï¼Œè¯·å…ˆå®‰è£… Docker"
    fi
    
    if ! docker info &> /dev/null; then
        error_exit "Docker æœåŠ¡æœªè¿è¡Œï¼Œè¯·å¯åŠ¨ Docker æœåŠ¡"
    fi
    green "âœ… Docker ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
}

# å‡†å¤‡æ•°æ®ç›®å½•
prepare_directory() {
    blue "ğŸ“ å‡†å¤‡æ•°æ®ç›®å½•..."
    
    # åˆ›å»º /data ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [ ! -d "/data" ]; then
        yellow "åˆ›å»º /data ç›®å½•..."
        sudo mkdir -p /data || error_exit "åˆ›å»º /data ç›®å½•å¤±è´¥"
        sudo chmod 755 /data || error_exit "è®¾ç½® /data æƒé™å¤±è´¥"
    fi
    
    # åˆ›å»º OpenList æ•°æ®ç›®å½•
    if [ ! -d "$DATA_DIR" ]; then
        yellow "åˆ›å»º OpenList æ•°æ®ç›®å½•: $DATA_DIR"
        sudo mkdir -p "$DATA_DIR" || error_exit "åˆ›å»ºæ•°æ®ç›®å½•å¤±è´¥"
    fi
    
    # è®¾ç½®æ­£ç¡®çš„ç›®å½•æƒé™
    blue "ğŸ”§ è®¾ç½®ç›®å½•æƒé™..."
    sudo chown -R 1000:1000 "$DATA_DIR" || error_exit "è®¾ç½®ç›®å½•æ‰€æœ‰æƒå¤±è´¥"
    sudo chmod -R 755 "$DATA_DIR" || error_exit "è®¾ç½®ç›®å½•æƒé™å¤±è´¥"
    
    # éªŒè¯æƒé™è®¾ç½®
    if [ -w "$DATA_DIR" ] && [ -x "$DATA_DIR" ]; then
        green "âœ… ç›®å½•æƒé™éªŒè¯é€šè¿‡"
    else
        error_exit "ç›®å½•æƒé™è®¾ç½®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æƒé™"
    fi
    
    green "âœ… æ•°æ®ç›®å½•å‡†å¤‡å®Œæˆ"
}

# æ¸…ç†ç°æœ‰å®¹å™¨
cleanup_existing_container() {
    blue "ğŸ§¹ æ£€æŸ¥ç°æœ‰å®¹å™¨..."
    if docker ps -a --filter "name=$CONTAINER_NAME" --format "{{.Names}}" | grep -q "$CONTAINER_NAME"; then
        yellow "å‘ç°å·²å­˜åœ¨çš„ OpenList å®¹å™¨ï¼Œæ­£åœ¨æ¸…ç†..."
        docker stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
        docker rm "$CONTAINER_NAME" >/dev/null 2>&1 || true
        green "âœ… æ—§å®¹å™¨æ¸…ç†å®Œæˆ"
    else
        green "âœ… æ— ç°æœ‰å®¹å™¨éœ€è¦æ¸…ç†"
    fi
}

# æ£€æŸ¥ç«¯å£å ç”¨
check_port() {
    local port=$1
    blue "ğŸ” æ£€æŸ¥ç«¯å£ $port å ç”¨æƒ…å†µ..."
    
    if command -v ss &> /dev/null; then
        if ss -tuln | grep ":$port " > /dev/null; then
            return 1
        fi
    else
        if netstat -tuln | grep ":$port " > /dev/null; then
            return 1
        fi
    fi
    
    green "âœ… ç«¯å£ $port å¯ç”¨"
    return 0
}

# è·å–å¯ç”¨ç«¯å£
get_available_port() {
    local port=$DEFAULT_PORT
    local max_port=6000
    
    while [ $port -le $max_port ]; do
        if check_port $port; then
            echo $port
            return 0
        fi
        port=$((port + 1))
    done
    
    error_exit "åœ¨ $DEFAULT_PORT-$max_port èŒƒå›´å†…æ‰¾ä¸åˆ°å¯ç”¨ç«¯å£"
}

# æ‹‰å– OpenList é•œåƒ
pull_openlist_image() {
    blue "ğŸ“¦ æ‹‰å– OpenList é•œåƒ..."
    if docker pull "$IMAGE_NAME"; then
        green "âœ… OpenList é•œåƒæ‹‰å–å®Œæˆ"
    else
        error_exit "æ‹‰å– OpenList é•œåƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
    fi
}

# éƒ¨ç½² OpenList å®¹å™¨ï¼ˆä½¿ç”¨ç‰¹æƒæ¨¡å¼è§£å†³æƒé™é—®é¢˜ï¼‰
deploy_openlist() {
    blue "ğŸš€ å¼€å§‹éƒ¨ç½² OpenList å®¹å™¨..."
    
    # ç¡®å®šä½¿ç”¨çš„ç«¯å£
    if check_port $DEFAULT_PORT; then
        PORT_MAPPING="$DEFAULT_PORT:5244"
        green "âœ… ä½¿ç”¨é»˜è®¤ç«¯å£ï¼š$DEFAULT_PORT"
    else
        local available_port=$(get_available_port)
        PORT_MAPPING="$available_port:5244"
        yellow "ğŸ“Š ä½¿ç”¨ç«¯å£ï¼š$available_port (åŸç«¯å£ $DEFAULT_PORT è¢«å ç”¨)"
    fi
    
    # éƒ¨ç½²å‘½ä»¤ï¼ˆä½¿ç”¨ç‰¹æƒæ¨¡å¼è§£å†³æƒé™é—®é¢˜ï¼‰
    blue "ğŸ³ å¯åŠ¨å®¹å™¨..."
    if docker run -d \
        --name "$CONTAINER_NAME" \
        --restart=unless-stopped \
        --privileged \
        --user root \
        -p "$PORT_MAPPING" \
        -v "$DATA_DIR:/opt/openlist/data" \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -e PUID=0 \
        -e PGID=0 \
        -e UMASK=000 \
        -e TZ=Asia/Shanghai \
        "$IMAGE_NAME"; then
        green "âœ… OpenList å®¹å™¨éƒ¨ç½²æˆåŠŸ"
    else
        error_exit "OpenList å®¹å™¨å¯åŠ¨å¤±è´¥"
    fi
}

# === æ–°å¢åŠŸèƒ½ï¼šå¯†ç æ£€æµ‹å’Œè‡ªåŠ¨é‡ç½® ===
# ç”Ÿæˆéšæœºå¯†ç 
generate_random_password() {
    tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 12
    echo
}

# æ£€æµ‹å¹¶è·å–å¯†ç 
detect_and_get_password() {
    blue "ğŸ” æ£€æµ‹å¯†ç ç”Ÿæˆæƒ…å†µ..."
    
    local max_attempts=10
    local attempt=1
    local password=""
    
    while [ $attempt -le $max_attempts ]; do
        yellow "å°è¯•æ£€æµ‹å¯†ç  ($attempt/$max_attempts)..."
        sleep 3
        
        # æ£€æŸ¥å®¹å™¨æ—¥å¿—è·å–å¯†ç 
        local logs=$(docker logs "$CONTAINER_NAME" 2>&1 | tail -10)
        
        # å°è¯•æå–å¯†ç 
        password=$(echo "$logs" | grep -o "initial password is: [[:alnum:]]*" | awk '{print $4}' | tail -1)
        
        if [ -n "$password" ]; then
            green "âœ… æ£€æµ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„å¯†ç "
            echo "$password"
            return 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸä½†æ²¡æœ‰æ–°å¯†ç ï¼ˆä½¿ç”¨ç°æœ‰é…ç½®ï¼‰
        if echo "$logs" | grep -q "HTTP server"; then
            yellow "âš ï¸  ä½¿ç”¨ç°æœ‰é…ç½®ï¼Œæ— æ–°å¯†ç ç”Ÿæˆ"
            # è¿”å›ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä½¿ç”¨ç°æœ‰é…ç½®
            echo ""
            return 0
        fi
        
        attempt=$((attempt + 1))
    done
    
    # å¦‚æœæ£€æµ‹ä¸åˆ°å¯†ç ï¼Œç”Ÿæˆéšæœºå¯†ç å¹¶é‡ç½®
    yellow "âš ï¸  æœªæ£€æµ‹åˆ°å¯†ç ç”Ÿæˆï¼Œæ‰§è¡Œè‡ªåŠ¨é‡ç½®..."
    auto_reset_password
}

# è‡ªåŠ¨é‡ç½®å¯†ç 
auto_reset_password() {
    blue "ğŸ”„ è‡ªåŠ¨é‡ç½®å¯†ç ..."
    
    # åœæ­¢å®¹å™¨
    docker stop "$CONTAINER_NAME" 2>/dev/null || true
    
    # åˆ é™¤é…ç½®æ–‡ä»¶ä»¥è§¦å‘æ–°å¯†ç ç”Ÿæˆ
    yellow "åˆ é™¤ç°æœ‰é…ç½®..."
    sudo rm -f "$DATA_DIR/config.json" 2>/dev/null || true
    sudo rm -f "$DATA_DIR"/*.db 2>/dev/null || true
    
    # é‡å¯å®¹å™¨
    yellow "é‡å¯å®¹å™¨ç”Ÿæˆæ–°å¯†ç ..."
    docker start "$CONTAINER_NAME" 2>/dev/null || {
        yellow "å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œé‡æ–°éƒ¨ç½²..."
        deploy_openlist
    }
    
    # ç­‰å¾…å¹¶å†æ¬¡æ£€æµ‹å¯†ç 
    sleep 8
    detect_and_get_password
}

# éªŒè¯éƒ¨ç½²çŠ¶æ€
verify_deployment() {
    blue "ğŸ” éªŒè¯å®¹å™¨è¿è¡ŒçŠ¶æ€..."
    
    local max_attempts=15
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        yellow "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨ ($attempt/$max_attempts)..."
        sleep 3
        
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if docker ps --filter "name=$CONTAINER_NAME" --filter "status=running" --format "{{.Names}}" | grep -q "$CONTAINER_NAME"; then
            green "âœ… å®¹å™¨æ­£åœ¨è¿è¡Œ"
            
            # æ£€æµ‹å¹¶è·å–å¯†ç 
            PASSWORD=$(detect_and_get_password)
            
            return 0
        fi
        
        attempt=$((attempt + 1))
    done
    
    red "âŒ å®¹å™¨å¯åŠ¨è¶…æ—¶"
    blue "ğŸ“‹ å®¹å™¨æ—¥å¿—ï¼š"
    docker logs "$CONTAINER_NAME" | tail -20
    error_exit "å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹æ—¥å¿—"
}

# æ˜¾ç¤ºéƒ¨ç½²æˆåŠŸä¿¡æ¯
show_success_info() {
    local port=$(echo "$PORT_MAPPING" | cut -d':' -f1)
    local ip_address=$(hostname -I | awk '{print $1}' | head -n1)
    
    echo ""
    green "ğŸ‰ OpenList éƒ¨ç½²æˆåŠŸï¼"
    echo "=========================================="
    blue "ğŸ“‹ è®¿é—®ä¿¡æ¯ï¼š"
    echo "   ğŸŒ è®¿é—®åœ°å€ï¼šhttp://$ip_address:$port"
    echo "   ğŸ  æœ¬åœ°è®¿é—®ï¼šhttp://localhost:$port"
    echo "   ğŸ“ æ•°æ®ç›®å½•ï¼š$DATA_DIR"
    echo ""
    blue "ğŸ” ç™»å½•ä¿¡æ¯ï¼š"
    echo "   ç”¨æˆ·åï¼šadmin"
    
    if [ -n "$PASSWORD" ]; then
        echo "   å¯†ç ï¼š$PASSWORD"
        yellow "ğŸ’¡ é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼"
    else
        echo "   å¯†ç ï¼šä½¿ç”¨ä¹‹å‰è®¾ç½®çš„å¯†ç "
        echo "   ğŸ”„ å¦‚éœ€é‡ç½®ï¼šåˆ é™¤ $DATA_DIR/config.json å¹¶é‡å¯å®¹å™¨"
    fi
    
    echo ""
    blue "âš¡ å¸¸ç”¨å‘½ä»¤ï¼š"
    echo "   ğŸ“œ æŸ¥çœ‹æ—¥å¿—ï¼šdocker logs $CONTAINER_NAME"
    echo "   ğŸ”„ é‡å¯å®¹å™¨ï¼šdocker restart $CONTAINER_NAME"
    echo "   â¹ï¸  åœæ­¢å®¹å™¨ï¼šdocker stop $CONTAINER_NAME"
    echo "   ğŸš€ å¯åŠ¨å®¹å™¨ï¼šdocker start $CONTAINER_NAME"
}

# ä¸»æ‰§è¡Œæµç¨‹
main() {
    echo "=========================================="
    green "    OpenList Docker ä¸€é”®éƒ¨ç½²è„šæœ¬"
    yellow "      ï¼ˆå¸¦è‡ªåŠ¨å¯†ç æ£€æµ‹åŠŸèƒ½ï¼‰"
    echo "=========================================="
    
    check_docker
    prepare_directory
    cleanup_existing_container
    pull_openlist_image
    deploy_openlist
    verify_deployment
    show_success_info
    
    echo ""
    green "âœ… éƒ¨ç½²æµç¨‹å®Œæˆï¼"
}

# æ‰§è¡Œä¸»å‡½æ•°ï¼ˆæ•è·ä¸­æ–­ä¿¡å·ï¼‰
trap 'echo; red "âš ï¸  æ“ä½œè¢«ç”¨æˆ·ä¸­æ–­"; exit 1' INT
main "$@"
