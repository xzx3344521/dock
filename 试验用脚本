#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# æ˜¾ç¤ºèœå•
show_menu() {
    echo -e "${BLUE}"
    echo "ğŸ±====================================ğŸ±"
    echo "âœ¨  Syncthing ä¸€é”®ç®¡ç†è„šæœ¬ âœ¨"
    echo "ğŸ±====================================ğŸ±"
    echo -e "${NC}"
    echo "1. ğŸš€ å®‰è£… Syncthing"
    echo "2. ğŸ—‘ï¸  å¸è½½ Syncthing" 
    echo "3. ğŸ”„ é‡å¯ Syncthing æœåŠ¡"
    echo "4. ğŸ“Š æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "5. âŒ é€€å‡º"
    echo ""
    read -p "ğŸ’• è¯·é€‰æ‹©æ“ä½œ (1-5): " choice
}

# å®‰è£…å‡½æ•°
install_syncthing() {
    echo -e "${GREEN}ğŸ± å¼€å§‹å®‰è£… Syncthing...${NC}"
    
    # æ£€æµ‹ç³»ç»Ÿ
    if [ -f /etc/debian_version ]; then
        echo -e "${YELLOW}ğŸ¥ æ£€æµ‹åˆ° Debian/Ubuntu ç³»ç»Ÿ${NC}"
        # å®‰è£… Syncthing
        curl -s -o /usr/share/keyrings/syncthing-archive-keyring.gpg https://syncthing.net/release-key.gpg
        echo "deb [signed-by=/usr/share/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable" | tee /etc/apt/sources.list.d/syncthing.list
        apt update && apt install -y syncthing
        
    elif [ -f /etc/redhat-release ]; then
        echo -e "${YELLOW}ğŸ€ æ£€æµ‹åˆ° CentOS/RHEL ç³»ç»Ÿ${NC}"
        dnf install -y syncthing 2>/dev/null || (yum install -y epel-release && yum install -y syncthing)
    else
        echo -e "${RED}âŒ ä¸æ”¯æŒçš„ç³»ç»Ÿ${NC}"
        exit 1
    fi

    echo -e "${YELLOW}ğŸ¯ é…ç½® Syncthing æœåŠ¡...${NC}"
    # åˆ›å»ºæœåŠ¡é…ç½®
    cat > /etc/systemd/system/syncthing@root.service << 'EOF'
[Unit]
Description=Syncthing - Open Source Continuous File Synchronization for %i
Documentation=man:syncthing(1)
After=network.target

[Service]
User=%i
ExecStart=/usr/bin/syncthing serve --no-browser --no-restart --logflags=0 --gui-address="0.0.0.0:8384"
Restart=on-failure
SuccessExitStatus=3 4
RestartForceExitStatus=3 4

[Install]
WantedBy=multi-user.target
EOF

    echo -e "${YELLOW}ğŸ”§ è®¾ç½®é˜²ç«å¢™...${NC}"
    # å¼€æ”¾ç«¯å£ï¼ˆå¦‚æœé˜²ç«å¢™å¼€å¯çš„è¯ï¼‰
    if command -v ufw >/dev/null; then
        ufw allow 8384/tcp comment "Syncthing GUI" 2>/dev/null
        ufw allow 22000/tcp comment "Syncthing Transfer" 2>/dev/null
        ufw allow 21027/udp comment "Syncthing Discovery" 2>/dev/null
        echo -e "${GREEN}âœ… UFW é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾${NC}"
    elif command -v firewall-cmd >/dev/null; then
        firewall-cmd --permanent --add-port=8384/tcp 2>/dev/null
        firewall-cmd --permanent --add-port=22000/tcp 2>/dev/null  
        firewall-cmd --permanent --add-port=21027/udp 2>/dev/null
        firewall-cmd --reload 2>/dev/null
        echo -e "${GREEN}âœ… Firewalld é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾${NC}"
    else
        echo -e "${YELLOW}ğŸ“ æœªæ£€æµ‹åˆ°é˜²ç«å¢™ï¼Œè·³è¿‡ç«¯å£é…ç½®${NC}"
    fi

    echo -e "${YELLOW}ğŸ“ åˆ›å»ºå¤‡ä»½ç›®å½•...${NC}"
    mkdir -p /syncthing_backup
    echo -e "${GREEN}ğŸ’¾ å¤‡ä»½ç›®å½•å·²åˆ›å»º: /syncthing_backup${NC}"

    echo -e "${YELLOW}ğŸš€ å¯åŠ¨æœåŠ¡...${NC}"
    systemctl daemon-reload
    systemctl enable syncthing@root
    systemctl start syncthing@root

    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 3

    echo -e "${GREEN}ğŸ‰ Syncthing å®‰è£…å®Œæˆï¼${NC}"
    show_access_info
}

# å¸è½½å‡½æ•°
uninstall_syncthing() {
    echo -e "${YELLOW}ğŸ—‘ï¸  å¼€å§‹å¸è½½ Syncthing...${NC}"
    
    # åœæ­¢æœåŠ¡
    systemctl stop syncthing@root 2>/dev/null
    systemctl disable syncthing@root 2>/dev/null
    
    # åˆ é™¤æœåŠ¡æ–‡ä»¶
    rm -f /etc/systemd/system/syncthing@root.service
    systemctl daemon-reload
    
    # å¸è½½è½¯ä»¶åŒ…
    if [ -f /etc/debian_version ]; then
        apt remove -y syncthing
        rm -f /etc/apt/sources.list.d/syncthing.list
        rm -f /usr/share/keyrings/syncthing-archive-keyring.gpg
        apt update
    elif [ -f /etc/redhat-release ]; then
        dnf remove -y syncthing 2>/dev/null || yum remove -y syncthing
    fi
    
    # å…³é—­é˜²ç«å¢™ç«¯å£
    if command -v ufw >/dev/null; then
        ufw delete allow 8384/tcp 2>/dev/null
        ufw delete allow 22000/tcp 2>/dev/null
        ufw delete allow 21027/udp 2>/dev/null
    elif command -v firewall-cmd >/dev/null; then
        firewall-cmd --permanent --remove-port=8384/tcp 2>/dev/null
        firewall-cmd --permanent --remove-port=22000/tcp 2>/dev/null  
        firewall-cmd --permanent --remove-port=21027/udp 2>/dev/null
        firewall-cmd --reload 2>/dev/null
    fi
    
    echo -e "${YELLOW}ğŸ“ æ˜¯å¦åˆ é™¤å¤‡ä»½ç›®å½•ï¼Ÿ${NC}"
    read -p "ğŸ’­ è¾“å…¥ 'yes' åˆ é™¤ /syncthing_backup ç›®å½•: " confirm
    if [ "$confirm" = "yes" ]; then
        rm -rf /syncthing_backup
        echo -e "${GREEN}âœ… å¤‡ä»½ç›®å½•å·²åˆ é™¤${NC}"
    else
        echo -e "${YELLOW}ğŸ“ å¤‡ä»½ç›®å½•ä¿ç•™åœ¨ /syncthing_backup${NC}"
    fi
    
    echo -e "${GREEN}âœ… Syncthing å¸è½½å®Œæˆï¼${NC}"
}

# é‡å¯æœåŠ¡
restart_service() {
    echo -e "${YELLOW}ğŸ”„ é‡å¯ Syncthing æœåŠ¡...${NC}"
    systemctl restart syncthing@root
    sleep 2
    systemctl status syncthing@root --no-pager
}

# æŸ¥çœ‹çŠ¶æ€
show_status() {
    echo -e "${YELLOW}ğŸ“Š Syncthing æœåŠ¡çŠ¶æ€ï¼š${NC}"
    systemctl status syncthing@root --no-pager
    echo ""
    echo -e "${YELLOW}ğŸŒ ç«¯å£ç›‘å¬çŠ¶æ€ï¼š${NC}"
    netstat -tlnp | grep 8384 || echo "ğŸ“­ 8384 ç«¯å£æœªç›‘å¬"
    netstat -tlnp | grep 22000 || echo "ğŸ“­ 22000 ç«¯å£æœªç›‘å¬"
}

# æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
show_access_info() {
    echo ""
    echo -e "${BLUE}========================================"
    echo "ğŸ¾ Syncthing ç®¡ç†ç•Œé¢è®¿é—®ä¿¡æ¯ï¼š"
    echo "ğŸŒ å¤–ç½‘è®¿é—®: http://$(curl -s ifconfig.me):8384/"
    echo "ğŸ’» æœ¬åœ°è®¿é—®: http://localhost:8384/"
    echo "ğŸ“ å¤‡ä»½ç›®å½•: /syncthing_backup"
    echo "ğŸ”§ æœåŠ¡ç®¡ç†: systemctl status/start/stop syncthing@root"
    echo "========================================"
    echo -e "${NC}"
}

# ä¸»å¾ªç¯
while true; do
    show_menu
    case $choice in
        1)
            install_syncthing
            ;;
        2)
            uninstall_syncthing
            ;;
        3)
            restart_service
            ;;
        4)
            show_status
            ;;
        5)
            echo -e "${GREEN}ğŸ± å†è§ï¼ç¥ä½ æœ‰ä¸ªç¾å¥½çš„ä¸€å¤©ï¼${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥${NC}"
            ;;
    esac
    
    echo ""
    read -p "ğŸ’• æŒ‰å›è½¦é”®ç»§ç»­..."
    clear
done
