cat > network-diagnose.sh << 'EOF'
#!/bin/bash

echo "=== 网络连接诊断 ==="

ENDPOINT="https://c5F-lD9CfUvvI5wNsepuS-ghXU_exa0bgiwBgM_h.r2.cloudflarestorage.com"

echo "1. 测试基础网络连通性:"
ping -c 2 cloudflare.com

echo ""
echo "2. 测试DNS解析:"
nslookup r2.cloudflarestorage.com

echo ""
echo "3. 测试HTTP连接(详细):"
curl -v -I "$ENDPOINT" --connect-timeout 10

echo ""
echo "4. 测试不使用HTTPS:"
curl -v -I "http://c5F-lD9CfUvvI5wNsepuS-ghXU_exa0bgiwBgM_h.r2.cloudflarestorage.com" --connect-timeout 10

echo ""
echo "5. 检查系统代理设置:"
echo "http_proxy: $http_proxy"
echo "https_proxy: $https_proxy"
echo "no_proxy: $no_proxy"

echo ""
echo "6. 检查防火墙:"
iptables -L 2>/dev/null | head -20
EOF

chmod +x network-diagnose.sh
./network-diagnose.sh
