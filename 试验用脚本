#!/bin/bash

# ç½‘ç»œç¯å¢ƒæ£€æµ‹è„šæœ¬
# åŠŸèƒ½ï¼šæ£€æµ‹å…¬ç½‘ IPv4 å’Œ IPv6 åœ°å€
# ä½œè€…ï¼šAI åŠ©æ‰‹

# è®¾ç½®ä¸¥æ ¼æ¨¡å¼
set -euo pipefail

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*"
}

# é”™è¯¯å¤„ç†å‡½æ•°
error() {
    log "âŒ $*" >&2
    exit 1
}

# è­¦å‘Šå¤„ç†å‡½æ•°
warn() {
    log "âš ï¸  $*" >&2
}

# ä¿¡æ¯è¾“å‡ºå‡½æ•°
info() {
    log "ğŸ“ $*"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
has_cmd() {
    command -v "$1" &>/dev/null
}

# è·å–å…¬ç½‘ IPv4 åœ°å€
get_public_ipv4() {
    local timeout=10
    local url="http://ipv4.icanhazip.com"
    
    if ! has_cmd curl; then
        error "curl å‘½ä»¤æœªæ‰¾åˆ°ï¼Œè¯·å®‰è£… curl"
    fi
    
    local response
    response=$(curl -s -m "$timeout" "$url" 2>/dev/null) || {
        warn "æ— æ³•è¿æ¥åˆ° IPv4 æœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚"
        return 1
    }
    
    # æ£€æŸ¥è¿”å›çš„æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ IPv4 åœ°å€
    if [[ $response =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo "$response"
        return 0
    else
        warn "è¯·æ±‚çš„æœåŠ¡è¿”å›å¼‚å¸¸æ•°æ®ï¼š$response"
        return 1
    fi
}

# è·å–å…¬ç½‘ IPv6 åœ°å€
get_public_ipv6() {
    local timeout=10
    local url="http://ipv6.icanhazip.com"
    
    if ! has_cmd curl; then
        error "curl å‘½ä»¤æœªæ‰¾åˆ°ï¼Œè¯·å®‰è£… curl"
    fi
    
    local response
    response=$(curl -s -m "$timeout" "$url" 2>/dev/null) || {
        warn "æ— æ³•è¿æ¥åˆ° IPv6 æœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚"
        return 1
    }
    
    # æ£€æŸ¥è¿”å›çš„æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ IPv6 åœ°å€ï¼ˆç®€åŒ–éªŒè¯ï¼‰
    if [[ $response =~ ^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}$ ]]; then
        echo "$response"
        return 0
    else
        warn "è¯·æ±‚çš„æœåŠ¡è¿”å›å¼‚å¸¸æ•°æ®ï¼š$response"
        return 1
    fi
}

# éªŒè¯ IPv4 åœ°å€æ ¼å¼
is_valid_ipv4() {
    local ip="$1"
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        local IFS='.'
        local -a octets=($ip)
        for octet in "${octets[@]}"; do
            if [[ $octet -gt 255 ]]; then
                return 1
            fi
        done
        return 0
    fi
    return 1
}

# éªŒè¯ IPv6 åœ°å€æ ¼å¼ï¼ˆç®€åŒ–éªŒè¯ï¼‰
is_valid_ipv6() {
    local ip="$1"
    # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ IPv6 åœ°å€æ ¼å¼
    if [[ $ip =~ ^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}$ ]] || [[ $ip =~ ^::1$ ]] || [[ $ip =~ ^::$ ]]; then
        return 0
    fi
    return 1
}

# ä¸»å‡½æ•°
main() {
    info "å¼€å§‹æ£€æµ‹ç½‘ç»œç¯å¢ƒ..."
    
    # æ£€æµ‹å…¬ç½‘ IPv4 åœ°å€
    info "æ£€æµ‹å…¬ç½‘ IPv4 åœ°å€..."
    local ipv4_result
    if ipv4_result=$(get_public_ipv4); then
        if is_valid_ipv4 "$ipv4_result"; then
            info "å½“å‰æ‹¥æœ‰å…¬ç½‘ IPv4 åœ°å€ï¼š$ipv4_result"
        else
            warn "è·å–åˆ°çš„ IPv4 åœ°å€æ— æ•ˆï¼š$ipv4_result"
        fi
    else
        info "å½“å‰æ²¡æœ‰å…¬ç½‘ IPv4 åœ°å€"
    fi
    
    # æ£€æµ‹å…¬ç½‘ IPv6 åœ°å€
    info "æ£€æµ‹å…¬ç½‘ IPv6 åœ°å€..."
    local ipv6_result
    if ipv6_result=$(get_public_ipv6); then
        if is_valid_ipv6 "$ipv6_result"; then
            info "å½“å‰æ‹¥æœ‰å…¬ç½‘ IPv6 åœ°å€ï¼š$ipv6_result"
        else
            warn "è·å–åˆ°çš„ IPv6 åœ°å€æ— æ•ˆï¼š$ipv6_result"
        fi
    else
        info "å½“å‰æ²¡æœ‰å…¬ç½‘ IPv6 åœ°å€"
    fi
    
    info "ç½‘ç»œç¯å¢ƒæ£€æµ‹å®Œæˆã€‚"
}

# æ‰§è¡Œä¸»å‡½æ•°
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
