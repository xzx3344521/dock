#!/bin/bash
echo "ğŸ± æ¬¢è¿ä½¿ç”¨ Syncthing èŒåŒ–ä¸€é”®å®‰è£…è„šæœ¬ï¼"
echo "âœ¨ å¼€å§‹å®‰è£… Syncthing..."

# æ£€æµ‹ç³»ç»Ÿ
if [ -f /etc/debian_version ]; then
    echo "ğŸ¥ æ£€æµ‹åˆ° Debian/Ubuntu ç³»ç»Ÿ"
    # å®‰è£… Syncthing
    curl -s -o /usr/share/keyrings/syncthing-archive-keyring.gpg https://syncthing.net/release-key.gpg
    echo "deb [signed-by=/usr/share/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable" | tee /etc/apt/sources.list.d/syncthing.list
    apt update && apt install -y syncthing
    
elif [ -f /etc/redhat-release ]; then
    echo "ğŸ€ æ£€æµ‹åˆ° CentOS/RHEL ç³»ç»Ÿ"
    dnf install -y syncthing || yum install -y epel-release && yum install -y syncthing
else
    echo "âŒ ä¸æ”¯æŒçš„ç³»ç»Ÿ"
    exit 1
fi

echo "ğŸ¯ é…ç½® Syncthing æœåŠ¡..."
# åˆ›å»ºæœåŠ¡é…ç½®
cat > /etc/systemd/system/syncthing@root.service << 'EOF'
[Unit]
Description=Syncthing - Open Source Continuous File Synchronization for %i
Documentation=man:syncthing(1)
After=network.target

[Service]
User=%i
ExecStart=/usr/bin/syncthing serve --no-browser --no-restart --logflags=0 --gui-address="0.0.0.0:8384"
Restart=on-failure
SuccessExitStatus=3 4
RestartForceExitStatus=3 4

[Install]
WantedBy=multi-user.target
EOF

echo "ğŸ”§ è®¾ç½®é˜²ç«å¢™..."
# å¼€æ”¾ç«¯å£ï¼ˆå¦‚æœé˜²ç«å¢™å¼€å¯çš„è¯ï¼‰
if command -v ufw >/dev/null; then
    ufw allow 8384/tcp comment "Syncthing GUI"
    ufw allow 22000/tcp comment "Syncthing Transfer"
    ufw allow 21027/udp comment "Syncthing Discovery"
elif command -v firewall-cmd >/dev/null; then
    firewall-cmd --permanent --add-port=8384/tcp
    firewall-cmd --permanent --add-port=22000/tcp  
    firewall-cmd --permanent --add-port=21027/udp
    firewall-cmd --reload
fi

echo "ğŸ“ åˆ›å»ºå¤‡ä»½ç›®å½•..."
mkdir -p /syncthing_backup
echo "ğŸ’¾ å¤‡ä»½ç›®å½•å·²åˆ›å»º: /syncthing_backup"

echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
systemctl daemon-reload
systemctl enable syncthing@root
systemctl start syncthing@root

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 5

echo "ğŸ‰ å®‰è£…å®Œæˆï¼"
echo ""
echo "========================================"
echo "ğŸ¾ Syncthing ç®¡ç†ç•Œé¢è®¿é—®ä¿¡æ¯ï¼š"
echo "ğŸŒ åœ°å€: http://$(curl -s ifconfig.me):8384/"
echo "ğŸ’» æœ¬åœ°è®¿é—®: http://localhost:8384/"
echo "ğŸ“ å¤‡ä»½ç›®å½•: /syncthing_backup"
echo "ğŸ”§ æœåŠ¡ç®¡ç†: systemctl status/start/stop syncthing@root"
echo "========================================"
echo ""
echo "ğŸ’• é¦–æ¬¡è®¿é—®è¯·é€šè¿‡ç½‘é¡µè®¾ç½®è®¾å¤‡åç§°å’Œå¯†ç ï½"
echo "ğŸ± ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼"
