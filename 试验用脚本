#!/bin/bash

# Syncthing æ™ºèƒ½ç®¡ç†è„šæœ¬ - å®‰è£…/å¸è½½äºŒåˆä¸€
set -e

# é…ç½®å˜é‡
SYNCTHING_VERSION="v1.27.7"
INSTALL_DIR="/opt/syncthing"
CONFIG_DIR="$HOME/.config/syncthing"
SERVICE_FILE="/etc/systemd/system/syncthing.service"
BIN_PATH="/usr/local/bin/syncthing"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# è¾“å‡ºå‡½æ•°
log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo -e "${BLUE}"
    echo "================================================"
    echo "          Syncthing æ™ºèƒ½ç®¡ç†è„šæœ¬"
    echo "================================================"
    echo -e "${NC}"
    echo "ä½¿ç”¨æ–¹æ³•: $0 [command]"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install    - å®‰è£… Syncthing"
    echo "  uninstall  - å¸è½½ Syncthing" 
    echo "  reinstall  - é‡æ–°å®‰è£… Syncthing"
    echo "  status     - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  restart    - é‡å¯æœåŠ¡"
    echo "  ä¸æŒ‡å®šå‘½ä»¤ - è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…æˆ–æ˜¾ç¤ºçŠ¶æ€"
    echo ""
    echo "ç‰¹æ€§:"
    echo "  âœ… ç›´æ¥IPè®¿é—® (0.0.0.0:8384)"
    echo "  âœ… ç³»ç»ŸæœåŠ¡å®ˆæŠ¤"
    echo "  âœ… å®Œæ•´æ–‡ä»¶æƒé™"
    echo "  âœ… ä¸€é”®å®‰è£…å¸è½½"
    echo -e "${BLUE}================================================"
    echo -e "${NC}"
}

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
check_installed() {
    if [ -f "$BIN_PATH" ] || [ -f "$INSTALL_DIR/syncthing" ] || systemctl is-enabled syncthing 2>/dev/null | grep -q enabled; then
        return 0  # å·²å®‰è£…
    else
        return 1  # æœªå®‰è£…
    fi
}

# è·å–æœ¬æœºIP
get_ip() {
    hostname -I | awk '{print $1}' 2>/dev/null || echo "127.0.0.1"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    if check_installed; then
        log_success "Syncthing å·²å®‰è£…"
        echo ""
        echo "ğŸ“ å®‰è£…ç›®å½•: $INSTALL_DIR"
        echo "âš™ï¸  é…ç½®ç›®å½•: $CONFIG_DIR"
        echo "ğŸ”§ äºŒè¿›åˆ¶æ–‡ä»¶: $BIN_PATH"
        echo ""
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if systemctl is-active --quiet syncthing; then
            log_success "æœåŠ¡çŠ¶æ€: è¿è¡Œä¸­"
            echo "ğŸŒ è®¿é—®åœ°å€: http://$(get_ip):8384"
        else
            log_warning "æœåŠ¡çŠ¶æ€: å·²åœæ­¢"
        fi
        
        # æ£€æŸ¥ç«¯å£ç›‘å¬
        if netstat -tuln 2>/dev/null | grep -q ":8384 "; then
            log_success "ç«¯å£ 8384: æ­£åœ¨ç›‘å¬"
        else
            log_warning "ç«¯å£ 8384: æœªç›‘å¬"
        fi
    else
        log_warning "Syncthing æœªå®‰è£…"
    fi
}

# å®‰è£…å‡½æ•°
install_syncthing() {
    log_info "å¼€å§‹å®‰è£… Syncthing..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    if check_installed; then
        log_warning "Syncthing å·²å®‰è£…ï¼Œå¦‚éœ€é‡æ–°å®‰è£…è¯·ä½¿ç”¨: $0 reinstall"
        show_status
        exit 1
    fi

    # åˆ›å»ºå®‰è£…ç›®å½•
    log_info "åˆ›å»ºå®‰è£…ç›®å½•..."
    sudo mkdir -p $INSTALL_DIR
    sudo chown $USER:$USER $INSTALL_DIR

    # ä¸‹è½½å¹¶å®‰è£…
    log_info "ä¸‹è½½ Syncthing $SYNCTHING_VERSION..."
    cd /tmp
    wget -q --show-progress https://github.com/syncthing/syncthing/releases/download/$SYNCTHING_VERSION/syncthing-linux-amd64-$SYNCTHING_VERSION.tar.gz

    log_info "è§£å‹å®‰è£…åŒ…..."
    tar xzf syncthing-linux-amd64-$SYNCTHING_VERSION.tar.gz
    cd syncthing-linux-amd64-$SYNCTHING_VERSION

    # å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶
    log_info "å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶..."
    sudo cp syncthing $INSTALL_DIR/
    sudo chmod +x $INSTALL_DIR/syncthing
    sudo ln -sf $INSTALL_DIR/syncthing $BIN_PATH

    # åˆ›å»ºé…ç½®ç›®å½•
    log_info "åˆ›å»ºé…ç½®ç›®å½•..."
    mkdir -p $CONFIG_DIR

    # åˆ›å»º systemd æœåŠ¡æ–‡ä»¶
    log_info "åˆ›å»ºç³»ç»ŸæœåŠ¡..."
    sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=Syncthing - Open Source Continuous File Synchronization
Documentation=man:syncthing(1)
After=network.target

[Service]
Type=simple
User=$USER
ExecStart=$BIN_PATH -no-browser -gui-address="0.0.0.0:8384" -no-restart
Restart=on-failure
RestartSec=5
SuccessExitStatus=3 4
RestartForceExitStatus=3 4

[Install]
WantedBy=multi-user.target
EOF

    # é‡æ–°åŠ è½½ systemd
    sudo systemctl daemon-reload

    # å¯åŠ¨æœåŠ¡
    log_info "å¯åŠ¨ Syncthing æœåŠ¡..."
    sudo systemctl enable syncthing
    sudo systemctl start syncthing

    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    log_info "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
    for i in {1..10}; do
        if systemctl is-active --quiet syncthing; then
            break
        fi
        sleep 2
    done

    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet syncthing; then
        log_success "Syncthing å®‰è£…æˆåŠŸï¼"
        log_success "è®¿é—®åœ°å€: http://$(get_ip):8384"
        log_success "é…ç½®ç›®å½•: $CONFIG_DIR"
    else
        log_error "æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæ£€æŸ¥æ—¥å¿—: journalctl -u syncthing -f"
        exit 1
    fi

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf /tmp/syncthing-linux-amd64*
}

# å¸è½½å‡½æ•°
uninstall_syncthing() {
    log_info "å¼€å§‹å¸è½½ Syncthing..."
    
    if ! check_installed; then
        log_warning "Syncthing æœªå®‰è£…ï¼Œæ— éœ€å¸è½½"
        exit 1
    fi

    # åœæ­¢æœåŠ¡
    log_info "åœæ­¢æœåŠ¡..."
    sudo systemctl stop syncthing 2>/dev/null || true
    sudo systemctl disable syncthing 2>/dev/null || true

    # åˆ é™¤æœåŠ¡æ–‡ä»¶
    log_info "åˆ é™¤æœåŠ¡æ–‡ä»¶..."
    sudo rm -f $SERVICE_FILE
    sudo systemctl daemon-reload

    # åˆ é™¤å®‰è£…æ–‡ä»¶
    log_info "åˆ é™¤å®‰è£…æ–‡ä»¶..."
    sudo rm -rf $INSTALL_DIR

    # åˆ é™¤ç¬¦å·é“¾æ¥
    log_info "åˆ é™¤ç¬¦å·é“¾æ¥..."
    sudo rm -f $BIN_PATH

    # è¯¢é—®æ˜¯å¦åˆ é™¤é…ç½®
    echo ""
    read -p "â“ æ˜¯å¦åˆ é™¤é…ç½®æ–‡ä»¶å’Œæ•°æ®? [y/N]: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "åˆ é™¤é…ç½®æ–‡ä»¶..."
        rm -rf $CONFIG_DIR
        log_success "é…ç½®å·²åˆ é™¤"
    else
        log_info "é…ç½®ä¿ç•™åœ¨: $CONFIG_DIR"
    fi

    log_success "Syncthing å¸è½½å®Œæˆï¼"
}

# é‡æ–°å®‰è£…å‡½æ•°
reinstall_syncthing() {
    log_info "å¼€å§‹é‡æ–°å®‰è£… Syncthing..."
    $0 uninstall
    sleep 2
    $0 install
}

# é‡å¯æœåŠ¡
restart_service() {
    if check_installed; then
        log_info "é‡å¯ Syncthing æœåŠ¡..."
        sudo systemctl restart syncthing
        sleep 3
        show_status
    else
        log_error "Syncthing æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…"
        exit 1
    fi
}

# ä¸»ç¨‹åº
case "${1:-}" in
    "install")
        install_syncthing
        ;;
    "uninstall")
        uninstall_syncthing
        ;;
    "reinstall")
        reinstall_syncthing
        ;;
    "status")
        show_status
        ;;
    "restart")
        restart_service
        ;;
    "")
        # æ— å‚æ•°æ—¶è‡ªåŠ¨åˆ¤æ–­
        if check_installed; then
            show_status
        else
            log_info "æœªæ£€æµ‹åˆ° Syncthingï¼Œå¼€å§‹å®‰è£…..."
            install_syncthing
        fi
        ;;
    "help"|"-h"|"--help")
        show_usage
        ;;
    *)
        log_error "æœªçŸ¥å‘½ä»¤: $1"
        show_usage
        exit 1
        ;;
esac
