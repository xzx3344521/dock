#!/bin/bash

# Sublink å¤šç‰ˆæœ¬éƒ¨ç½²è„šæœ¬
# è·¯å¾„å·²é”å®šä¸º /data/sublinkx
set -e

# ================= é…ç½®åŒºåŸŸ =================
# è¿™é‡Œç»Ÿä¸€äº†æ‰€æœ‰æ–‡ä»¶çš„å­˜å‚¨ä½ç½®
PROJECT_DIR="/data/sublinkx"
COMPOSE_FILE="$PROJECT_DIR/docker-compose.yml"
# ===========================================

echo "=================================================="
echo "è¯·é€‰æ‹©è¦éƒ¨ç½²çš„ç‰ˆæœ¬ / Select Version:"
echo "1. SublinkX (åŽŸç‰ˆ - jaaksi/sublinkx)"
echo "2. SublinkE (æ–°ç‰ˆ - eun1e/sublinke)"
echo "=================================================="
read -p "è¯·è¾“å…¥æ•°å­— [1-2]: " choice

# åˆ›å»ºåŸºç¡€ç›®å½• (å¦‚æžœ /data ä¸å­˜åœ¨ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»º)
echo "æ­£åœ¨åˆ›å»ºç»Ÿä¸€æ•°æ®ç›®å½•: $PROJECT_DIR ..."
mkdir -p "$PROJECT_DIR"/{db,template,logs}

# å¦‚æžœæ˜¯é€‰é¡¹2 (eun1e)ï¼Œé¢å¤–åˆ›å»º plugins ç›®å½•
if [ "$choice" == "2" ]; then
    mkdir -p "$PROJECT_DIR"/plugins
fi

# å¦‚æžœä¹‹å‰æœ‰æ—§çš„ compose æ–‡ä»¶ï¼Œå…ˆå°è¯•åœæ­¢æœåŠ¡ï¼Œé¿å…å†²çª
if [ -f "$COMPOSE_FILE" ]; then
    echo "æ£€æµ‹åˆ°æ—§é…ç½®ï¼Œå°è¯•åœæ­¢æ—§å®¹å™¨..."
    cd "$PROJECT_DIR"
    docker compose down 2>/dev/null || true
fi

# æ ¹æ®é€‰æ‹©ç”Ÿæˆ Docker Compose æ–‡ä»¶
if [ "$choice" == "1" ]; then
    echo "æ­£åœ¨ç”Ÿæˆ SublinkX (jaaksi) é…ç½®æ–‡ä»¶..."
    cat > "$COMPOSE_FILE" << 'EOF'
version: '3.8'
services:
  sublinkx:
    image: jaaksi/sublinkx:latest
    container_name: sublinkx
    ports:
      - "8000:8000"
    volumes:
      - ./db:/app/db
      - ./template:/app/template
      - ./logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
    networks:
      - sublinkx-network

networks:
  sublinkx-network:
    driver: bridge
EOF

elif [ "$choice" == "2" ]; then
    echo "æ­£åœ¨ç”Ÿæˆ SublinkE (eun1e) é…ç½®æ–‡ä»¶..."
    # å¯¹åº”ä½ è¦æ±‚çš„ docker run å‘½ä»¤è½¬æ¢ï¼Œå¹¶ç»Ÿä¸€æ˜ å°„åˆ°å½“å‰ç›®å½•
    cat > "$COMPOSE_FILE" << 'EOF'
version: '3.8'
services:
  sublinke:
    image: eun1e/sublinke
    container_name: sublinke
    ports:
      - "8000:8000"
    volumes:
      - ./db:/app/db
      - ./template:/app/template
      - ./logs:/app/logs
      - ./plugins:/app/plugins
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
    networks:
      - sublinkx-network

networks:
  sublinkx-network:
    driver: bridge
EOF

else
    echo "è¾“å…¥é”™è¯¯ï¼Œè„šæœ¬é€€å‡ºã€‚"
    exit 1
fi

echo "é…ç½®æ–‡ä»¶å·²åˆ›å»º: $COMPOSE_FILE"

# éƒ¨ç½²æœåŠ¡
cd "$PROJECT_DIR"
echo "å¯åŠ¨æœåŠ¡..."
docker compose up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 5

# èŽ·å–æœåŠ¡å™¨IP
SERVER_IP=$(hostname -I | awk '{print $1}')

echo "=================================================="
if docker compose ps | grep -q "Up"; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
    if [ "$choice" == "1" ]; then
        echo "å½“å‰ç‰ˆæœ¬: SublinkX (jaaksi)"
    else
        echo "å½“å‰ç‰ˆæœ¬: SublinkE (eun1e)"
    fi
    echo "è®¿é—®åœ°å€: http://${SERVER_IP}:8000"
    echo "--------------------------------------------------"
    echo "ðŸ“‚ æ•°æ®å­˜å‚¨ä½ç½®: $PROJECT_DIR"
    echo "   (å¤‡ä»½æ—¶æ‰“åŒ…æ­¤ç›®å½•å³å¯)"
    echo "--------------------------------------------------"
    echo "å¸¸ç”¨å‘½ä»¤:"
    echo "è¿›å…¥ç›®å½•: cd /data/sublinkx"
    echo "åœæ­¢æœåŠ¡: docker compose down"
    echo "é‡å¯æœåŠ¡: docker compose restart"
    echo "æŸ¥çœ‹æ—¥å¿—: docker compose logs -f"
else
    echo "âŒ å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: docker compose logs"
fi
echo "=================================================="
