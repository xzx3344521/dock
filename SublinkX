#!/bin/bash

# ==========================================
# SublinkX/E éƒ¨ç½²è„šæœ¬ (å¸¦è‡ªåŠ¨å¤‡ä»½æ¢å¤åŠŸèƒ½)
# è·¯å¾„é”å®š: /data/sublinkx
# ==========================================

set -e

# å®šä¹‰è·¯å¾„å’Œå¤‡ä»½åœ°å€
PROJECT_DIR="/data/sublinkx"
COMPOSE_FILE="$PROJECT_DIR/docker-compose.yml"
BACKUP_URL="https://pub-b69a7194f4ea42fba6aa990c49bded91.r2.dev/data/sublinkx.zip"

# æ£€æŸ¥å¹¶å®‰è£…å¿…è¦å·¥å…· (wget, unzip)
echo "æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŽ¯å¢ƒ..."
if ! command -v unzip &> /dev/null; then
    echo "æœªæ‰¾åˆ° unzipï¼Œæ­£åœ¨å®‰è£…..."
    if [ -f /etc/debian_version ]; then
        apt-get update && apt-get install -y unzip wget
    elif [ -f /etc/redhat-release ]; then
        yum install -y unzip wget
    fi
fi

echo "=================================================="
echo "è¯·é€‰æ‹©è¦éƒ¨ç½²çš„ç‰ˆæœ¬ / Select Version:"
echo "1. SublinkX (åŽŸç‰ˆ - jaaksi/sublinkx) - ä»…å…¨æ–°éƒ¨ç½²"
echo "2. SublinkE (æ–°ç‰ˆ - eun1e/sublinke) - éƒ¨ç½²å¹¶æ¢å¤æ•°æ®"
echo "=================================================="
read -p "è¯·è¾“å…¥æ•°å­— [1-2]: " choice

# 1. åœæ­¢æ—§æœåŠ¡
if [ -f "$COMPOSE_FILE" ]; then
    echo "æ£€æµ‹åˆ°æ—§é…ç½®ï¼Œæ­£åœ¨åœæ­¢æ—§å®¹å™¨..."
    cd "$PROJECT_DIR"
    docker compose down 2>/dev/null || true
fi

# 2. å‡†å¤‡ç›®å½•
echo "æ­£åœ¨å‡†å¤‡ç›®å½•: $PROJECT_DIR ..."
mkdir -p "$PROJECT_DIR"

# 3. å¦‚æžœé€‰æ‹© 2ï¼Œæ‰§è¡Œå¤‡ä»½æ¢å¤é€»è¾‘
if [ "$choice" == "2" ]; then
    echo "--------------------------------------------------"
    echo "ðŸ”„ æ­£åœ¨ä¸‹è½½å¹¶æ¢å¤å¤‡ä»½æ•°æ®..."
    echo "ä¸‹è½½åœ°å€: $BACKUP_URL"
    
    # ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•
    wget -O /tmp/sublinkx_backup.zip "$BACKUP_URL"
    
    echo "æ­£åœ¨è§£åŽ‹æ•°æ®..."
    # è§£åŽ‹åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ä»¥æ£€æŸ¥ç»“æž„
    rm -rf /tmp/sublink_restore_temp
    mkdir -p /tmp/sublink_restore_temp
    unzip -o /tmp/sublinkx_backup.zip -d /tmp/sublink_restore_temp
    
    # æ™ºèƒ½ç§»åŠ¨æ•°æ® (é˜²æ­¢åŽ‹ç¼©åŒ…å†…åŒ…å«/ä¸åŒ…å«æ ¹æ–‡ä»¶å¤¹çš„æƒ…å†µ)
    # å¦‚æžœè§£åŽ‹åŽæœ‰ä¸€ä¸ªåä¸º sublinkx çš„æ–‡ä»¶å¤¹ï¼Œåˆ™ç§»åŠ¨å…¶å†…å®¹ï¼›å¦åˆ™ç§»åŠ¨æ‰€æœ‰å†…å®¹
    if [ -d "/tmp/sublink_restore_temp/sublinkx" ]; then
        echo "æ£€æµ‹åˆ°ç›®å½•åµŒå¥—ï¼Œæ­£åœ¨ç§»åŠ¨å†…éƒ¨æ•°æ®..."
        cp -rf /tmp/sublink_restore_temp/sublinkx/* "$PROJECT_DIR/"
    else
        echo "æ£€æµ‹åˆ°ç›´æŽ¥ç»“æž„ï¼Œæ­£åœ¨ç§»åŠ¨æ•°æ®..."
        cp -rf /tmp/sublink_restore_temp/* "$PROJECT_DIR/"
    fi
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f /tmp/sublinkx_backup.zip
    rm -rf /tmp/sublink_restore_temp
    
    # ç¡®ä¿ plugins ç›®å½•å­˜åœ¨ (ä»¥é˜²å¤‡ä»½é‡Œæ²¡æœ‰)
    mkdir -p "$PROJECT_DIR"/plugins
    
    echo "âœ… æ•°æ®æ¢å¤å®Œæˆï¼"
    echo "--------------------------------------------------"
else
    # é€‰é¡¹ 1 çš„å¸¸è§„ç›®å½•åˆ›å»º
    mkdir -p "$PROJECT_DIR"/{db,template,logs}
fi

# 4. ç”Ÿæˆ Docker Compose æ–‡ä»¶
if [ "$choice" == "1" ]; then
    echo "æ­£åœ¨ç”Ÿæˆ SublinkX (jaaksi) é…ç½®æ–‡ä»¶..."
    cat > "$COMPOSE_FILE" << 'EOF'
version: '3.8'
services:
  sublinkx:
    image: jaaksi/sublinkx:latest
    container_name: sublinkx
    ports:
      - "8000:8000"
    volumes:
      - ./db:/app/db
      - ./template:/app/template
      - ./logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
    networks:
      - sublinkx-network

networks:
  sublinkx-network:
    driver: bridge
EOF

elif [ "$choice" == "2" ]; then
    echo "æ­£åœ¨ç”Ÿæˆ SublinkE (eun1e) é…ç½®æ–‡ä»¶..."
    cat > "$COMPOSE_FILE" << 'EOF'
version: '3.8'
services:
  sublinke:
    image: eun1e/sublinke
    container_name: sublinke
    ports:
      - "8000:8000"
    volumes:
      - ./db:/app/db
      - ./template:/app/template
      - ./logs:/app/logs
      - ./plugins:/app/plugins
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
    networks:
      - sublinkx-network

networks:
  sublinkx-network:
    driver: bridge
EOF
else
    echo "è¾“å…¥é”™è¯¯ï¼Œè„šæœ¬é€€å‡ºã€‚"
    exit 1
fi

# 5. å¯åŠ¨æœåŠ¡
cd "$PROJECT_DIR"
echo "æ­£åœ¨å¯åŠ¨å®¹å™¨..."
docker compose up -d

# 6. æ£€æŸ¥çŠ¶æ€
echo "ç­‰å¾…æœåŠ¡åˆå§‹åŒ–..."
sleep 5
SERVER_IP=$(hostname -I | awk '{print $1}')

echo "=================================================="
if docker compose ps | grep -q "Up"; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
    if [ "$choice" == "2" ]; then
        echo "æ¨¡å¼: SublinkE (å·²æ¢å¤å¤‡ä»½)"
    else
        echo "æ¨¡å¼: SublinkX (å…¨æ–°å®‰è£…)"
    fi
    echo "è®¿é—®åœ°å€: http://${SERVER_IP}:8000"
    echo "æ•°æ®ä½ç½®: $PROJECT_DIR"
    echo "=================================================="
else
    echo "âŒ å¯åŠ¨å¤±è´¥ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ—¥å¿—:"
    echo "cd $PROJECT_DIR && docker compose logs"
fi
