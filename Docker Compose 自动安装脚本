#!/bin/bash

# Docker Compose è‡ªåŠ¨å®‰è£…è„šæœ¬
# é€‚ç”¨äºå¤§å¤šæ•°Linuxå‘è¡Œç‰ˆ

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "=== Docker Compose å®‰è£…è„šæœ¬ ==="

# æ£€æŸ¥ç³»ç»Ÿæ¶æ„
ARCH=$(uname -m)
if [ "$ARCH" != "x86_64" ] && [ "$ARCH" != "aarch64" ]; then
    echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
    echo "è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…Docker:"
    echo "curl -fsSL https://get.docker.com -o get-docker.sh && sh get-docker.sh"
    exit 1
fi

echo "âœ… Docker å·²å®‰è£…"

# æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰Dockeræƒé™
if ! docker ps &> /dev/null; then
    echo "âš ï¸  å½“å‰ç”¨æˆ·æ— Dockeræƒé™ï¼Œå°è¯•æ·»åŠ åˆ°dockerç»„..."
    sudo usermod -aG docker $USER
    echo "ğŸ“ è¯·é‡æ–°ç™»å½•æˆ–è¿è¡Œ 'newgrp docker' ä½¿æƒé™ç”Ÿæ•ˆ"
    echo "ğŸ“ ç„¶åé‡æ–°è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# è·å–æœ€æ–°ç‰ˆæœ¬
get_latest_version() {
    curl -s https://api.github.com/repos/docker/compose/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/'
}

# å®‰è£…Docker Compose
install_docker_compose() {
    echo "ğŸ“¥ æ­£åœ¨å®‰è£… Docker Compose..."
    
    # è·å–æœ€æ–°ç‰ˆæœ¬
    VERSION=$(get_latest_version)
    echo "ğŸ” æœ€æ–°ç‰ˆæœ¬: $VERSION"
    
    # ä¸‹è½½å¹¶å®‰è£…
    sudo curl -L "https://github.com/docker/compose/releases/download/${VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    
    # èµ‹äºˆæ‰§è¡Œæƒé™
    sudo chmod +x /usr/local/bin/docker-compose
    
    # åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
    if [ ! -f /usr/bin/docker-compose ]; then
        sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
    fi
}

# ä¸»å®‰è£…æµç¨‹
main() {
    # å¦‚æœå·²å®‰è£…ï¼Œè¯¢é—®æ˜¯å¦é‡æ–°å®‰è£…
    if command -v docker-compose &> /dev/null; then
        CURRENT_VERSION=$(docker-compose --version 2>/dev/null || echo "æœªçŸ¥ç‰ˆæœ¬")
        echo "â„¹ï¸  Docker Compose å·²å®‰è£…: $CURRENT_VERSION"
        read -p "æ˜¯å¦é‡æ–°å®‰è£…ï¼Ÿ(y/N): " -n 1 -r
        echo
        if [[ ! $REply =~ ^[Yy]$ ]]; then
            echo "âœ… å®‰è£…å·²å–æ¶ˆ"
            exit 0
        fi
    fi
    
    install_docker_compose
    
    # éªŒè¯å®‰è£…
    if docker-compose --version &> /dev/null; then
        echo "âœ… Docker Compose å®‰è£…æˆåŠŸï¼"
        echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: $(docker-compose --version)"
    else
        echo "âŒ å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ‰‹åŠ¨å®‰è£…"
        exit 1
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main
